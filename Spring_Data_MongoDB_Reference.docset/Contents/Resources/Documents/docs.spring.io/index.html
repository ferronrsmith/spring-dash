<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.2">
<meta name="author" content="Mark Pollack, Thomas Risberg, Oliver Gierke, Costin Leau, Jon Brisbin, Thomas Darimont, Christoph Strobl, Mark Paluch, Jay Bryant">
<title>Spring Data MongoDB - Reference Documentation</title>
<link rel="stylesheet" href="css/spring.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
</head>
<body class="book toc2 toc-left">
<div id="header">
<h1>Spring Data MongoDB - Reference Documentation</h1>
<div class="details">
<span id="author" class="author">Mark Pollack</span><br>
<span id="author2" class="author">Thomas Risberg</span><br>
<span id="author3" class="author">Oliver Gierke</span><br>
<span id="author4" class="author">Costin Leau</span><br>
<span id="author5" class="author">Jon Brisbin</span><br>
<span id="author6" class="author">Thomas Darimont</span><br>
<span id="author7" class="author">Christoph Strobl</span><br>
<span id="author8" class="author">Mark Paluch</span><br>
<span id="author9" class="author">Jay Bryant</span><br>
<span id="revnumber">version 3.1.1,</span>
<span id="revdate">2020-11-11</span>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel0">
<li><a href="index.html#preface">Preface</a>
<ul class="sectlevel1">
<li><a href="index.html#get-started:first-steps:spring">1. Learning Spring</a></li>
<li><a href="index.html#get-started:first-steps:nosql">2. Learning NoSQL and Document databases</a></li>
<li><a href="index.html#requirements">3. Requirements</a></li>
<li><a href="index.html#get-started:help">4. Additional Help Resources</a></li>
<li><a href="index.html#get-started:up-to-date">5. Following Development</a></li>
<li><a href="index.html#new-features">6. New &amp; Noteworthy</a>
<ul class="sectlevel2">
<li><a href="index.html#new-features.3.1">6.1. What&#8217;s New in Spring Data MongoDB 3.1</a></li>
<li><a href="index.html#new-features.3.0">6.2. What&#8217;s New in Spring Data MongoDB 3.0</a></li>
<li><a href="index.html#new-features.2-2-0">6.3. What&#8217;s New in Spring Data MongoDB 2.2</a></li>
<li><a href="index.html#new-features.2-1-0">6.4. What&#8217;s New in Spring Data MongoDB 2.1</a></li>
<li><a href="index.html#new-features.2-0-0">6.5. What&#8217;s New in Spring Data MongoDB 2.0</a></li>
<li><a href="index.html#new-features.1-10-0">6.6. What&#8217;s New in Spring Data MongoDB 1.10</a></li>
<li><a href="index.html#new-features.1-9-0">6.7. What&#8217;s New in Spring Data MongoDB 1.9</a></li>
<li><a href="index.html#new-features.1-8-0">6.8. What&#8217;s New in Spring Data MongoDB 1.8</a></li>
<li><a href="index.html#new-features.1-7-0">6.9. What&#8217;s New in Spring Data MongoDB 1.7</a></li>
</ul>
</li>
<li><a href="index.html#upgrading.2-3">7. Upgrading from 2.x to 3.x</a>
<ul class="sectlevel2">
<li><a href="index.html#">7.1. Dependency Changes</a></li>
<li><a href="index.html#">7.2. Java Configuration</a></li>
<li><a href="index.html#">7.3. XML Namespace</a></li>
<li><a href="index.html#">7.4. Other Changes</a>
<ul class="sectlevel3">
<li><a href="index.html#">7.4.1. Auto Index Creation</a></li>
<li><a href="index.html#">7.4.2. UUID Types</a></li>
<li><a href="index.html#">7.4.3. Deferred MongoDatabase lookup in <code>ReactiveMongoDatabaseFactory</code></a></li>
</ul>
</li>
</ul>
</li>
<li><a href="index.html#dependencies">8. Dependencies</a>
<ul class="sectlevel2">
<li><a href="index.html#dependencies.spring-boot">8.1. Dependency Management with Spring Boot</a></li>
<li><a href="index.html#dependencies.spring-framework">8.2. Spring Framework</a></li>
</ul>
</li>
<li><a href="index.html#repositories">9. Working with Spring Data Repositories</a>
<ul class="sectlevel2">
<li><a href="index.html#repositories.core-concepts">9.1. Core concepts</a></li>
<li><a href="index.html#repositories.query-methods">9.2. Query Methods</a></li>
<li><a href="index.html#repositories.definition">9.3. Defining Repository Interfaces</a>
<ul class="sectlevel3">
<li><a href="index.html#repositories.definition-tuning">9.3.1. Fine-tuning Repository Definition</a></li>
<li><a href="index.html#repositories.multiple-modules">9.3.2. Using Repositories with Multiple Spring Data Modules</a></li>
</ul>
</li>
<li><a href="index.html#repositories.query-methods.details">9.4. Defining Query Methods</a>
<ul class="sectlevel3">
<li><a href="index.html#repositories.query-methods.query-lookup-strategies">9.4.1. Query Lookup Strategies</a></li>
<li><a href="index.html#repositories.query-methods.query-creation">9.4.2. Query Creation</a></li>
<li><a href="index.html#repositories.query-methods.query-property-expressions">9.4.3. Property Expressions</a></li>
<li><a href="index.html#repositories.special-parameters">9.4.4. Special parameter handling</a>
<ul class="sectlevel4">
<li><a href="index.html#repositories.paging-and-sorting">Paging and Sorting</a></li>
</ul>
</li>
<li><a href="index.html#repositories.limit-query-result">9.4.5. Limiting Query Results</a></li>
<li><a href="index.html#repositories.collections-and-iterables">9.4.6. Repository Methods Returning Collections or Iterables</a>
<ul class="sectlevel4">
<li><a href="index.html#repositories.collections-and-iterables.streamable">Using Streamable as Query Method Return Type</a></li>
<li><a href="index.html#repositories.collections-and-iterables.streamable-wrapper">Returning Custom Streamable Wrapper Types</a></li>
<li><a href="index.html#repositories.collections-and-iterables.vavr">Support for Vavr Collections</a></li>
</ul>
</li>
<li><a href="index.html#repositories.nullability">9.4.7. Null Handling of Repository Methods</a>
<ul class="sectlevel4">
<li><a href="index.html#repositories.nullability.annotations">Nullability Annotations</a></li>
<li><a href="index.html#repositories.nullability.kotlin">Nullability in Kotlin-based Repositories</a></li>
</ul>
</li>
<li><a href="index.html#repositories.query-streaming">9.4.8. Streaming Query Results</a></li>
<li><a href="index.html#repositories.query-async">9.4.9. Asynchronous Query Results</a></li>
</ul>
</li>
<li><a href="index.html#repositories.create-instances">9.5. Creating Repository Instances</a>
<ul class="sectlevel3">
<li><a href="index.html#repositories.create-instances.spring">9.5.1. XML Configuration</a>
<ul class="sectlevel4">
<li><a href="index.html#repositories.using-filters">Using Filters</a></li>
</ul>
</li>
<li><a href="index.html#repositories.create-instances.java-config">9.5.2. Java Configuration</a></li>
<li><a href="index.html#repositories.create-instances.standalone">9.5.3. Standalone Usage</a></li>
</ul>
</li>
<li><a href="index.html#repositories.custom-implementations">9.6. Custom Implementations for Spring Data Repositories</a>
<ul class="sectlevel3">
<li><a href="index.html#repositories.single-repository-behavior">9.6.1. Customizing Individual Repositories</a>
<ul class="sectlevel4">
<li><a href="index.html#repositories.configuration">Configuration</a></li>
</ul>
</li>
<li><a href="index.html#repositories.customize-base-repository">9.6.2. Customize the Base Repository</a></li>
</ul>
</li>
<li><a href="index.html#core.domain-events">9.7. Publishing Events from Aggregate Roots</a></li>
<li><a href="index.html#core.extensions">9.8. Spring Data Extensions</a>
<ul class="sectlevel3">
<li><a href="index.html#core.extensions.querydsl">9.8.1. Querydsl Extension</a></li>
<li><a href="index.html#core.web">9.8.2. Web support</a>
<ul class="sectlevel4">
<li><a href="index.html#core.web.basic">Basic Web Support</a></li>
<li><a href="index.html#core.web.pageables">Hypermedia Support for Pageables</a></li>
<li><a href="index.html#core.web.binding">Web Databinding Support</a></li>
<li><a href="index.html#core.web.type-safe">Querydsl Web Support</a></li>
</ul>
</li>
<li><a href="index.html#core.repository-populators">9.8.3. Repository Populators</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="index.html#reference">Reference Documentation</a>
<ul class="sectlevel1">
<li><a href="index.html#introduction">10. Introduction</a>
<ul class="sectlevel2">
<li><a href="index.html#">10.1. Document Structure</a></li>
</ul>
</li>
<li><a href="index.html#mongo.core">11. MongoDB support</a>
<ul class="sectlevel2">
<li><a href="index.html#mongodb-getting-started">11.1. Getting Started</a></li>
<li><a href="index.html#mongo.examples-repo">11.2. Examples Repository</a></li>
<li><a href="index.html#mongodb-connectors">11.3. Connecting to MongoDB with Spring</a>
<ul class="sectlevel3">
<li><a href="index.html#mongo.mongo-java-config">11.3.1. Registering a Mongo Instance by using Java-based Metadata</a></li>
<li><a href="index.html#mongo.mongo-xml-config">11.3.2. Registering a Mongo Instance by Using XML-based Metadata</a></li>
<li><a href="index.html#mongo.mongo-db-factory">11.3.3. The MongoDatabaseFactory Interface</a></li>
<li><a href="index.html#mongo.mongo-db-factory-java">11.3.4. Registering a <code>MongoDatabaseFactory</code> Instance by Using Java-based Metadata</a></li>
<li><a href="index.html#mongo.mongo-db-factory-xml">11.3.5. Registering a <code>MongoDatabaseFactory</code> Instance by Using XML-based Metadata</a></li>
</ul>
</li>
<li><a href="index.html#mongo-template">11.4. Introduction to <code>MongoTemplate</code></a>
<ul class="sectlevel3">
<li><a href="index.html#mongo-template.instantiating">11.4.1. Instantiating <code>MongoTemplate</code></a></li>
<li><a href="index.html#mongo-template.writeresultchecking">11.4.2. <code>WriteResultChecking</code> Policy</a></li>
<li><a href="index.html#mongo-template.writeconcern">11.4.3. <code>WriteConcern</code></a></li>
<li><a href="index.html#mongo-template.writeconcernresolver">11.4.4. <code>WriteConcernResolver</code></a></li>
</ul>
</li>
<li><a href="index.html#mongo-template.save-update-remove">11.5. Saving, Updating, and Removing Documents</a>
<ul class="sectlevel3">
<li><a href="index.html#mongo-template.id-handling">11.5.1. How the <code>_id</code> Field is Handled in the Mapping Layer</a></li>
<li><a href="index.html#mongo-template.type-mapping">11.5.2. Type Mapping</a>
<ul class="sectlevel4">
<li><a href="index.html#">Customizing Type Mapping</a></li>
<li><a href="index.html#">Configuring Custom Type Mapping</a></li>
</ul>
</li>
<li><a href="index.html#mongo-template.save-insert">11.5.3. Methods for Saving and Inserting Documents</a>
<ul class="sectlevel4">
<li><a href="index.html#mongo-template.save-insert.collection">Into Which Collection Are My Documents Saved?</a></li>
<li><a href="index.html#mongo-template.save-insert.individual">Inserting or Saving Individual Objects</a></li>
<li><a href="index.html#mongo-template.save-insert.batch">Inserting Several Objects in a Batch</a></li>
</ul>
</li>
<li><a href="index.html#mongodb-template-update">11.5.4. Updating Documents in a Collection</a>
<ul class="sectlevel4">
<li><a href="index.html#mongodb-template-update.methods">Methods for Running Updates for Documents</a></li>
<li><a href="index.html#mongodb-template-update.update">Methods in the <code>Update</code> Class</a></li>
</ul>
</li>
<li><a href="index.html#mongo-template.upserts">11.5.5. &#8220;Upserting&#8221; Documents in a Collection</a></li>
<li><a href="index.html#mongo-template.find-and-upsert">11.5.6. Finding and Upserting Documents in a Collection</a></li>
<li><a href="index.html#mongo-template.aggregation-update">11.5.7. Aggregation Pipeline Updates</a></li>
<li><a href="index.html#mongo-template.find-and-replace">11.5.8. Finding and Replacing Documents</a></li>
<li><a href="index.html#mongo-template.delete">11.5.9. Methods for Removing Documents</a></li>
<li><a href="index.html#mongo-template.optimistic-locking">11.5.10. Optimistic Locking</a></li>
</ul>
</li>
<li><a href="index.html#mongo.query">11.6. Querying Documents</a>
<ul class="sectlevel3">
<li><a href="index.html#mongodb-template-query">11.6.1. Querying Documents in a Collection</a>
<ul class="sectlevel4">
<li><a href="index.html#mongodb-template-query.criteria">Methods for the Criteria Class</a></li>
<li><a href="index.html#mongodb-template-query.query">Methods for the Query class</a></li>
</ul>
</li>
<li><a href="index.html#mongo-template.querying">11.6.2. Methods for Querying for Documents</a></li>
<li><a href="index.html#mongo-template.query.distinct">11.6.3. Query Distinct Values</a></li>
<li><a href="index.html#mongo.geospatial">11.6.4. GeoSpatial Queries</a>
<ul class="sectlevel4">
<li><a href="index.html#mongo.geo-near">Geo-near Queries</a></li>
</ul>
</li>
<li><a href="index.html#mongo.geo-json">11.6.5. GeoJSON Support</a>
<ul class="sectlevel4">
<li><a href="index.html#">GeoJSON Types in Domain Classes</a></li>
<li><a href="index.html#">GeoJSON Types in Repository Query Methods</a></li>
<li><a href="index.html#">Metrics and Distance calculation</a></li>
</ul>
</li>
<li><a href="index.html#mongo.textsearch">11.6.6. Full-text Queries</a>
<ul class="sectlevel4">
<li><a href="index.html#">Full-text Search</a></li>
</ul>
</li>
<li><a href="index.html#mongo.collation">11.6.7. Collations</a>
<ul class="sectlevel4">
<li><a href="index.html#mongo.jsonSchema">JSON Schema</a></li>
</ul>
</li>
<li><a href="index.html#mongo.jsonSchema">11.6.8. JSON Schema</a></li>
<li><a href="index.html#mongo.query.fluent-template-api">11.6.9. Fluent Template API</a></li>
<li><a href="index.html#mongo.query.kotlin-support">11.6.10. Type-safe Queries for Kotlin</a></li>
<li><a href="index.html#mongo.query.additional-query-options">11.6.11. Additional Query Options</a></li>
</ul>
</li>
<li><a href="index.html#query-by-example">11.7. Query by Example</a>
<ul class="sectlevel3">
<li><a href="index.html#query-by-example.introduction">11.7.1. Introduction</a></li>
<li><a href="index.html#query-by-example.usage">11.7.2. Usage</a></li>
<li><a href="index.html#query-by-example.matchers">11.7.3. Example Matchers</a></li>
<li><a href="index.html#query-by-example.running">11.7.4. Running an Example</a></li>
<li><a href="index.html#query-by-example.untyped">11.7.5. Untyped Example</a></li>
</ul>
</li>
<li><a href="index.html#mongo.query.count">11.8. Counting Documents</a></li>
<li><a href="index.html#mongo.mapreduce">11.9. Map-Reduce Operations</a>
<ul class="sectlevel3">
<li><a href="index.html#mongo.mapreduce.example">11.9.1. Example Usage</a></li>
</ul>
</li>
<li><a href="index.html#mongo.server-side-scripts">11.10. Script Operations</a></li>
<li><a href="index.html#mongo.group">11.11. Group Operations</a>
<ul class="sectlevel3">
<li><a href="index.html#mongo.group.example">11.11.1. Example Usage</a></li>
</ul>
</li>
<li><a href="index.html#mongo.aggregation">11.12. Aggregation Framework Support</a>
<ul class="sectlevel3">
<li><a href="index.html#mongo.aggregation.basic-concepts">11.12.1. Basic Concepts</a></li>
<li><a href="index.html#mongo.aggregation.supported-aggregation-operations">11.12.2. Supported Aggregation Operations</a></li>
<li><a href="index.html#mongo.aggregation.projection">11.12.3. Projection Expressions</a></li>
<li><a href="index.html#mongo.aggregation.facet">11.12.4. Faceted Classification</a>
<ul class="sectlevel4">
<li><a href="index.html#">Buckets</a></li>
<li><a href="index.html#">Multi-faceted Aggregation</a></li>
<li><a href="index.html#mongo.aggregation.sort-by-count">Sort By Count</a></li>
<li><a href="index.html#mongo.aggregation.projection.expressions">Spring Expression Support in Projection Expressions</a></li>
<li><a href="index.html#mongo.aggregation.examples">Aggregation Framework Examples</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="index.html#mongo-template.index-and-collections">11.13. Index and Collection Management</a>
<ul class="sectlevel3">
<li><a href="index.html#mongo-template.index-and-collections.index">11.13.1. Methods for Creating an Index</a></li>
<li><a href="index.html#mongo-template.index-and-collections.access">11.13.2. Accessing Index Information</a></li>
<li><a href="index.html#mongo-template.index-and-collections.collection">11.13.3. Methods for Working with a Collection</a></li>
</ul>
</li>
<li><a href="index.html#mongo-template.commands">11.14. Running Commands</a>
<ul class="sectlevel3">
<li><a href="index.html#mongo-template.commands.execution">11.14.1. Methods for running commands</a></li>
</ul>
</li>
<li><a href="index.html#mongodb.mapping-usage.events">11.15. Lifecycle Events</a></li>
<li><a href="index.html#entity-callbacks">11.16. Entity Callbacks</a>
<ul class="sectlevel3">
<li><a href="index.html#entity-callbacks.implement">11.16.1. Implementing Entity Callbacks</a></li>
<li><a href="index.html#entity-callbacks.register">11.16.2. Registering Entity Callbacks</a></li>
<li><a href="index.html#mongo.entity-callbacks">11.16.3. Store specific EntityCallbacks</a></li>
</ul>
</li>
<li><a href="index.html#mongo.exception">11.17. Exception Translation</a></li>
<li><a href="index.html#mongo.executioncallback">11.18. Execution Callbacks</a></li>
<li><a href="index.html#gridfs">11.19. GridFS Support</a></li>
<li><a href="index.html#tailable-cursors">11.20. Infinite Streams with Tailable Cursors</a>
<ul class="sectlevel3">
<li><a href="index.html#tailable-cursors.sync">11.20.1. Tailable Cursors with <code>MessageListener</code></a></li>
<li><a href="index.html#tailable-cursors.reactive">11.20.2. Reactive Tailable Cursors</a></li>
</ul>
</li>
<li><a href="index.html#change-streams">11.21. Change Streams</a>
<ul class="sectlevel3">
<li><a href="index.html#">11.21.1. Change Streams with <code>MessageListener</code></a></li>
<li><a href="index.html#">11.21.2. Reactive Change Streams</a></li>
<li><a href="index.html#">11.21.3. Resuming Change Streams</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="index.html#mongo.sessions">12. MongoDB Sessions</a>
<ul class="sectlevel2">
<li><a href="index.html#mongo.sessions.sync">12.1. Synchronous <code>ClientSession</code> support.</a></li>
<li><a href="index.html#mongo.sessions.reactive">12.2. Reactive <code>ClientSession</code> support</a></li>
</ul>
</li>
<li><a href="index.html#mongo.transactions">13. MongoDB Transactions</a>
<ul class="sectlevel2">
<li><a href="index.html#mongo.transactions.transaction-template">13.1. Transactions with <code>TransactionTemplate</code></a></li>
<li><a href="index.html#mongo.transactions.tx-manager">13.2. Transactions with <code>MongoTransactionManager</code></a></li>
<li><a href="index.html#mongo.transactions.reactive">13.3. Reactive Transactions</a></li>
<li><a href="index.html#mongo.transactions.reactive-operator">13.4. Transactions with <code>TransactionalOperator</code></a></li>
<li><a href="index.html#mongo.transactions.reactive-tx-manager">13.5. Transactions with <code>ReactiveMongoTransactionManager</code></a></li>
<li><a href="index.html#mongo.transactions.behavior">13.6. Special behavior inside transactions</a></li>
</ul>
</li>
<li><a href="index.html#mongo.reactive">14. Reactive MongoDB support</a>
<ul class="sectlevel2">
<li><a href="index.html#mongodb-reactive-getting-started">14.1. Getting Started</a></li>
<li><a href="index.html#mongo.reactive.driver">14.2. Connecting to MongoDB with Spring and the Reactive Streams Driver</a>
<ul class="sectlevel3">
<li><a href="index.html#mongo.reactive.mongo-java-config">14.2.1. Registering a MongoClient Instance Using Java-based Metadata</a></li>
<li><a href="index.html#mongo.reactive.mongo-db-factory">14.2.2. The ReactiveMongoDatabaseFactory Interface</a></li>
<li><a href="index.html#mongo.reactive.mongo-db-factory-java">14.2.3. Registering a ReactiveMongoDatabaseFactory Instance by Using Java-based Metadata</a></li>
</ul>
</li>
<li><a href="index.html#mongo.reactive.template">14.3. Introduction to <code>ReactiveMongoTemplate</code></a>
<ul class="sectlevel3">
<li><a href="index.html#mongo.reactive.template.instantiating">14.3.1. Instantiating ReactiveMongoTemplate</a></li>
<li><a href="index.html#mongo.reactive.template.writeresultchecking">14.3.2. <code>WriteResultChecking</code> Policy</a></li>
<li><a href="index.html#mongo.reactive.template.writeconcern">14.3.3. <code>WriteConcern</code></a></li>
<li><a href="index.html#mongo.reactive.template.writeconcernresolver">14.3.4. <code>WriteConcernResolver</code></a></li>
</ul>
</li>
<li><a href="index.html#mongo.reactive.template.save-update-remove">14.4. Saving, Updating, and Removing Documents</a></li>
<li><a href="index.html#mongo.reactive.executioncallback">14.5. Execution Callbacks</a></li>
<li><a href="index.html#reactive.gridfs">14.6. GridFS Support</a></li>
</ul>
</li>
<li><a href="index.html#mongo.repositories">15. MongoDB Repositories</a>
<ul class="sectlevel2">
<li><a href="index.html#mongo-repo-intro">15.1. Introduction</a></li>
<li><a href="index.html#mongo-repo-usage">15.2. Usage</a></li>
<li><a href="index.html#mongodb.repositories.queries">15.3. Query Methods</a>
<ul class="sectlevel3">
<li><a href="index.html#mongodb.repositories.queries.delete">15.3.1. Repository Delete Queries</a></li>
<li><a href="index.html#mongodb.repositories.queries.geo-spatial">15.3.2. Geo-spatial Repository Queries</a>
<ul class="sectlevel4">
<li><a href="index.html#">Geo-near Queries</a></li>
</ul>
</li>
<li><a href="index.html#mongodb.repositories.queries.json-based">15.3.3. MongoDB JSON-based Query Methods and Field Restriction</a></li>
<li><a href="index.html#mongodb.repositories.queries.sort">15.3.4. Sorting Query Method results</a></li>
<li><a href="index.html#mongodb.repositories.queries.json-spel">15.3.5. JSON-based Queries with SpEL Expressions</a></li>
<li><a href="index.html#mongodb.repositories.queries.type-safe">15.3.6. Type-safe Query Methods</a></li>
<li><a href="index.html#mongodb.repositories.queries.full-text">15.3.7. Full-text Search Queries</a></li>
<li><a href="index.html#projections">15.3.8. Projections</a>
<ul class="sectlevel4">
<li><a href="index.html#projections.interfaces">Interface-based Projections</a></li>
<li><a href="index.html#projections.dtos">Class-based Projections (DTOs)</a></li>
<li><a href="index.html#projection.dynamic">Dynamic Projections</a></li>
</ul>
</li>
<li><a href="index.html#mongodb.repositories.queries.aggregation">15.3.9. Aggregation Repository Methods</a></li>
</ul>
</li>
<li><a href="index.html#mongodb.repositories.misc.cdi-integration">15.4. CDI Integration</a></li>
</ul>
</li>
<li><a href="index.html#mongo.reactive.repositories">16. Reactive MongoDB repositories</a>
<ul class="sectlevel2">
<li><a href="index.html#mongo.reactive.repositories.libraries">16.1. Reactive Composition Libraries</a></li>
<li><a href="index.html#mongo.reactive.repositories.usage">16.2. Usage</a></li>
<li><a href="index.html#mongo.reactive.repositories.features">16.3. Features</a>
<ul class="sectlevel3">
<li><a href="index.html#mongodb.reactive.repositories.queries.geo-spatial">16.3.1. Geo-spatial Repository Queries</a>
<ul class="sectlevel4">
<li><a href="index.html#">Geo-near Queries</a></li>
</ul>
</li>
<li><a href="index.html#mongodb.reactive.repositories.queries.type-safe">16.3.2. Type-safe Query Methods</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="index.html#auditing">17. Auditing</a>
<ul class="sectlevel2">
<li><a href="index.html#auditing.basics">17.1. Basics</a>
<ul class="sectlevel3">
<li><a href="index.html#auditing.annotations">17.1.1. Annotation-based Auditing Metadata</a></li>
<li><a href="index.html#auditing.interfaces">17.1.2. Interface-based Auditing Metadata</a></li>
<li><a href="index.html#auditing.auditor-aware">17.1.3. <code>AuditorAware</code></a></li>
<li><a href="index.html#auditing.reactive-auditor-aware">17.1.4. <code>ReactiveAuditorAware</code></a></li>
</ul>
</li>
<li><a href="index.html#mongo.auditing">17.2. General Auditing Configuration for MongoDB</a></li>
</ul>
</li>
<li><a href="index.html#mapping-chapter">18. Mapping</a>
<ul class="sectlevel2">
<li><a href="index.html#mapping.fundamentals">18.1. Object Mapping Fundamentals</a>
<ul class="sectlevel3">
<li><a href="index.html#mapping.object-creation">18.1.1. Object creation</a></li>
<li><a href="index.html#mapping.property-population">18.1.2. Property population</a></li>
<li><a href="index.html#mapping.general-recommendations">18.1.3. General recommendations</a></li>
<li><a href="index.html#mapping.kotlin">18.1.4. Kotlin support</a>
<ul class="sectlevel4">
<li><a href="index.html#">Kotlin object creation</a></li>
<li><a href="index.html#">Property population of Kotlin data classes</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="index.html#mapping-conventions">18.2. Convention-based Mapping</a>
<ul class="sectlevel3">
<li><a href="index.html#mapping.conventions.id-field">18.2.1. How the <code>_id</code> field is handled in the mapping layer.</a></li>
</ul>
</li>
<li><a href="index.html#mapping-conversion">18.3. Data Mapping and Type Conversion</a></li>
<li><a href="index.html#mapping-configuration">18.4. Mapping Configuration</a></li>
<li><a href="index.html#mapping-usage">18.5. Metadata-based Mapping</a>
<ul class="sectlevel3">
<li><a href="index.html#mapping.index-creation">18.5.1. Index Creation</a></li>
<li><a href="index.html#mapping-usage-annotations">18.5.2. Mapping Annotation Overview</a></li>
<li><a href="index.html#mapping-custom-object-construction">18.5.3. Customized Object Construction</a></li>
<li><a href="index.html#mapping-usage-indexes.compound-index">18.5.4. Compound Indexes</a></li>
<li><a href="index.html#mapping-usage-indexes.hashed-index">18.5.5. Hashed Indexes</a></li>
<li><a href="index.html#mapping-usage-indexes.text-index">18.5.6. Text Indexes</a></li>
<li><a href="index.html#mapping-usage-references">18.5.7. Using DBRefs</a></li>
<li><a href="index.html#mapping-usage-events">18.5.8. Mapping Framework Events</a></li>
</ul>
</li>
<li><a href="index.html#mongo.custom-converters">18.6. Custom Conversions - Overriding Default Mapping</a>
<ul class="sectlevel3">
<li><a href="index.html#mongo.custom-converters.writer">18.6.1. Saving by Using a Registered Spring Converter</a></li>
<li><a href="index.html#mongo.custom-converters.reader">18.6.2. Reading by Using a Spring Converter</a></li>
<li><a href="index.html#mongo.custom-converters.xml">18.6.3. Registering Spring Converters with the <code>MongoConverter</code></a>
<ul class="sectlevel5">
<li><a href="index.html#customconversions.converter-disambiguation">Converter Disambiguation</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="index.html#sharding">19. Sharding</a>
<ul class="sectlevel2">
<li><a href="index.html#sharding.sharded-collections">19.1. Sharded Collections</a></li>
<li><a href="index.html#sharding.shard-key">19.2. Shard Key Handling</a></li>
</ul>
</li>
<li><a href="index.html#kotlin">20. Kotlin Support</a>
<ul class="sectlevel2">
<li><a href="index.html#kotlin.requirements">20.1. Requirements</a></li>
<li><a href="index.html#kotlin.null-safety">20.2. Null Safety</a></li>
<li><a href="index.html#kotlin.mapping">20.3. Object Mapping</a></li>
<li><a href="index.html#kotlin.extensions">20.4. Extensions</a></li>
<li><a href="index.html#kotlin.coroutines">20.5. Coroutines</a>
<ul class="sectlevel3">
<li><a href="index.html#kotlin.coroutines.dependencies">20.5.1. Dependencies</a></li>
<li><a href="index.html#kotlin.coroutines.reactive">20.5.2. How Reactive translates to Coroutines?</a></li>
<li><a href="index.html#kotlin.coroutines.repositories">20.5.3. Repositories</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="index.html#mongo.jmx">21. JMX support</a>
<ul class="sectlevel2">
<li><a href="index.html#mongodb:jmx-configuration">21.1. MongoDB JMX Configuration</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="index.html#appendix">Appendix</a>
<ul class="sectlevel1">
<li><a href="index.html#repositories.namespace-reference">Appendix A: Namespace reference</a>
<ul class="sectlevel2">
<li><a href="index.html#populator.namespace-dao-config">The <code>&lt;repositories /&gt;</code> Element</a></li>
</ul>
</li>
<li><a href="index.html#populator.namespace-reference">Appendix B: Populators namespace reference</a>
<ul class="sectlevel2">
<li><a href="index.html#namespace-dao-config">The &lt;populator /&gt; element</a></li>
</ul>
</li>
<li><a href="index.html#repository-query-keywords">Appendix C: Repository query keywords</a>
<ul class="sectlevel2">
<li><a href="index.html#">Supported query keywords</a></li>
</ul>
</li>
<li><a href="index.html#repository-query-return-types">Appendix D: Repository query return types</a>
<ul class="sectlevel2">
<li><a href="index.html#">Supported Query Return Types</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>&#169; 2008-2019 The original authors.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Copies of this document may be made for your own use and for distribution to others, provided that you do not charge any fee for such copies and further provided that each copy contains this Copyright Notice, whether distributed in print or electronically.
</td>
</tr>
</table>
</div>

</div>
</div>
<h1 id="preface" class="sect0"><a class="anchor" href="index.html#preface"></a>Preface</h1>
<div class="openblock partintro">
<div class="content">
<div class="paragraph">
<p>The Spring Data MongoDB project applies core Spring concepts to the development of solutions that use the MongoDB document style data store. We provide a &#8220;template&#8221; as a high-level abstraction for storing and querying documents. You may notice similarities to the JDBC support provided by the Spring Framework.</p>
</div>
<div class="paragraph">
<p>This document is the reference guide for Spring Data - MongoDB Support. It explains MongoDB module concepts and semantics and syntax for various store namespaces.</p>
</div>
<div class="paragraph">
<p>This section provides some basic introduction to Spring and Document databases. The rest of the document refers only to Spring Data MongoDB features and assumes the user is familiar with MongoDB and Spring concepts.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="get-started:first-steps:spring"><a class="anchor" href="index.html#get-started:first-steps:spring"></a>1. Learning Spring</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Spring Data uses Spring framework&#8217;s <a href="https://docs.spring.io/spring/docs/5.3.1/spring-framework-reference/core.html">core</a> functionality, including:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://docs.spring.io/spring/docs/5.3.1/spring-framework-reference/core.html#beans">IoC</a> container</p>
</li>
<li>
<p><a href="https://docs.spring.io/spring/docs/5.3.1/spring-framework-reference/core.html#validation">type conversion system</a></p>
</li>
<li>
<p><a href="https://docs.spring.io/spring/docs/5.3.1/spring-framework-reference/core.html#expressions">expression language</a></p>
</li>
<li>
<p><a href="https://docs.spring.io/spring/docs/5.3.1/spring-framework-reference/integration.html#jmx">JMX integration</a></p>
</li>
<li>
<p><a href="https://docs.spring.io/spring/docs/5.3.1/spring-framework-reference/data-access.html#dao-exceptions">DAO exception hierarchy</a>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>While you need not know the Spring APIs, understanding the concepts behind them is important. At a minimum, the idea behind Inversion of Control (IoC) should be familiar, and you should be familiar with whatever IoC container you choose to use.</p>
</div>
<div class="paragraph">
<p>The core functionality of the MongoDB support can be used directly, with no need to invoke the IoC services of the Spring Container. This is much like <code>JdbcTemplate</code>, which can be used "'standalone'" without any other services of the Spring container. To leverage all the features of Spring Data MongoDB, such as the repository support, you need to configure some parts of the library to use Spring.</p>
</div>
<div class="paragraph">
<p>To learn more about Spring, you can refer to the comprehensive documentation that explains the Spring Framework in detail. There are a lot of articles, blog entries, and books on the subject. See the Spring framework <a href="https://spring.io/docs">home page</a> for more information.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="get-started:first-steps:nosql"><a class="anchor" href="index.html#get-started:first-steps:nosql"></a>2. Learning NoSQL and Document databases</h2>
<div class="sectionbody">
<div class="paragraph">
<p>NoSQL stores have taken the storage world by storm. It is a vast domain with a plethora of solutions, terms, and patterns (to make things worse, even the term itself has multiple <a href="https://www.google.com/search?q=nosoql+acronym">meanings</a>). While some of the principles are common, you must be familiar with MongoDB to some degree. The best way to get acquainted is to read the documentation and follow the examples. It usually does not take more then 5-10 minutes to go through them and, especially if you are coming from an RDMBS-only background, these exercises can be an eye opener.</p>
</div>
<div class="paragraph">
<p>The starting point for learning about MongoDB is <a href="https://www.mongodb.org/">www.mongodb.org</a>. Here is a list of other useful resources:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The <a href="https://docs.mongodb.org/manual/">manual</a> introduces MongoDB and contains links to getting started guides, reference documentation, and tutorials.</p>
</li>
<li>
<p>The <a href="https://try.mongodb.org/">online shell</a> provides a convenient way to interact with a MongoDB instance in combination with the online <a href="https://docs.mongodb.org/manual/tutorial/getting-started/">tutorial.</a></p>
</li>
<li>
<p>MongoDB <a href="https://docs.mongodb.org/ecosystem/drivers/java/">Java Language Center</a>.</p>
</li>
<li>
<p>Several <a href="https://www.mongodb.org/books">books</a> you can purchase.</p>
</li>
<li>
<p>Karl Seguin&#8217;s online book: <a href="https://openmymind.net/mongodb.pdf">The Little MongoDB Book</a>.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="requirements"><a class="anchor" href="index.html#requirements"></a>3. Requirements</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The Spring Data MongoDB 3.x binaries require JDK level 8.0 and above and <a href="https://spring.io/docs">Spring Framework</a> 5.3.1 and above.</p>
</div>
<div class="paragraph">
<p>In terms of document stores, you need at least version 2.6 of <a href="https://www.mongodb.org/">MongoDB</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="get-started:help"><a class="anchor" href="index.html#get-started:help"></a>4. Additional Help Resources</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Learning a new framework is not always straightforward.
In this section, we try to provide what we think is an easy-to-follow guide for starting with the Spring Data MongoDB module.
However, if you encounter issues or you need advice, feel free to use one of the following links:</p>
</div>
<div id="get-started:help:community" class="dlist">
<dl>
<dt class="hdlist1">Community Forum </dt>
<dd>
<p>Spring Data on <a href="https://stackoverflow.com/questions/tagged/spring-data">Stack Overflow</a> is a tag for all Spring Data (not just Document) users to share information and help each other.
Note that registration is needed only for posting.</p>
</dd>
</dl>
</div>
<div id="get-started:help:professional" class="dlist">
<dl>
<dt class="hdlist1">Professional Support </dt>
<dd>
<p>Professional, from-the-source support, with guaranteed response time, is available from <a href="https://pivotal.io/">Pivotal Software, Inc.</a>, the company behind Spring Data and Spring.</p>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect1">
<h2 id="get-started:up-to-date"><a class="anchor" href="index.html#get-started:up-to-date"></a>5. Following Development</h2>
<div class="sectionbody">
<div class="paragraph">
<p>For information on the Spring Data Mongo source code repository, nightly builds, and snapshot artifacts, see the Spring Data Mongo <a href="https://projects.spring.io/spring-data-mongodb/">homepage</a>. You can help make Spring Data best serve the needs of the Spring community by interacting with developers through the Community on <a href="https://stackoverflow.com/questions/tagged/spring-data">Stack Overflow</a>. To follow developer activity, look for the mailing list information on the Spring Data Mongo <a href="https://projects.spring.io/spring-data-mongodb/">homepage</a>. If you encounter a bug or want to suggest an improvement, please create a ticket on the Spring Data issue <a href="https://jira.spring.io/browse/DATAMONGO">tracker</a>. To stay up to date with the latest news and announcements in the Spring eco system, subscribe to the Spring Community <a href="https://spring.io">Portal</a>. You can also follow the Spring <a href="https://spring.io/blog">blog</a> or the project team on Twitter (<a href="https://twitter.com/SpringData">SpringData</a>).</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="new-features"><a class="anchor" href="index.html#new-features"></a>6. New &amp; Noteworthy</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="new-features.3.1"><a class="anchor" href="index.html#new-features.3.1"></a>6.1. What&#8217;s New in Spring Data MongoDB 3.1</h3>
<div class="ulist">
<ul>
<li>
<p><a href="index.html#mongo.auditing">Reactive auditing</a> enabled through <code>@EnableReactiveMongoAuditing</code>. <code>@EnableMongoAuditing</code> no longer registers <code>ReactiveAuditingEntityCallback</code>.</p>
</li>
<li>
<p>Reactive SpEL support in <code>@Query</code> and <code>@Aggregation</code> query methods.</p>
</li>
<li>
<p>Aggregation hints via <code>AggregationOptions.builder().hint(bson).build()</code>.</p>
</li>
<li>
<p>Extension Function <code>KProperty.asPath()</code> to render property references into a property path representation.</p>
</li>
<li>
<p>Server-side JavaScript aggregation expressions <code>$function</code> and <code>$accumulator</code> via <code>ScriptOperators</code>.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="new-features.3.0"><a class="anchor" href="index.html#new-features.3.0"></a>6.2. What&#8217;s New in Spring Data MongoDB 3.0</h3>
<div class="ulist">
<ul>
<li>
<p>Upgrade to MongoDB Driver 4.0. See <a href="index.html#upgrading.2-3">Upgrading from 2.x to 3.x</a> for further details.</p>
</li>
<li>
<p><a href="index.html#mapping.index-creation">Auto-index creation</a> is now <strong>disabled</strong> by default.</p>
</li>
<li>
<p>Support for <a href="index.html#mongo-template.aggregation-update">aggregation pipelines in update operations</a>.</p>
</li>
<li>
<p>Removal of <code>_id</code> flattening for composite Id&#8217;s when using <code>MongoTemplate</code> aggregations.</p>
</li>
<li>
<p>Apply pagination when using GridFS <code>find(Query)</code>.</p>
</li>
<li>
<p><a href="index.html#sharding">Sharding key derivation</a> via <code>@Sharded</code>.</p>
</li>
<li>
<p><code>$merge</code> and <code>$addFields</code> aggregation pipeline stages.</p>
</li>
<li>
<p><code>@TextScore</code> is <code>null</code> for entities retrieved through non-fulltext queries.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="new-features.2-2-0"><a class="anchor" href="index.html#new-features.2-2-0"></a>6.3. What&#8217;s New in Spring Data MongoDB 2.2</h3>
<div class="ulist">
<ul>
<li>
<p>Compatibility with MongoDB 4.2 deprecating <code>eval</code>, <code>group</code> and <code>geoNear</code> Template API methods.</p>
</li>
<li>
<p>Extended SpEL aggregation support for MongoDB 3.4 and MongoDB 4.0 operators (see <a href="index.html#mongo.aggregation.projection.expressions">Spring Expression Support in Projection Expressions</a>).</p>
</li>
<li>
<p><a href="index.html#mongodb.reactive.repositories.queries.type-safe">Querydsl support for reactive repositories</a> via <code>ReactiveQuerydslPredicateExecutor</code>.</p>
</li>
<li>
<p><a href="index.html#reactive.gridfs">Reactive GridFS support</a>.</p>
</li>
<li>
<p><a href="index.html#mongodb.repositories.queries.aggregation">Aggregation framework</a> support via repository query methods.</p>
</li>
<li>
<p>Declarative reactive transactions using <a href="index.html#mongo.transactions.reactive-tx-manager">@Transactional</a>.</p>
</li>
<li>
<p>Template API delete by entity considers the version property in delete queries.</p>
</li>
<li>
<p>Repository deletes now throw <code>OptimisticLockingFailureException</code> when a versioned entity cannot be deleted.</p>
</li>
<li>
<p>Support <code>Range&lt;T&gt;</code> in repository between queries.</p>
</li>
<li>
<p>Changed behavior of <code>Reactive/MongoOperations#count</code> now limiting the range to count matches within by passing on <em>offset</em> &amp; <em>limit</em> to the server.</p>
</li>
<li>
<p>Support of array filters in <code>Update</code> operations.</p>
</li>
<li>
<p><a href="index.html#mongo.jsonSchema.generated">JSON Schema generation</a> from domain types.</p>
</li>
<li>
<p>SpEL support in for expressions in <code>@Indexed</code>.</p>
</li>
<li>
<p>Support for <a href="index.html#mapping-usage-indexes.hashed-index">Hashed Indexes</a>.</p>
</li>
<li>
<p>Annotation-based Collation support through <code>@Document</code> and <code>@Query</code>.</p>
</li>
<li>
<p><a href="index.html#mongo.query.kotlin-support">Type-safe Queries for Kotlin</a>.</p>
</li>
<li>
<p>Kotlin extension methods accepting <code>KClass</code> are deprecated now in favor of <code>reified</code> methods.</p>
</li>
<li>
<p>Kotlin <a href="index.html#kotlin.coroutines">Coroutines</a> support.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="new-features.2-1-0"><a class="anchor" href="index.html#new-features.2-1-0"></a>6.4. What&#8217;s New in Spring Data MongoDB 2.1</h3>
<div class="ulist">
<ul>
<li>
<p>Cursor-based aggregation.</p>
</li>
<li>
<p><a href="index.html#mongo-template.query.distinct">Distinct queries</a> for imperative and reactive Template APIs.</p>
</li>
<li>
<p>Support for Map/Reduce through the reactive Template API.</p>
</li>
<li>
<p><a href="index.html#mongo.mongo-3.validation"><code>validator</code> support for collections</a>.</p>
</li>
<li>
<p><a href="index.html#mongo.jsonSchema"><code>$jsonSchema</code> support</a> for queries and collection creation.</p>
</li>
<li>
<p><a href="index.html#change-streams">Change Stream support</a> for imperative and reactive drivers.</p>
</li>
<li>
<p><a href="index.html#tailable-cursors.sync">Tailable cursors</a> for imperative driver.</p>
</li>
<li>
<p><a href="index.html#mongo.sessions">MongoDB 3.6 Session</a> support for the imperative and reactive Template APIs.</p>
</li>
<li>
<p><a href="index.html#mongo.transactions">MongoDB 4.0 Transaction</a> support and a MongoDB-specific transaction manager implementation.</p>
</li>
<li>
<p><a href="index.html#mongodb.repositories.queries.sort">Default sort specifications for repository query methods</a> using <code>@Query(sort=…)</code>.</p>
</li>
<li>
<p><a href="index.html#mongo-template.find-and-replace">findAndReplace</a> support through imperative and reactive Template APIs.</p>
</li>
<li>
<p>Deprecation of <code>dropDups</code> in <code>@Indexed</code> and <code>@CompoundIndex</code> as MongoDB server 3.0 and newer do not support <code>dropDups</code> anymore.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="new-features.2-0-0"><a class="anchor" href="index.html#new-features.2-0-0"></a>6.5. What&#8217;s New in Spring Data MongoDB 2.0</h3>
<div class="ulist">
<ul>
<li>
<p>Upgrade to Java 8.</p>
</li>
<li>
<p>Usage of the <code>Document</code> API, instead of <code>DBObject</code>.</p>
</li>
<li>
<p><a href="index.html#mongo.reactive">Reactive MongoDB support</a>.</p>
</li>
<li>
<p><a href="index.html#mongo.reactive.repositories.infinite-streams">Tailable Cursor</a> queries.</p>
</li>
<li>
<p>Support for aggregation result streaming by using Java 8 <code>Stream</code>.</p>
</li>
<li>
<p><a href="index.html#mongo.query.fluent-template-api">Fluent Collection API</a> for CRUD and aggregation operations.</p>
</li>
<li>
<p>Kotlin extensions for Template and Collection APIs.</p>
</li>
<li>
<p>Integration of collations for collection and index creation and query operations.</p>
</li>
<li>
<p>Query-by-Example support without type matching.</p>
</li>
<li>
<p>Support for isolation <code>Update</code> operations.</p>
</li>
<li>
<p>Tooling support for null-safety by using Spring&#8217;s <code>@NonNullApi</code> and <code>@Nullable</code> annotations.</p>
</li>
<li>
<p>Deprecated cross-store support and removed Log4j appender.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="new-features.1-10-0"><a class="anchor" href="index.html#new-features.1-10-0"></a>6.6. What&#8217;s New in Spring Data MongoDB 1.10</h3>
<div class="ulist">
<ul>
<li>
<p>Compatible with MongoDB Server 3.4 and the MongoDB Java Driver 3.4.</p>
</li>
<li>
<p>New annotations for <code>@CountQuery</code>, <code>@DeleteQuery</code>, and <code>@ExistsQuery</code>.</p>
</li>
<li>
<p>Extended support for MongoDB 3.2 and MongoDB 3.4 aggregation operators (see <a href="index.html#mongo.aggregation.supported-aggregation-operations">Supported Aggregation Operations</a>).</p>
</li>
<li>
<p>Support for partial filter expression when creating indexes.</p>
</li>
<li>
<p>Publishing lifecycle events when loading or converting <code>DBRef</code> instances.</p>
</li>
<li>
<p>Added any-match mode for Query By Example.</p>
</li>
<li>
<p>Support for <code>$caseSensitive</code> and <code>$diacriticSensitive</code> text search.</p>
</li>
<li>
<p>Support for GeoJSON Polygon with hole.</p>
</li>
<li>
<p>Performance improvements by bulk-fetching <code>DBRef</code> instances.</p>
</li>
<li>
<p>Multi-faceted aggregations using <code>$facet</code>, <code>$bucket</code>, and <code>$bucketAuto</code> with <code>Aggregation</code>.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="new-features.1-9-0"><a class="anchor" href="index.html#new-features.1-9-0"></a>6.7. What&#8217;s New in Spring Data MongoDB 1.9</h3>
<div class="ulist">
<ul>
<li>
<p>The following annotations have been enabled to build your own composed annotations: <code>@Document</code>, <code>@Id</code>, <code>@Field</code>, <code>@Indexed</code>, <code>@CompoundIndex</code>, <code>@GeoSpatialIndexed</code>, <code>@TextIndexed</code>, <code>@Query</code>, and <code>@Meta</code>.</p>
</li>
<li>
<p>Support for <a href="index.html#projections">Projections</a> in repository query methods.</p>
</li>
<li>
<p>Support for <a href="index.html#query-by-example">Query by Example</a>.</p>
</li>
<li>
<p>Out-of-the-box support for <code>java.util.Currency</code> in object mapping.</p>
</li>
<li>
<p>Support for the bulk operations introduced in MongoDB 2.6.</p>
</li>
<li>
<p>Upgrade to Querydsl 4.</p>
</li>
<li>
<p>Assert compatibility with MongoDB 3.0 and MongoDB Java Driver 3.2.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="new-features.1-8-0"><a class="anchor" href="index.html#new-features.1-8-0"></a>6.8. What&#8217;s New in Spring Data MongoDB 1.8</h3>
<div class="ulist">
<ul>
<li>
<p><code>Criteria</code> offers support for creating <code>$geoIntersects</code>.</p>
</li>
<li>
<p>Support for <a href="https://docs.spring.io/spring/docs/5.3.1/spring-framework-reference/core.html#expressions">SpEL expressions</a> in <code>@Query</code>.</p>
</li>
<li>
<p><code>MongoMappingEvents</code> expose the collection name for which they are issued.</p>
</li>
<li>
<p>Improved support for <code>&lt;mongo:mongo-client credentials="&#8230;&#8203;" /&gt;</code>.</p>
</li>
<li>
<p>Improved index creation failure error message.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="new-features.1-7-0"><a class="anchor" href="index.html#new-features.1-7-0"></a>6.9. What&#8217;s New in Spring Data MongoDB 1.7</h3>
<div class="ulist">
<ul>
<li>
<p>Assert compatibility with MongoDB 3.0 and MongoDB Java Driver 3-beta3.</p>
</li>
<li>
<p>Support JSR-310 and ThreeTen back-port date/time types.</p>
</li>
<li>
<p>Allow <code>Stream</code> as a query method return type (see: <a href="index.html#mongodb.repositories.queries">Query Methods</a>).</p>
</li>
<li>
<p><a href="https://geojson.org/">GeoJSON</a> support in both domain types and queries (see: <a href="index.html#mongo.geo-json">GeoJSON Support</a>).</p>
</li>
<li>
<p><code>QueryDslPredicateExcecutor</code> now supports <code>findAll(OrderSpecifier&lt;?&gt;… orders)</code>.</p>
</li>
<li>
<p>Support calling JavaScript functions with <a href="index.html#mongo.server-side-scripts">Script Operations</a>.</p>
</li>
<li>
<p>Improve support for <code>CONTAINS</code> keyword on collection-like properties.</p>
</li>
<li>
<p>Support for <code>$bit</code>, <code>$mul</code>, and <code>$position</code> operators to <code>Update</code>.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="upgrading.2-3"><a class="anchor" href="index.html#upgrading.2-3"></a>7. Upgrading from 2.x to 3.x</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Spring Data MongoDB 3.x requires the MongoDB Java Driver 4.x.<br>
The 4.0 MongoDB Java Driver does no longer support certain features that have already been deprecated in one of the last minor versions.
Some of the changes affect the initial setup configuration as well as compile/runtime features.
We summarized the most typical changes one might encounter.</p>
</div>
<div class="paragraph">
<p>Things to keep in mind when using the 4.0 driver:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>IndexOperations.resetIndexCache()</code> is no longer supported.</p>
</li>
<li>
<p>Any <code>MapReduceOptions.extraOption</code> is silently ignored.</p>
</li>
<li>
<p><code>WriteResult</code> no longer holds error information but, instead, throws an <code>Exception</code>.</p>
</li>
<li>
<p><code>MongoOperations.executeInSession(…)</code> no longer calls <code>requestStart</code> and <code>requestDone</code>.</p>
</li>
<li>
<p>Index name generation has become a driver-internal operation.
Spring Data MongoDB still uses the 2.x schema to generate names.</p>
</li>
<li>
<p>Some <code>Exception</code> messages differ between the generation 2 and 3 servers as well as between the MMap.v1 and WiredTiger storage engines.</p>
</li>
</ul>
</div>
<div class="sect2">
<h3>7.1. Dependency Changes</h3>
<div class="paragraph">
<p>Instead of the single artifact uber-jar <code>mongo-java-driver</code>, imports are now split to include separate artifacts:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>org.mongodb:mongodb-driver-core</code> (required)</p>
</li>
<li>
<p><code>org.mongodb:mongodb-driver-sync</code> (optional)</p>
</li>
<li>
<p><code>org.mongodb:mongodb-driver-reactivestreams</code> (optional)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Depending on the application one of the <code>mongodb-driver-sync</code>, <code>mongodb-driver-reactivestreams</code> artifacts is is required next to the mandatory <code>mongodb-driver-core</code>.
It is possible to combine the sync and reactive drivers in one application if needed.</p>
</div>
</div>
<div class="sect2">
<h3>7.2. Java Configuration</h3>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. Java API changes</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Comment</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>MongoClientFactoryBean</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Creates <code>com.mongodb.client.MongoClient</code> instead of <code>com.mongodb.MongoClient</code><br>
Uses <code>MongoClientSettings</code> instead of <code>MongoClientOptions</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>MongoDataIntegrityViolationException</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Uses <code>WriteConcernResult</code> instead of <code>WriteResult</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>BulkOperationException</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Uses <code>MongoBulkWriteException</code> and <code>com.mongodb.bulk.BulkWriteError</code> instead of <code>BulkWriteException</code> and <code>com.mongodb.BulkWriteError</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ReactiveMongoClientFactoryBean</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Uses <code>com.mongodb.MongoClientSettings</code> instead of <code>com.mongodb.async.client.MongoClientSettings</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ReactiveMongoClientSettingsFactoryBean</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Now produces <code>com.mongodb.MongoClientSettings</code> instead of <code>com.mongodb.async.client.MongoClientSettings</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>AbstractMongoClientConfiguration</code>, <code>AbstractReactiveMongoConfiguration</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Configuration methods use parameter injection instead of calling local methods to avoid the need for cglib proxies</p></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 2. Removed Java API:</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">2.x</th>
<th class="tableblock halign-left valign-top">Replacement in 3.x</th>
<th class="tableblock halign-left valign-top">Comment</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>MongoClientOptionsFactoryBean</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>MongoClientSettingsFactoryBean</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Creating a <code>com.mongodb.MongoClientSettings</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>AbstractMongoConfiguration</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>AbstractMongoClientConfiguration</code><br>
(Available since 2.1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Using <code>com.mongodb.client.MongoClient</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>MongoDbFactory#getLegacyDb()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>SimpleMongoDbFactory</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>SimpleMongoClientDbFactory</code><br>
(Available since 2.1)</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>MapReduceOptions#getOutputType()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>MapReduceOptions#getMapReduceAction()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Returns <code>MapReduceAction</code> instead of <code>MapReduceCommand.OutputType</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Meta|Query</code> maxScan &amp; snapshot</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3>7.3. XML Namespace</h3>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 3. Changed XML Namespace Elements and Attributes:</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Element / Attribute</th>
<th class="tableblock halign-left valign-top">2.x</th>
<th class="tableblock halign-left valign-top">3.x</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;mongo:mongo-client /&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Used to create a <code>com.mongodb.MongoClient</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Now exposes a <code>com.mongodb.client.MongoClient</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;mongo:mongo-client replica-set="&#8230;&#8203;" /&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Was a comma delimited list of replica set members (host/port)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Now defines the replica set name.<br>
Use <code>&lt;mongo:client-settings cluster-hosts="&#8230;&#8203;" /&gt;</code> instead</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;mongo:db-factory writeConcern="&#8230;&#8203;" /&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">NONE, NORMAL, SAFE, FSYNC_SAFE, REPLICAS_SAFE, MAJORITY</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">W1, W2, W3, UNAKNOWLEDGED, AKNOWLEDGED, JOURNALED, MAJORITY</p></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 4. Removed XML Namespace Elements and Attributes:</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Element / Attribute</th>
<th class="tableblock halign-left valign-top">Replacement in 3.x</th>
<th class="tableblock halign-left valign-top">Comment</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;mongo:db-factory mongo-ref="&#8230;&#8203;" /&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;mongo:db-factory mongo-client-ref="&#8230;&#8203;" /&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Referencing a <code>com.mongodb.client.MongoClient</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;mongo:mongo-client credentials="&#8230;&#8203;" /&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;mongo:mongo-client credential="&#8230;&#8203;" /&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Single authentication data instead of list.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;mongo:client-options /&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;mongo:client-settings /&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">See <code>com.mongodb.MongoClientSettings</code> for details.</p></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 5. New XML Namespace Elements and Attributes:</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Element</th>
<th class="tableblock halign-left valign-top">Comment</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;mongo:db-factory mongo-client-ref="&#8230;&#8203;" /&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Replacement for <code>&lt;mongo:db-factory mongo-ref="&#8230;&#8203;" /&gt;</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;mongo:db-factory connection-string="&#8230;&#8203;" /&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Replacement for <code>uri</code> and <code>client-uri</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;mongo:mongo-client connection-string="&#8230;&#8203;" /&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Replacement for <code>uri</code> and <code>client-uri</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;mongo:client-settings /&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Namespace element for <code>com.mongodb.MongoClientSettings</code>.</p></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 6. Deprecations:</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">2.x</th>
<th class="tableblock halign-left valign-top">Replacement in 3.x</th>
<th class="tableblock halign-left valign-top">Comment</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>MongoDbFactorySupport</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>MongoDatabaseFactorySupport</code></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>SimpleMongoClientDbFactory</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>SimpleMongoClientDatabaseFactory</code></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>MongoDbFactory</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>MongoDatabaseFactory</code></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3>7.4. Other Changes</h3>
<div class="sect3">
<h4>7.4.1. Auto Index Creation</h4>
<div class="paragraph">
<p>Annotation based index creation is now turned <strong>OFF</strong> by default and needs to be enabled eg. when relying on <code>@GeoSpatialIndexed</code>.
Please refer to <a href="index.html#mapping.index-creation">Index Creation</a> on how to create indexes programmatically.</p>
</div>
<div class="exampleblock">
<div class="title">Example 1. Enable Auto Index Creation</div>
<div class="content">
<div class="listingblock">
<div class="title">XML Namespace</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;mongo:mapping-converter auto-index-creation="true" /&gt;    <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Java Config</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Configuration
public class Config extends AbstractMongoClientConfiguration {

	@Override
    protected boolean autoIndexCreation() {               <i class="conum" data-value="2"></i><b>(2)</b>
        return true;
    }

    // ...
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Programmatic</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">MongoDatabaseFactory dbFactory = new SimpleMongoClientDatabaseFactory(...);
DefaultDbRefResolver dbRefResolver = new DefaultDbRefResolver(dbFactory);

MongoMappingContext mappingContext = new MongoMappingContext();
mappingContext.setAutoIndexCreation(true);                <i class="conum" data-value="3"></i><b>(3)</b>
// ...
mappingContext.afterPropertiesSet();

MongoTemplate template = new MongoTemplate(dbFactory, new MappingMongoConverter(dbRefResolver, mappingContext));</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Use the XML namespace attribute <code>auto-index-creation</code> on <code>mapping-converter</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Override <code>autoIndexCreation</code> via <code>AbstractMongoClientConfiguration</code> or <code>AbstractReactiveMongoClientConfiguration</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Set the flag on <code>MongoMappingContext</code>.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4>7.4.2. UUID Types</h4>
<div class="paragraph">
<p>The MongoDB UUID representation can now be configured with different formats.
This has to be done via <code>MongoClientSettings</code> as shown in the snippet below.</p>
</div>
<div class="exampleblock">
<div class="title">Example 2. UUid Codec Configuration</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Configuration
public class Config extends AbstractMongoClientConfiguration {

    @Override
    public void configureClientSettings(MongoClientSettings.Builder builder) {
        builder.uuidRepresentation(UuidRepresentation.STANDARD);
    }

    // ...
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4>7.4.3. Deferred MongoDatabase lookup in <code>ReactiveMongoDatabaseFactory</code></h4>
<div class="paragraph">
<p><code>ReactiveMongoDatabaseFactory</code> now returns <code>Mono&lt;MongoDatabase&gt;</code> instead of <code>MongoDatabase</code> to allow access to the Reactor Subscriber context to enable context-specific routing functionality.</p>
</div>
<div class="paragraph">
<p>This change affects <code>ReactiveMongoTemplate.getMongoDatabase()</code> and <code>ReactiveMongoTemplate.getCollection()</code> so both methods must follow deferred retrieval.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="dependencies"><a class="anchor" href="index.html#dependencies"></a>8. Dependencies</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Due to the different inception dates of individual Spring Data modules, most of them carry different major and minor version numbers. The easiest way to find compatible ones is to rely on the Spring Data Release Train BOM that we ship with the compatible versions defined. In a Maven project, you would declare this dependency in the <code>&lt;dependencyManagement /&gt;</code> section of your POM as follows:</p>
</div>
<div class="exampleblock">
<div class="title">Example 3. Using the Spring Data release train BOM</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;dependencyManagement&gt;
  &lt;dependencies&gt;
    &lt;dependency&gt;
      &lt;groupId&gt;org.springframework.data&lt;/groupId&gt;
      &lt;artifactId&gt;spring-data-bom&lt;/artifactId&gt;
      &lt;version&gt;2020.0.1&lt;/version&gt;
      &lt;scope&gt;import&lt;/scope&gt;
      &lt;type&gt;pom&lt;/type&gt;
    &lt;/dependency&gt;
  &lt;/dependencies&gt;
&lt;/dependencyManagement&gt;</code></pre>
</div>
</div>
</div>
</div>
<div id="dependencies.train-version" class="paragraph">
<p>The current release train version is <code>2020.0.1</code>. The train version uses <a href="https://calver.org/">calver</a> with the pattern <code>YYYY.MINOR.MICRO</code>.
The version name follows <code>${calver}</code> for GA releases and service releases and the following pattern for all other versions: <code>${calver}-${modifier}</code>, where <code>modifier</code> can be one of the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>SNAPSHOT</code>: Current snapshots</p>
</li>
<li>
<p><code>M1</code>, <code>M2</code>, and so on: Milestones</p>
</li>
<li>
<p><code>RC1</code>, <code>RC2</code>, and so on: Release candidates</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You can find a working example of using the BOMs in our <a href="https://github.com/spring-projects/spring-data-examples/tree/master/bom">Spring Data examples repository</a>. With that in place, you can declare the Spring Data modules you would like to use without a version in the <code>&lt;dependencies /&gt;</code> block, as follows:</p>
</div>
<div class="exampleblock">
<div class="title">Example 4. Declaring a dependency to a Spring Data module</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;dependencies&gt;
  &lt;dependency&gt;
    &lt;groupId&gt;org.springframework.data&lt;/groupId&gt;
    &lt;artifactId&gt;spring-data-jpa&lt;/artifactId&gt;
  &lt;/dependency&gt;
&lt;dependencies&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="dependencies.spring-boot"><a class="anchor" href="index.html#dependencies.spring-boot"></a>8.1. Dependency Management with Spring Boot</h3>
<div class="paragraph">
<p>Spring Boot selects a recent version of Spring Data modules for you. If you still want to upgrade to a newer version, set
the <code>spring-data-releasetrain.version</code> property to the <a href="index.html#dependencies.train-version">train version and iteration</a> you would like to use.</p>
</div>
</div>
<div class="sect2">
<h3 id="dependencies.spring-framework"><a class="anchor" href="index.html#dependencies.spring-framework"></a>8.2. Spring Framework</h3>
<div class="paragraph">
<p>The current version of Spring Data modules require Spring Framework 5.3.1 or better. The modules might also work with an older bugfix version of that minor version. However, using the most recent version within that generation is highly recommended.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="repositories"><a class="anchor" href="index.html#repositories"></a>9. Working with Spring Data Repositories</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The goal of the Spring Data repository abstraction is to significantly reduce the amount of boilerplate code required to implement data access layers for various persistence stores.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p><em>Spring Data repository documentation and your module</em></p>
</div>
<div class="paragraph">
<p>This chapter explains the core concepts and interfaces of Spring Data repositories. The information in this chapter is pulled from the Spring Data Commons module. It uses the configuration and code samples for the Java Persistence API (JPA) module. You should adapt the XML namespace declaration and the types to be extended to the equivalents of the particular module that you use. &#8220;<a href="index.html#repositories.namespace-reference">Namespace reference</a>&#8221; covers XML configuration, which is supported across all Spring Data modules that support the repository API. &#8220;<a href="index.html#repository-query-keywords">Repository query keywords</a>&#8221; covers the query method keywords supported by the repository abstraction in general. For detailed information on the specific features of your module, see the chapter on that module of this document.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="repositories.core-concepts"><a class="anchor" href="index.html#repositories.core-concepts"></a>9.1. Core concepts</h3>
<div class="paragraph">
<p>The central interface in the Spring Data repository abstraction is <code>Repository</code>. It takes the domain class to manage as well as the ID type of the domain class as type arguments. This interface acts primarily as a marker interface to capture the types to work with and to help you to discover interfaces that extend this one. The <a href="../../../../../commons/docs/current/api/org/springframework/data/repository/CrudRepository.html"><code>CrudRepository</code></a> interface provides sophisticated CRUD functionality for the entity class that is being managed.</p>
</div>
<div id="repositories.repository" class="exampleblock">
<div class="title">Example 5. <code>CrudRepository</code> Interface</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">public interface CrudRepository&lt;T, ID&gt; extends Repository&lt;T, ID&gt; {

  &lt;S extends T&gt; S save(S entity);      <i class="conum" data-value="1"></i><b>(1)</b>

  Optional&lt;T&gt; findById(ID primaryKey); <i class="conum" data-value="2"></i><b>(2)</b>

  Iterable&lt;T&gt; findAll();               <i class="conum" data-value="3"></i><b>(3)</b>

  long count();                        <i class="conum" data-value="4"></i><b>(4)</b>

  void delete(T entity);               <i class="conum" data-value="5"></i><b>(5)</b>

  boolean existsById(ID primaryKey);   <i class="conum" data-value="6"></i><b>(6)</b>

  // … more functionality omitted.
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Saves the given entity.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Returns the entity identified by the given ID.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Returns all entities.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Returns the number of entities.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Deletes the given entity.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Indicates whether an entity with the given ID exists.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
We also provide persistence technology-specific abstractions, such as <code>JpaRepository</code> or <code>MongoRepository</code>. Those interfaces extend <code>CrudRepository</code> and expose the capabilities of the underlying persistence technology in addition to the rather generic persistence technology-agnostic interfaces such as <code>CrudRepository</code>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>On top of the <code>CrudRepository</code>, there is a <a href="../../../../../commons/docs/current/api/org/springframework/data/repository/PagingAndSortingRepository.html"><code>PagingAndSortingRepository</code></a> abstraction that adds additional methods to ease paginated access to entities:</p>
</div>
<div class="exampleblock">
<div class="title">Example 6. <code>PagingAndSortingRepository</code> interface</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">public interface PagingAndSortingRepository&lt;T, ID&gt; extends CrudRepository&lt;T, ID&gt; {

  Iterable&lt;T&gt; findAll(Sort sort);

  Page&lt;T&gt; findAll(Pageable pageable);
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>To access the second page of <code>User</code> by a page size of 20, you could do something like the following:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">PagingAndSortingRepository&lt;User, Long&gt; repository = // … get access to a bean
Page&lt;User&gt; users = repository.findAll(PageRequest.of(1, 20));</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>In addition to query methods, query derivation for both count and delete queries is available. The following list shows the interface definition for a derived count query:</p>
</div>
<div class="exampleblock">
<div class="title">Example 7. Derived Count Query</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">interface UserRepository extends CrudRepository&lt;User, Long&gt; {

  long countByLastname(String lastname);
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The following listing shows the interface definition for a derived delete query:</p>
</div>
<div class="exampleblock">
<div class="title">Example 8. Derived Delete Query</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">interface UserRepository extends CrudRepository&lt;User, Long&gt; {

  long deleteByLastname(String lastname);

  List&lt;User&gt; removeByLastname(String lastname);
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="repositories.query-methods"><a class="anchor" href="index.html#repositories.query-methods"></a>9.2. Query Methods</h3>
<div class="paragraph">
<p>Standard CRUD functionality repositories usually have queries on the underlying datastore. With Spring Data, declaring those queries becomes a four-step process:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Declare an interface extending Repository or one of its subinterfaces and type it to the domain class and ID type that it should handle, as shown in the following example:</p>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">interface PersonRepository extends Repository&lt;Person, Long&gt; { … }</code></pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p>Declare query methods on the interface.</p>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">interface PersonRepository extends Repository&lt;Person, Long&gt; {
  List&lt;Person&gt; findByLastname(String lastname);
}</code></pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p>Set up Spring to create proxy instances for those interfaces, either with <a href="index.html#repositories.create-instances.java-config">JavaConfig</a> or with <a href="index.html#repositories.create-instances">XML configuration</a>.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>To use Java configuration, create a class similar to the following:</p>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">import org.springframework.data.jpa.repository.config.EnableJpaRepositories;

@EnableJpaRepositories
class Config { … }</code></pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p>To use XML configuration, define a bean similar to the following:</p>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;beans xmlns="http://www.springframework.org/schema/beans"
   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
   xmlns:jpa="http://www.springframework.org/schema/data/jpa"
   xsi:schemaLocation="http://www.springframework.org/schema/beans
     https://www.springframework.org/schema/beans/spring-beans.xsd
     http://www.springframework.org/schema/data/jpa
     https://www.springframework.org/schema/data/jpa/spring-jpa.xsd"&gt;

   &lt;jpa:repositories base-package="com.acme.repositories"/&gt;

&lt;/beans&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The JPA namespace is used in this example. If you use the repository abstraction for any other store, you need to change this to the appropriate namespace declaration of your store module. In other words, you should exchange <code>jpa</code> in favor of, for example, <code>mongodb</code>.</p>
</div>
<div class="paragraph">
<p>Also, note that the JavaConfig variant does not configure a package explicitly, because the package of the annotated class is used by default. To customize the package to scan, use one of the <code>basePackage…</code> attributes of the data-store-specific repository&#8217;s <code>@Enable${store}Repositories</code>-annotation.</p>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Inject the repository instance and use it, as shown in the following example:</p>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">class SomeClient {

  private final PersonRepository repository;

  SomeClient(PersonRepository repository) {
    this.repository = repository;
  }

  void doSomething() {
    List&lt;Person&gt; persons = repository.findByLastname("Matthews");
  }
}</code></pre>
</div>
</div>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>The sections that follow explain each step in detail:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="index.html#repositories.definition">Defining Repository Interfaces</a></p>
</li>
<li>
<p><a href="index.html#repositories.query-methods.details">Defining Query Methods</a></p>
</li>
<li>
<p><a href="index.html#repositories.create-instances">Creating Repository Instances</a></p>
</li>
<li>
<p><a href="index.html#repositories.custom-implementations">Custom Implementations for Spring Data Repositories</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="repositories.definition"><a class="anchor" href="index.html#repositories.definition"></a>9.3. Defining Repository Interfaces</h3>
<div class="paragraph">
<p>To define a repository interface, you first need to define a domain class-specific repository interface. The interface must extend <code>Repository</code> and be typed to the domain class and an ID type. If you want to expose CRUD methods for that domain type, extend <code>CrudRepository</code> instead of <code>Repository</code>.</p>
</div>
<div class="sect3">
<h4 id="repositories.definition-tuning"><a class="anchor" href="index.html#repositories.definition-tuning"></a>9.3.1. Fine-tuning Repository Definition</h4>
<div class="paragraph">
<p>Typically, your repository interface extends <code>Repository</code>, <code>CrudRepository</code>, or <code>PagingAndSortingRepository</code>. Alternatively, if you do not want to extend Spring Data interfaces, you can also annotate your repository interface with <code>@RepositoryDefinition</code>. Extending <code>CrudRepository</code> exposes a complete set of methods to manipulate your entities. If you prefer to be selective about the methods being exposed, copy the methods you want to expose from <code>CrudRepository</code> into your domain repository.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Doing so lets you define your own abstractions on top of the provided Spring Data Repositories functionality.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The following example shows how to selectively expose CRUD methods (<code>findById</code> and <code>save</code>, in this case):</p>
</div>
<div class="exampleblock">
<div class="title">Example 9. Selectively exposing CRUD methods</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@NoRepositoryBean
interface MyBaseRepository&lt;T, ID&gt; extends Repository&lt;T, ID&gt; {

  Optional&lt;T&gt; findById(ID id);

  &lt;S extends T&gt; S save(S entity);
}

interface UserRepository extends MyBaseRepository&lt;User, Long&gt; {
  User findByEmailAddress(EmailAddress emailAddress);
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>In the prior example, you defined a common base interface for all your domain repositories and exposed <code>findById(…)</code> as well as <code>save(…)</code>.These methods are routed into the base repository implementation of the store of your choice provided by Spring Data (for example, if you use JPA, the implementation is <code>SimpleJpaRepository</code>), because they match the method signatures in <code>CrudRepository</code>. So the <code>UserRepository</code> can now save users, find individual users by ID, and trigger a query to find <code>Users</code> by email address.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The intermediate repository interface is annotated with <code>@NoRepositoryBean</code>. Make sure you add that annotation to all repository interfaces for which Spring Data should not create instances at runtime.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="repositories.multiple-modules"><a class="anchor" href="index.html#repositories.multiple-modules"></a>9.3.2. Using Repositories with Multiple Spring Data Modules</h4>
<div class="paragraph">
<p>Using a unique Spring Data module in your application makes things simple, because all repository interfaces in the defined scope are bound to the Spring Data module. Sometimes, applications require using more than one Spring Data module. In such cases, a repository definition must distinguish between persistence technologies. When it detects multiple repository factories on the class path, Spring Data enters strict repository configuration mode. Strict configuration uses details on the repository or the domain class to decide about Spring Data module binding for a repository definition:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>If the repository definition <a href="index.html#repositories.multiple-modules.types">extends the module-specific repository</a>, it is a valid candidate for the particular Spring Data module.</p>
</li>
<li>
<p>If the domain class is <a href="index.html#repositories.multiple-modules.annotations">annotated with the module-specific type annotation</a>, it is a valid candidate for the particular Spring Data module. Spring Data modules accept either third-party annotations (such as JPA&#8217;s <code>@Entity</code>) or provide their own annotations (such as <code>@Document</code> for Spring Data MongoDB and Spring Data Elasticsearch).</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The following example shows a repository that uses module-specific interfaces (JPA in this case):</p>
</div>
<div id="repositories.multiple-modules.types" class="exampleblock">
<div class="title">Example 10. Repository definitions using module-specific interfaces</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">interface MyRepository extends JpaRepository&lt;User, Long&gt; { }

@NoRepositoryBean
interface MyBaseRepository&lt;T, ID&gt; extends JpaRepository&lt;T, ID&gt; { … }

interface UserRepository extends MyBaseRepository&lt;User, Long&gt; { … }</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>MyRepository</code> and <code>UserRepository</code> extend <code>JpaRepository</code> in their type hierarchy. They are valid candidates for the Spring Data JPA module.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>The following example shows a repository that uses generic interfaces:</p>
</div>
<div class="exampleblock">
<div class="title">Example 11. Repository definitions using generic interfaces</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">interface AmbiguousRepository extends Repository&lt;User, Long&gt; { … }

@NoRepositoryBean
interface MyBaseRepository&lt;T, ID&gt; extends CrudRepository&lt;T, ID&gt; { … }

interface AmbiguousUserRepository extends MyBaseRepository&lt;User, Long&gt; { … }</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>AmbiguousRepository</code> and <code>AmbiguousUserRepository</code> extend only <code>Repository</code> and <code>CrudRepository</code> in their type hierarchy. While this is fine when using a unique Spring Data module, multiple modules cannot distinguish to which particular Spring Data these repositories should be bound.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>The following example shows a repository that uses domain classes with annotations:</p>
</div>
<div id="repositories.multiple-modules.annotations" class="exampleblock">
<div class="title">Example 12. Repository definitions using domain classes with annotations</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">interface PersonRepository extends Repository&lt;Person, Long&gt; { … }

@Entity
class Person { … }

interface UserRepository extends Repository&lt;User, Long&gt; { … }

@Document
class User { … }</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>PersonRepository</code> references <code>Person</code>, which is annotated with the JPA <code>@Entity</code> annotation, so this repository clearly belongs to Spring Data JPA. <code>UserRepository</code> references <code>User</code>, which is annotated with Spring Data MongoDB&#8217;s <code>@Document</code> annotation.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>The following bad example shows a repository that uses domain classes with mixed annotations:</p>
</div>
<div class="exampleblock">
<div class="title">Example 13. Repository definitions using domain classes with mixed annotations</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">interface JpaPersonRepository extends Repository&lt;Person, Long&gt; { … }

interface MongoDBPersonRepository extends Repository&lt;Person, Long&gt; { … }

@Entity
@Document
class Person { … }</code></pre>
</div>
</div>
<div class="paragraph">
<p>This example shows a domain class using both JPA and Spring Data MongoDB annotations. It defines two repositories, <code>JpaPersonRepository</code> and <code>MongoDBPersonRepository</code>. One is intended for JPA and the other for MongoDB usage. Spring Data is no longer able to tell the repositories apart, which leads to undefined behavior.</p>
</div>
</div>
</div>
<div class="paragraph">
<p><a href="index.html#repositories.multiple-modules.types">Repository type details</a> and <a href="index.html#repositories.multiple-modules.annotations">distinguishing domain class annotations</a> are used for strict repository configuration to identify repository candidates for a particular Spring Data module. Using multiple persistence technology-specific annotations on the same domain type is possible and enables reuse of domain types across multiple persistence technologies. However, Spring Data can then no longer determine a unique module with which to bind the repository.</p>
</div>
<div class="paragraph">
<p>The last way to distinguish repositories is by scoping repository base packages. Base packages define the starting points for scanning for repository interface definitions, which implies having repository definitions located in the appropriate packages. By default, annotation-driven configuration uses the package of the configuration class. The <a href="index.html#repositories.create-instances.spring">base package in XML-based configuration</a> is mandatory.</p>
</div>
<div class="paragraph">
<p>The following example shows annotation-driven configuration of base packages:</p>
</div>
<div class="exampleblock">
<div class="title">Example 14. Annotation-driven configuration of base packages</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@EnableJpaRepositories(basePackages = "com.acme.repositories.jpa")
@EnableMongoRepositories(basePackages = "com.acme.repositories.mongo")
class Configuration { … }</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="repositories.query-methods.details"><a class="anchor" href="index.html#repositories.query-methods.details"></a>9.4. Defining Query Methods</h3>
<div class="paragraph">
<p>The repository proxy has two ways to derive a store-specific query from the method name:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>By deriving the query from the method name directly.</p>
</li>
<li>
<p>By using a manually defined query.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Available options depend on the actual store. However, there must be a strategy that decides what actual query is created. The next section describes the available options.</p>
</div>
<div class="sect3">
<h4 id="repositories.query-methods.query-lookup-strategies"><a class="anchor" href="index.html#repositories.query-methods.query-lookup-strategies"></a>9.4.1. Query Lookup Strategies</h4>
<div class="paragraph">
<p>The following strategies are available for the repository infrastructure to resolve the query. With XML configuration, you can configure the strategy at the namespace through the <code>query-lookup-strategy</code> attribute. For Java configuration, you can use the <code>queryLookupStrategy</code> attribute of the <code>Enable${store}Repositories</code> annotation. Some strategies may not be supported for particular datastores.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>CREATE</code> attempts to construct a store-specific query from the query method name. The general approach is to remove a given set of well known prefixes from the method name and parse the rest of the method. You can read more about query construction in &#8220;<a href="index.html#repositories.query-methods.query-creation">Query Creation</a>&#8221;.</p>
</li>
<li>
<p><code>USE_DECLARED_QUERY</code> tries to find a declared query and throws an exception if it cannot find one. The query can be defined by an annotation somewhere or declared by other means. See the documentation of the specific store to find available options for that store. If the repository infrastructure does not find a declared query for the method at bootstrap time, it fails.</p>
</li>
<li>
<p><code>CREATE_IF_NOT_FOUND</code> (the default) combines <code>CREATE</code> and <code>USE_DECLARED_QUERY</code>. It looks up a declared query first, and, if no declared query is found, it creates a custom method name-based query. This is the default lookup strategy and, thus, is used if you do not configure anything explicitly. It allows quick query definition by method names but also custom-tuning of these queries by introducing declared queries as needed.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="repositories.query-methods.query-creation"><a class="anchor" href="index.html#repositories.query-methods.query-creation"></a>9.4.2. Query Creation</h4>
<div class="paragraph">
<p>The query builder mechanism built into the Spring Data repository infrastructure is useful for building constraining queries over entities of the repository. The mechanism strips the <code>find…By</code>, <code>read…By</code>, <code>query…By</code>, <code>count…By</code>, and <code>get…By</code> prefixes from the method and starts parsing the rest of it. The introducing clause can contain further expressions, such as a <code>Distinct</code> to set a distinct flag on the query to be created. However, the first <code>By</code> acts as a delimiter to indicate the start of the actual criteria. At a very basic level, you can define conditions on entity properties and concatenate them with <code>And</code> and <code>Or</code>. The following example shows how to create a number of queries:</p>
</div>
<div class="exampleblock">
<div class="title">Example 15. Query creation from method names</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">interface PersonRepository extends Repository&lt;Person, Long&gt; {

  List&lt;Person&gt; findByEmailAddressAndLastname(EmailAddress emailAddress, String lastname);

  // Enables the distinct flag for the query
  List&lt;Person&gt; findDistinctPeopleByLastnameOrFirstname(String lastname, String firstname);
  List&lt;Person&gt; findPeopleDistinctByLastnameOrFirstname(String lastname, String firstname);

  // Enabling ignoring case for an individual property
  List&lt;Person&gt; findByLastnameIgnoreCase(String lastname);
  // Enabling ignoring case for all suitable properties
  List&lt;Person&gt; findByLastnameAndFirstnameAllIgnoreCase(String lastname, String firstname);

  // Enabling static ORDER BY for a query
  List&lt;Person&gt; findByLastnameOrderByFirstnameAsc(String lastname);
  List&lt;Person&gt; findByLastnameOrderByFirstnameDesc(String lastname);
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The actual result of parsing the method depends on the persistence store for which you create the query. However, there are some general things to notice:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The expressions are usually property traversals combined with operators that can be concatenated. You can combine property expressions with <code>AND</code> and <code>OR</code>. You also get support for operators such as <code>Between</code>, <code>LessThan</code>, <code>GreaterThan</code>, and <code>Like</code> for the property expressions. The supported operators can vary by datastore, so consult the appropriate part of your reference documentation.</p>
</li>
<li>
<p>The method parser supports setting an <code>IgnoreCase</code> flag for individual properties (for example, <code>findByLastnameIgnoreCase(…)</code>) or for all properties of a type that supports ignoring case (usually <code>String</code> instances&#8201;&#8212;&#8201;for example, <code>findByLastnameAndFirstnameAllIgnoreCase(…)</code>). Whether ignoring cases is supported may vary by store, so consult the relevant sections in the reference documentation for the store-specific query method.</p>
</li>
<li>
<p>You can apply static ordering by appending an <code>OrderBy</code> clause to the query method that references a property and by providing a sorting direction (<code>Asc</code> or <code>Desc</code>). To create a query method that supports dynamic sorting, see &#8220;<a href="index.html#repositories.special-parameters">Special parameter handling</a>&#8221;.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="repositories.query-methods.query-property-expressions"><a class="anchor" href="index.html#repositories.query-methods.query-property-expressions"></a>9.4.3. Property Expressions</h4>
<div class="paragraph">
<p>Property expressions can refer only to a direct property of the managed entity, as shown in the preceding example. At query creation time, you already make sure that the parsed property is a property of the managed domain class. However, you can also define constraints by traversing nested properties. Consider the following method signature:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">List&lt;Person&gt; findByAddressZipCode(ZipCode zipCode);</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Assume a <code>Person</code> has an <code>Address</code> with a <code>ZipCode</code>. In that case, the method creates the <code>x.address.zipCode</code> property traversal. The resolution algorithm starts by interpreting the entire part (<code>AddressZipCode</code>) as the property and checks the domain class for a property with that name (uncapitalized). If the algorithm succeeds, it uses that property. If not, the algorithm splits up the source at the camel-case parts from the right side into a head and a tail and tries to find the corresponding property&#8201;&#8212;&#8201;in our example, <code>AddressZip</code> and <code>Code</code>. If the algorithm finds a property with that head, it takes the tail and continues building the tree down from there, splitting the tail up in the way just described. If the first split does not match, the algorithm moves the split point to the left (<code>Address</code>, <code>ZipCode</code>) and continues.</p>
</div>
<div class="paragraph">
<p>Although this should work for most cases, it is possible for the algorithm to select the wrong property. Suppose the <code>Person</code> class has an <code>addressZip</code> property as well. The algorithm would match in the first split round already, choose the wrong property, and fail (as the type of <code>addressZip</code> probably has no <code>code</code> property).</p>
</div>
<div class="paragraph">
<p>To resolve this ambiguity you can use <code>_</code> inside your method name to manually define traversal points. So our method name would be as follows:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">List&lt;Person&gt; findByAddress_ZipCode(ZipCode zipCode);</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Because we treat the underscore character as a reserved character, we strongly advise following standard Java naming conventions (that is, not using underscores in property names but using camel case instead).</p>
</div>
</div>
<div class="sect3">
<h4 id="repositories.special-parameters"><a class="anchor" href="index.html#repositories.special-parameters"></a>9.4.4. Special parameter handling</h4>
<div class="paragraph">
<p>To handle parameters in your query, define method parameters as already seen in the preceding examples. Besides that, the infrastructure recognizes certain specific types like <code>Pageable</code> and <code>Sort</code>, to apply pagination and sorting to your queries dynamically. The following example demonstrates these features:</p>
</div>
<div class="exampleblock">
<div class="title">Example 16. Using <code>Pageable</code>, <code>Slice</code>, and <code>Sort</code> in query methods</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">Page&lt;User&gt; findByLastname(String lastname, Pageable pageable);

Slice&lt;User&gt; findByLastname(String lastname, Pageable pageable);

List&lt;User&gt; findByLastname(String lastname, Sort sort);

List&lt;User&gt; findByLastname(String lastname, Pageable pageable);</code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
APIs taking <code>Sort</code> and <code>Pageable</code> expect non-<code>null</code> values to be handed into methods.
If you do not want to apply any sorting or pagination, use <code>Sort.unsorted()</code> and <code>Pageable.unpaged()</code>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The first method lets you pass an <code>org.springframework.data.domain.Pageable</code> instance to the query method to dynamically add paging to your statically defined query. A <code>Page</code> knows about the total number of elements and pages available. It does so by the infrastructure triggering a count query to calculate the overall number. As this might be expensive (depending on the store used), you can instead return a <code>Slice</code>. A <code>Slice</code> knows only about whether a next <code>Slice</code> is available, which might be sufficient when walking through a larger result set.</p>
</div>
<div class="paragraph">
<p>Sorting options are handled through the <code>Pageable</code> instance, too. If you need only sorting, add an <code>org.springframework.data.domain.Sort</code> parameter to your method. As you can see, returning a <code>List</code> is also possible. In this case, the additional metadata required to build the actual <code>Page</code> instance is not created (which, in turn, means that the additional count query that would have been necessary is not issued). Rather, it restricts the query to look up only the given range of entities.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
To find out how many pages you get for an entire query, you have to trigger an additional count query. By default, this query is derived from the query you actually trigger.
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="repositories.paging-and-sorting"><a class="anchor" href="index.html#repositories.paging-and-sorting"></a>Paging and Sorting</h5>
<div class="paragraph">
<p>You can define simple sorting expressions by using property names.
You can concatenate expressions to collect multiple criteria into one expression.</p>
</div>
<div class="exampleblock">
<div class="title">Example 17. Defining sort expressions</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">Sort sort = Sort.by("firstname").ascending()
  .and(Sort.by("lastname").descending());</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>For a more type-safe way to define sort expressions, start with the type for which to define the sort expression and use method references to define the properties on which to sort.</p>
</div>
<div class="exampleblock">
<div class="title">Example 18. Defining sort expressions by using the type-safe API</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">TypedSort&lt;Person&gt; person = Sort.sort(Person.class);

Sort sort = person.by(Person::getFirstname).ascending()
  .and(person.by(Person::getLastname).descending());</code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<code>TypedSort.by(…)</code> makes use of runtime proxies by (typically) using CGlib, which may interfere with native image compilation when using tools such as Graal VM Native.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If your store implementation supports Querydsl, you can also use the generated metamodel types to define sort expressions:</p>
</div>
<div class="exampleblock">
<div class="title">Example 19. Defining sort expressions by using the Querydsl API</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">QSort sort = QSort.by(QPerson.firstname.asc())
  .and(QSort.by(QPerson.lastname.desc()));</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="repositories.limit-query-result"><a class="anchor" href="index.html#repositories.limit-query-result"></a>9.4.5. Limiting Query Results</h4>
<div class="paragraph">
<p>You can limit the results of query methods by using the <code>first</code> or <code>top</code> keywords, which you can use interchangeably. You can append an optional numeric value to <code>top</code> or <code>first</code> to specify the maximum result size to be returned.
If the number is left out, a result size of 1 is assumed. The following example shows how to limit the query size:</p>
</div>
<div class="exampleblock">
<div class="title">Example 20. Limiting the result size of a query with <code>Top</code> and <code>First</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">User findFirstByOrderByLastnameAsc();

User findTopByOrderByAgeDesc();

Page&lt;User&gt; queryFirst10ByLastname(String lastname, Pageable pageable);

Slice&lt;User&gt; findTop3ByLastname(String lastname, Pageable pageable);

List&lt;User&gt; findFirst10ByLastname(String lastname, Sort sort);

List&lt;User&gt; findTop10ByLastname(String lastname, Pageable pageable);</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The limiting expressions also support the <code>Distinct</code> keyword. Also, for the queries that limit the result set to one instance, wrapping the result into with the <code>Optional</code> keyword is supported.</p>
</div>
<div class="paragraph">
<p>If pagination or slicing is applied to a limiting query pagination (and the calculation of the number of available pages), it is applied within the limited result.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Limiting the results in combination with dynamic sorting by using a <code>Sort</code> parameter lets you express query methods for the 'K' smallest as well as for the 'K' biggest elements.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="repositories.collections-and-iterables"><a class="anchor" href="index.html#repositories.collections-and-iterables"></a>9.4.6. Repository Methods Returning Collections or Iterables</h4>
<div class="paragraph">
<p>Query methods that return multiple results can use standard Java <code>Iterable</code>, <code>List</code>, and <code>Set</code>.
Beyond that, we support returning Spring Data&#8217;s <code>Streamable</code>, a custom extension of <code>Iterable</code>, as well as collection types provided by <a href="https://www.vavr.io/">Vavr</a>.</p>
</div>
<div class="sect4">
<h5 id="repositories.collections-and-iterables.streamable"><a class="anchor" href="index.html#repositories.collections-and-iterables.streamable"></a>Using Streamable as Query Method Return Type</h5>
<div class="paragraph">
<p>You can use <code>Streamable</code> as alternative to <code>Iterable</code> or any collection type.
It provides convenience methods to access a non-parallel <code>Stream</code> (missing from <code>Iterable</code>) and the ability to directly <code>….filter(…)</code> and <code>….map(…)</code> over the elements and concatenate the <code>Streamable</code> to others:</p>
</div>
<div class="exampleblock">
<div class="title">Example 21. Using Streamable to combine query method results</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">interface PersonRepository extends Repository&lt;Person, Long&gt; {
  Streamable&lt;Person&gt; findByFirstnameContaining(String firstname);
  Streamable&lt;Person&gt; findByLastnameContaining(String lastname);
}

Streamable&lt;Person&gt; result = repository.findByFirstnameContaining("av")
  .and(repository.findByLastnameContaining("ea"));</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="repositories.collections-and-iterables.streamable-wrapper"><a class="anchor" href="index.html#repositories.collections-and-iterables.streamable-wrapper"></a>Returning Custom Streamable Wrapper Types</h5>
<div class="paragraph">
<p>Providing dedicated wrapper types for collections is a commonly used pattern to provide an API for a query result that returns multiple elements.
Usually, these types are used by invoking a repository method returning a collection-like type and creating an instance of the wrapper type manually.
You can avoid that additional step as Spring Data lets you use these wrapper types as query method return types if they meet the following criteria:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The type implements <code>Streamable</code>.</p>
</li>
<li>
<p>The type exposes either a constructor or a static factory method named <code>of(…)</code> or <code>valueOf(…)</code> that takes <code>Streamable</code> as an argument.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The following listing shows an example:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">class Product { <i class="conum" data-value="1"></i><b>(1)</b>
  MonetaryAmount getPrice() { … }
}

@RequiredArgConstructor(staticName = "of")
class Products implements Streamable&lt;Product&gt; { <i class="conum" data-value="2"></i><b>(2)</b>

  private Streamable&lt;Product&gt; streamable;

  public MonetaryAmount getTotal() { <i class="conum" data-value="3"></i><b>(3)</b>
    return streamable.stream() //
      .map(Priced::getPrice)
      .reduce(Money.of(0), MonetaryAmount::add);
  }
}

interface ProductRepository implements Repository&lt;Product, Long&gt; {
  Products findAllByDescriptionContaining(String text); <i class="conum" data-value="4"></i><b>(4)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>A <code>Product</code> entity that exposes API to access the product&#8217;s price.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>A wrapper type for a <code>Streamable&lt;Product&gt;</code> that can be constructed by using <code>Products.of(…)</code> (factory method created with the Lombok annotation).</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The wrapper type exposes an additional API, calculating new values on the <code>Streamable&lt;Product&gt;</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>That wrapper type can be used as a query method return type directly. You need not return <code>Streamable&lt;Product&gt;</code> and manually wrap it in the repository client.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="repositories.collections-and-iterables.vavr"><a class="anchor" href="index.html#repositories.collections-and-iterables.vavr"></a>Support for Vavr Collections</h5>
<div class="paragraph">
<p><a href="https://www.vavr.io/">Vavr</a> is a library that embraces functional programming concepts in Java.
It ships with a custom set of collection types that you can use as query method return types, as the following table shows:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Vavr collection type</th>
<th class="tableblock halign-left valign-top">Used Vavr implementation type</th>
<th class="tableblock halign-left valign-top">Valid Java source types</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>io.vavr.collection.Seq</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>io.vavr.collection.List</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.util.Iterable</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>io.vavr.collection.Set</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>io.vavr.collection.LinkedHashSet</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.util.Iterable</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>io.vavr.collection.Map</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>io.vavr.collection.LinkedHashMap</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.util.Map</code></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>You can use the types in the first column (or subtypes thereof) as query method return types and get the types in the second column used as implementation type, depending on the Java type of the actual query result (third column).
Alternatively, you can declare <code>Traversable</code> (the Vavr <code>Iterable</code> equivalent), and we then derive the implementation class from the actual return value. That is, a <code>java.util.List</code> is turned into a Vavr <code>List</code> or <code>Seq</code>, a <code>java.util.Set</code> becomes a Vavr <code>LinkedHashSet</code> <code>Set</code>, and so on.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="repositories.nullability"><a class="anchor" href="index.html#repositories.nullability"></a>9.4.7. Null Handling of Repository Methods</h4>
<div class="paragraph">
<p>As of Spring Data 2.0, repository CRUD methods that return an individual aggregate instance use Java 8&#8217;s <code>Optional</code> to indicate the potential absence of a value.
Besides that, Spring Data supports returning the following wrapper types on query methods:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>com.google.common.base.Optional</code></p>
</li>
<li>
<p><code>scala.Option</code></p>
</li>
<li>
<p><code>io.vavr.control.Option</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Alternatively, query methods can choose not to use a wrapper type at all.
The absence of a query result is then indicated by returning <code>null</code>.
Repository methods returning collections, collection alternatives, wrappers, and streams are guaranteed never to return <code>null</code> but rather the corresponding empty representation.
See &#8220;<a href="index.html#repository-query-return-types">Repository query return types</a>&#8221; for details.</p>
</div>
<div class="sect4">
<h5 id="repositories.nullability.annotations"><a class="anchor" href="index.html#repositories.nullability.annotations"></a>Nullability Annotations</h5>
<div class="paragraph">
<p>You can express nullability constraints for repository methods by using <a href="https://docs.spring.io/spring/docs/5.3.1/spring-framework-reference/core.html#null-safety">Spring Framework&#8217;s nullability annotations</a>.
They provide a tooling-friendly approach and opt-in <code>null</code> checks during runtime, as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="../../../../../../spring/docs/5.3.1/javadoc-api/org/springframework/lang/NonNullApi.html"><code>@NonNullApi</code></a>: Used on the package level to declare that the default behavior for parameters and return values is, respectively, neither to accept nor to produce <code>null</code> values.</p>
</li>
<li>
<p><a href="../../../../../../spring/docs/5.3.1/javadoc-api/org/springframework/lang/NonNull.html"><code>@NonNull</code></a>: Used on a parameter or return value that must not be <code>null</code> (not needed on a parameter and return value where <code>@NonNullApi</code> applies).</p>
</li>
<li>
<p><a href="../../../../../../spring/docs/5.3.1/javadoc-api/org/springframework/lang/Nullable.html"><code>@Nullable</code></a>: Used on a parameter or return value that can be <code>null</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Spring annotations are meta-annotated with <a href="https://jcp.org/en/jsr/detail?id=305">JSR 305</a> annotations (a dormant but widely used JSR). JSR 305 meta-annotations let tooling vendors (such as <a href="https://www.jetbrains.com/help/idea/nullable-and-notnull-annotations.html">IDEA</a>, <a href="https://help.eclipse.org/oxygen/index.jsp?topic=/org.eclipse.jdt.doc.user/tasks/task-using_external_null_annotations.htm">Eclipse</a>, and <a href="https://kotlinlang.org/docs/reference/java-interop.html#null-safety-and-platform-types">Kotlin</a>) provide null-safety support in a generic way, without having to hard-code support for Spring annotations.
To enable runtime checking of nullability constraints for query methods, you need to activate non-nullability on the package level by using Spring’s <code>@NonNullApi</code> in <code>package-info.java</code>, as shown in the following example:</p>
</div>
<div class="exampleblock">
<div class="title">Example 22. Declaring Non-nullability in <code>package-info.java</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@org.springframework.lang.NonNullApi
package com.acme;</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Once non-null defaulting is in place, repository query method invocations get validated at runtime for nullability constraints.
If a query result violates the defined constraint, an exception is thrown. This happens when the method would return <code>null</code> but is declared as non-nullable (the default with the annotation defined on the package in which the repository resides).
If you want to opt-in to nullable results again, selectively use <code>@Nullable</code> on individual methods.
Using the result wrapper types mentioned at the start of this section continues to work as expected: an empty result is translated into the value that represents absence.</p>
</div>
<div class="paragraph">
<p>The following example shows a number of the techniques just described:</p>
</div>
<div class="exampleblock">
<div class="title">Example 23. Using different nullability constraints</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">package com.acme;                                                       <i class="conum" data-value="1"></i><b>(1)</b>

import org.springframework.lang.Nullable;

interface UserRepository extends Repository&lt;User, Long&gt; {

  User getByEmailAddress(EmailAddress emailAddress);                    <i class="conum" data-value="2"></i><b>(2)</b>

  @Nullable
  User findByEmailAddress(@Nullable EmailAddress emailAdress);          <i class="conum" data-value="3"></i><b>(3)</b>

  Optional&lt;User&gt; findOptionalByEmailAddress(EmailAddress emailAddress); <i class="conum" data-value="4"></i><b>(4)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The repository resides in a package (or sub-package) for which we have defined non-null behavior.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Throws an <code>EmptyResultDataAccessException</code> when the query does not produce a result. Throws an <code>IllegalArgumentException</code> when the <code>emailAddress</code> handed to the method is <code>null</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Returns <code>null</code> when the query does not produce a result. Also accepts <code>null</code> as the value for <code>emailAddress</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Returns <code>Optional.empty()</code> when the query does not produce a result. Throws an <code>IllegalArgumentException</code> when the <code>emailAddress</code> handed to the method is <code>null</code>.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="repositories.nullability.kotlin"><a class="anchor" href="index.html#repositories.nullability.kotlin"></a>Nullability in Kotlin-based Repositories</h5>
<div class="paragraph">
<p>Kotlin has the definition of <a href="https://kotlinlang.org/docs/reference/null-safety.html">nullability constraints</a> baked into the language.
Kotlin code compiles to bytecode, which does not express nullability constraints through method signatures but rather through compiled-in metadata. Make sure to include the <code>kotlin-reflect</code> JAR in your project to enable introspection of Kotlin&#8217;s nullability constraints.
Spring Data repositories use the language mechanism to define those constraints to apply the same runtime checks, as follows:</p>
</div>
<div class="exampleblock">
<div class="title">Example 24. Using nullability constraints on Kotlin repositories</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="kotlin" class="language-kotlin hljs">interface UserRepository : Repository&lt;User, String&gt; {

  fun findByUsername(username: String): User     <i class="conum" data-value="1"></i><b>(1)</b>

  fun findByFirstname(firstname: String?): User? <i class="conum" data-value="2"></i><b>(2)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The method defines both the parameter and the result as non-nullable (the Kotlin default). The Kotlin compiler rejects method invocations that pass <code>null</code> to the method. If the query yields an empty result, an <code>EmptyResultDataAccessException</code> is thrown.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>This method accepts <code>null</code> for the <code>firstname</code> parameter and returns <code>null</code> if the query does not produce a result.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="repositories.query-streaming"><a class="anchor" href="index.html#repositories.query-streaming"></a>9.4.8. Streaming Query Results</h4>
<div class="paragraph">
<p>You can process the results of query methods incrementally by using a Java 8 <code>Stream&lt;T&gt;</code> as the return type. Instead of wrapping the query results in a <code>Stream</code>, data store-specific methods are used to perform the streaming, as shown in the following example:</p>
</div>
<div class="exampleblock">
<div class="title">Example 25. Stream the result of a query with Java 8 <code>Stream&lt;T&gt;</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Query("select u from User u")
Stream&lt;User&gt; findAllByCustomQueryAndStream();

Stream&lt;User&gt; readAllByFirstnameNotNull();

@Query("select u from User u")
Stream&lt;User&gt; streamAllPaged(Pageable pageable);</code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
A <code>Stream</code> potentially wraps underlying data store-specific resources and must, therefore, be closed after usage. You can either manually close the <code>Stream</code> by using the <code>close()</code> method or by using a Java 7 <code>try-with-resources</code> block, as shown in the following example:
</td>
</tr>
</table>
</div>
<div class="exampleblock">
<div class="title">Example 26. Working with a <code>Stream&lt;T&gt;</code> result in a <code>try-with-resources</code> block</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">try (Stream&lt;User&gt; stream = repository.findAllByCustomQueryAndStream()) {
  stream.forEach(…);
}</code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Not all Spring Data modules currently support <code>Stream&lt;T&gt;</code> as a return type.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="repositories.query-async"><a class="anchor" href="index.html#repositories.query-async"></a>9.4.9. Asynchronous Query Results</h4>
<div class="paragraph">
<p>You can run repository queries asynchronously by using <a href="https://docs.spring.io/spring/docs/5.3.1/spring-framework-reference/integration.html#scheduling">Spring&#8217;s asynchronous method running capability</a>. This means the method returns immediately upon invocation while the actual query occurs in a task that has been submitted to a Spring <code>TaskExecutor</code>. Asynchronous queries differ from reactive queries and should not be mixed. See the store-specific documentation for more details on reactive support. The following example shows a number of asynchronous queries:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Async
Future&lt;User&gt; findByFirstname(String firstname);               <i class="conum" data-value="1"></i><b>(1)</b>

@Async
CompletableFuture&lt;User&gt; findOneByFirstname(String firstname); <i class="conum" data-value="2"></i><b>(2)</b>

@Async
ListenableFuture&lt;User&gt; findOneByLastname(String lastname);    <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Use <code>java.util.concurrent.Future</code> as the return type.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Use a Java 8 <code>java.util.concurrent.CompletableFuture</code> as the return type.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Use a <code>org.springframework.util.concurrent.ListenableFuture</code> as the return type.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="repositories.create-instances"><a class="anchor" href="index.html#repositories.create-instances"></a>9.5. Creating Repository Instances</h3>
<div class="paragraph">
<p>This section covers how to create instances and bean definitions for the defined repository interfaces. One way to do so is by using the Spring namespace that is shipped with each Spring Data module that supports the repository mechanism, although we generally recommend using Java configuration.</p>
</div>
<div class="sect3">
<h4 id="repositories.create-instances.spring"><a class="anchor" href="index.html#repositories.create-instances.spring"></a>9.5.1. XML Configuration</h4>
<div class="paragraph">
<p>Each Spring Data module includes a <code>repositories</code> element that lets you define a base package that Spring scans for you, as shown in the following example:</p>
</div>
<div class="exampleblock">
<div class="title">Example 27. Enabling Spring Data repositories via XML</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;beans:beans xmlns:beans="http://www.springframework.org/schema/beans"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xmlns="http://www.springframework.org/schema/data/jpa"
  xsi:schemaLocation="http://www.springframework.org/schema/beans
    https://www.springframework.org/schema/beans/spring-beans.xsd
    http://www.springframework.org/schema/data/jpa
    https://www.springframework.org/schema/data/jpa/spring-jpa.xsd"&gt;

  &lt;repositories base-package="com.acme.repositories" /&gt;

&lt;/beans:beans&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>In the preceding example, Spring is instructed to scan <code>com.acme.repositories</code> and all its sub-packages for interfaces extending <code>Repository</code> or one of its sub-interfaces.
For each interface found, the infrastructure registers the persistence technology-specific <code>FactoryBean</code> to create the appropriate proxies that handle invocations of the query methods.
Each bean is registered under a bean name that is derived from the interface name, so an interface of <code>UserRepository</code> would be registered under <code>userRepository</code>.
Bean names for nested repository interfaces are prefixed with their enclosing type name.
The <code>base-package</code> attribute allows wildcards so that you can define a pattern of scanned packages.</p>
</div>
<div class="sect4">
<h5 id="repositories.using-filters"><a class="anchor" href="index.html#repositories.using-filters"></a>Using Filters</h5>
<div class="paragraph">
<p>By default, the infrastructure picks up every interface that extends the persistence technology-specific <code>Repository</code> sub-interface located under the configured base package and creates a bean instance for it. However, you might want more fine-grained control over which interfaces have bean instances created for them. To do so, use <code>&lt;include-filter /&gt;</code> and <code>&lt;exclude-filter /&gt;</code> elements inside the <code>&lt;repositories /&gt;</code> element. The semantics are exactly equivalent to the elements in Spring&#8217;s context namespace. For details, see the <a href="https://docs.spring.io/spring/docs/5.3.1/spring-framework-reference/core.html#beans-scanning-filters">Spring reference documentation</a> for these elements.</p>
</div>
<div class="paragraph">
<p>For example, to exclude certain interfaces from instantiation as repository beans, you could use the following configuration:</p>
</div>
<div class="exampleblock">
<div class="title">Example 28. Using exclude-filter element</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;repositories base-package="com.acme.repositories"&gt;
  &lt;context:exclude-filter type="regex" expression=".*SomeRepository" /&gt;
&lt;/repositories&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The preceding example excludes all interfaces ending in <code>SomeRepository</code> from being instantiated.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="repositories.create-instances.java-config"><a class="anchor" href="index.html#repositories.create-instances.java-config"></a>9.5.2. Java Configuration</h4>
<div class="paragraph">
<p>You can also trigger the repository infrastructure by using a store-specific <code>@Enable${store}Repositories</code> annotation on a Java configuration class. For an introduction to Java-based configuration of the Spring container, see <a href="https://docs.spring.io/spring/docs/5.3.1/spring-framework-reference/core.html#beans-java">JavaConfig in the Spring reference documentation</a>.</p>
</div>
<div class="paragraph">
<p>A sample configuration to enable Spring Data repositories resembles the following:</p>
</div>
<div class="exampleblock">
<div class="title">Example 29. Sample annotation-based repository configuration</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Configuration
@EnableJpaRepositories("com.acme.repositories")
class ApplicationConfiguration {

  @Bean
  EntityManagerFactory entityManagerFactory() {
    // …
  }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The preceding example uses the JPA-specific annotation, which you would change according to the store module you actually use. The same applies to the definition of the <code>EntityManagerFactory</code> bean. See the sections covering the store-specific configuration.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="repositories.create-instances.standalone"><a class="anchor" href="index.html#repositories.create-instances.standalone"></a>9.5.3. Standalone Usage</h4>
<div class="paragraph">
<p>You can also use the repository infrastructure outside of a Spring container&#8201;&#8212;&#8201;for example, in CDI environments. You still need some Spring libraries in your classpath, but, generally, you can set up repositories programmatically as well. The Spring Data modules that provide repository support ship with a persistence technology-specific <code>RepositoryFactory</code> that you can use, as follows:</p>
</div>
<div class="exampleblock">
<div class="title">Example 30. Standalone usage of the repository factory</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">RepositoryFactorySupport factory = … // Instantiate factory here
UserRepository repository = factory.getRepository(UserRepository.class);</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="repositories.custom-implementations"><a class="anchor" href="index.html#repositories.custom-implementations"></a>9.6. Custom Implementations for Spring Data Repositories</h3>
<div class="paragraph">
<p>This section covers repository customization and how fragments form a composite repository.</p>
</div>
<div class="paragraph">
<p>When a query method requires a different behavior or cannot be implemented by query derivation, you need to provide a custom implementation. Spring Data repositories let you provide custom repository code and integrate it with generic CRUD abstraction and query method functionality.</p>
</div>
<div class="sect3">
<h4 id="repositories.single-repository-behavior"><a class="anchor" href="index.html#repositories.single-repository-behavior"></a>9.6.1. Customizing Individual Repositories</h4>
<div class="paragraph">
<p>To enrich a repository with custom functionality, you must first define a fragment interface and an implementation for the custom functionality, as follows:</p>
</div>
<div class="exampleblock">
<div class="title">Example 31. Interface for custom repository functionality</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">interface CustomizedUserRepository {
  void someCustomMethod(User user);
}</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 32. Implementation of custom repository functionality</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">class CustomizedUserRepositoryImpl implements CustomizedUserRepository {

  public void someCustomMethod(User user) {
    // Your custom implementation
  }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The most important part of the class name that corresponds to the fragment interface is the <code>Impl</code> postfix.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The implementation itself does not depend on Spring Data and can be a regular Spring bean. Consequently, you can use standard dependency injection behavior to inject references to other beans (such as a <code>JdbcTemplate</code>), take part in aspects, and so on.</p>
</div>
<div class="paragraph">
<p>Then you can let your repository interface extend the fragment interface, as follows:</p>
</div>
<div class="exampleblock">
<div class="title">Example 33. Changes to your repository interface</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">interface UserRepository extends CrudRepository&lt;User, Long&gt;, CustomizedUserRepository {

  // Declare query methods here
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Extending the fragment interface with your repository interface combines the CRUD and custom functionality and makes it available to clients.</p>
</div>
<div class="paragraph">
<p>Spring Data repositories are implemented by using fragments that form a repository composition. Fragments are the base repository, functional aspects (such as <a href="index.html#core.extensions.querydsl">QueryDsl</a>), and custom interfaces along with their implementations. Each time you add an interface to your repository interface, you enhance the composition by adding a fragment. The base repository and repository aspect implementations are provided by each Spring Data module.</p>
</div>
<div class="paragraph">
<p>The following example shows custom interfaces and their implementations:</p>
</div>
<div class="exampleblock">
<div class="title">Example 34. Fragments with their implementations</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">interface HumanRepository {
  void someHumanMethod(User user);
}

class HumanRepositoryImpl implements HumanRepository {

  public void someHumanMethod(User user) {
    // Your custom implementation
  }
}

interface ContactRepository {

  void someContactMethod(User user);

  User anotherContactMethod(User user);
}

class ContactRepositoryImpl implements ContactRepository {

  public void someContactMethod(User user) {
    // Your custom implementation
  }

  public User anotherContactMethod(User user) {
    // Your custom implementation
  }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The following example shows the interface for a custom repository that extends <code>CrudRepository</code>:</p>
</div>
<div class="exampleblock">
<div class="title">Example 35. Changes to your repository interface</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">interface UserRepository extends CrudRepository&lt;User, Long&gt;, HumanRepository, ContactRepository {

  // Declare query methods here
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Repositories may be composed of multiple custom implementations that are imported in the order of their declaration. Custom implementations have a higher priority than the base implementation and repository aspects. This ordering lets you override base repository and aspect methods and resolves ambiguity if two fragments contribute the same method signature. Repository fragments are not limited to use in a single repository interface. Multiple repositories may use a fragment interface, letting you reuse customizations across different repositories.</p>
</div>
<div class="paragraph">
<p>The following example shows a repository fragment and its implementation:</p>
</div>
<div class="exampleblock">
<div class="title">Example 36. Fragments overriding <code>save(…)</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">interface CustomizedSave&lt;T&gt; {
  &lt;S extends T&gt; S save(S entity);
}

class CustomizedSaveImpl&lt;T&gt; implements CustomizedSave&lt;T&gt; {

  public &lt;S extends T&gt; S save(S entity) {
    // Your custom implementation
  }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The following example shows a repository that uses the preceding repository fragment:</p>
</div>
<div class="exampleblock">
<div class="title">Example 37. Customized repository interfaces</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">interface UserRepository extends CrudRepository&lt;User, Long&gt;, CustomizedSave&lt;User&gt; {
}

interface PersonRepository extends CrudRepository&lt;Person, Long&gt;, CustomizedSave&lt;Person&gt; {
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="repositories.configuration"><a class="anchor" href="index.html#repositories.configuration"></a>Configuration</h5>
<div class="paragraph">
<p>If you use namespace configuration, the repository infrastructure tries to autodetect custom implementation fragments by scanning for classes below the package in which it found a repository. These classes need to follow the naming convention of appending the namespace element&#8217;s <code>repository-impl-postfix</code> attribute to the fragment interface name. This postfix defaults to <code>Impl</code>. The following example shows a repository that uses the default postfix and a repository that sets a custom value for the postfix:</p>
</div>
<div class="exampleblock">
<div class="title">Example 38. Configuration example</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;repositories base-package="com.acme.repository" /&gt;

&lt;repositories base-package="com.acme.repository" repository-impl-postfix="MyPostfix" /&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The first configuration in the preceding example tries to look up a class called <code>com.acme.repository.CustomizedUserRepositoryImpl</code> to act as a custom repository implementation. The second example tries to look up <code>com.acme.repository.CustomizedUserRepositoryMyPostfix</code>.</p>
</div>
<div class="sect5">
<h6 id="repositories.single-repository-behaviour.ambiguity"><a class="anchor" href="index.html#repositories.single-repository-behaviour.ambiguity"></a>Resolution of Ambiguity</h6>
<div class="paragraph">
<p>If multiple implementations with matching class names are found in different packages, Spring Data uses the bean names to identify which one to use.</p>
</div>
<div class="paragraph">
<p>Given the following two custom implementations for the <code>CustomizedUserRepository</code> shown earlier, the first implementation is used.
Its bean name is <code>customizedUserRepositoryImpl</code>, which matches that of the fragment interface (<code>CustomizedUserRepository</code>) plus the postfix <code>Impl</code>.</p>
</div>
<div class="exampleblock">
<div class="title">Example 39. Resolution of ambiguous implementations</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">package com.acme.impl.one;

class CustomizedUserRepositoryImpl implements CustomizedUserRepository {

  // Your custom implementation
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">package com.acme.impl.two;

@Component("specialCustomImpl")
class CustomizedUserRepositoryImpl implements CustomizedUserRepository {

  // Your custom implementation
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>If you annotate the <code>UserRepository</code> interface with <code>@Component("specialCustom")</code>, the bean name plus <code>Impl</code> then matches the one defined for the repository implementation in <code>com.acme.impl.two</code>, and it is used instead of the first one.</p>
</div>
</div>
<div class="sect5">
<h6 id="repositories.manual-wiring"><a class="anchor" href="index.html#repositories.manual-wiring"></a>Manual Wiring</h6>
<div class="paragraph">
<p>If your custom implementation uses annotation-based configuration and autowiring only, the preceding approach shown works well, because it is treated as any other Spring bean. If your implementation fragment bean needs special wiring, you can declare the bean and name it according to the conventions described in the <a href="index.html#repositories.single-repository-behaviour.ambiguity">preceding section</a>. The infrastructure then refers to the manually defined bean definition by name instead of creating one itself. The following example shows how to manually wire a custom implementation:</p>
</div>
<div class="exampleblock">
<div class="title">Example 40. Manual wiring of custom implementations</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;repositories base-package="com.acme.repository" /&gt;

&lt;beans:bean id="userRepositoryImpl" class="…"&gt;
  &lt;!-- further configuration --&gt;
&lt;/beans:bean&gt;</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="repositories.customize-base-repository"><a class="anchor" href="index.html#repositories.customize-base-repository"></a>9.6.2. Customize the Base Repository</h4>
<div class="paragraph">
<p>The approach described in the <a href="index.html#repositories.manual-wiring">preceding section</a> requires customization of each repository interfaces when you want to customize the base repository behavior so that all repositories are affected. To instead change behavior for all repositories, you can create an implementation that extends the persistence technology-specific repository base class. This class then acts as a custom base class for the repository proxies, as shown in the following example:</p>
</div>
<div class="exampleblock">
<div class="title">Example 41. Custom repository base class</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">class MyRepositoryImpl&lt;T, ID&gt;
  extends SimpleJpaRepository&lt;T, ID&gt; {

  private final EntityManager entityManager;

  MyRepositoryImpl(JpaEntityInformation entityInformation,
                          EntityManager entityManager) {
    super(entityInformation, entityManager);

    // Keep the EntityManager around to used from the newly introduced methods.
    this.entityManager = entityManager;
  }

  @Transactional
  public &lt;S extends T&gt; S save(S entity) {
    // implementation goes here
  }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
The class needs to have a constructor of the super class which the store-specific repository factory implementation uses. If the repository base class has multiple constructors, override the one taking an <code>EntityInformation</code> plus a store specific infrastructure object (such as an <code>EntityManager</code> or a template class).
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The final step is to make the Spring Data infrastructure aware of the customized repository base class. In Java configuration, you can do so by using the <code>repositoryBaseClass</code> attribute of the <code>@Enable${store}Repositories</code> annotation, as shown in the following example:</p>
</div>
<div class="exampleblock">
<div class="title">Example 42. Configuring a custom repository base class using JavaConfig</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Configuration
@EnableJpaRepositories(repositoryBaseClass = MyRepositoryImpl.class)
class ApplicationConfiguration { … }</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>A corresponding attribute is available in the XML namespace, as shown in the following example:</p>
</div>
<div class="exampleblock">
<div class="title">Example 43. Configuring a custom repository base class using XML</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;repositories base-package="com.acme.repository"
     base-class="….MyRepositoryImpl" /&gt;</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="core.domain-events"><a class="anchor" href="index.html#core.domain-events"></a>9.7. Publishing Events from Aggregate Roots</h3>
<div class="paragraph">
<p>Entities managed by repositories are aggregate roots.
In a Domain-Driven Design application, these aggregate roots usually publish domain events.
Spring Data provides an annotation called <code>@DomainEvents</code> that you can use on a method of your aggregate root to make that publication as easy as possible, as shown in the following example:</p>
</div>
<div class="exampleblock">
<div class="title">Example 44. Exposing domain events from an aggregate root</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">class AnAggregateRoot {

    @DomainEvents <i class="conum" data-value="1"></i><b>(1)</b>
    Collection&lt;Object&gt; domainEvents() {
        // … return events you want to get published here
    }

    @AfterDomainEventPublication <i class="conum" data-value="2"></i><b>(2)</b>
    void callbackMethod() {
       // … potentially clean up domain events list
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The method that uses <code>@DomainEvents</code> can return either a single event instance or a collection of events. It must not take any arguments.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>After all events have been published, we have a method annotated with <code>@AfterDomainEventPublication</code>. You can use it to potentially clean the list of events to be published (among other uses).</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>The methods are called every time one of a Spring Data repository&#8217;s <code>save(…)</code>, <code>saveAll(…)</code>, <code>delete(…)</code> or <code>deleteAll(…)</code> methods are called.</p>
</div>
</div>
<div class="sect2">
<h3 id="core.extensions"><a class="anchor" href="index.html#core.extensions"></a>9.8. Spring Data Extensions</h3>
<div class="paragraph">
<p>This section documents a set of Spring Data extensions that enable Spring Data usage in a variety of contexts. Currently, most of the integration is targeted towards Spring MVC.</p>
</div>
<div class="sect3">
<h4 id="core.extensions.querydsl"><a class="anchor" href="index.html#core.extensions.querydsl"></a>9.8.1. Querydsl Extension</h4>
<div class="paragraph">
<p><a href="http://www.querydsl.com/">Querydsl</a> is a framework that enables the construction of statically typed SQL-like queries through its fluent API.</p>
</div>
<div class="paragraph">
<p>Several Spring Data modules offer integration with Querydsl through <code>QuerydslPredicateExecutor</code>, as the following example shows:</p>
</div>
<div class="exampleblock">
<div class="title">Example 45. QuerydslPredicateExecutor interface</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">public interface QuerydslPredicateExecutor&lt;T&gt; {

  Optional&lt;T&gt; findById(Predicate predicate);  <i class="conum" data-value="1"></i><b>(1)</b>

  Iterable&lt;T&gt; findAll(Predicate predicate);   <i class="conum" data-value="2"></i><b>(2)</b>

  long count(Predicate predicate);            <i class="conum" data-value="3"></i><b>(3)</b>

  boolean exists(Predicate predicate);        <i class="conum" data-value="4"></i><b>(4)</b>

  // … more functionality omitted.
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Finds and returns a single entity matching the <code>Predicate</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Finds and returns all entities matching the <code>Predicate</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Returns the number of entities matching the <code>Predicate</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Returns whether an entity that matches the <code>Predicate</code> exists.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>To use the Querydsl support, extend <code>QuerydslPredicateExecutor</code> on your repository interface, as the following example shows:</p>
</div>
<div class="exampleblock">
<div class="title">Example 46. Querydsl integration on repositories</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">interface UserRepository extends CrudRepository&lt;User, Long&gt;, QuerydslPredicateExecutor&lt;User&gt; {
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The preceding example lets you write type-safe queries by using Querydsl <code>Predicate</code> instances, as the following example shows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">Predicate predicate = user.firstname.equalsIgnoreCase("dave")
	.and(user.lastname.startsWithIgnoreCase("mathews"));

userRepository.findAll(predicate);</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="core.web"><a class="anchor" href="index.html#core.web"></a>9.8.2. Web support</h4>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This section contains the documentation for the Spring Data web support as it is implemented in the current versions of Spring Data Commons. As the newly introduced support changes many things, we kept the documentation of the former behavior in <a href="index.html#web.legacy">[web.legacy]</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Spring Data modules that support the repository programming model ship with a variety of web support. The web related components require Spring MVC JARs to be on the classpath. Some of them even provide integration with <a href="https://github.com/spring-projects/spring-hateoas">Spring HATEOAS</a>. In general, the integration support is enabled by using the <code>@EnableSpringDataWebSupport</code> annotation in your JavaConfig configuration class, as the following example shows:</p>
</div>
<div class="exampleblock">
<div class="title">Example 47. Enabling Spring Data web support</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Configuration
@EnableWebMvc
@EnableSpringDataWebSupport
class WebConfiguration {}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The <code>@EnableSpringDataWebSupport</code> annotation registers a few components. We discuss those later in this section. It also detects Spring HATEOAS on the classpath and registers integration components (if present) for it as well.</p>
</div>
<div class="paragraph">
<p>Alternatively, if you use XML configuration, register either <code>SpringDataWebConfiguration</code> or <code>HateoasAwareSpringDataWebConfiguration</code> as Spring beans, as the following example shows (for <code>SpringDataWebConfiguration</code>):</p>
</div>
<div class="exampleblock">
<div class="title">Example 48. Enabling Spring Data web support in XML</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;bean class="org.springframework.data.web.config.SpringDataWebConfiguration" /&gt;

&lt;!-- If you use Spring HATEOAS, register this one *instead* of the former --&gt;
&lt;bean class="org.springframework.data.web.config.HateoasAwareSpringDataWebConfiguration" /&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="core.web.basic"><a class="anchor" href="index.html#core.web.basic"></a>Basic Web Support</h5>
<div class="paragraph">
<p>The configuration shown in the <a href="index.html#core.web">previous section</a> registers a few basic components:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A <a href="index.html#core.web.basic.domain-class-converter">Using the <code>DomainClassConverter</code> Class</a> to let Spring MVC resolve instances of repository-managed domain classes from request parameters or path variables.</p>
</li>
<li>
<p><a href="index.html#core.web.basic.paging-and-sorting"><code>HandlerMethodArgumentResolver</code></a> implementations to let Spring MVC resolve <code>Pageable</code> and <code>Sort</code> instances from request parameters.</p>
</li>
</ul>
</div>
<div class="sect5">
<h6 id="core.web.basic.domain-class-converter"><a class="anchor" href="index.html#core.web.basic.domain-class-converter"></a>Using the <code>DomainClassConverter</code> Class</h6>
<div class="paragraph">
<p>The <code>DomainClassConverter</code> class lets you use domain types in your Spring MVC controller method signatures directly so that you need not manually lookup the instances through the repository, as the following example shows:</p>
</div>
<div class="exampleblock">
<div class="title">Example 49. A Spring MVC controller using domain types in method signatures</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Controller
@RequestMapping("/users")
class UserController {

  @RequestMapping("/{id}")
  String showUserForm(@PathVariable("id") User user, Model model) {

    model.addAttribute("user", user);
    return "userForm";
  }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The method receives a <code>User</code> instance directly, and no further lookup is necessary. The instance can be resolved by letting Spring MVC convert the path variable into the <code>id</code> type of the domain class first and eventually access the instance through calling <code>findById(…)</code> on the repository instance registered for the domain type.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Currently, the repository has to implement <code>CrudRepository</code> to be eligible to be discovered for conversion.
</td>
</tr>
</table>
</div>
</div>
<div class="sect5">
<h6 id="core.web.basic.paging-and-sorting"><a class="anchor" href="index.html#core.web.basic.paging-and-sorting"></a>HandlerMethodArgumentResolvers for Pageable and Sort</h6>
<div class="paragraph">
<p>The configuration snippet shown in the <a href="index.html#core.web.basic.domain-class-converter">previous section</a> also registers a <code>PageableHandlerMethodArgumentResolver</code> as well as an instance of <code>SortHandlerMethodArgumentResolver</code>. The registration enables <code>Pageable</code> and <code>Sort</code> as valid controller method arguments, as the following example shows:</p>
</div>
<div class="exampleblock">
<div class="title">Example 50. Using Pageable as a controller method argument</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Controller
@RequestMapping("/users")
class UserController {

  private final UserRepository repository;

  UserController(UserRepository repository) {
    this.repository = repository;
  }

  @RequestMapping
  String showUsers(Model model, Pageable pageable) {

    model.addAttribute("users", repository.findAll(pageable));
    return "users";
  }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The preceding method signature causes Spring MVC try to derive a <code>Pageable</code> instance from the request parameters by using the following default configuration:</p>
</div>
<table class="tableblock frame-all grid-all fit-content">
<caption class="title">Table 7. Request parameters evaluated for <code>Pageable</code> instances</caption>
<colgroup>
<col>
<col>
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>page</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Page you want to retrieve. 0-indexed and defaults to 0.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>size</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Size of the page you want to retrieve. Defaults to 20.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>sort</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Properties that should be sorted by in the format <code>property,property(,ASC|DESC)(,IgnoreCase)</code>. The default sort direction is case-sensitive ascending. Use multiple <code>sort</code> parameters if you want to switch direction or case sensitivity&#8201;&#8212;&#8201;for example, <code>?sort=firstname&amp;sort=lastname,asc&amp;sort=city,ignorecase</code>.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>To customize this behavior, register a bean that implements the <code>PageableHandlerMethodArgumentResolverCustomizer</code> interface or the <code>SortHandlerMethodArgumentResolverCustomizer</code> interface, respectively. Its <code>customize()</code> method gets called, letting you change settings, as the following example shows:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Bean SortHandlerMethodArgumentResolverCustomizer sortCustomizer() {
    return s -&gt; s.setPropertyDelimiter("&lt;--&gt;");
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>If setting the properties of an existing <code>MethodArgumentResolver</code> is not sufficient for your purpose, extend either <code>SpringDataWebConfiguration</code> or the HATEOAS-enabled equivalent, override the <code>pageableResolver()</code> or <code>sortResolver()</code> methods, and import your customized configuration file instead of using the <code>@Enable</code> annotation.</p>
</div>
<div class="paragraph">
<p>If you need multiple <code>Pageable</code> or <code>Sort</code> instances to be resolved from the request (for multiple tables, for example), you can use Spring&#8217;s <code>@Qualifier</code> annotation to distinguish one from another. The request parameters then have to be prefixed with <code>${qualifier}_</code>. The following example shows the resulting method signature:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">String showUsers(Model model,
      @Qualifier("thing1") Pageable first,
      @Qualifier("thing2") Pageable second) { … }</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>You have to populate <code>thing1_page</code>, <code>thing2_page</code>, and so on.</p>
</div>
<div class="paragraph">
<p>The default <code>Pageable</code> passed into the method is equivalent to a <code>PageRequest.of(0, 20)</code>, but you can customize it by using the <code>@PageableDefault</code> annotation on the <code>Pageable</code> parameter.</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="core.web.pageables"><a class="anchor" href="index.html#core.web.pageables"></a>Hypermedia Support for Pageables</h5>
<div class="paragraph">
<p>Spring HATEOAS ships with a representation model class (<code>PagedResources</code>) that allows enriching the content of a <code>Page</code> instance with the necessary <code>Page</code> metadata as well as links to let the clients easily navigate the pages. The conversion of a <code>Page</code> to a <code>PagedResources</code> is done by an implementation of the Spring HATEOAS <code>ResourceAssembler</code> interface, called the <code>PagedResourcesAssembler</code>. The following example shows how to use a <code>PagedResourcesAssembler</code> as a controller method argument:</p>
</div>
<div class="exampleblock">
<div class="title">Example 51. Using a PagedResourcesAssembler as controller method argument</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Controller
class PersonController {

  @Autowired PersonRepository repository;

  @RequestMapping(value = "/persons", method = RequestMethod.GET)
  HttpEntity&lt;PagedResources&lt;Person&gt;&gt; persons(Pageable pageable,
    PagedResourcesAssembler assembler) {

    Page&lt;Person&gt; persons = repository.findAll(pageable);
    return new ResponseEntity&lt;&gt;(assembler.toResources(persons), HttpStatus.OK);
  }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Enabling the configuration, as shown in the preceding example, lets the <code>PagedResourcesAssembler</code> be used as a controller method argument. Calling <code>toResources(…)</code> on it has the following effects:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The content of the <code>Page</code> becomes the content of the <code>PagedResources</code> instance.</p>
</li>
<li>
<p>The <code>PagedResources</code> object gets a <code>PageMetadata</code> instance attached, and it is populated with information from the <code>Page</code> and the underlying <code>PageRequest</code>.</p>
</li>
<li>
<p>The <code>PagedResources</code> may get <code>prev</code> and <code>next</code> links attached, depending on the page&#8217;s state. The links point to the URI to which the method maps. The pagination parameters added to the method match the setup of the <code>PageableHandlerMethodArgumentResolver</code> to make sure the links can be resolved later.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Assume we have 30 <code>Person</code> instances in the database. You can now trigger a request (<code>GET <a href="http://localhost:8080/persons" class="bare">http://localhost:8080/persons</a></code>) and see output similar to the following:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="javascript" class="language-javascript hljs">{ "links" : [ { "rel" : "next",
                "href" : "http://localhost:8080/persons?page=1&amp;size=20" }
  ],
  "content" : [
     … // 20 Person instances rendered here
  ],
  "pageMetadata" : {
    "size" : 20,
    "totalElements" : 30,
    "totalPages" : 2,
    "number" : 0
  }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The assembler produced the correct URI and also picked up the default configuration to resolve the parameters into a <code>Pageable</code> for an upcoming request. This means that, if you change that configuration, the links automatically adhere to the change. By default, the assembler points to the controller method it was invoked in, but you can customize that by passing a custom <code>Link</code> to be used as base to build the pagination links, which overloads the <code>PagedResourcesAssembler.toResource(…)</code> method.</p>
</div>
</div>
<div class="sect4">
<h5 id="core.web.binding"><a class="anchor" href="index.html#core.web.binding"></a>Web Databinding Support</h5>
<div class="paragraph">
<p>You can use Spring Data projections (described in <a href="index.html#projections">Projections</a>) to bind incoming request payloads by using either <a href="https://goessner.net/articles/JsonPath/">JSONPath</a> expressions (requires <a href="https://github.com/json-path/JsonPath">Jayway JsonPath</a> or <a href="https://www.w3.org/TR/xpath-31/">XPath</a> expressions (requires <a href="https://xmlbeam.org/">XmlBeam</a>), as the following example shows:</p>
</div>
<div class="exampleblock">
<div class="title">Example 52. HTTP payload binding using JSONPath or XPath expressions</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@ProjectedPayload
public interface UserPayload {

  @XBRead("//firstname")
  @JsonPath("$..firstname")
  String getFirstname();

  @XBRead("/lastname")
  @JsonPath({ "$.lastname", "$.user.lastname" })
  String getLastname();
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>You can use the type shown in the preceding example as a Spring MVC handler method argument or by using <code>ParameterizedTypeReference</code> on one of methods of the <code>RestTemplate</code>.
The preceding method declarations would try to find <code>firstname</code> anywhere in the given document.
The <code>lastname</code> XML lookup is performed on the top-level of the incoming document.
The JSON variant of that tries a top-level <code>lastname</code> first but also tries <code>lastname</code> nested in a <code>user</code> sub-document if the former does not return a value.
That way, changes in the structure of the source document can be mitigated easily without having clients calling the exposed methods (usually a drawback of class-based payload binding).</p>
</div>
<div class="paragraph">
<p>Nested projections are supported as described in <a href="index.html#projections">Projections</a>.
If the method returns a complex, non-interface type, a Jackson <code>ObjectMapper</code> is used to map the final value.</p>
</div>
<div class="paragraph">
<p>For Spring MVC, the necessary converters are registered automatically as soon as <code>@EnableSpringDataWebSupport</code> is active and the required dependencies are available on the classpath.
For usage with <code>RestTemplate</code>, register a <code>ProjectingJackson2HttpMessageConverter</code> (JSON) or <code>XmlBeamHttpMessageConverter</code> manually.</p>
</div>
<div class="paragraph">
<p>For more information, see the <a href="https://github.com/spring-projects/spring-data-examples/tree/master/web/projection">web projection example</a> in the canonical <a href="https://github.com/spring-projects/spring-data-examples">Spring Data Examples repository</a>.</p>
</div>
</div>
<div class="sect4">
<h5 id="core.web.type-safe"><a class="anchor" href="index.html#core.web.type-safe"></a>Querydsl Web Support</h5>
<div class="paragraph">
<p>For those stores that have <a href="http://www.querydsl.com/">QueryDSL</a> integration, you can derive queries from the attributes contained in a <code>Request</code> query string.</p>
</div>
<div class="paragraph">
<p>Consider the following query string:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="text" class="language-text hljs">?firstname=Dave&amp;lastname=Matthews</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Given the <code>User</code> object from the previous examples, you can resolve a query string to the following value by using the <code>QuerydslPredicateArgumentResolver</code>, as follows:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="text" class="language-text hljs">QUser.user.firstname.eq("Dave").and(QUser.user.lastname.eq("Matthews"))</code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The feature is automatically enabled, along with <code>@EnableSpringDataWebSupport</code>, when Querydsl is found on the classpath.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Adding a <code>@QuerydslPredicate</code> to the method signature provides a ready-to-use <code>Predicate</code>, which you can run by using the <code>QuerydslPredicateExecutor</code>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Type information is typically resolved from the method&#8217;s return type. Since that information does not necessarily match the domain type, it might be a good idea to use the <code>root</code> attribute of <code>QuerydslPredicate</code>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The following example shows how to use <code>@QuerydslPredicate</code> in a method signature:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Controller
class UserController {

  @Autowired UserRepository repository;

  @RequestMapping(value = "/", method = RequestMethod.GET)
  String index(Model model, @QuerydslPredicate(root = User.class) Predicate predicate,    <i class="conum" data-value="1"></i><b>(1)</b>
          Pageable pageable, @RequestParam MultiValueMap&lt;String, String&gt; parameters) {

    model.addAttribute("users", repository.findAll(predicate, pageable));

    return "index";
  }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Resolve query string arguments to matching <code>Predicate</code> for <code>User</code>.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>The default binding is as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>Object</code> on simple properties as <code>eq</code>.</p>
</li>
<li>
<p><code>Object</code> on collection like properties as <code>contains</code>.</p>
</li>
<li>
<p><code>Collection</code> on simple properties as <code>in</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You can customize those bindings through the <code>bindings</code> attribute of <code>@QuerydslPredicate</code> or by making use of Java 8 <code>default methods</code> and adding the <code>QuerydslBinderCustomizer</code> method to the repository interface, as follows:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">interface UserRepository extends CrudRepository&lt;User, String&gt;,
                                 QuerydslPredicateExecutor&lt;User&gt;,                <i class="conum" data-value="1"></i><b>(1)</b>
                                 QuerydslBinderCustomizer&lt;QUser&gt; {               <i class="conum" data-value="2"></i><b>(2)</b>

  @Override
  default void customize(QuerydslBindings bindings, QUser user) {

    bindings.bind(user.username).first((path, value) -&gt; path.contains(value))    <i class="conum" data-value="3"></i><b>(3)</b>
    bindings.bind(String.class)
      .first((StringPath path, String value) -&gt; path.containsIgnoreCase(value)); <i class="conum" data-value="4"></i><b>(4)</b>
    bindings.excluding(user.password);                                           <i class="conum" data-value="5"></i><b>(5)</b>
  }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>QuerydslPredicateExecutor</code> provides access to specific finder methods for <code>Predicate</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>QuerydslBinderCustomizer</code> defined on the repository interface is automatically picked up and shortcuts <code>@QuerydslPredicate(bindings=&#8230;&#8203;)</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Define the binding for the <code>username</code> property to be a simple <code>contains</code> binding.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Define the default binding for <code>String</code> properties to be a case-insensitive <code>contains</code> match.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Exclude the <code>password</code> property from <code>Predicate</code> resolution.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="core.repository-populators"><a class="anchor" href="index.html#core.repository-populators"></a>9.8.3. Repository Populators</h4>
<div class="paragraph">
<p>If you work with the Spring JDBC module, you are probably familiar with the support for populating a <code>DataSource</code> with SQL scripts. A similar abstraction is available on the repositories level, although it does not use SQL as the data definition language because it must be store-independent. Thus, the populators support XML (through Spring&#8217;s OXM abstraction) and JSON (through Jackson) to define data with which to populate the repositories.</p>
</div>
<div class="paragraph">
<p>Assume you have a file called <code>data.json</code> with the following content:</p>
</div>
<div class="exampleblock">
<div class="title">Example 53. Data defined in JSON</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="javascript" class="language-javascript hljs">[ { "_class" : "com.acme.Person",
 "firstname" : "Dave",
  "lastname" : "Matthews" },
  { "_class" : "com.acme.Person",
 "firstname" : "Carter",
  "lastname" : "Beauford" } ]</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>You can populate your repositories by using the populator elements of the repository namespace provided in Spring Data Commons. To populate the preceding data to your <code>PersonRepository</code>, declare a populator similar to the following:</p>
</div>
<div class="exampleblock">
<div class="title">Example 54. Declaring a Jackson repository populator</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;beans xmlns="http://www.springframework.org/schema/beans"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xmlns:repository="http://www.springframework.org/schema/data/repository"
  xsi:schemaLocation="http://www.springframework.org/schema/beans
    https://www.springframework.org/schema/beans/spring-beans.xsd
    http://www.springframework.org/schema/data/repository
    https://www.springframework.org/schema/data/repository/spring-repository.xsd"&gt;

  &lt;repository:jackson2-populator locations="classpath:data.json" /&gt;

&lt;/beans&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The preceding declaration causes the <code>data.json</code> file to
be read and deserialized by a Jackson <code>ObjectMapper</code>.</p>
</div>
<div class="paragraph">
<p>The type to which the JSON object is unmarshalled is determined by inspecting the <code>_class</code> attribute of the JSON document. The infrastructure eventually selects the appropriate repository to handle the object that was deserialized.</p>
</div>
<div class="paragraph">
<p>To instead use XML to define the data the repositories should be populated with, you can use the <code>unmarshaller-populator</code> element. You configure it to use one of the XML marshaller options available in Spring OXM. See the <a href="https://docs.spring.io/spring/docs/5.3.1/spring-framework-reference/data-access.html#oxm">Spring reference documentation</a> for details. The following example shows how to unmarshall a repository populator with JAXB:</p>
</div>
<div class="exampleblock">
<div class="title">Example 55. Declaring an unmarshalling repository populator (using JAXB)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;beans xmlns="http://www.springframework.org/schema/beans"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xmlns:repository="http://www.springframework.org/schema/data/repository"
  xmlns:oxm="http://www.springframework.org/schema/oxm"
  xsi:schemaLocation="http://www.springframework.org/schema/beans
    https://www.springframework.org/schema/beans/spring-beans.xsd
    http://www.springframework.org/schema/data/repository
    https://www.springframework.org/schema/data/repository/spring-repository.xsd
    http://www.springframework.org/schema/oxm
    https://www.springframework.org/schema/oxm/spring-oxm.xsd"&gt;

  &lt;repository:unmarshaller-populator locations="classpath:data.json"
    unmarshaller-ref="unmarshaller" /&gt;

  &lt;oxm:jaxb2-marshaller contextPath="com.acme" /&gt;

&lt;/beans&gt;</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<h1 id="reference" class="sect0"><a class="anchor" href="index.html#reference"></a>Reference Documentation</h1>
<div class="sect1">
<h2 id="introduction"><a class="anchor" href="index.html#introduction"></a>10. Introduction</h2>
<div class="sectionbody">
<div class="sect2">
<h3>10.1. Document Structure</h3>
<div class="paragraph">
<p>This part of the reference documentation explains the core functionality offered by Spring Data MongoDB.</p>
</div>
<div class="paragraph">
<p>&#8220;<a href="index.html#mongo.core">MongoDB support</a>&#8221; introduces the MongoDB module feature set.</p>
</div>
<div class="paragraph">
<p>&#8220;<a href="index.html#mongo.repositories">MongoDB Repositories</a>&#8221; introduces the repository support for MongoDB.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="mongo.core"><a class="anchor" href="index.html#mongo.core"></a>11. MongoDB support</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The MongoDB support contains a wide range of features:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Spring configuration support with Java-based <code>@Configuration</code> classes or an XML namespace for a Mongo driver instance and replica sets.</p>
</li>
<li>
<p><code>MongoTemplate</code> helper class that increases productivity when performing common Mongo operations.Includes integrated object mapping between documents and POJOs.</p>
</li>
<li>
<p>Exception translation into Spring&#8217;s portable Data Access Exception hierarchy.</p>
</li>
<li>
<p>Feature-rich Object Mapping integrated with Spring&#8217;s Conversion Service.</p>
</li>
<li>
<p>Annotation-based mapping metadata that is extensible to support other metadata formats.</p>
</li>
<li>
<p>Persistence and mapping lifecycle events.</p>
</li>
<li>
<p>Java-based Query, Criteria, and Update DSLs.</p>
</li>
<li>
<p>Automatic implementation of Repository interfaces, including support for custom finder methods.</p>
</li>
<li>
<p>QueryDSL integration to support type-safe queries.</p>
</li>
<li>
<p>Cross-store persistence support for JPA Entities with fields transparently persisted and retrieved with MongoDB (deprecated - to be removed without replacement).</p>
</li>
<li>
<p>GeoSpatial integration.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For most tasks, you should use <code>MongoTemplate</code> or the Repository support, which both leverage the rich mapping functionality. <code>MongoTemplate</code> is the place to look for accessing functionality such as incrementing counters or ad-hoc CRUD operations. <code>MongoTemplate</code> also provides callback methods so that it is easy for you to get the low-level API artifacts, such as <code>com.mongodb.client.MongoDatabase</code>, to communicate directly with MongoDB. The goal with naming conventions on various API artifacts is to copy those in the base MongoDB Java driver so you can easily map your existing knowledge onto the Spring APIs.</p>
</div>
<div class="sect2">
<h3 id="mongodb-getting-started"><a class="anchor" href="index.html#mongodb-getting-started"></a>11.1. Getting Started</h3>
<div class="paragraph">
<p>An easy way to bootstrap setting up a working environment is to create a Spring-based project in <a href="https://spring.io/tools/sts">STS</a>.</p>
</div>
<div class="paragraph">
<p>First, you need to set up a running MongoDB server. Refer to the <a href="https://docs.mongodb.org/manual/core/introduction/">MongoDB Quick Start guide</a> for an explanation on how to startup a MongoDB instance. Once installed, starting MongoDB is typically a matter of running the following command: <code>${MONGO_HOME}/bin/mongod</code></p>
</div>
<div class="paragraph">
<p>To create a Spring project in STS:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Go to File &#8594; New &#8594; Spring Template Project &#8594; Simple Spring Utility Project, and press Yes when prompted. Then enter a project and a package name, such as <code>org.spring.mongodb.example</code>.</p>
</li>
<li>
<p>Add the following to the pom.xml files <code>dependencies</code> element:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;dependencies&gt;

  &lt;!-- other dependency elements omitted --&gt;

  &lt;dependency&gt;
    &lt;groupId&gt;org.springframework.data&lt;/groupId&gt;
    &lt;artifactId&gt;spring-data-mongodb&lt;/artifactId&gt;
    &lt;version&gt;3.1.1&lt;/version&gt;
  &lt;/dependency&gt;

&lt;/dependencies&gt;</code></pre>
</div>
</div>
</li>
<li>
<p>Change the version of Spring in the pom.xml to be</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;spring.framework.version&gt;5.3.1&lt;/spring.framework.version&gt;</code></pre>
</div>
</div>
</li>
<li>
<p>Add the following location of the Spring Milestone repository for Maven to your <code>pom.xml</code> such that it is at the same level of your <code>&lt;dependencies/&gt;</code> element:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;repositories&gt;
  &lt;repository&gt;
    &lt;id&gt;spring-milestone&lt;/id&gt;
    &lt;name&gt;Spring Maven MILESTONE Repository&lt;/name&gt;
    &lt;url&gt;https://repo.spring.io/libs-milestone&lt;/url&gt;
  &lt;/repository&gt;
&lt;/repositories&gt;</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>The repository is also <a href="https://repo.spring.io/milestone/org/springframework/data/">browseable here</a>.</p>
</div>
<div class="paragraph">
<p>You may also want to set the logging level to <code>DEBUG</code> to see some additional information. To do so, edit the <code>log4j.properties</code> file to have the following content:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">log4j.category.org.springframework.data.mongodb=DEBUG
log4j.appender.stdout.layout.ConversionPattern=%d{ABSOLUTE} %5p %40.40c:%4L - %m%n</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then you can create a <code>Person</code> class to persist:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">package org.spring.mongodb.example;

public class Person {

  private String id;
  private String name;
  private int age;

  public Person(String name, int age) {
    this.name = name;
    this.age = age;
  }

  public String getId() {
    return id;
  }
  public String getName() {
    return name;
  }
  public int getAge() {
    return age;
  }

  @Override
  public String toString() {
    return "Person [id=" + id + ", name=" + name + ", age=" + age + "]";
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>You also need a main application to run:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">package org.spring.mongodb.example;

import static org.springframework.data.mongodb.core.query.Criteria.where;

import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;
import org.springframework.data.mongodb.core.MongoOperations;
import org.springframework.data.mongodb.core.MongoTemplate;
import org.springframework.data.mongodb.core.query.Query;

import com.mongodb.client.MongoClients;

public class MongoApp {

  private static final Log log = LogFactory.getLog(MongoApp.class);

  public static void main(String[] args) throws Exception {

    MongoOperations mongoOps = new MongoTemplate(MongoClients.create(), "database");
    mongoOps.insert(new Person("Joe", 34));

    log.info(mongoOps.findOne(new Query(where("name").is("Joe")), Person.class));

    mongoOps.dropCollection("person");
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>When you run the main program, the preceding examples produce the following output:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">10:01:32,062 DEBUG apping.MongoPersistentEntityIndexCreator:  80 - Analyzing class class org.spring.example.Person for index information.
10:01:32,265 DEBUG ramework.data.mongodb.core.MongoTemplate: 631 - insert Document containing fields: [_class, age, name] in collection: Person
10:01:32,765 DEBUG ramework.data.mongodb.core.MongoTemplate:1243 - findOne using query: { "name" : "Joe"} in db.collection: database.Person
10:01:32,953  INFO      org.spring.mongodb.example.MongoApp:  25 - Person [id=4ddbba3c0be56b7e1b210166, name=Joe, age=34]
10:01:32,984 DEBUG ramework.data.mongodb.core.MongoTemplate: 375 - Dropped collection [database.person]</code></pre>
</div>
</div>
<div class="paragraph">
<p>Even in this simple example, there are few things to notice:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>You can instantiate the central helper class of Spring Mongo, <a href="index.html#mongo-template"><code>MongoTemplate</code></a>, by using the standard <code>com.mongodb.client.MongoClient</code> object and the name of the database to use.</p>
</li>
<li>
<p>The mapper works against standard POJO objects without the need for any additional metadata (though you can optionally provide that information. See <a href="index.html#mapping-chapter">here</a>.).</p>
</li>
<li>
<p>Conventions are used for handling the <code>id</code> field, converting it to be an <code>ObjectId</code> when stored in the database.</p>
</li>
<li>
<p>Mapping conventions can use field access. Notice that the <code>Person</code> class has only getters.</p>
</li>
<li>
<p>If the constructor argument names match the field names of the stored document, they are used to instantiate the object</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="mongo.examples-repo"><a class="anchor" href="index.html#mongo.examples-repo"></a>11.2. Examples Repository</h3>
<div class="paragraph">
<p>There is a <a href="https://github.com/spring-projects/spring-data-examples">GitHub repository with several examples</a> that you can download and play around with to get a feel for how the library works.</p>
</div>
</div>
<div class="sect2">
<h3 id="mongodb-connectors"><a class="anchor" href="index.html#mongodb-connectors"></a>11.3. Connecting to MongoDB with Spring</h3>
<div class="paragraph">
<p>One of the first tasks when using MongoDB and Spring is to create a <code>com.mongodb.client.MongoClient</code> object using the IoC container. There are two main ways to do this, either by using Java-based bean metadata or by using XML-based bean metadata. Both are discussed in the following sections.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
For those not familiar with how to configure the Spring container using Java-based bean metadata instead of XML-based metadata, see the high-level introduction in the reference docs <a href="../../../../../../spring/docs/3.2.x/spring-framework-reference/html/new-in-3.0.html#new-java-configuration">here</a> as well as the detailed documentation <a href="https://docs.spring.io/spring/docs/5.3.1/spring-framework-reference/core.html#beans-java-instantiating-container">here</a>.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="mongo.mongo-java-config"><a class="anchor" href="index.html#mongo.mongo-java-config"></a>11.3.1. Registering a Mongo Instance by using Java-based Metadata</h4>
<div class="paragraph">
<p>The following example shows an example of using Java-based bean metadata to register an instance of a <code>com.mongodb.client.MongoClient</code>:</p>
</div>
<div class="exampleblock">
<div class="title">Example 56. Registering a <code>com.mongodb.client.MongoClient</code> object using Java-based bean metadata</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Configuration
public class AppConfig {

  /*
   * Use the standard Mongo driver API to create a com.mongodb.client.MongoClient instance.
   */
   public @Bean MongoClient mongoClient() {
       return MongoClients.create("mongodb://localhost:27017");
   }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>This approach lets you use the standard <code>com.mongodb.client.MongoClient</code> instance, with the container using Spring&#8217;s <code>MongoClientFactoryBean</code>. As compared to instantiating a <code>com.mongodb.client.MongoClient</code> instance directly, the <code>FactoryBean</code> has the added advantage of also providing the container with an <code>ExceptionTranslator</code> implementation that translates MongoDB exceptions to exceptions in Spring&#8217;s portable <code>DataAccessException</code> hierarchy for data access classes annotated with the <code>@Repository</code> annotation. This hierarchy and the use of <code>@Repository</code> is described in <a href="https://docs.spring.io/spring/docs/5.3.1/spring-framework-reference/data-access.html">Spring&#8217;s DAO support features</a>.</p>
</div>
<div class="paragraph">
<p>The following example shows an example of a Java-based bean metadata that supports exception translation on <code>@Repository</code> annotated classes:</p>
</div>
<div class="exampleblock">
<div class="title">Example 57. Registering a <code>com.mongodb.client.MongoClient</code> object by using Spring&#8217;s <code>MongoClientFactoryBean</code> and enabling Spring&#8217;s exception translation support</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Configuration
public class AppConfig {

    /*
     * Factory bean that creates the com.mongodb.client.MongoClient instance
     */
     public @Bean MongoClientFactoryBean mongo() {
          MongoClientFactoryBean mongo = new MongoClientFactoryBean();
          mongo.setHost("localhost");
          return mongo;
     }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>To access the <code>com.mongodb.client.MongoClient</code> object created by the <code>MongoClientFactoryBean</code> in other <code>@Configuration</code> classes or your own classes, use a <code>private @Autowired Mongo mongo;</code> field.</p>
</div>
</div>
<div class="sect3">
<h4 id="mongo.mongo-xml-config"><a class="anchor" href="index.html#mongo.mongo-xml-config"></a>11.3.2. Registering a Mongo Instance by Using XML-based Metadata</h4>
<div class="paragraph">
<p>While you can use Spring&#8217;s traditional <code>&lt;beans/&gt;</code> XML namespace to register an instance of <code>com.mongodb.client.MongoClient</code> with the container, the XML can be quite verbose, as it is general-purpose. XML namespaces are a better alternative to configuring commonly used objects, such as the Mongo instance. The mongo namespace lets you create a Mongo instance server location, replica-sets, and options.</p>
</div>
<div class="paragraph">
<p>To use the Mongo namespace elements, you need to reference the Mongo schema, as follows:</p>
</div>
<div class="exampleblock">
<div class="title">Example 58. XML schema to configure MongoDB</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;beans xmlns="http://www.springframework.org/schema/beans"
          xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
          xmlns:mongo="http://www.springframework.org/schema/data/mongo"
          xsi:schemaLocation=
          "
          http://www.springframework.org/schema/data/mongo https://www.springframework.org/schema/data/mongo/spring-mongo.xsd
          http://www.springframework.org/schema/beans
          https://www.springframework.org/schema/beans/spring-beans.xsd"&gt;

    &lt;!-- Default bean name is 'mongo' --&gt;
    &lt;mongo:mongo-client host="localhost" port="27017"/&gt;

&lt;/beans&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The following example shows a more advanced configuration with <code>MongoClientSettings</code> (note that these are not recommended values):</p>
</div>
<div class="exampleblock">
<div class="title">Example 59. XML schema to configure a <code>com.mongodb.client.MongoClient</code> object with <code>MongoClientSettings</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;beans&gt;

  &lt;mongo:mongo-client host="localhost" port="27017"&gt;
    &lt;mongo:client-settings connection-pool-max-connection-life-time="10"
        connection-pool-min-size="10"
		connection-pool-max-size="20"
		connection-pool-maintenance-frequency="10"
		connection-pool-maintenance-initial-delay="11"
		connection-pool-max-connection-idle-time="30"
		connection-pool-max-wait-time="15" /&gt;
  &lt;/mongo:mongo-client&gt;

&lt;/beans&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The following example shows a configuration using replica sets:</p>
</div>
<div class="exampleblock">
<div class="title">Example 60. XML schema to configure a <code>com.mongodb.client.MongoClient</code> object with Replica Sets</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;mongo:mongo-client id="replicaSetMongo" replica-set="rs0"&gt;
    &lt;mongo:client-settings cluster-hosts="127.0.0.1:27017,localhost:27018" /&gt;
&lt;/mongo:mongo-client&gt;</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="mongo.mongo-db-factory"><a class="anchor" href="index.html#mongo.mongo-db-factory"></a>11.3.3. The MongoDatabaseFactory Interface</h4>
<div class="paragraph">
<p>While <code>com.mongodb.client.MongoClient</code> is the entry point to the MongoDB driver API, connecting to a specific MongoDB database instance requires additional information, such as the database name and an optional username and password. With that information, you can obtain a <code>com.mongodb.client.MongoDatabase</code> object and access all the functionality of a specific MongoDB database instance. Spring provides the <code>org.springframework.data.mongodb.core.MongoDatabaseFactory</code> interface, shown in the following listing, to bootstrap connectivity to the database:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">public interface MongoDatabaseFactory {

  MongoDatabase getDatabase() throws DataAccessException;

  MongoDatabase getDatabase(String dbName) throws DataAccessException;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following sections show how you can use the container with either Java-based or XML-based metadata to configure an instance of the <code>MongoDatabaseFactory</code> interface. In turn, you can use the <code>MongoDatabaseFactory</code> instance to configure <code>MongoTemplate</code>.</p>
</div>
<div class="paragraph">
<p>Instead of using the IoC container to create an instance of MongoTemplate, you can use them in standard Java code, as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">public class MongoApp {

  private static final Log log = LogFactory.getLog(MongoApp.class);

  public static void main(String[] args) throws Exception {

    MongoOperations mongoOps = new MongoTemplate(new SimpleMongoClientDatabaseFactory(MongoClients.create(), "database"));

    mongoOps.insert(new Person("Joe", 34));

    log.info(mongoOps.findOne(new Query(where("name").is("Joe")), Person.class));

    mongoOps.dropCollection("person");
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The code in bold highlights the use of <code>SimpleMongoClientDbFactory</code> and is the only difference between the listing shown in the <a href="index.html#mongodb-getting-started">getting started section</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Use <code>SimpleMongoClientDbFactory</code> when choosing <code>com.mongodb.client.MongoClient</code> as the entrypoint of choice.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="mongo.mongo-db-factory-java"><a class="anchor" href="index.html#mongo.mongo-db-factory-java"></a>11.3.4. Registering a <code>MongoDatabaseFactory</code> Instance by Using Java-based Metadata</h4>
<div class="paragraph">
<p>To register a <code>MongoDatabaseFactory</code> instance with the container, you write code much like what was highlighted in the previous code listing. The following listing shows a simple example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Configuration
public class MongoConfiguration {

  public @Bean MongoDatabaseFactory mongoDatabaseFactory() {
    return new SimpleMongoClientDatabaseFactory(MongoClients.create(), "database");
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>MongoDB Server generation 3 changed the authentication model when connecting to the DB. Therefore, some of the configuration options available for authentication are no longer valid. You should use the <code>MongoClient</code>-specific options for setting credentials through <code>MongoCredential</code> to provide authentication data, as shown in the following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Configuration
public class ApplicationContextEventTestsAppConfig extends AbstractMongoClientConfiguration {

  @Override
  public String getDatabaseName() {
    return "database";
  }

  @Override
  protected void configureClientSettings(Builder builder) {

  	builder
  	    .credential(MongoCredential.createCredential("name", "db", "pwd".toCharArray()))
  	    .applyToClusterSettings(settings  -&gt; {
  	    	settings.hosts(singletonList(new ServerAddress("127.0.0.1", 27017)));
  	    });
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In order to use authentication with XML-based configuration, use the <code>credential</code> attribute on the <code>&lt;mongo-client&gt;</code> element.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Username and password credentials used in XML-based configuration must be URL-encoded when these contain reserved characters, such as <code>:</code>, <code>%</code>, <code>@</code>, or <code>,</code>.
The following example shows encoded credentials:
<code><a href="../../../../../../cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="365b0658510676525b5f58">[email&#160;protected]</a>:mo_res:bw6},<a href="../../../../../../cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="6b3a180f13132b0a0f060205">[email&#160;protected]</a>@database</code> &#8594; <code>m0ng0%40dmin:mo_res%3Abw6%7D%2CQsdxx%<a href="../../../../../../cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="57636736333a3e39173336233635362432">[email&#160;protected]</a></code>
See <a href="https://tools.ietf.org/html/rfc3986#section-2.2">section 2.2 of RFC 3986</a> for further details.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="mongo.mongo-db-factory-xml"><a class="anchor" href="index.html#mongo.mongo-db-factory-xml"></a>11.3.5. Registering a <code>MongoDatabaseFactory</code> Instance by Using XML-based Metadata</h4>
<div class="paragraph">
<p>The <code>mongo</code> namespace provides a convenient way to create a <code>SimpleMongoClientDbFactory</code>, as compared to using the <code>&lt;beans/&gt;</code> namespace, as shown in the following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;mongo:db-factory dbname="database"&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you need to configure additional options on the <code>com.mongodb.client.MongoClient</code> instance that is used to create a <code>SimpleMongoClientDbFactory</code>, you can refer to an existing bean by using the <code>mongo-ref</code> attribute as shown in the following example. To show another common usage pattern, the following listing shows the use of a property placeholder, which lets you parametrize the configuration and the creation of a <code>MongoTemplate</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;context:property-placeholder location="classpath:/com/myapp/mongodb/config/mongo.properties"/&gt;

&lt;mongo:mongo-client host="${mongo.host}" port="${mongo.port}"&gt;
  &lt;mongo:client-settings connection-pool-max-connection-life-time="${mongo.pool-max-life-time}"
    connection-pool-min-size="${mongo.pool-min-size}"
    connection-pool-max-size="${mongo.pool-max-size}"
	connection-pool-maintenance-frequency="10"
	connection-pool-maintenance-initial-delay="11"
	connection-pool-max-connection-idle-time="30"
	connection-pool-max-wait-time="15" /&gt;
&lt;/mongo:mongo-client&gt;

&lt;mongo:db-factory dbname="database" mongo-ref="mongoClient"/&gt;

&lt;bean id="anotherMongoTemplate" class="org.springframework.data.mongodb.core.MongoTemplate"&gt;
  &lt;constructor-arg name="mongoDbFactory" ref="mongoDbFactory"/&gt;
&lt;/bean&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="mongo-template"><a class="anchor" href="index.html#mongo-template"></a>11.4. Introduction to <code>MongoTemplate</code></h3>
<div class="paragraph">
<p>The <code>MongoTemplate</code> class, located in the <code>org.springframework.data.mongodb.core</code> package, is the central class of Spring&#8217;s MongoDB support and provides a rich feature set for interacting with the database. The template offers convenience operations to create, update, delete, and query MongoDB documents and provides a mapping between your domain objects and MongoDB documents.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Once configured, <code>MongoTemplate</code> is thread-safe and can be reused across multiple instances.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The mapping between MongoDB documents and domain classes is done by delegating to an implementation of the <code>MongoConverter</code> interface. Spring provides <code>MappingMongoConverter</code>, but you can also write your own converter. See &#8220;<a href="index.html#mongo.custom-converters">Custom Conversions - Overriding Default Mapping</a>&#8221; for more detailed information.</p>
</div>
<div class="paragraph">
<p>The <code>MongoTemplate</code> class implements the interface <code>MongoOperations</code>. In as much as possible, the methods on <code>MongoOperations</code> are named after methods available on the MongoDB driver <code>Collection</code> object, to make the API familiar to existing MongoDB developers who are used to the driver API. For example, you can find methods such as <code>find</code>, <code>findAndModify</code>, <code>findAndReplace</code>, <code>findOne</code>, <code>insert</code>, <code>remove</code>, <code>save</code>, <code>update</code>, and <code>updateMulti</code>. The design goal was to make it as easy as possible to transition between the use of the base MongoDB driver and <code>MongoOperations</code>. A major difference between the two APIs is that <code>MongoOperations</code> can be passed domain objects instead of <code>Document</code>. Also, <code>MongoOperations</code> has fluent APIs for <code>Query</code>, <code>Criteria</code>, and <code>Update</code> operations instead of populating a <code>Document</code> to specify the parameters for those operations.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The preferred way to reference the operations on <code>MongoTemplate</code> instance is through its interface, <code>MongoOperations</code>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The default converter implementation used by <code>MongoTemplate</code> is <code>MappingMongoConverter</code>. While the <code>MappingMongoConverter</code> can use additional metadata to specify the mapping of objects to documents, it can also convert objects that contain no additional metadata by using some conventions for the mapping of IDs and collection names. These conventions, as well as the use of mapping annotations, are explained in the &#8220;<a href="index.html#mapping-chapter">Mapping</a>&#8221; chapter.</p>
</div>
<div class="paragraph">
<p>Another central feature of <code>MongoTemplate</code> is translation of exceptions thrown by the MongoDB Java driver into Spring&#8217;s portable Data Access Exception hierarchy. See &#8220;<a href="index.html#mongo.exception">Exception Translation</a>&#8221; for more information.</p>
</div>
<div class="paragraph">
<p><code>MongoTemplate</code> offers many convenience methods to help you easily perform common tasks. However, if you need to directly access the MongoDB driver API, you can use one of several <code>Execute</code> callback methods. The <code>execute</code> callbacks gives you a reference to either a <code>com.mongodb.client.MongoCollection</code> or a <code>com.mongodb.client.MongoDatabase</code> object. See the <a href="index.html#mongo.executioncallback">&#8220;Execution Callbacks&#8221;</a> section for more information.</p>
</div>
<div class="paragraph">
<p>The next section contains an example of how to work with the <code>MongoTemplate</code> in the context of the Spring container.</p>
</div>
<div class="sect3">
<h4 id="mongo-template.instantiating"><a class="anchor" href="index.html#mongo-template.instantiating"></a>11.4.1. Instantiating <code>MongoTemplate</code></h4>
<div class="paragraph">
<p>You can use Java to create and register an instance of <code>MongoTemplate</code>, as the following example shows:</p>
</div>
<div class="exampleblock">
<div class="title">Example 61. Registering a <code>com.mongodb.client.MongoClient</code> object and enabling Spring&#8217;s exception translation support</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Configuration
public class AppConfig {

  public @Bean MongoClient mongoClient() {
      return MongoClients.create("mongodb://localhost:27017");
  }

  public @Bean MongoTemplate mongoTemplate() {
      return new MongoTemplate(mongoClient(), "mydatabase");
  }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>There are several overloaded constructors of <code>MongoTemplate</code>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>MongoTemplate(MongoClient mongo, String databaseName)</code>: Takes the <code>MongoClient</code> object and the default database name to operate against.</p>
</li>
<li>
<p><code>MongoTemplate(MongoDatabaseFactory mongoDbFactory)</code>: Takes a MongoDbFactory object that encapsulated the <code>MongoClient</code> object, database name, and username and password.</p>
</li>
<li>
<p><code>MongoTemplate(MongoDatabaseFactory mongoDbFactory, MongoConverter mongoConverter)</code>: Adds a <code>MongoConverter</code> to use for mapping.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You can also configure a MongoTemplate by using Spring&#8217;s XML &lt;beans/&gt; schema, as the following example shows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;mongo:mongo-client host="localhost" port="27017"/&gt;

&lt;bean id="mongoTemplate" class="org.springframework.data.mongodb.core.MongoTemplate"&gt;
  &lt;constructor-arg ref="mongoClient"/&gt;
  &lt;constructor-arg name="databaseName" value="geospatial"/&gt;
&lt;/bean&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Other optional properties that you might like to set when creating a <code>MongoTemplate</code> are the default <code>WriteResultCheckingPolicy</code>, <code>WriteConcern</code>, and <code>ReadPreference</code> properties.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The preferred way to reference the operations on <code>MongoTemplate</code> instance is through its interface, <code>MongoOperations</code>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="mongo-template.writeresultchecking"><a class="anchor" href="index.html#mongo-template.writeresultchecking"></a>11.4.2. <code>WriteResultChecking</code> Policy</h4>
<div class="paragraph">
<p>When in development, it is handy to either log or throw an exception if the <code>com.mongodb.WriteResult</code> returned from any MongoDB operation contains an error. It is quite common to forget to do this during development and then end up with an application that looks like it runs successfully when, in fact, the database was not modified according to your expectations. You can set the <code>WriteResultChecking</code> property of <code>MongoTemplate</code> to one of the following values: <code>EXCEPTION</code> or <code>NONE</code>, to either throw an <code>Exception</code> or do nothing, respectively. The default is to use a <code>WriteResultChecking</code> value of <code>NONE</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="mongo-template.writeconcern"><a class="anchor" href="index.html#mongo-template.writeconcern"></a>11.4.3. <code>WriteConcern</code></h4>
<div class="paragraph">
<p>If it has not yet been specified through the driver at a higher level (such as <code>com.mongodb.client.MongoClient</code>), you can set the <code>com.mongodb.WriteConcern</code> property that the <code>MongoTemplate</code> uses for write operations. If the <code>WriteConcern</code> property is not set, it defaults to the one set in the MongoDB driver&#8217;s DB or Collection setting.</p>
</div>
</div>
<div class="sect3">
<h4 id="mongo-template.writeconcernresolver"><a class="anchor" href="index.html#mongo-template.writeconcernresolver"></a>11.4.4. <code>WriteConcernResolver</code></h4>
<div class="paragraph">
<p>For more advanced cases where you want to set different <code>WriteConcern</code> values on a per-operation basis (for remove, update, insert, and save operations), a strategy interface called <code>WriteConcernResolver</code> can be configured on <code>MongoTemplate</code>. Since <code>MongoTemplate</code> is used to persist POJOs, the <code>WriteConcernResolver</code> lets you create a policy that can map a specific POJO class to a <code>WriteConcern</code> value. The following listing shows the <code>WriteConcernResolver</code> interface:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">public interface WriteConcernResolver {
  WriteConcern resolve(MongoAction action);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can use the <code>MongoAction</code> argument to determine the <code>WriteConcern</code> value or use the value of the Template itself as a default. <code>MongoAction</code> contains the collection name being written to, the <code>java.lang.Class</code> of the POJO, the converted <code>Document</code>, the operation (<code>REMOVE</code>, <code>UPDATE</code>, <code>INSERT</code>, <code>INSERT_LIST</code>, or <code>SAVE</code>), and a few other pieces of contextual information. The following example shows two sets of classes getting different <code>WriteConcern</code> settings:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">private class MyAppWriteConcernResolver implements WriteConcernResolver {

  public WriteConcern resolve(MongoAction action) {
    if (action.getEntityClass().getSimpleName().contains("Audit")) {
      return WriteConcern.NONE;
    } else if (action.getEntityClass().getSimpleName().contains("Metadata")) {
      return WriteConcern.JOURNAL_SAFE;
    }
    return action.getDefaultWriteConcern();
  }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="mongo-template.save-update-remove"><a class="anchor" href="index.html#mongo-template.save-update-remove"></a>11.5. Saving, Updating, and Removing Documents</h3>
<div class="paragraph">
<p><code>MongoTemplate</code> lets you save, update, and delete your domain objects and map those objects to documents stored in MongoDB.</p>
</div>
<div class="paragraph">
<p>Consider the following class:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">public class Person {

  private String id;
  private String name;
  private int age;

  public Person(String name, int age) {
    this.name = name;
    this.age = age;
  }

  public String getId() {
    return id;
  }
  public String getName() {
    return name;
  }
  public int getAge() {
    return age;
  }

  @Override
  public String toString() {
    return "Person [id=" + id + ", name=" + name + ", age=" + age + "]";
  }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Given the <code>Person</code> class in the preceding example, you can save, update and delete the object, as the following example shows:</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<code>MongoOperations</code> is the interface that <code>MongoTemplate</code> implements.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">package org.spring.example;

import static org.springframework.data.mongodb.core.query.Criteria.where;
import static org.springframework.data.mongodb.core.query.Update.update;
import static org.springframework.data.mongodb.core.query.Query.query;

import java.util.List;

import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;
import org.springframework.data.mongodb.core.MongoOperations;
import org.springframework.data.mongodb.core.MongoTemplate;
import org.springframework.data.mongodb.core.SimpleMongoClientDbFactory;

import com.mongodb.client.MongoClients;

public class MongoApp {

  private static final Log log = LogFactory.getLog(MongoApp.class);

  public static void main(String[] args) {

    MongoOperations mongoOps = new MongoTemplate(new SimpleMongoClientDbFactory(MongoClients.create(), "database"));

    Person p = new Person("Joe", 34);

    // Insert is used to initially store the object into the database.
    mongoOps.insert(p);
    log.info("Insert: " + p);

    // Find
    p = mongoOps.findById(p.getId(), Person.class);
    log.info("Found: " + p);

    // Update
    mongoOps.updateFirst(query(where("name").is("Joe")), update("age", 35), Person.class);
    p = mongoOps.findOne(query(where("name").is("Joe")), Person.class);
    log.info("Updated: " + p);

    // Delete
    mongoOps.remove(p);

    // Check that deletion worked
    List&lt;Person&gt; people =  mongoOps.findAll(Person.class);
    log.info("Number of people = : " + people.size());


    mongoOps.dropCollection(Person.class);
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The preceding example would produce the following log output (including debug messages from <code>MongoTemplate</code>):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">DEBUG apping.MongoPersistentEntityIndexCreator:  80 - Analyzing class class org.spring.example.Person for index information.
DEBUG work.data.mongodb.core.MongoTemplate: 632 - insert Document containing fields: [_class, age, name] in collection: person
INFO               org.spring.example.MongoApp:  30 - Insert: Person [id=4ddc6e784ce5b1eba3ceaf5c, name=Joe, age=34]
DEBUG work.data.mongodb.core.MongoTemplate:1246 - findOne using query: { "_id" : { "$oid" : "4ddc6e784ce5b1eba3ceaf5c"}} in db.collection: database.person
INFO               org.spring.example.MongoApp:  34 - Found: Person [id=4ddc6e784ce5b1eba3ceaf5c, name=Joe, age=34]
DEBUG work.data.mongodb.core.MongoTemplate: 778 - calling update using query: { "name" : "Joe"} and update: { "$set" : { "age" : 35}} in collection: person
DEBUG work.data.mongodb.core.MongoTemplate:1246 - findOne using query: { "name" : "Joe"} in db.collection: database.person
INFO               org.spring.example.MongoApp:  39 - Updated: Person [id=4ddc6e784ce5b1eba3ceaf5c, name=Joe, age=35]
DEBUG work.data.mongodb.core.MongoTemplate: 823 - remove using query: { "id" : "4ddc6e784ce5b1eba3ceaf5c"} in collection: person
INFO               org.spring.example.MongoApp:  46 - Number of people = : 0
DEBUG work.data.mongodb.core.MongoTemplate: 376 - Dropped collection [database.person]</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>MongoConverter</code> caused implicit conversion between a <code>String</code> and an <code>ObjectId</code> stored in the database by recognizing (through convention) the <code>Id</code> property name.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The preceding example is meant to show the use of save, update, and remove operations on <code>MongoTemplate</code> and not to show complex mapping functionality.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The query syntax used in the preceding example is explained in more detail in the section &#8220;<a href="index.html#mongo.query">Querying Documents</a>&#8221;.</p>
</div>
<div class="sect3">
<h4 id="mongo-template.id-handling"><a class="anchor" href="index.html#mongo-template.id-handling"></a>11.5.1. How the <code>_id</code> Field is Handled in the Mapping Layer</h4>
<div class="paragraph">
<p>MongoDB requires that you have an <code>_id</code> field for all documents. If you do not provide one, the driver assigns an <code>ObjectId</code> with a generated value. When you use the <code>MappingMongoConverter</code>, certain rules govern how properties from the Java class are mapped to this <code>_id</code> field:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>A property or field annotated with <code>@Id</code> (<code>org.springframework.data.annotation.Id</code>) maps to the <code>_id</code> field.</p>
</li>
<li>
<p>A property or field without an annotation but named <code>id</code> maps to the <code>_id</code> field.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The following outlines what type conversion, if any, is done on the property mapped to the <code>_id</code> document field when using the <code>MappingMongoConverter</code> (the default for <code>MongoTemplate</code>).</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>If possible, an <code>id</code> property or field declared as a <code>String</code> in the Java class is converted to and stored as an <code>ObjectId</code> by using a Spring <code>Converter&lt;String, ObjectId&gt;</code>. Valid conversion rules are delegated to the MongoDB Java driver. If it cannot be converted to an <code>ObjectId</code>, then the value is stored as a string in the database.</p>
</li>
<li>
<p>An <code>id</code> property or field declared as <code>BigInteger</code> in the Java class is converted to and stored as an <code>ObjectId</code> by using a Spring <code>Converter&lt;BigInteger, ObjectId&gt;</code>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>If no field or property specified in the previous sets of rules is present in the Java class, an implicit <code>_id</code> file is generated by the driver but not mapped to a property or field of the Java class.</p>
</div>
<div class="paragraph">
<p>When querying and updating, <code>MongoTemplate</code> uses the converter that corresponds to the preceding rules for saving documents so that field names and types used in your queries can match what is in your domain classes.</p>
</div>
<div class="paragraph">
<p>Some environments require a customized approach to map <code>Id</code> values such as data stored in MongoDB that did not run through the Spring Data mapping layer. Documents can contain <code>_id</code> values that can be represented either as <code>ObjectId</code> or as <code>String</code>.
Reading documents from the store back to the domain type works just fine. Querying for documents via their <code>id</code> can be cumbersome due to the implicit <code>ObjectId</code> conversion. Therefore documents cannot be retrieved that way.
For those cases <code>@MongoId</code> provides more control over the actual id mapping attempts.</p>
</div>
<div class="exampleblock">
<div class="title">Example 62. <code>@MongoId</code> mapping</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">public class PlainStringId {
  @MongoId String id; <i class="conum" data-value="1"></i><b>(1)</b>
}

public class PlainObjectId {
  @MongoId ObjectId id; <i class="conum" data-value="2"></i><b>(2)</b>
}

public class StringToObjectId {
  @MongoId(FieldType.OBJECT_ID) String id; <i class="conum" data-value="3"></i><b>(3)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The id is treated as <code>String</code> without further conversion.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The id is treated as <code>ObjectId</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The id is treated as <code>ObjectId</code> if the given <code>String</code> is a valid <code>ObjectId</code> hex, otherwise as <code>String</code>. Corresponds to <code>@Id</code> usage.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="mongo-template.type-mapping"><a class="anchor" href="index.html#mongo-template.type-mapping"></a>11.5.2. Type Mapping</h4>
<div class="paragraph">
<p>MongoDB collections can contain documents that represent instances of a variety of types.This feature can be useful if you store a hierarchy of classes or have a class with a property of type <code>Object</code>.In the latter case, the values held inside that property have to be read in correctly when retrieving the object.Thus, we need a mechanism to store type information alongside the actual document.</p>
</div>
<div class="paragraph">
<p>To achieve that, the <code>MappingMongoConverter</code> uses a <code>MongoTypeMapper</code> abstraction with <code>DefaultMongoTypeMapper</code> as its main implementation.Its default behavior to store the fully qualified classname under <code>_class</code> inside the document.Type hints are written for top-level documents as well as for every value (if it is a complex type and a subtype of the declared property type).The following example (with a JSON representation at the end) shows how the mapping works:</p>
</div>
<div class="exampleblock">
<div class="title">Example 63. Type mapping</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">public class Sample {
  Contact value;
}

public abstract class Contact { … }

public class Person extends Contact { … }

Sample sample = new Sample();
sample.value = new Person();

mongoTemplate.save(sample);

{
  "value" : { "_class" : "com.acme.Person" },
  "_class" : "com.acme.Sample"
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Spring Data MongoDB stores the type information as the last field for the actual root class as well as for the nested type (because it is complex and a subtype of <code>Contact</code>).So, if you now use <code>mongoTemplate.findAll(Object.class, "sample")</code>, you can find out that the document stored is a <code>Sample</code> instance.You can also find out that the value property is actually a <code>Person</code>.</p>
</div>
<div class="sect4">
<h5>Customizing Type Mapping</h5>
<div class="paragraph">
<p>If you want to avoid writing the entire Java class name as type information but would rather like to use a key, you can use the <code>@TypeAlias</code> annotation on the entity class.If you need to customize the mapping even more, have a look at the <code>TypeInformationMapper</code> interface.An instance of that interface can be configured at the <code>DefaultMongoTypeMapper</code>, which can, in turn, be configured on <code>MappingMongoConverter</code>.The following example shows how to define a type alias for an entity:</p>
</div>
<div class="exampleblock">
<div class="title">Example 64. Defining a type alias for an Entity</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@TypeAlias("pers")
class Person {

}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Note that the resulting document contains <code>pers</code> as the value in the <code>_class</code> Field.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Type aliases only work if the mapping context is aware of the actual type.
The required entity metadata is determined either on first save or has to be provided via the configurations initial entity set.
By default, the configuration class scans the base package for potential candidates.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Configuration
public class AppConfig extends AbstractMongoClientConfiguration {

  @Override
  protected Set&lt;Class&lt;?&gt;&gt; getInitialEntitySet() {
    return Collections.singleton(Person.class);
  }

  // ...
}</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5>Configuring Custom Type Mapping</h5>
<div class="paragraph">
<p>The following example shows how to configure a custom <code>MongoTypeMapper</code> in <code>MappingMongoConverter</code>:</p>
</div>
<div class="exampleblock">
<div class="title">Example 65. Configuring a custom <code>MongoTypeMapper</code> with Spring Java Config</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">class CustomMongoTypeMapper extends DefaultMongoTypeMapper {
  //implement custom type mapping here
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Configuration
class SampleMongoConfiguration extends AbstractMongoClientConfiguration {

  @Override
  protected String getDatabaseName() {
    return "database";
  }

  @Bean
  @Override
  public MappingMongoConverter mappingMongoConverter() throws Exception {
    MappingMongoConverter mmc = super.mappingMongoConverter();
    mmc.setTypeMapper(customTypeMapper());
    return mmc;
  }

  @Bean
  public MongoTypeMapper customTypeMapper() {
    return new CustomMongoTypeMapper();
  }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Note that the preceding example extends the <code>AbstractMongoClientConfiguration</code> class and overrides the bean definition of the <code>MappingMongoConverter</code> where we configured our custom <code>MongoTypeMapper</code>.</p>
</div>
<div class="paragraph">
<p>The following example shows how to use XML to configure a custom <code>MongoTypeMapper</code>:</p>
</div>
<div class="exampleblock">
<div class="title">Example 66. Configuring a custom <code>MongoTypeMapper</code> with XML</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;mongo:mapping-converter type-mapper-ref="customMongoTypeMapper"/&gt;

&lt;bean name="customMongoTypeMapper" class="com.bubu.mongo.CustomMongoTypeMapper"/&gt;</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="mongo-template.save-insert"><a class="anchor" href="index.html#mongo-template.save-insert"></a>11.5.3. Methods for Saving and Inserting Documents</h4>
<div class="paragraph">
<p>There are several convenient methods on <code>MongoTemplate</code> for saving and inserting your objects. To have more fine-grained control over the conversion process, you can register Spring converters with the <code>MappingMongoConverter</code>&#8201;&#8212;&#8201;for example <code>Converter&lt;Person, Document&gt;</code> and <code>Converter&lt;Document, Person&gt;</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The difference between insert and save operations is that a save operation performs an insert if the object is not already present.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The simple case of using the save operation is to save a POJO. In this case, the collection name is determined by name (not fully qualified) of the class. You may also call the save operation with a specific collection name. You can use mapping metadata to override the collection in which to store the object.</p>
</div>
<div class="paragraph">
<p>When inserting or saving, if the <code>Id</code> property is not set, the assumption is that its value will be auto-generated by the database. Consequently, for auto-generation of an <code>ObjectId</code> to succeed, the type of the <code>Id</code> property or field in your class must be a <code>String</code>, an <code>ObjectId</code>, or a <code>BigInteger</code>.</p>
</div>
<div class="paragraph">
<p>The following example shows how to save a document and retrieving its contents:</p>
</div>
<div class="exampleblock">
<div class="title">Example 67. Inserting and retrieving documents using the MongoTemplate</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">import static org.springframework.data.mongodb.core.query.Criteria.where;
import static org.springframework.data.mongodb.core.query.Criteria.query;
…

Person p = new Person("Bob", 33);
mongoTemplate.insert(p);

Person qp = mongoTemplate.findOne(query(where("age").is(33)), Person.class);</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The following insert and save operations are available:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>void</code> <strong>save</strong> <code>(Object objectToSave)</code>: Save the object to the default collection.</p>
</li>
<li>
<p><code>void</code> <strong>save</strong> <code>(Object objectToSave, String collectionName)</code>: Save the object to the specified collection.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>A similar set of insert operations is also available:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>void</code> <strong>insert</strong> <code>(Object objectToSave)</code>: Insert the object to the default collection.</p>
</li>
<li>
<p><code>void</code> <strong>insert</strong> <code>(Object objectToSave, String collectionName)</code>: Insert the object to the specified collection.</p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="mongo-template.save-insert.collection"><a class="anchor" href="index.html#mongo-template.save-insert.collection"></a>Into Which Collection Are My Documents Saved?</h5>
<div class="paragraph">
<p>There are two ways to manage the collection name that is used for the documents. The default collection name that is used is the class name changed to start with a lower-case letter. So a <code>com.test.Person</code> class is stored in the <code>person</code> collection. You can customize this by providing a different collection name with the <code>@Document</code> annotation. You can also override the collection name by providing your own collection name as the last parameter for the selected <code>MongoTemplate</code> method calls.</p>
</div>
</div>
<div class="sect4">
<h5 id="mongo-template.save-insert.individual"><a class="anchor" href="index.html#mongo-template.save-insert.individual"></a>Inserting or Saving Individual Objects</h5>
<div class="paragraph">
<p>The MongoDB driver supports inserting a collection of documents in a single operation. The following methods in the <code>MongoOperations</code> interface support this functionality:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>insert</strong>: Inserts an object. If there is an existing document with the same <code>id</code>, an error is generated.</p>
</li>
<li>
<p><strong>insertAll</strong>: Takes a <code>Collection</code> of objects as the first parameter. This method inspects each object and inserts it into the appropriate collection, based on the rules specified earlier.</p>
</li>
<li>
<p><strong>save</strong>: Saves the object, overwriting any object that might have the same <code>id</code>.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="mongo-template.save-insert.batch"><a class="anchor" href="index.html#mongo-template.save-insert.batch"></a>Inserting Several Objects in a Batch</h5>
<div class="paragraph">
<p>The MongoDB driver supports inserting a collection of documents in one operation. The following methods in the <code>MongoOperations</code> interface support this functionality:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>insert</strong> methods: Take a <code>Collection</code> as the first argument. They insert a list of objects in a single batch write to the database.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="mongodb-template-update"><a class="anchor" href="index.html#mongodb-template-update"></a>11.5.4. Updating Documents in a Collection</h4>
<div class="paragraph">
<p>For updates, you can update the first document found by using <code>MongoOperation.updateFirst</code> or you can update all documents that were found to match the query by using the <code>MongoOperation.updateMulti</code> method. The following example shows an update of all <code>SAVINGS</code> accounts where we are adding a one-time $50.00 bonus to the balance by using the <code>$inc</code> operator:</p>
</div>
<div class="exampleblock">
<div class="title">Example 68. Updating documents by using the <code>MongoTemplate</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">import static org.springframework.data.mongodb.core.query.Criteria.where;
import static org.springframework.data.mongodb.core.query.Query;
import static org.springframework.data.mongodb.core.query.Update;

...

WriteResult wr = mongoTemplate.updateMulti(new Query(where("accounts.accountType").is(Account.Type.SAVINGS)),
  new Update().inc("accounts.$.balance", 50.00), Account.class);</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>In addition to the <code>Query</code> discussed earlier, we provide the update definition by using an <code>Update</code> object. The <code>Update</code> class has methods that match the update modifiers available for MongoDB.</p>
</div>
<div class="paragraph">
<p>Most methods return the <code>Update</code> object to provide a fluent style for the API.</p>
</div>
<div class="sect4">
<h5 id="mongodb-template-update.methods"><a class="anchor" href="index.html#mongodb-template-update.methods"></a>Methods for Running Updates for Documents</h5>
<div class="ulist">
<ul>
<li>
<p><strong>updateFirst</strong>: Updates the first document that matches the query document criteria with the updated document.</p>
</li>
<li>
<p><strong>updateMulti</strong>: Updates all objects that match the query document criteria with the updated document.</p>
</li>
</ul>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<code>updateFirst</code> does not support ordering. Please use <a href="index.html#mongo-template.find-and-upsert">findAndModify</a> to apply <code>Sort</code>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="mongodb-template-update.update"><a class="anchor" href="index.html#mongodb-template-update.update"></a>Methods in the <code>Update</code> Class</h5>
<div class="paragraph">
<p>You can use a little "'syntax sugar'" with the <code>Update</code> class, as its methods are meant to be chained together. Also, you can kick-start the creation of a new <code>Update</code> instance by using <code>public static Update update(String key, Object value)</code> and using static imports.</p>
</div>
<div class="paragraph">
<p>The <code>Update</code> class contains the following methods:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>Update</code> <strong>addToSet</strong> <code>(String key, Object value)</code> Update using the <code>$addToSet</code> update modifier</p>
</li>
<li>
<p><code>Update</code> <strong>currentDate</strong> <code>(String key)</code> Update using the <code>$currentDate</code> update modifier</p>
</li>
<li>
<p><code>Update</code> <strong>currentTimestamp</strong> <code>(String key)</code> Update using the <code>$currentDate</code> update modifier with <code>$type</code> <code>timestamp</code></p>
</li>
<li>
<p><code>Update</code> <strong>inc</strong> <code>(String key, Number inc)</code> Update using the <code>$inc</code> update modifier</p>
</li>
<li>
<p><code>Update</code> <strong>max</strong> <code>(String key, Object max)</code> Update using the <code>$max</code> update modifier</p>
</li>
<li>
<p><code>Update</code> <strong>min</strong> <code>(String key, Object min)</code> Update using the <code>$min</code> update modifier</p>
</li>
<li>
<p><code>Update</code> <strong>multiply</strong> <code>(String key, Number multiplier)</code> Update using the <code>$mul</code> update modifier</p>
</li>
<li>
<p><code>Update</code> <strong>pop</strong> <code>(String key, Update.Position pos)</code> Update using the <code>$pop</code> update modifier</p>
</li>
<li>
<p><code>Update</code> <strong>pull</strong> <code>(String key, Object value)</code> Update using the <code>$pull</code> update modifier</p>
</li>
<li>
<p><code>Update</code> <strong>pullAll</strong> <code>(String key, Object[] values)</code> Update using the <code>$pullAll</code> update modifier</p>
</li>
<li>
<p><code>Update</code> <strong>push</strong> <code>(String key, Object value)</code> Update using the <code>$push</code> update modifier</p>
</li>
<li>
<p><code>Update</code> <strong>pushAll</strong> <code>(String key, Object[] values)</code> Update using the <code>$pushAll</code> update modifier</p>
</li>
<li>
<p><code>Update</code> <strong>rename</strong> <code>(String oldName, String newName)</code> Update using the <code>$rename</code> update modifier</p>
</li>
<li>
<p><code>Update</code> <strong>set</strong> <code>(String key, Object value)</code> Update using the <code>$set</code> update modifier</p>
</li>
<li>
<p><code>Update</code> <strong>setOnInsert</strong> <code>(String key, Object value)</code> Update using the <code>$setOnInsert</code> update modifier</p>
</li>
<li>
<p><code>Update</code> <strong>unset</strong> <code>(String key)</code> Update using the <code>$unset</code> update modifier</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Some update modifiers, such as <code>$push</code> and <code>$addToSet</code>, allow nesting of additional operators.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">// { $push : { "category" : { "$each" : [ "spring" , "data" ] } } }
new Update().push("category").each("spring", "data")

// { $push : { "key" : { "$position" : 0 , "$each" : [ "Arya" , "Arry" , "Weasel" ] } } }
new Update().push("key").atPosition(Position.FIRST).each(Arrays.asList("Arya", "Arry", "Weasel"));

// { $push : { "key" : { "$slice" : 5 , "$each" : [ "Arya" , "Arry" , "Weasel" ] } } }
new Update().push("key").slice(5).each(Arrays.asList("Arya", "Arry", "Weasel"));

// { $addToSet : { "values" : { "$each" : [ "spring" , "data" , "mongodb" ] } } }
new Update().addToSet("values").each("spring", "data", "mongodb");</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="mongo-template.upserts"><a class="anchor" href="index.html#mongo-template.upserts"></a>11.5.5. &#8220;Upserting&#8221; Documents in a Collection</h4>
<div class="paragraph">
<p>Related to performing an <code>updateFirst</code> operation, you can also perform an &#8220;upsert&#8221; operation, which will perform an insert if no document is found that matches the query. The document that is inserted is a combination of the query document and the update document. The following example shows how to use the <code>upsert</code> method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">template.update(Person.class)
  .matching(query(where("ssn").is(1111).and("firstName").is("Joe").and("Fraizer").is("Update"))
  .apply(update("address", addr))
  .upsert();</code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<code>upsert</code> does not support ordering. Please use <a href="index.html#mongo-template.find-and-upsert">findAndModify</a> to apply <code>Sort</code>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="mongo-template.find-and-upsert"><a class="anchor" href="index.html#mongo-template.find-and-upsert"></a>11.5.6. Finding and Upserting Documents in a Collection</h4>
<div class="paragraph">
<p>The <code>findAndModify(…)</code> method on <code>MongoCollection</code> can update a document and return either the old or newly updated document in a single operation. <code>MongoTemplate</code> provides four <code>findAndModify</code> overloaded methods that take <code>Query</code> and <code>Update</code> classes and converts from <code>Document</code> to your POJOs:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">&lt;T&gt; T findAndModify(Query query, Update update, Class&lt;T&gt; entityClass);

&lt;T&gt; T findAndModify(Query query, Update update, Class&lt;T&gt; entityClass, String collectionName);

&lt;T&gt; T findAndModify(Query query, Update update, FindAndModifyOptions options, Class&lt;T&gt; entityClass);

&lt;T&gt; T findAndModify(Query query, Update update, FindAndModifyOptions options, Class&lt;T&gt; entityClass, String collectionName);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following example inserts a few <code>Person</code> objects into the container and performs a <code>findAndUpdate</code> operation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">template.insert(new Person("Tom", 21));
template.insert(new Person("Dick", 22));
template.insert(new Person("Harry", 23));

Query query = new Query(Criteria.where("firstName").is("Harry"));
Update update = new Update().inc("age", 1);

Person oldValue = template.update(Person.class)
  .matching(query)
  .apply(update)
  .findAndModifyValue(); // return's old person object

assertThat(oldValue.getFirstName()).isEqualTo("Harry");
assertThat(oldValue.getAge()).isEqualTo(23);

Person newValue = template.query(Person.class)
  .matching(query)
  .findOneValue();

assertThat(newValue.getAge()).isEqualTo(24);

Person newestValue = template.update(Person.class)
  .matching(query)
  .apply(update)
  .withOptions(FindAndModifyOptions.options().returnNew(true)) // Now return the newly updated document when updating
  .findAndModifyValue();

assertThat(newestValue.getAge()).isEqualTo(25);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>FindAndModifyOptions</code> method lets you set the options of <code>returnNew</code>, <code>upsert</code>, and <code>remove</code>.An example extending from the previous code snippet follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">Person upserted = template.update(Person.class)
  .matching(new Query(Criteria.where("firstName").is("Mary")))
  .apply(update)
  .withOptions(FindAndModifyOptions.options().upsert(true).returnNew(true))
  .findAndModifyValue()

assertThat(upserted.getFirstName()).isEqualTo("Mary");
assertThat(upserted.getAge()).isOne();</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="mongo-template.aggregation-update"><a class="anchor" href="index.html#mongo-template.aggregation-update"></a>11.5.7. Aggregation Pipeline Updates</h4>
<div class="paragraph">
<p>Update methods exposed by <code>MongoOperations</code> and <code>ReactiveMongoOperations</code> also accept an <a href="index.html#mongo.aggregation">Aggregation Pipeline</a> via <code>AggregationUpdate</code>.
Using <code>AggregationUpdate</code> allows leveraging <a href="https://docs.mongodb.com/manual/reference/method/db.collection.update/#update-with-aggregation-pipeline">MongoDB 4.2 aggregations</a> in an update operation.
Using aggregations in an update allows updating one or more fields by expressing multiple stages and multiple conditions with a single operation.</p>
</div>
<div class="paragraph">
<p>The update can consist of the following stages:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>AggregationUpdate.set(&#8230;&#8203;).toValue(&#8230;&#8203;)</code> &#8594; <code>$set : { &#8230;&#8203; }</code></p>
</li>
<li>
<p><code>AggregationUpdate.unset(&#8230;&#8203;)</code> &#8594; <code>$unset : [ &#8230;&#8203; ]</code></p>
</li>
<li>
<p><code>AggregationUpdate.replaceWith(&#8230;&#8203;)</code> &#8594; <code>$replaceWith : { &#8230;&#8203; }</code></p>
</li>
</ul>
</div>
<div class="exampleblock">
<div class="title">Example 69. Update Aggregation</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">AggregationUpdate update = Aggregation.newUpdate()
    .set("average").toValue(ArithmeticOperators.valueOf("tests").avg())     <i class="conum" data-value="1"></i><b>(1)</b>
    .set("grade").toValue(ConditionalOperators.switchCases(                 <i class="conum" data-value="2"></i><b>(2)</b>
        when(valueOf("average").greaterThanEqualToValue(90)).then("A"),
        when(valueOf("average").greaterThanEqualToValue(80)).then("B"),
        when(valueOf("average").greaterThanEqualToValue(70)).then("C"),
        when(valueOf("average").greaterThanEqualToValue(60)).then("D"))
        .defaultTo("F")
    );

template.update(Student.class)                                              <i class="conum" data-value="3"></i><b>(3)</b>
    .apply(update)
    .all();                                                                 <i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="javascript" class="language-javascript hljs">db.students.update(                                                         <i class="conum" data-value="3"></i><b>(3)</b>
   { },
   [
     { $set: { average : { $avg: "$tests" } } },                            <i class="conum" data-value="1"></i><b>(1)</b>
     { $set: { grade: { $switch: {                                          <i class="conum" data-value="2"></i><b>(2)</b>
                           branches: [
                               { case: { $gte: [ "$average", 90 ] }, then: "A" },
                               { case: { $gte: [ "$average", 80 ] }, then: "B" },
                               { case: { $gte: [ "$average", 70 ] }, then: "C" },
                               { case: { $gte: [ "$average", 60 ] }, then: "D" }
                           ],
                           default: "F"
     } } } }
   ],
   { multi: true }                                                          <i class="conum" data-value="4"></i><b>(4)</b>
)</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The 1st <code>$set</code> stage calculates a new field <em>average</em> based on the average of the <em>tests</em> field.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The 2nd <code>$set</code> stage calculates a new field <em>grade</em> based on the <em>average</em> field calculated by the first aggregation stage.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The pipeline is run on the <em>students</em> collection and uses <code>Student</code> for the aggregation field mapping.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Apply the update to all matching documents in the collection.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="mongo-template.find-and-replace"><a class="anchor" href="index.html#mongo-template.find-and-replace"></a>11.5.8. Finding and Replacing Documents</h4>
<div class="paragraph">
<p>The most straight forward method of replacing an entire <code>Document</code> is via its <code>id</code> using the <code>save</code> method. However this
might not always be feasible. <code>findAndReplace</code> offers an alternative that allows to identify the document to replace via
a simple query.</p>
</div>
<div class="exampleblock">
<div class="title">Example 70. Find and Replace Documents</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">Optional&lt;User&gt; result = template.update(Person.class)      <i class="conum" data-value="1"></i><b>(1)</b>
    .matching(query(where("firstame").is("Tom")))          <i class="conum" data-value="2"></i><b>(2)</b>
    .replaceWith(new Person("Dick"))
    .withOptions(FindAndReplaceOptions.options().upsert()) <i class="conum" data-value="3"></i><b>(3)</b>
    .as(User.class)                                        <i class="conum" data-value="4"></i><b>(4)</b>
    .findAndReplace();                                     <i class="conum" data-value="5"></i><b>(5)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Use the fluent update API with the domain type given for mapping the query and deriving the collection name or just use <code>MongoOperations#findAndReplace</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The actual match query mapped against the given domain type. Provide <code>sort</code>, <code>fields</code> and <code>collation</code> settings via the query.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Additional optional hook to provide options other than the defaults, like <code>upsert</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>An optional projection type used for mapping the operation result. If none given the initial domain type is used.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Trigger the actual processing. Use <code>findAndReplaceValue</code> to obtain the nullable result instead of an <code>Optional</code>.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Please note that the replacement must not hold an <code>id</code> itself as the <code>id</code> of the existing <code>Document</code> will be
carried over to the replacement by the store itself. Also keep in mind that <code>findAndReplace</code> will only replace the first
document matching the query criteria depending on a potentially given sort order.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="mongo-template.delete"><a class="anchor" href="index.html#mongo-template.delete"></a>11.5.9. Methods for Removing Documents</h4>
<div class="paragraph">
<p>You can use one of five overloaded methods to remove an object from the database:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">template.remove(tywin, "GOT");                                              <i class="conum" data-value="1"></i><b>(1)</b>

template.remove(query(where("lastname").is("lannister")), "GOT");           <i class="conum" data-value="2"></i><b>(2)</b>

template.remove(new Query().limit(3), "GOT");                               <i class="conum" data-value="3"></i><b>(3)</b>

template.findAllAndRemove(query(where("lastname").is("lannister"), "GOT");  <i class="conum" data-value="4"></i><b>(4)</b>

template.findAllAndRemove(new Query().limit(3), "GOT");                     <i class="conum" data-value="5"></i><b>(5)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Remove a single entity specified by its <code>_id</code> from the associated collection.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Remove all documents that match the criteria of the query from the <code>GOT</code> collection.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Remove the first three documents in the <code>GOT</code> collection. Unlike &lt;2&gt;, the documents to remove are identified by their <code>_id</code>, running the given query, applying <code>sort</code>, <code>limit</code>, and <code>skip</code> options first, and then removing all at once in a separate step.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Remove all documents matching the criteria of the query from the <code>GOT</code> collection. Unlike &lt;3&gt;, documents do not get deleted in a batch but one by one.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Remove the first three documents in the <code>GOT</code> collection. Unlike &lt;3&gt;, documents do not get deleted in a batch but one by one.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="mongo-template.optimistic-locking"><a class="anchor" href="index.html#mongo-template.optimistic-locking"></a>11.5.10. Optimistic Locking</h4>
<div class="paragraph">
<p>The <code>@Version</code> annotation provides syntax similar to that of JPA in the context of MongoDB and makes sure updates are only applied to documents with a matching version. Therefore, the actual value of the version property is added to the update query in such a way that the update does not have any effect if another operation altered the document in the meantime. In that case, an <code>OptimisticLockingFailureException</code> is thrown. The following example shows these features:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Document
class Person {

  @Id String id;
  String firstname;
  String lastname;
  @Version Long version;
}

Person daenerys = template.insert(new Person("Daenerys"));                            <i class="conum" data-value="1"></i><b>(1)</b>

Person tmp = template.findOne(query(where("id").is(daenerys.getId())), Person.class); <i class="conum" data-value="2"></i><b>(2)</b>

daenerys.setLastname("Targaryen");
template.save(daenerys);                                                              <i class="conum" data-value="3"></i><b>(3)</b>

template.save(tmp); // throws OptimisticLockingFailureException                       <i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Intially insert document. <code>version</code> is set to <code>0</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Load the just inserted document. <code>version</code> is still <code>0</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Update the document with <code>version = 0</code>. Set the <code>lastname</code> and bump <code>version</code> to <code>1</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Try to update the previously loaded document that still has <code>version = 0</code>. The operation fails with an <code>OptimisticLockingFailureException</code>, as the current <code>version</code> is <code>1</code>.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Optimistic Locking requires to set the <code>WriteConcern</code> to <code>ACKNOWLEDGED</code>. Otherwise <code>OptimisticLockingFailureException</code> can be silently swallowed.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
As of Version 2.2 <code>MongoOperations</code> also includes the <code>@Version</code> property when removing an entity from the database.
To remove a <code>Document</code> without version check use <code>MongoOperations#remove(Query,&#8230;&#8203;)</code> instead of <code>MongoOperations#remove(Object)</code>.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
As of Version 2.2 repositories check for the outcome of acknowledged deletes when removing versioned entities.
An <code>OptimisticLockingFailureException</code> is raised if a versioned entity cannot be deleted through <code>CrudRepository.delete(Object)</code>. In such case, the version was changed or the object was deleted in the meantime. Use <code>CrudRepository.deleteById(ID)</code> to bypass optimistic locking functionality and delete objects regardless of their version.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="mongo.query"><a class="anchor" href="index.html#mongo.query"></a>11.6. Querying Documents</h3>
<div class="paragraph">
<p>You can use the <code>Query</code> and <code>Criteria</code> classes to express your queries.They have method names that mirror the native MongoDB operator names, such as <code>lt</code>, <code>lte</code>, <code>is</code>, and others.The <code>Query</code> and <code>Criteria</code> classes follow a fluent API style so that you can chain together multiple method criteria and queries while having easy-to-understand code.To improve readability, static imports let you avoid using the 'new' keyword for creating <code>Query</code> and <code>Criteria</code> instances.You can also use <code>BasicQuery</code> to create <code>Query</code> instances from plain JSON Strings, as shown in the following example:</p>
</div>
<div class="exampleblock">
<div class="title">Example 71. Creating a Query instance from a plain JSON String</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">BasicQuery query = new BasicQuery("{ age : { $lt : 50 }, accounts.balance : { $gt : 1000.00 }}");
List&lt;Person&gt; result = mongoTemplate.find(query, Person.class);</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Spring MongoDB also supports GeoSpatial queries (see the <a href="index.html#mongo.geospatial">GeoSpatial Queries</a> section) and Map-Reduce operations (see the <a href="index.html#mongo.mapreduce">Map-Reduce</a> section.).</p>
</div>
<div class="sect3">
<h4 id="mongodb-template-query"><a class="anchor" href="index.html#mongodb-template-query"></a>11.6.1. Querying Documents in a Collection</h4>
<div class="paragraph">
<p>Earlier, we saw how to retrieve a single document by using the <code>findOne</code> and <code>findById</code> methods on <code>MongoTemplate</code>. These methods return a single domain object. We can also query for a collection of documents to be returned as a list of domain objects. Assuming that we have a number of <code>Person</code> objects with name and age stored as documents in a collection and that each person has an embedded account document with a balance, we can now run a query using the following code:</p>
</div>
<div class="exampleblock">
<div class="title">Example 72. Querying for documents using the MongoTemplate</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">import static org.springframework.data.mongodb.core.query.Criteria.where;
import static org.springframework.data.mongodb.core.query.Query.query;

// ...

List&lt;Person&gt; result = template.query(Person.class)
  .matching(query(where("age").lt(50).and("accounts.balance").gt(1000.00d)))
  .all();</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>All find methods take a <code>Query</code> object as a parameter. This object defines the criteria and options used to perform the query. The criteria are specified by using a <code>Criteria</code> object that has a static factory method named <code>where</code> to instantiate a new <code>Criteria</code> object. We recommend using static imports for <code>org.springframework.data.mongodb.core.query.Criteria.where</code> and <code>Query.query</code> to make the query more readable.</p>
</div>
<div class="paragraph">
<p>The query should return a list of <code>Person</code> objects that meet the specified criteria. The rest of this section lists the methods of the <code>Criteria</code> and <code>Query</code> classes that correspond to the operators provided in MongoDB. Most methods return the <code>Criteria</code> object, to provide a fluent style for the API.</p>
</div>
<div class="sect4">
<h5 id="mongodb-template-query.criteria"><a class="anchor" href="index.html#mongodb-template-query.criteria"></a>Methods for the Criteria Class</h5>
<div class="paragraph">
<p>The <code>Criteria</code> class provides the following methods, all of which correspond to operators in MongoDB:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>Criteria</code> <strong>all</strong> <code>(Object o)</code> Creates a criterion using the <code>$all</code> operator</p>
</li>
<li>
<p><code>Criteria</code> <strong>and</strong> <code>(String key)</code> Adds a chained <code>Criteria</code> with the specified <code>key</code> to the current <code>Criteria</code> and returns the newly created one</p>
</li>
<li>
<p><code>Criteria</code> <strong>andOperator</strong> <code>(Criteria&#8230;&#8203; criteria)</code> Creates an and query using the <code>$and</code> operator for all of the provided criteria (requires MongoDB 2.0 or later)</p>
</li>
<li>
<p><code>Criteria</code> <strong>elemMatch</strong> <code>(Criteria c)</code> Creates a criterion using the <code>$elemMatch</code> operator</p>
</li>
<li>
<p><code>Criteria</code> <strong>exists</strong> <code>(boolean b)</code> Creates a criterion using the <code>$exists</code> operator</p>
</li>
<li>
<p><code>Criteria</code> <strong>gt</strong> <code>(Object o)</code> Creates a criterion using the <code>$gt</code> operator</p>
</li>
<li>
<p><code>Criteria</code> <strong>gte</strong> <code>(Object o)</code> Creates a criterion using the <code>$gte</code> operator</p>
</li>
<li>
<p><code>Criteria</code> <strong>in</strong> <code>(Object&#8230;&#8203; o)</code> Creates a criterion using the <code>$in</code> operator for a varargs argument.</p>
</li>
<li>
<p><code>Criteria</code> <strong>in</strong> <code>(Collection&lt;?&gt; collection)</code> Creates a criterion using the <code>$in</code> operator using a collection</p>
</li>
<li>
<p><code>Criteria</code> <strong>is</strong> <code>(Object o)</code> Creates a criterion using field matching (<code>{ key:value }</code>). If the specified value is a document, the order of the fields and exact equality in the document matters.</p>
</li>
<li>
<p><code>Criteria</code> <strong>lt</strong> <code>(Object o)</code> Creates a criterion using the <code>$lt</code> operator</p>
</li>
<li>
<p><code>Criteria</code> <strong>lte</strong> <code>(Object o)</code> Creates a criterion using the <code>$lte</code> operator</p>
</li>
<li>
<p><code>Criteria</code> <strong>mod</strong> <code>(Number value, Number remainder)</code> Creates a criterion using the <code>$mod</code> operator</p>
</li>
<li>
<p><code>Criteria</code> <strong>ne</strong> <code>(Object o)</code> Creates a criterion using the <code>$ne</code> operator</p>
</li>
<li>
<p><code>Criteria</code> <strong>nin</strong> <code>(Object&#8230;&#8203; o)</code> Creates a criterion using the <code>$nin</code> operator</p>
</li>
<li>
<p><code>Criteria</code> <strong>norOperator</strong> <code>(Criteria&#8230;&#8203; criteria)</code> Creates an nor query using the <code>$nor</code> operator for all of the provided criteria</p>
</li>
<li>
<p><code>Criteria</code> <strong>not</strong> <code>()</code> Creates a criterion using the <code>$not</code> meta operator which affects the clause directly following</p>
</li>
<li>
<p><code>Criteria</code> <strong>orOperator</strong> <code>(Criteria&#8230;&#8203; criteria)</code> Creates an or query using the <code>$or</code> operator for all of the provided criteria</p>
</li>
<li>
<p><code>Criteria</code> <strong>regex</strong> <code>(String re)</code> Creates a criterion using a <code>$regex</code></p>
</li>
<li>
<p><code>Criteria</code> <strong>size</strong> <code>(int s)</code> Creates a criterion using the <code>$size</code> operator</p>
</li>
<li>
<p><code>Criteria</code> <strong>type</strong> <code>(int t)</code> Creates a criterion using the <code>$type</code> operator</p>
</li>
<li>
<p><code>Criteria</code> <strong>matchingDocumentStructure</strong> <code>(MongoJsonSchema schema)</code> Creates a criterion using the <code>$jsonSchema</code> operator for <a href="index.html#mongo.jsonSchema">JSON schema criteria</a>. <code>$jsonSchema</code> can only be applied on the top level of a query and not property specific. Use the <code>properties</code> attribute of the schema to match against nested fields.</p>
</li>
<li>
<p><code>Criteria</code> <strong>bits()</strong> is the gateway to <a href="https://docs.mongodb.com/manual/reference/operator/query-bitwise/">MongoDB bitwise query operators</a> like <code>$bitsAllClear</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The Criteria class also provides the following methods for geospatial queries (see the <a href="index.html#mongo.geospatial">GeoSpatial Queries</a> section to see them in action):</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>Criteria</code> <strong>within</strong> <code>(Circle circle)</code> Creates a geospatial criterion using <code>$geoWithin $center</code> operators.</p>
</li>
<li>
<p><code>Criteria</code> <strong>within</strong> <code>(Box box)</code> Creates a geospatial criterion using a <code>$geoWithin $box</code> operation.</p>
</li>
<li>
<p><code>Criteria</code> <strong>withinSphere</strong> <code>(Circle circle)</code> Creates a geospatial criterion using <code>$geoWithin $center</code> operators.</p>
</li>
<li>
<p><code>Criteria</code> <strong>near</strong> <code>(Point point)</code> Creates a geospatial criterion using a <code>$near</code> operation</p>
</li>
<li>
<p><code>Criteria</code> <strong>nearSphere</strong> <code>(Point point)</code> Creates a geospatial criterion using <code>$nearSphere$center</code> operations. This is only available for MongoDB 1.7 and higher.</p>
</li>
<li>
<p><code>Criteria</code> <strong>minDistance</strong> <code>(double minDistance)</code> Creates a geospatial criterion using the <code>$minDistance</code> operation, for use with $near.</p>
</li>
<li>
<p><code>Criteria</code> <strong>maxDistance</strong> <code>(double maxDistance)</code> Creates a geospatial criterion using the <code>$maxDistance</code> operation, for use with $near.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="mongodb-template-query.query"><a class="anchor" href="index.html#mongodb-template-query.query"></a>Methods for the Query class</h5>
<div class="paragraph">
<p>The <code>Query</code> class has some additional methods that provide options for the query:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>Query</code> <strong>addCriteria</strong> <code>(Criteria criteria)</code> used to add additional criteria to the query</p>
</li>
<li>
<p><code>Field</code> <strong>fields</strong> <code>()</code> used to define fields to be included in the query results</p>
</li>
<li>
<p><code>Query</code> <strong>limit</strong> <code>(int limit)</code> used to limit the size of the returned results to the provided limit (used for paging)</p>
</li>
<li>
<p><code>Query</code> <strong>skip</strong> <code>(int skip)</code> used to skip the provided number of documents in the results (used for paging)</p>
</li>
<li>
<p><code>Query</code> <strong>with</strong> <code>(Sort sort)</code> used to provide sort definition for the results</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="mongo-template.querying"><a class="anchor" href="index.html#mongo-template.querying"></a>11.6.2. Methods for Querying for Documents</h4>
<div class="paragraph">
<p>The query methods need to specify the target type <code>T</code> that is returned, and they are overloaded with an explicit collection name for queries that should operate on a collection other than the one indicated by the return type. The following query methods let you find one or more documents:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>findAll</strong>: Query for a list of objects of type <code>T</code> from the collection.</p>
</li>
<li>
<p><strong>findOne</strong>: Map the results of an ad-hoc query on the collection to a single instance of an object of the specified type.</p>
</li>
<li>
<p><strong>findById</strong>: Return an object of the given ID and target class.</p>
</li>
<li>
<p><strong>find</strong>: Map the results of an ad-hoc query on the collection to a <code>List</code> of the specified type.</p>
</li>
<li>
<p><strong>findAndRemove</strong>: Map the results of an ad-hoc query on the collection to a single instance of an object of the specified type. The first document that matches the query is returned and removed from the collection in the database.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="mongo-template.query.distinct"><a class="anchor" href="index.html#mongo-template.query.distinct"></a>11.6.3. Query Distinct Values</h4>
<div class="paragraph">
<p>MongoDB provides an operation to obtain distinct values for a single field by using a query from the resulting documents.
Resulting values are not required to have the same data type, nor is the feature limited to simple types.
For retrieval, the actual result type does matter for the sake of conversion and typing. The following example shows how to query for distinct values:</p>
</div>
<div class="exampleblock">
<div class="title">Example 73. Retrieving distinct values</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">template.query(Person.class)  <i class="conum" data-value="1"></i><b>(1)</b>
  .distinct("lastname")       <i class="conum" data-value="2"></i><b>(2)</b>
  .all();                     <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Query the <code>Person</code> collection.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Select distinct values of the <code>lastname</code> field. The field name is mapped according to the domain types property declaration, taking potential <code>@Field</code> annotations into account.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Retrieve all distinct values as a <code>List</code> of <code>Object</code> (due to no explicit result type being specified).</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>Retrieving distinct values into a <code>Collection</code> of <code>Object</code> is the most flexible way, as it tries to determine the property value of the domain type and convert results to the desired type or mapping <code>Document</code> structures.</p>
</div>
<div class="paragraph">
<p>Sometimes, when all values of the desired field are fixed to a certain type, it is more convenient to directly obtain a correctly typed <code>Collection</code>, as shown in the following example:</p>
</div>
<div class="exampleblock">
<div class="title">Example 74. Retrieving strongly typed distinct values</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">template.query(Person.class)  <i class="conum" data-value="1"></i><b>(1)</b>
  .distinct("lastname")       <i class="conum" data-value="2"></i><b>(2)</b>
  .as(String.class)           <i class="conum" data-value="3"></i><b>(3)</b>
  .all();                     <i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Query the collection of <code>Person</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Select distinct values of the <code>lastname</code> field. The fieldname is mapped according to the domain types property declaration, taking potential <code>@Field</code> annotations into account.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Retrieved values are converted into the desired target type&#8201;&#8212;&#8201;in this case, <code>String</code>. It is also possible to map the values to a more complex type if the stored field contains a document.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Retrieve all distinct values as a <code>List</code> of <code>String</code>. If the type cannot be converted into the desired target type, this method throws a <code>DataAccessException</code>.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="mongo.geospatial"><a class="anchor" href="index.html#mongo.geospatial"></a>11.6.4. GeoSpatial Queries</h4>
<div class="paragraph">
<p>MongoDB supports GeoSpatial queries through the use of operators such as <code>$near</code>, <code>$within</code>, <code>geoWithin</code>, and <code>$nearSphere</code>. Methods specific to geospatial queries are available on the <code>Criteria</code> class. There are also a few shape classes (<code>Box</code>, <code>Circle</code>, and <code>Point</code>) that are used in conjunction with geospatial related <code>Criteria</code> methods.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Using GeoSpatial queries requires attention when used within MongoDB transactions, see <a href="index.html#mongo.transactions.behavior">Special behavior inside transactions</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To understand how to perform GeoSpatial queries, consider the following <code>Venue</code> class (taken from the integration tests and relying on the rich <code>MappingMongoConverter</code>):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Document(collection="newyork")
public class Venue {

  @Id
  private String id;
  private String name;
  private double[] location;

  @PersistenceConstructor
  Venue(String name, double[] location) {
    super();
    this.name = name;
    this.location = location;
  }

  public Venue(String name, double x, double y) {
    super();
    this.name = name;
    this.location = new double[] { x, y };
  }

  public String getName() {
    return name;
  }

  public double[] getLocation() {
    return location;
  }

  @Override
  public String toString() {
    return "Venue [id=" + id + ", name=" + name + ", location="
        + Arrays.toString(location) + "]";
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>To find locations within a <code>Circle</code>, you can use the following query:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">Circle circle = new Circle(-73.99171, 40.738868, 0.01);
List&lt;Venue&gt; venues =
    template.find(new Query(Criteria.where("location").within(circle)), Venue.class);</code></pre>
</div>
</div>
<div class="paragraph">
<p>To find venues within a <code>Circle</code> using spherical coordinates, you can use the following query:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">Circle circle = new Circle(-73.99171, 40.738868, 0.003712240453784);
List&lt;Venue&gt; venues =
    template.find(new Query(Criteria.where("location").withinSphere(circle)), Venue.class);</code></pre>
</div>
</div>
<div class="paragraph">
<p>To find venues within a <code>Box</code>, you can use the following query:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">//lower-left then upper-right
Box box = new Box(new Point(-73.99756, 40.73083), new Point(-73.988135, 40.741404));
List&lt;Venue&gt; venues =
    template.find(new Query(Criteria.where("location").within(box)), Venue.class);</code></pre>
</div>
</div>
<div class="paragraph">
<p>To find venues near a <code>Point</code>, you can use the following queries:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">Point point = new Point(-73.99171, 40.738868);
List&lt;Venue&gt; venues =
    template.find(new Query(Criteria.where("location").near(point).maxDistance(0.01)), Venue.class);</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">Point point = new Point(-73.99171, 40.738868);
List&lt;Venue&gt; venues =
    template.find(new Query(Criteria.where("location").near(point).minDistance(0.01).maxDistance(100)), Venue.class);</code></pre>
</div>
</div>
<div class="paragraph">
<p>To find venues near a <code>Point</code> using spherical coordinates, you can use the following query:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">Point point = new Point(-73.99171, 40.738868);
List&lt;Venue&gt; venues =
    template.find(new Query(
        Criteria.where("location").nearSphere(point).maxDistance(0.003712240453784)),
        Venue.class);</code></pre>
</div>
</div>
<div class="sect4">
<h5 id="mongo.geo-near"><a class="anchor" href="index.html#mongo.geo-near"></a>Geo-near Queries</h5>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p><strong>Changed in 2.2!</strong><br>
<a href="https://docs.mongodb.com/master/release-notes/4.2-compatibility/">MongoDB 4.2</a> removed support for the
<code>geoNear</code> command which had been previously used to run the <code>NearQuery</code>.</p>
</div>
<div class="paragraph">
<p>Spring Data MongoDB 2.2 <code>MongoOperations#geoNear</code> uses the <code>$geoNear</code> <a href="https://docs.mongodb.com/manual/reference/operator/aggregation/geoNear/">aggregation</a>
instead of the <code>geoNear</code> command to run a <code>NearQuery</code>.</p>
</div>
<div class="paragraph">
<p>The calculated distance (the <code>dis</code> when using a geoNear command) previously returned within a wrapper type now is embedded
into the resulting document.
If the given domain type already contains a property with that name, the calculated distance
is named <code>calculated-distance</code> with a potentially random postfix.</p>
</div>
<div class="paragraph">
<p>Target types may contain a property named after the returned distance to (additionally) read it back directly into the domain type as shown below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">GeoResults&lt;VenueWithDisField&gt; = template.query(Venue.class) <i class="conum" data-value="1"></i><b>(1)</b>
    .as(VenueWithDisField.class)                            <i class="conum" data-value="2"></i><b>(2)</b>
    .near(NearQuery.near(new GeoJsonPoint(-73.99, 40.73), KILOMETERS))
    .all();</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Domain type used to identify the target collection and potential query mapping.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Target type containing a <code>dis</code> field of type <code>Number</code>.</td>
</tr>
</table>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>MongoDB supports querying the database for geo locations and calculating the distance from a given origin at the same time. With geo-near queries, you can express queries such as "find all restaurants in the surrounding 10 miles". To let you do so, <code>MongoOperations</code> provides <code>geoNear(…)</code> methods that take a <code>NearQuery</code> as an argument (as well as the already familiar entity type and collection), as shown in the following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">Point location = new Point(-73.99171, 40.738868);
NearQuery query = NearQuery.near(location).maxDistance(new Distance(10, Metrics.MILES));

GeoResults&lt;Restaurant&gt; = operations.geoNear(query, Restaurant.class);</code></pre>
</div>
</div>
<div class="paragraph">
<p>We use the <code>NearQuery</code> builder API to set up a query to return all <code>Restaurant</code> instances surrounding the given <code>Point</code> out to 10 miles. The <code>Metrics</code> enum used here actually implements an interface so that other metrics could be plugged into a distance as well. A <code>Metric</code> is backed by a multiplier to transform the distance value of the given metric into native distances. The sample shown here would consider the 10 to be miles. Using one of the built-in metrics (miles and kilometers) automatically triggers the spherical flag to be set on the query. If you want to avoid that, pass plain <code>double</code> values into <code>maxDistance(…)</code>. For more information, see the <a href="../../../3.1.1/api/index.html">JavaDoc</a> of <code>NearQuery</code> and <code>Distance</code>.</p>
</div>
<div class="paragraph">
<p>The geo-near operations return a <code>GeoResults</code> wrapper object that encapsulates <code>GeoResult</code> instances. Wrapping <code>GeoResults</code> allows accessing the average distance of all results. A single <code>GeoResult</code> object carries the entity found plus its distance from the origin.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="mongo.geo-json"><a class="anchor" href="index.html#mongo.geo-json"></a>11.6.5. GeoJSON Support</h4>
<div class="paragraph">
<p>MongoDB supports <a href="https://geojson.org/">GeoJSON</a> and simple (legacy) coordinate pairs for geospatial data. Those formats can both be used for storing as well as querying data. See the <a href="https://docs.mongodb.org/manual/core/2dsphere/#geospatial-indexes-store-geojson/">MongoDB manual on GeoJSON support</a> to learn about requirements and restrictions.</p>
</div>
<div class="sect4">
<h5>GeoJSON Types in Domain Classes</h5>
<div class="paragraph">
<p>Usage of <a href="https://geojson.org/">GeoJSON</a> types in domain classes is straightforward. The <code>org.springframework.data.mongodb.core.geo</code> package contains types such as <code>GeoJsonPoint</code>, <code>GeoJsonPolygon</code>, and others. These types are extend the existing <code>org.springframework.data.geo</code> types. The following example uses a <code>GeoJsonPoint</code>:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">public class Store {

	String id;

	/**
	 * location is stored in GeoJSON format.
	 * {
	 *   "type" : "Point",
	 *   "coordinates" : [ x, y ]
	 * }
	 */
	GeoJsonPoint location;
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5>GeoJSON Types in Repository Query Methods</h5>
<div class="paragraph">
<p>Using GeoJSON types as repository query parameters forces usage of the <code>$geometry</code> operator when creating the query, as the following example shows:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">public interface StoreRepository extends CrudRepository&lt;Store, String&gt; {

	List&lt;Store&gt; findByLocationWithin(Polygon polygon);  <i class="conum" data-value="1"></i><b>(1)</b>

}

/*
 * {
 *   "location": {
 *     "$geoWithin": {
 *       "$geometry": {
 *         "type": "Polygon",
 *         "coordinates": [
 *           [
 *             [-73.992514,40.758934],
 *             [-73.961138,40.760348],
 *             [-73.991658,40.730006],
 *             [-73.992514,40.758934]
 *           ]
 *         ]
 *       }
 *     }
 *   }
 * }
 */
repo.findByLocationWithin(                              <i class="conum" data-value="2"></i><b>(2)</b>
  new GeoJsonPolygon(
    new Point(-73.992514, 40.758934),
    new Point(-73.961138, 40.760348),
    new Point(-73.991658, 40.730006),
    new Point(-73.992514, 40.758934)));                 <i class="conum" data-value="3"></i><b>(3)</b>

/*
 * {
 *   "location" : {
 *     "$geoWithin" : {
 *        "$polygon" : [ [-73.992514,40.758934] , [-73.961138,40.760348] , [-73.991658,40.730006] ]
 *     }
 *   }
 * }
 */
repo.findByLocationWithin(                              <i class="conum" data-value="4"></i><b>(4)</b>
  new Polygon(
    new Point(-73.992514, 40.758934),
    new Point(-73.961138, 40.760348),
    new Point(-73.991658, 40.730006)));</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Repository method definition using the commons type allows calling it with both the GeoJSON and the legacy format.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Use GeoJSON type to make use of <code>$geometry</code> operator.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Note that GeoJSON polygons need to define a closed ring.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Use the legacy format <code>$polygon</code> operator.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5>Metrics and Distance calculation</h5>
<div class="paragraph">
<p>Then MongoDB <code>$geoNear</code> operator allows usage of a GeoJSON Point or legacy coordinate pairs.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">NearQuery.near(new Point(-73.99171, 40.738868))</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="json" class="language-json hljs">{
  "$geoNear": {
    //...
    "near": [-73.99171, 40.738868]
  }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">NearQuery.near(new GeoJsonPoint(-73.99171, 40.738868))</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="json" class="language-json hljs">{
  "$geoNear": {
    //...
    "near": { "type": "Point", "coordinates": [-73.99171, 40.738868] }
  }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Though syntactically different the server is fine accepting both no matter what format the target Document within the collection
is using.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
There is a huge difference in the distance calculation. Using the legacy format operates
upon <em>Radians</em> on an Earth like sphere, whereas the GeoJSON format uses <em>Meters</em>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To avoid a serious headache make sure to set the <code>Metric</code> to the desired unit of measure which ensures the
distance to be calculated correctly.</p>
</div>
<div class="paragraph">
<p>In other words:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p>Assume you&#8217;ve got 5 Documents like the ones below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="json" class="language-json hljs">{
    "_id" : ObjectId("5c10f3735d38908db52796a5"),
    "name" : "Penn Station",
    "location" : { "type" : "Point", "coordinates" : [  -73.99408, 40.75057 ] }
}
{
    "_id" : ObjectId("5c10f3735d38908db52796a6"),
    "name" : "10gen Office",
    "location" : { "type" : "Point", "coordinates" : [ -73.99171, 40.738868 ] }
}
{
    "_id" : ObjectId("5c10f3735d38908db52796a9"),
    "name" : "City Bakery ",
    "location" : { "type" : "Point", "coordinates" : [ -73.992491, 40.738673 ] }
}
{
    "_id" : ObjectId("5c10f3735d38908db52796aa"),
    "name" : "Splash Bar",
    "location" : { "type" : "Point", "coordinates" : [ -73.992491, 40.738673 ] }
}
{
    "_id" : ObjectId("5c10f3735d38908db52796ab"),
    "name" : "Momofuku Milk Bar",
    "location" : { "type" : "Point", "coordinates" : [ -73.985839, 40.731698 ] }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Fetching all Documents within a 400 Meter radius from <code>[-73.99171, 40.738868]</code> would look like this using
GeoJSON:</p>
</div>
<div class="exampleblock">
<div class="title">Example 75. GeoNear with GeoJSON</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="json" class="language-json hljs">{
    "$geoNear": {
        "maxDistance": 400, <i class="conum" data-value="1"></i><b>(1)</b>
        "num": 10,
        "near": { type: "Point", coordinates: [-73.99171, 40.738868] },
        "spherical":true, <i class="conum" data-value="2"></i><b>(2)</b>
        "key": "location",
        "distanceField": "distance"
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Returning the following 3 Documents:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="json" class="language-json hljs">{
    "_id" : ObjectId("5c10f3735d38908db52796a6"),
    "name" : "10gen Office",
    "location" : { "type" : "Point", "coordinates" : [ -73.99171, 40.738868 ] }
    "distance" : 0.0 <i class="conum" data-value="3"></i><b>(3)</b>
}
{
    "_id" : ObjectId("5c10f3735d38908db52796a9"),
    "name" : "City Bakery ",
    "location" : { "type" : "Point", "coordinates" : [ -73.992491, 40.738673 ] }
    "distance" : 69.3582262492474 <i class="conum" data-value="3"></i><b>(3)</b>
}
{
    "_id" : ObjectId("5c10f3735d38908db52796aa"),
    "name" : "Splash Bar",
    "location" : { "type" : "Point", "coordinates" : [ -73.992491, 40.738673 ] }
    "distance" : 69.3582262492474 <i class="conum" data-value="3"></i><b>(3)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Maximum distance from center point in <em>Meters</em>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>GeoJSON always operates upon a sphere.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Distance from center point in <em>Meters</em>.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>Now, when using legacy coordinate pairs one operates upon <em>Radians</em> as discussed before. So we use <code>Metrics#KILOMETERS
when constructing the `$geoNear</code> command. The <code>Metric</code> makes sure the distance multiplier is set correctly.</p>
</div>
<div class="exampleblock">
<div class="title">Example 76. GeoNear with Legacy Coordinate Pairs</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="json" class="language-json hljs">{
    "$geoNear": {
        "maxDistance": 0.0000627142377, <i class="conum" data-value="1"></i><b>(1)</b>
        "distanceMultiplier": 6378.137, <i class="conum" data-value="2"></i><b>(2)</b>
        "num": 10,
        "near": [-73.99171, 40.738868],
        "spherical":true, <i class="conum" data-value="3"></i><b>(3)</b>
        "key": "location",
        "distanceField": "distance"
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Returning the 3 Documents just like the GeoJSON variant:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="json" class="language-json hljs">{
    "_id" : ObjectId("5c10f3735d38908db52796a6"),
    "name" : "10gen Office",
    "location" : { "type" : "Point", "coordinates" : [ -73.99171, 40.738868 ] }
    "distance" : 0.0 <i class="conum" data-value="4"></i><b>(4)</b>
}
{
    "_id" : ObjectId("5c10f3735d38908db52796a9"),
    "name" : "City Bakery ",
    "location" : { "type" : "Point", "coordinates" : [ -73.992491, 40.738673 ] }
    "distance" : 0.0693586286032982 <i class="conum" data-value="4"></i><b>(4)</b>
}
{
    "_id" : ObjectId("5c10f3735d38908db52796aa"),
    "name" : "Splash Bar",
    "location" : { "type" : "Point", "coordinates" : [ -73.992491, 40.738673 ] }
    "distance" : 0.0693586286032982 <i class="conum" data-value="4"></i><b>(4)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Maximum distance from center point in <em>Radians</em>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The distance multiplier so we get <em>Kilometers</em> as resulting distance.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Make sure we operate on a 2d_sphere index.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Distance from center point in <em>Kilometers</em> - take it times 1000 to match <em>Meters</em> of the GeoJSON variant.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="mongo.textsearch"><a class="anchor" href="index.html#mongo.textsearch"></a>11.6.6. Full-text Queries</h4>
<div class="paragraph">
<p>Since version 2.6 of MongoDB, you can run full-text queries by using the <code>$text</code> operator. Methods and operations specific to full-text queries are available in <code>TextQuery</code> and <code>TextCriteria</code>. When doing full text search, see the <a href="https://docs.mongodb.org/manual/reference/operator/query/text/#behavior">MongoDB reference</a> for its behavior and limitations.</p>
</div>
<div class="sect4">
<h5>Full-text Search</h5>
<div class="paragraph">
<p>Before you can actually use full-text search, you must set up the search index correctly. See <a href="index.html#mapping-usage-indexes.text-index">Text Index</a> for more detail on how to create index structures. The following example shows how to set up a full-text search:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="javascript" class="language-javascript hljs">db.foo.createIndex(
{
  title : "text",
  content : "text"
},
{
  weights : {
              title : 3
            }
}
)</code></pre>
</div>
</div>
<div class="paragraph">
<p>A query searching for <code>coffee cake</code> can be defined and run as follows:</p>
</div>
<div class="exampleblock">
<div class="title">Example 77. Full Text Query</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">Query query = TextQuery
  .searching(new TextCriteria().matchingAny("coffee", "cake"));

List&lt;Document&gt; page = template.find(query, Document.class);</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>To sort results by relevance according to the <code>weights</code> use <code>TextQuery.sortByScore</code>.</p>
</div>
<div class="exampleblock">
<div class="title">Example 78. Full Text Query - Sort by Score</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">Query query = TextQuery
  .searching(new TextCriteria().matchingAny("coffee", "cake"))
  .sortByScore() <i class="conum" data-value="1"></i><b>(1)</b>
  .includeScore(); <i class="conum" data-value="2"></i><b>(2)</b>

List&lt;Document&gt; page = template.find(query, Document.class);</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Use the score property for sorting results by relevance which triggers <code>.sort({'score': {'$meta': 'textScore'}})</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Use <code>TextQuery.includeScore()</code> to include the calculated relevance in the resulting <code>Document</code>.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>You can exclude search terms by prefixing the term with <code>-</code> or by using <code>notMatching</code>, as shown in the following example (note that the two lines have the same effect and are thus redundant):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">// search for 'coffee' and not 'cake'
TextQuery.searching(new TextCriteria().matching("coffee").matching("-cake"));
TextQuery.searching(new TextCriteria().matching("coffee").notMatching("cake"));</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>TextCriteria.matching</code> takes the provided term as is. Therefore, you can define phrases by putting them between double quotation marks (for example, <code>\"coffee cake\")</code> or using by <code>TextCriteria.phrase.</code> The following example shows both ways of defining a phrase:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">// search for phrase 'coffee cake'
TextQuery.searching(new TextCriteria().matching("\"coffee cake\""));
TextQuery.searching(new TextCriteria().phrase("coffee cake"));</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can set flags for <code>$caseSensitive</code> and <code>$diacriticSensitive</code> by using the corresponding methods on <code>TextCriteria</code>. Note that these two optional flags have been introduced in MongoDB 3.2 and are not included in the query unless explicitly set.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="mongo.collation"><a class="anchor" href="index.html#mongo.collation"></a>11.6.7. Collations</h4>
<div class="paragraph">
<p>Since version 3.4, MongoDB supports collations for collection and index creation and various query operations. Collations define string comparison rules based on the <a href="http://userguide.icu-project.org/collation/concepts">ICU collations</a>. A collation document consists of various properties that are encapsulated in <code>Collation</code>, as the following listing shows:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">Collation collation = Collation.of("fr")         <i class="conum" data-value="1"></i><b>(1)</b>

  .strength(ComparisonLevel.secondary()          <i class="conum" data-value="2"></i><b>(2)</b>
    .includeCase())

  .numericOrderingEnabled()                      <i class="conum" data-value="3"></i><b>(3)</b>

  .alternate(Alternate.shifted().punct())        <i class="conum" data-value="4"></i><b>(4)</b>

  .forwardDiacriticSort()                        <i class="conum" data-value="5"></i><b>(5)</b>

  .normalizationEnabled();                       <i class="conum" data-value="6"></i><b>(6)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>Collation</code> requires a locale for creation. This can be either a string representation of the locale, a <code>Locale</code> (considering language, country, and variant) or a <code>CollationLocale</code>. The locale is mandatory for creation.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Collation strength defines comparison levels that denote differences between characters. You can configure various options (case-sensitivity, case-ordering, and others), depending on the selected strength.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Specify whether to compare numeric strings as numbers or as strings.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Specify whether the collation should consider whitespace and punctuation as base characters for purposes of comparison.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Specify whether strings with diacritics sort from back of the string, such as with some French dictionary ordering.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Specify whether to check whether text requires normalization and whether to perform normalization.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>Collations can be used to create collections and indexes. If you create a collection that specifies a collation, the
collation is applied to index creation and queries unless you specify a different collation. A collation is valid for a
whole operation and cannot be specified on a per-field basis.</p>
</div>
<div class="paragraph">
<p>Like other metadata, collations can be be derived from the domain type via the <code>collation</code> attribute of the <code>@Document</code>
annotation and will be applied directly when running queries, creating collections or indexes.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Annotated collations will not be used when a collection is auto created by MongoDB on first interaction. This would
require additional store interaction delaying the entire process. Please use <code>MongoOperations.createCollection</code> for those cases.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">Collation french = Collation.of("fr");
Collation german = Collation.of("de");

template.createCollection(Person.class, CollectionOptions.just(collation));

template.indexOps(Person.class).ensureIndex(new Index("name", Direction.ASC).collation(german));</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
MongoDB uses simple binary comparison if no collation is specified (<code>Collation.simple()</code>).
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Using collations with collection operations is a matter of specifying a <code>Collation</code> instance in your query or operation options, as the following two examples show:</p>
</div>
<div class="exampleblock">
<div class="title">Example 79. Using collation with <code>find</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">Collation collation = Collation.of("de");

Query query = new Query(Criteria.where("firstName").is("Amél")).collation(collation);

List&lt;Person&gt; results = template.find(query, Person.class);</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 80. Using collation with <code>aggregate</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">Collation collation = Collation.of("de");

AggregationOptions options = AggregationOptions.builder().collation(collation).build();

Aggregation aggregation = newAggregation(
  project("tags"),
  unwind("tags"),
  group("tags")
    .count().as("count")
).withOptions(options);

AggregationResults&lt;TagCount&gt; results = template.aggregate(aggregation, "tags", TagCount.class);</code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Indexes are only used if the collation used for the operation matches the index collation.
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="mongo.jsonSchema"><a class="anchor" href="index.html#mongo.jsonSchema"></a>JSON Schema</h5>
<div class="paragraph">
<p>As of version 3.6, MongoDB supports collections that validate documents against a provided <a href="https://docs.mongodb.com/manual/core/schema-validation/#json-schema">JSON Schema</a>.
The schema itself and both validation action and level can be defined when creating the collection, as the following example shows:</p>
</div>
<div class="exampleblock">
<div class="title">Example 81. Sample JSON schema</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="json" class="language-json hljs">{
  "type": "object",                                                        <i class="conum" data-value="1"></i><b>(1)</b>

  "required": [ "firstname", "lastname" ],                                 <i class="conum" data-value="2"></i><b>(2)</b>

  "properties": {                                                          <i class="conum" data-value="3"></i><b>(3)</b>

    "firstname": {                                                         <i class="conum" data-value="4"></i><b>(4)</b>
      "type": "string",
      "enum": [ "luke", "han" ]
    },
    "address": {                                                           <i class="conum" data-value="5"></i><b>(5)</b>
      "type": "object",
      "properties": {
        "postCode": { "type": "string", "minLength": 4, "maxLength": 5 }
      }
    }
  }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>JSON schema documents always describe a whole document from its root. A schema is a schema object itself that can contain
embedded schema objects that describe properties and subdocuments.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>required</code> is a property that describes which properties are required in a document. It can be specified optionally, along with other
schema constraints. See MongoDB&#8217;s documentation on <a href="https://docs.mongodb.com/manual/reference/operator/query/jsonSchema/#available-keywords">available keywords</a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td><code>properties</code> is related to a schema object that describes an <code>object</code> type. It contains property-specific schema constraints.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td><code>firstname</code> specifies constraints for the <code>firsname</code> field inside the document. Here, it is a string-based <code>properties</code> element declaring
possible field values.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td><code>address</code> is a subdocument defining a schema for values in its <code>postCode</code> field.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>You can provide a schema either by specifying a schema document (that is, by using the <code>Document</code> API to parse or build a document object) or by building it with Spring Data&#8217;s JSON schema utilities in <code>org.springframework.data.mongodb.core.schema</code>. <code>MongoJsonSchema</code> is the entry point for all JSON schema-related operations. The following example shows how use <code>MongoJsonSchema.builder()</code> to create a JSON schema:</p>
</div>
<div class="exampleblock">
<div class="title">Example 82. Creating a JSON schema</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">MongoJsonSchema.builder()                                                    <i class="conum" data-value="1"></i><b>(1)</b>
    .required("lastname")                                                    <i class="conum" data-value="2"></i><b>(2)</b>

    .properties(
                required(string("firstname").possibleValues("luke", "han")), <i class="conum" data-value="3"></i><b>(3)</b>

                object("address")
                     .properties(string("postCode").minLength(4).maxLength(5)))

    .build();                                                                <i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Obtain a schema builder to configure the schema with a fluent API.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Configure required properties either directly as shown here or with more details as in 3.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Configure the required String-typed <code>firstname</code> field, allowing only <code>luke</code> and <code>han</code> values. Properties can be typed or untyped. Use a static import of <code>JsonSchemaProperty</code> to make the syntax slightly more compact and to get entry points such as <code>string(…)</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Build the schema object. Use the schema to create either a collection or <a href="index.html#mongodb-template-query.criteria">query documents</a>.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>There are already some predefined and strongly typed schema objects (<code>JsonSchemaObject</code> and <code>JsonSchemaProperty</code>) available
through static methods on the gateway interfaces.
However, you may need to build custom property validation rules, which can be created through the builder API, as the following example shows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">// "birthdate" : { "bsonType": "date" }
JsonSchemaProperty.named("birthdate").ofType(Type.dateType());

// "birthdate" : { "bsonType": "date", "description", "Must be a date" }
JsonSchemaProperty.named("birthdate").with(JsonSchemaObject.of(Type.dateType()).description("Must be a date"));</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>CollectionOptions</code> provides the entry point to schema support for collections, as the following example shows:</p>
</div>
<div class="exampleblock">
<div class="title">Example 83. Create collection with <code>$jsonSchema</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">MongoJsonSchema schema = MongoJsonSchema.builder().required("firstname", "lastname").build();

template.createCollection(Person.class, CollectionOptions.empty().schema(schema));</code></pre>
</div>
</div>
</div>
</div>
<div class="sect5">
<h6 id="mongo.jsonSchema.generated"><a class="anchor" href="index.html#mongo.jsonSchema.generated"></a>Generating a Schema</h6>
<div class="paragraph">
<p>Setting up a schema can be a time consuming task and we encourage everyone who decides to do so, to really take the time it takes.
It&#8217;s important, schema changes can be hard.
However, there might be times when one does not want to balked with it, and that is where <code>JsonSchemaCreator</code> comes into play.</p>
</div>
<div class="paragraph">
<p><code>JsonSchemaCreator</code> and its default implementation generates a <code>MongoJsonSchema</code> out of domain types metadata provided by the mapping infrastructure.
This means, that <a href="index.html#mapping-usage-annotations">annotated properties</a> as well as potential <a href="index.html#mapping-configuration">custom conversions</a> are considered.</p>
</div>
<div class="exampleblock">
<div class="title">Example 84. Generate Json Schema from domain type</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">public class Person {

    private final String firstname;                   <i class="conum" data-value="1"></i><b>(1)</b>
    private final int age;                            <i class="conum" data-value="2"></i><b>(2)</b>
    private Species species;                          <i class="conum" data-value="3"></i><b>(3)</b>
    private Address address;                          <i class="conum" data-value="4"></i><b>(4)</b>
    private @Field(fieldType=SCRIPT) String theForce; <i class="conum" data-value="5"></i><b>(5)</b>
    private @Transient Boolean useTheForce;           <i class="conum" data-value="6"></i><b>(6)</b>

    public Person(String firstname, int age) {        <i class="conum" data-value="1"></i><b>(1)</b> <i class="conum" data-value="2"></i><b>(2)</b>

        this.firstname = firstname;
        this.age = age;
    }

    // gettter / setter omitted
}

MongoJsonSchema schema = MongoJsonSchemaCreator.create(mongoOperations.getConverter())
    .createSchemaFor(Person.class);

template.createCollection(Person.class, CollectionOptions.empty().schema(schema));</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="json" class="language-json hljs">{
    'type' : 'object',
    'required' : ['age'],                     <i class="conum" data-value="2"></i><b>(2)</b>
    'properties' : {
        'firstname' : { 'type' : 'string' },  <i class="conum" data-value="1"></i><b>(1)</b>
        'age' : { 'bsonType' : 'int' }        <i class="conum" data-value="2"></i><b>(2)</b>
        'species' : {                         <i class="conum" data-value="3"></i><b>(3)</b>
            'type' : 'string',
            'enum' : ['HUMAN', 'WOOKIE', 'UNKNOWN']
        }
        'address' : {                         <i class="conum" data-value="4"></i><b>(4)</b>
            'type' : 'object'
            'properties' : {
                'postCode' : { 'type': 'string' }
            }
        },
        'theForce' : { 'type' : 'javascript'} <i class="conum" data-value="5"></i><b>(5)</b>
     }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Simple object properties are consideres regular properties.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Primitive types are considered required properties</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Enums are restricted to possible values.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Object type properties are inspected and represented as nested documents.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td><code>String</code> type property that is converted to <code>Code</code> by the converter.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td><code>@Transient</code> properties are omitted when generating the schema.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<code>_id</code> properties using types that can be converted into <code>ObjectId</code> like <code>String</code> are mapped to <code>{ type : 'object' }</code>
unless there is more specific information available via the <code>@MongoId</code> annotation.
</td>
</tr>
</table>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 8. Sepcial Schema Generation rules</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 60%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Java</th>
<th class="tableblock halign-left valign-top">Schema Type</th>
<th class="tableblock halign-left valign-top">Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Object</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>type : object</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">with <code>properties</code> if metadata available.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Collection</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>type : array</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Map</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>type : object</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Enum</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>type : string</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">with <code>enum</code> property holding the possible enumeration values.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>array</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>type : array</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">simple type array unless it&#8217;s a <code>byte[]</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>byte[]</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>bsonType : binData</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect5">
<h6 id="mongo.jsonSchema.query"><a class="anchor" href="index.html#mongo.jsonSchema.query"></a>Query a collection for matching JSON Schema</h6>
<div class="paragraph">
<p>You can use a schema to query any collection for documents that match a given structure defined by a JSON schema, as the following example shows:</p>
</div>
<div class="exampleblock">
<div class="title">Example 85. Query for Documents matching a <code>$jsonSchema</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">MongoJsonSchema schema = MongoJsonSchema.builder().required("firstname", "lastname").build();

template.find(query(matchingDocumentStructure(schema)), Person.class);</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect5">
<h6 id="mongo.jsonSchema.encrypted-fields"><a class="anchor" href="index.html#mongo.jsonSchema.encrypted-fields"></a>Encrypted Fields</h6>
<div class="paragraph">
<p>MongoDB 4.2 <a href="https://docs.mongodb.com/master/core/security-client-side-encryption/">Field Level Encryption</a> allows to directly encrypt individual properties.</p>
</div>
<div class="paragraph">
<p>Properties can be wrapped within an encrypted property when setting up the JSON Schema as shown in the example below.</p>
</div>
<div class="exampleblock">
<div class="title">Example 86. Client-Side Field Level Encryption via Json Schema</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">MongoJsonSchema schema = MongoJsonSchema.builder()
    .properties(
        encrypted(string("ssn"))
            .algorithm("AEAD_AES_256_CBC_HMAC_SHA_512-Deterministic")
            .keyId("*key0_id")
	).build();</code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Make sure to set the drivers <code>com.mongodb.AutoEncryptionSettings</code> to use client-side encryption. MongoDB does not support encryption for all field types. Specific data types require deterministic encryption to preserve equality comparison functionality.
</td>
</tr>
</table>
</div>
</div>
<div class="sect5">
<h6 id="mongo.jsonSchema.types"><a class="anchor" href="index.html#mongo.jsonSchema.types"></a>JSON Schema Types</h6>
<div class="paragraph">
<p>The following table shows the supported JSON schema types:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 9. Supported JSON schema types</caption>
<colgroup>
<col style="width: 30%;">
<col style="width: 10%;">
<col style="width: 60%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Schema Type</th>
<th class="tableblock halign-left valign-top">Java Type</th>
<th class="tableblock halign-left valign-top">Schema Properties</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>untyped</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>description</code>, generated <code>description</code>, <code>enum</code>, <code>allOf</code>, <code>anyOf</code>, <code>oneOf</code>, <code>not</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>object</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Object</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>required</code>, <code>additionalProperties</code>, <code>properties</code>, <code>minProperties</code>, <code>maxProperties</code>, <code>patternProperties</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>array</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">any array except <code>byte[]</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>uniqueItems</code>, <code>additionalItems</code>, <code>items</code>, <code>minItems</code>, <code>maxItems</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>string</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>String</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>minLength</code>, <code>maxLentgth</code>, <code>pattern</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>int</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>int</code>, <code>Integer</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>multipleOf</code>, <code>minimum</code>, <code>exclusiveMinimum</code>, <code>maximum</code>, <code>exclusiveMaximum</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>long</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>long</code>, <code>Long</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>multipleOf</code>, <code>minimum</code>, <code>exclusiveMinimum</code>, <code>maximum</code>, <code>exclusiveMaximum</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>double</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>float</code>, <code>Float</code>, <code>double</code>, <code>Double</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>multipleOf</code>, <code>minimum</code>, <code>exclusiveMinimum</code>, <code>maximum</code>, <code>exclusiveMaximum</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>decimal</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>BigDecimal</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>multipleOf</code>, <code>minimum</code>, <code>exclusiveMinimum</code>, <code>maximum</code>, <code>exclusiveMaximum</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>number</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Number</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>multipleOf</code>, <code>minimum</code>, <code>exclusiveMinimum</code>, <code>maximum</code>, <code>exclusiveMaximum</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>binData</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>byte[]</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(none)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>boolean</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>boolean</code>, <code>Boolean</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(none)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>null</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>null</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(none)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>objectId</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ObjectId</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(none)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>date</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.util.Date</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(none)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>timestamp</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>BsonTimestamp</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(none)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>regex</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.util.regex.Pattern</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(none)</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<code>untyped</code> is a generic type that is inherited by all typed schema types. It provides all <code>untyped</code> schema properties to typed schema types.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For more information, see <a href="https://docs.mongodb.com/manual/reference/operator/query/jsonSchema/#op._S_jsonSchema">$jsonSchema</a>.</p>
</div>
<div class="paragraph">
<p><a href="index.html#mongo.repositories">MongoDB Repositories</a> support <code>Collations</code> via the <code>collation</code> attribute of the <code>@Query</code> annotation.</p>
</div>
<div class="exampleblock">
<div class="title">Example 87. Collation support for Repositories</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">public interface PersonRepository extends MongoRepository&lt;Person, String&gt; {

  @Query(collation = "en_US")  <i class="conum" data-value="1"></i><b>(1)</b>
  List&lt;Person&gt; findByFirstname(String firstname);

  @Query(collation = "{ 'locale' : 'en_US' }") <i class="conum" data-value="2"></i><b>(2)</b>
  List&lt;Person&gt; findPersonByFirstname(String firstname);

  @Query(collation = "?1") <i class="conum" data-value="3"></i><b>(3)</b>
  List&lt;Person&gt; findByFirstname(String firstname, Object collation);

  @Query(collation = "{ 'locale' : '?1' }") <i class="conum" data-value="4"></i><b>(4)</b>
  List&lt;Person&gt; findByFirstname(String firstname, String collation);

  List&lt;Person&gt; findByFirstname(String firstname, Collation collation); <i class="conum" data-value="5"></i><b>(5)</b>

  @Query(collation = "{ 'locale' : 'en_US' }")
  List&lt;Person&gt; findByFirstname(String firstname, @Nullable Collation collation); <i class="conum" data-value="6"></i><b>(6)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Static collation definition resulting in <code>{ 'locale' : 'en_US' }</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Static collation definition resulting in <code>{ 'locale' : 'en_US' }</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Dynamic collation depending on 2nd method argument. Allowed types include <code>String</code> (eg. 'en_US'), <code>Locacle</code> (eg. Locacle.US)
and <code>Document</code> (eg. new Document("locale", "en_US"))</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Dynamic collation depending on 2nd method argument.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Apply the <code>Collation</code> method parameter to the query.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>The <code>Collation</code> method parameter overrides the default <code>collation</code> from <code>@Query</code> if not null.</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
In case you enabled the automatic index creation for repository finder methods a potential static collation definition,
as shown in (1) and (2), will be included when creating the index.
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
The most specifc <code>Collation</code> outroules potentially defined others. Which means Method argument over query method annotation over doamin type annotation.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="mongo.jsonSchema"><a class="anchor" href="index.html#mongo.jsonSchema"></a>11.6.8. JSON Schema</h4>
<div class="paragraph">
<p>As of version 3.6, MongoDB supports collections that validate documents against a provided <a href="https://docs.mongodb.com/manual/core/schema-validation/#json-schema">JSON Schema</a>.
The schema itself and both validation action and level can be defined when creating the collection, as the following example shows:</p>
</div>
<div class="exampleblock">
<div class="title">Example 88. Sample JSON schema</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="json" class="language-json hljs">{
  "type": "object",                                                        <i class="conum" data-value="1"></i><b>(1)</b>

  "required": [ "firstname", "lastname" ],                                 <i class="conum" data-value="2"></i><b>(2)</b>

  "properties": {                                                          <i class="conum" data-value="3"></i><b>(3)</b>

    "firstname": {                                                         <i class="conum" data-value="4"></i><b>(4)</b>
      "type": "string",
      "enum": [ "luke", "han" ]
    },
    "address": {                                                           <i class="conum" data-value="5"></i><b>(5)</b>
      "type": "object",
      "properties": {
        "postCode": { "type": "string", "minLength": 4, "maxLength": 5 }
      }
    }
  }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>JSON schema documents always describe a whole document from its root. A schema is a schema object itself that can contain
embedded schema objects that describe properties and subdocuments.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>required</code> is a property that describes which properties are required in a document. It can be specified optionally, along with other
schema constraints. See MongoDB&#8217;s documentation on <a href="https://docs.mongodb.com/manual/reference/operator/query/jsonSchema/#available-keywords">available keywords</a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td><code>properties</code> is related to a schema object that describes an <code>object</code> type. It contains property-specific schema constraints.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td><code>firstname</code> specifies constraints for the <code>firsname</code> field inside the document. Here, it is a string-based <code>properties</code> element declaring
possible field values.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td><code>address</code> is a subdocument defining a schema for values in its <code>postCode</code> field.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>You can provide a schema either by specifying a schema document (that is, by using the <code>Document</code> API to parse or build a document object) or by building it with Spring Data&#8217;s JSON schema utilities in <code>org.springframework.data.mongodb.core.schema</code>. <code>MongoJsonSchema</code> is the entry point for all JSON schema-related operations. The following example shows how use <code>MongoJsonSchema.builder()</code> to create a JSON schema:</p>
</div>
<div class="exampleblock">
<div class="title">Example 89. Creating a JSON schema</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">MongoJsonSchema.builder()                                                  <i class="conum" data-value="1"></i><b>(1)</b>
    .required("firstname", "lastname")                                     <i class="conum" data-value="2"></i><b>(2)</b>

    .properties(
                string("firstname").possibleValues("luke", "han"),         <i class="conum" data-value="3"></i><b>(3)</b>

                object("address")
                     .properties(string("postCode").minLength(4).maxLength(5)))

    .build();                                                              <i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Obtain a schema builder to configure the schema with a fluent API.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Configure required properties.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Configure the String-typed <code>firstname</code> field, allowing only <code>luke</code> and <code>han</code> values. Properties can be typed or untyped. Use a static import of <code>JsonSchemaProperty</code> to make the syntax slightly more compact and to get entry points such as <code>string(…)</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Build the schema object. Use the schema to create either a collection or <a href="index.html#mongodb-template-query.criteria">query documents</a>.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>There are already some predefined and strongly typed schema objects (<code>JsonSchemaObject</code> and <code>JsonSchemaProperty</code>) available
through static methods on the gateway interfaces.
However, you may need to build custom property validation rules, which can be created through the builder API, as the following example shows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">// "birthdate" : { "bsonType": "date" }
JsonSchemaProperty.named("birthdate").ofType(Type.dateType());

// "birthdate" : { "bsonType": "date", "description", "Must be a date" }
JsonSchemaProperty.named("birthdate").with(JsonSchemaObject.of(Type.dateType()).description("Must be a date"));</code></pre>
</div>
</div>
<div class="paragraph">
<p>The Schema builder also provides support for <a href="https://docs.mongodb.com/manual/core/security-client-side-encryption/">Client-Side Field Level Encryption</a>. Please refer to <a href="index.html#mongo.jsonSchema.encrypted-fields">Encrypted Fields</a> for more information,</p>
</div>
<div class="paragraph">
<p><code>CollectionOptions</code> provides the entry point to schema support for collections, as the following example shows:</p>
</div>
<div class="exampleblock">
<div class="title">Example 90. Create collection with <code>$jsonSchema</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">MongoJsonSchema schema = MongoJsonSchema.builder().required("firstname", "lastname").build();

template.createCollection(Person.class, CollectionOptions.empty().schema(schema));</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>You can use a schema to query any collection for documents that match a given structure defined by a JSON schema, as the following example shows:</p>
</div>
<div class="exampleblock">
<div class="title">Example 91. Query for Documents matching a <code>$jsonSchema</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">MongoJsonSchema schema = MongoJsonSchema.builder().required("firstname", "lastname").build();

template.find(query(matchingDocumentStructure(schema)), Person.class);</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The following table shows the supported JSON schema types:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 10. Supported JSON schema types</caption>
<colgroup>
<col style="width: 30%;">
<col style="width: 10%;">
<col style="width: 60%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Schema Type</th>
<th class="tableblock halign-left valign-top">Java Type</th>
<th class="tableblock halign-left valign-top">Schema Properties</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>untyped</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>description</code>, generated <code>description</code>, <code>enum</code>, <code>allOf</code>, <code>anyOf</code>, <code>oneOf</code>, <code>not</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>object</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Object</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>required</code>, <code>additionalProperties</code>, <code>properties</code>, <code>minProperties</code>, <code>maxProperties</code>, <code>patternProperties</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>array</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">any array except <code>byte[]</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>uniqueItems</code>, <code>additionalItems</code>, <code>items</code>, <code>minItems</code>, <code>maxItems</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>string</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>String</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>minLength</code>, <code>maxLentgth</code>, <code>pattern</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>int</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>int</code>, <code>Integer</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>multipleOf</code>, <code>minimum</code>, <code>exclusiveMinimum</code>, <code>maximum</code>, <code>exclusiveMaximum</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>long</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>long</code>, <code>Long</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>multipleOf</code>, <code>minimum</code>, <code>exclusiveMinimum</code>, <code>maximum</code>, <code>exclusiveMaximum</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>double</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>float</code>, <code>Float</code>, <code>double</code>, <code>Double</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>multipleOf</code>, <code>minimum</code>, <code>exclusiveMinimum</code>, <code>maximum</code>, <code>exclusiveMaximum</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>decimal</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>BigDecimal</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>multipleOf</code>, <code>minimum</code>, <code>exclusiveMinimum</code>, <code>maximum</code>, <code>exclusiveMaximum</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>number</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Number</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>multipleOf</code>, <code>minimum</code>, <code>exclusiveMinimum</code>, <code>maximum</code>, <code>exclusiveMaximum</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>binData</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>byte[]</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(none)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>boolean</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>boolean</code>, <code>Boolean</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(none)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>null</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>null</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(none)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>objectId</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ObjectId</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(none)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>date</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.util.Date</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(none)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>timestamp</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>BsonTimestamp</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(none)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>regex</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.util.regex.Pattern</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(none)</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<code>untyped</code> is a generic type that is inherited by all typed schema types. It provides all <code>untyped</code> schema properties to typed schema types.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For more information, see <a href="https://docs.mongodb.com/manual/reference/operator/query/jsonSchema/#op._S_jsonSchema">$jsonSchema</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="mongo.query.fluent-template-api"><a class="anchor" href="index.html#mongo.query.fluent-template-api"></a>11.6.9. Fluent Template API</h4>
<div class="paragraph">
<p>The <code>MongoOperations</code> interface is one of the central components when it comes to more low-level interaction with MongoDB. It offers a wide range of methods covering needs from collection creation, index creation, and CRUD operations to more advanced functionality, such as Map-Reduce and aggregations.
You can find multiple overloads for each method. Most of them cover optional or nullable parts of the API.</p>
</div>
<div class="paragraph">
<p><code>FluentMongoOperations</code> provides a more narrow interface for the common methods of <code>MongoOperations</code> and provides a more readable, fluent API.
The entry points (<code>insert(…)</code>, <code>find(…)</code>, <code>update(…)</code>, and others) follow a natural naming schema based on the operation to be run. Moving on from the entry point, the API is designed to offer only context-dependent methods that lead to a terminating method that invokes the actual <code>MongoOperations</code> counterpart&#8201;&#8212;&#8201;the <code>all</code> method in the case of the following example:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">List&lt;SWCharacter&gt; all = ops.find(SWCharacter.class)
  .inCollection("star-wars")                        <i class="conum" data-value="1"></i><b>(1)</b>
  .all();</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Skip this step if <code>SWCharacter</code> defines the collection with <code>@Document</code> or if you use the class name as the collection name, which is fine.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>Sometimes, a collection in MongoDB holds entities of different types, such as a <code>Jedi</code> within a collection of <code>SWCharacters</code>.
To use different types for <code>Query</code> and return value mapping, you can use <code>as(Class&lt;?&gt; targetType)</code> to map results differently, as the following example shows:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">List&lt;Jedi&gt; all = ops.find(SWCharacter.class)    <i class="conum" data-value="1"></i><b>(1)</b>
  .as(Jedi.class)                               <i class="conum" data-value="2"></i><b>(2)</b>
  .matching(query(where("jedi").is(true)))
  .all();</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The query fields are mapped against the <code>SWCharacter</code> type.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Resulting documents are mapped into <code>Jedi</code>.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
You can directly apply <a href="index.html#projections">Projections</a> to result documents by providing the target type via <code>as(Class&lt;?&gt;)</code>.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Using projections allows <code>MongoTemplate</code> to optimize result mapping by limiting the actual response to fields required
by the projection target type. This applies as long as the <code>Query</code> itself does not contain any field restriction and the
target type is a closed interface or DTO projection.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You can switch between retrieving a single entity and retrieving multiple entities as a <code>List</code> or a <code>Stream</code> through the terminating methods: <code>first()</code>, <code>one()</code>, <code>all()</code>, or <code>stream()</code>.</p>
</div>
<div class="paragraph">
<p>When writing a geo-spatial query with <code>near(NearQuery)</code>, the number of terminating methods is altered to include only the methods that are valid for running a <code>geoNear</code> command in MongoDB (fetching entities as a <code>GeoResult</code> within <code>GeoResults</code>), as the following example shows:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">GeoResults&lt;Jedi&gt; results = mongoOps.query(SWCharacter.class)
  .as(Jedi.class)
  .near(alderaan) // NearQuery.near(-73.9667, 40.78).maxDis…
  .all();</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="mongo.query.kotlin-support"><a class="anchor" href="index.html#mongo.query.kotlin-support"></a>11.6.10. Type-safe Queries for Kotlin</h4>
<div class="paragraph">
<p>Kotlin embraces domain-specific language creation through its language syntax and its extension system.
Spring Data MongoDB ships with a Kotlin Extension for <code>Criteria</code> using <a href="https://kotlinlang.org/docs/reference/reflection.html#property-references">Kotlin property references</a> to build type-safe queries.
Queries using this extension are typically benefit from improved readability.
Most keywords on <code>Criteria</code> have a matching Kotlin extension, such as <code>inValues</code> and <code>regex</code>.</p>
</div>
<div class="paragraph">
<p>Consider the following example explaining Type-safe Queries:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="kotlin" class="language-kotlin hljs">import org.springframework.data.mongodb.core.query.*

mongoOperations.find&lt;Book&gt;(
  Query(Book::title isEqualTo "Moby-Dick")               <i class="conum" data-value="1"></i><b>(1)</b>
)

mongoOperations.find&lt;Book&gt;(
  Query(titlePredicate = Book::title exists true)
)

mongoOperations.find&lt;Book&gt;(
  Query(
    Criteria().andOperator(
      Book::price gt 5,
      Book::price lt 10
    ))
)

// Binary operators
mongoOperations.find&lt;BinaryMessage&gt;(
  Query(BinaryMessage::payload bits { allClear(0b101) }) <i class="conum" data-value="2"></i><b>(2)</b>
)

// Nested Properties (i.e. refer to "book.author")
mongoOperations.find&lt;Book&gt;(
  Query(Book::author / Author::name regex "^H")          <i class="conum" data-value="3"></i><b>(3)</b>
)</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>isEqualTo()</code> is an infix extension function with receiver type <code>KProperty&lt;T&gt;</code> that returns <code>Criteria</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>For bitwise operators, pass a lambda argument where you call one of the methods of <code>Criteria.BitwiseCriteriaOperators</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>To construct nested properties, use the <code>/</code> character (overloaded operator <code>div</code>).</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="mongo.query.additional-query-options"><a class="anchor" href="index.html#mongo.query.additional-query-options"></a>11.6.11. Additional Query Options</h4>
<div class="paragraph">
<p>MongoDB offers various ways of applying meta information, like a comment or a batch size, to a query.Using the <code>Query</code> API
directly there are several methods for those options.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">Query query = query(where("firstname").is("luke"))
    .comment("find luke")         <i class="conum" data-value="1"></i><b>(1)</b>
    .batchSize(100)                                 <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The comment propagated to the MongoDB profile log.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The number of documents to return in each response batch.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>On the repository level the <code>@Meta</code> annotation provides means to add query options in a declarative way.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Meta(comment = "find luke", batchSize = 100, flags = { SLAVE_OK })
List&lt;Person&gt; findByFirstname(String firstname);</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="query-by-example"><a class="anchor" href="index.html#query-by-example"></a>11.7. Query by Example</h3>
<div class="sect3">
<h4 id="query-by-example.introduction"><a class="anchor" href="index.html#query-by-example.introduction"></a>11.7.1. Introduction</h4>
<div class="paragraph">
<p>This chapter provides an introduction to Query by Example and explains how to use it.</p>
</div>
<div class="paragraph">
<p>Query by Example (QBE) is a user-friendly querying technique with a simple interface.
It allows dynamic query creation and does not require you to write queries that contain field names.
In fact, Query by Example does not require you to write queries by using store-specific query languages at all.</p>
</div>
</div>
<div class="sect3">
<h4 id="query-by-example.usage"><a class="anchor" href="index.html#query-by-example.usage"></a>11.7.2. Usage</h4>
<div class="paragraph">
<p>The Query by Example API consists of three parts:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Probe: The actual example of a domain object with populated fields.</p>
</li>
<li>
<p><code>ExampleMatcher</code>: The <code>ExampleMatcher</code> carries details on how to match particular fields.
It can be reused across multiple Examples.</p>
</li>
<li>
<p><code>Example</code>: An <code>Example</code> consists of the probe and the <code>ExampleMatcher</code>.
It is used to create the query.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Query by Example is well suited for several use cases:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Querying your data store with a set of static or dynamic constraints.</p>
</li>
<li>
<p>Frequent refactoring of the domain objects without worrying about breaking existing queries.</p>
</li>
<li>
<p>Working independently from the underlying data store API.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Query by Example also has several limitations:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>No support for nested or grouped property constraints, such as <code>firstname = ?0 or (firstname = ?1 and lastname = ?2)</code>.</p>
</li>
<li>
<p>Only supports starts/contains/ends/regex matching for strings and exact matching for other property types.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Before getting started with Query by Example, you need to have a domain object.
To get started, create an interface for your repository, as shown in the following example:</p>
</div>
<div class="exampleblock">
<div class="title">Example 92. Sample Person object</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">public class Person {

  @Id
  private String id;
  private String firstname;
  private String lastname;
  private Address address;

  // … getters and setters omitted
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The preceding example shows a simple domain object.
You can use it to create an <code>Example</code>.
By default, fields having <code>null</code> values are ignored, and strings are matched by using the store specific defaults.
Examples can be built by either using the <code>of</code> factory method or by using <a href="index.html#query-by-example.matchers"><code>ExampleMatcher</code></a>. <code>Example</code> is immutable.
The following listing shows a simple Example:</p>
</div>
<div class="exampleblock">
<div class="title">Example 93. Simple Example</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">Person person = new Person();                         <i class="conum" data-value="1"></i><b>(1)</b>
person.setFirstname("Dave");                          <i class="conum" data-value="2"></i><b>(2)</b>

Example&lt;Person&gt; example = Example.of(person);         <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Create a new instance of the domain object.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Set the properties to query.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Create the <code>Example</code>.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>You can run the example queries by using repositories.
To do so, let your repository interface extend <code>QueryByExampleExecutor&lt;T&gt;</code>.
The following listing shows an excerpt from the <code>QueryByExampleExecutor</code> interface:</p>
</div>
<div class="exampleblock">
<div class="title">Example 94. The <code>QueryByExampleExecutor</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">public interface QueryByExampleExecutor&lt;T&gt; {

  &lt;S extends T&gt; S findOne(Example&lt;S&gt; example);

  &lt;S extends T&gt; Iterable&lt;S&gt; findAll(Example&lt;S&gt; example);

  // … more functionality omitted.
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="query-by-example.matchers"><a class="anchor" href="index.html#query-by-example.matchers"></a>11.7.3. Example Matchers</h4>
<div class="paragraph">
<p>Examples are not limited to default settings.
You can specify your own defaults for string matching, null handling, and property-specific settings by using the <code>ExampleMatcher</code>, as shown in the following example:</p>
</div>
<div class="exampleblock">
<div class="title">Example 95. Example matcher with customized matching</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">Person person = new Person();                          <i class="conum" data-value="1"></i><b>(1)</b>
person.setFirstname("Dave");                           <i class="conum" data-value="2"></i><b>(2)</b>

ExampleMatcher matcher = ExampleMatcher.matching()     <i class="conum" data-value="3"></i><b>(3)</b>
  .withIgnorePaths("lastname")                         <i class="conum" data-value="4"></i><b>(4)</b>
  .withIncludeNullValues()                             <i class="conum" data-value="5"></i><b>(5)</b>
  .withStringMatcherEnding();                          <i class="conum" data-value="6"></i><b>(6)</b>

Example&lt;Person&gt; example = Example.of(person, matcher); <i class="conum" data-value="7"></i><b>(7)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Create a new instance of the domain object.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Set properties.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Create an <code>ExampleMatcher</code> to expect all values to match.
It is usable at this stage even without further configuration.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Construct a new <code>ExampleMatcher</code> to ignore the <code>lastname</code> property path.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Construct a new <code>ExampleMatcher</code> to ignore the <code>lastname</code> property path and to include null values.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Construct a new <code>ExampleMatcher</code> to ignore the <code>lastname</code> property path, to include null values, and to perform suffix string matching.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Create a new <code>Example</code> based on the domain object and the configured <code>ExampleMatcher</code>.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>By default, the <code>ExampleMatcher</code> expects all values set on the probe to match.
If you want to get results matching any of the predicates defined implicitly, use <code>ExampleMatcher.matchingAny()</code>.</p>
</div>
<div class="paragraph">
<p>You can specify behavior for individual properties (such as "firstname" and "lastname" or, for nested properties, "address.city").
You can tune it with matching options and case sensitivity, as shown in the following example:</p>
</div>
<div class="exampleblock">
<div class="title">Example 96. Configuring matcher options</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">ExampleMatcher matcher = ExampleMatcher.matching()
  .withMatcher("firstname", endsWith())
  .withMatcher("lastname", startsWith().ignoreCase());
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Another way to configure matcher options is to use lambdas (introduced in Java 8).
This approach creates a callback that asks the implementor to modify the matcher.
You need not return the matcher, because configuration options are held within the matcher instance.
The following example shows a matcher that uses lambdas:</p>
</div>
<div class="exampleblock">
<div class="title">Example 97. Configuring matcher options with lambdas</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">ExampleMatcher matcher = ExampleMatcher.matching()
  .withMatcher("firstname", match -&gt; match.endsWith())
  .withMatcher("firstname", match -&gt; match.startsWith());
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Queries created by <code>Example</code> use a merged view of the configuration.
Default matching settings can be set at the <code>ExampleMatcher</code> level, while individual settings can be applied to particular property paths.
Settings that are set on <code>ExampleMatcher</code> are inherited by property path settings unless they are defined explicitly.
Settings on a property patch have higher precedence than default settings.
The following table describes the scope of the various <code>ExampleMatcher</code> settings:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 11. Scope of <code>ExampleMatcher</code> settings</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Setting</th>
<th class="tableblock halign-left valign-top">Scope</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Null-handling</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ExampleMatcher</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">String matching</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ExampleMatcher</code> and property path</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Ignoring properties</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Property path</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Case sensitivity</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ExampleMatcher</code> and property path</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Value transformation</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Property path</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="query-by-example.running"><a class="anchor" href="index.html#query-by-example.running"></a>11.7.4. Running an Example</h4>
<div class="paragraph">
<p>The following example shows how to query by example when using a repository (of <code>Person</code> objects, in this case):</p>
</div>
<div class="exampleblock">
<div class="title">Example 98. Query by Example using a repository</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">public interface PersonRepository extends QueryByExampleExecutor&lt;Person&gt; {

}

public class PersonService {

  @Autowired PersonRepository personRepository;

  public List&lt;Person&gt; findPeople(Person probe) {
    return personRepository.findAll(Example.of(probe));
  }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>An <code>Example</code> containing an untyped <code>ExampleSpec</code> uses the Repository type and its collection name. Typed <code>ExampleSpec</code> instances use their type as the result type and the collection name from the <code>Repository</code> instance.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
When including <code>null</code> values in the <code>ExampleSpec</code>, Spring Data Mongo uses embedded document matching instead of dot notation property matching. Doing so forces exact document matching for all property values and the property order in the embedded document.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Spring Data MongoDB provides support for the following matching options:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 12. <code>StringMatcher</code> options</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Matching</th>
<th class="tableblock halign-left valign-top">Logical result</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>DEFAULT</code> (case-sensitive)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"firstname" : firstname}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>DEFAULT</code> (case-insensitive)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"firstname" : { $regex: firstname, $options: 'i'}}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>EXACT</code> (case-sensitive)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"firstname" : { $regex: /^firstname$/}}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>EXACT</code> (case-insensitive)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"firstname" : { $regex: /^firstname$/, $options: 'i'}}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>STARTING</code> (case-sensitive)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"firstname" : { $regex: /^firstname/}}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>STARTING</code> (case-insensitive)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"firstname" : { $regex: /^firstname/, $options: 'i'}}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ENDING</code> (case-sensitive)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"firstname" : { $regex: /firstname$/}}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ENDING</code> (case-insensitive)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"firstname" : { $regex: /firstname$/, $options: 'i'}}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>CONTAINING</code> (case-sensitive)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"firstname" : { $regex: /.*firstname.*/}}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>CONTAINING</code> (case-insensitive)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"firstname" : { $regex: /.*firstname.*/, $options: 'i'}}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>REGEX</code> (case-sensitive)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"firstname" : { $regex: /firstname/}}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>REGEX</code> (case-insensitive)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"firstname" : { $regex: /firstname/, $options: 'i'}}</code></p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="query-by-example.untyped"><a class="anchor" href="index.html#query-by-example.untyped"></a>11.7.5. Untyped Example</h4>
<div class="paragraph">
<p>By default <code>Example</code> is strictly typed. This means that the mapped query has an included type match, restricting it to probe assignable types. For example, when sticking with the default type key (<code>_class</code>), the query has restrictions such as (<code>_class : { $in : [ com.acme.Person] }</code>).</p>
</div>
<div class="paragraph">
<p>By using the <code>UntypedExampleMatcher</code>, it is possible to bypass the default behavior and skip the type restriction. So, as long as field names match, nearly any domain type can be used as the probe for creating the reference, as the following example shows:</p>
</div>
<div class="exampleblock">
<div class="title">Example 99. Untyped Example Query</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">class JustAnArbitraryClassWithMatchingFieldName {
  @Field("lastname") String value;
}

JustAnArbitraryClassWithMatchingFieldNames probe = new JustAnArbitraryClassWithMatchingFieldNames();
probe.value = "stark";

Example example = Example.of(probe, UntypedExampleMatcher.matching());

Query query = new Query(new Criteria().alike(example));
List&lt;Person&gt; result = template.find(query, Person.class);</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="mongo.query.count"><a class="anchor" href="index.html#mongo.query.count"></a>11.8. Counting Documents</h3>
<div class="paragraph">
<p>In pre-3.x versions of SpringData MongoDB the count operation used MongoDBs internal collection statistics.
With the introduction of <a href="index.html#mongo.transactions">MongoDB Transactions</a> this was no longer possible because statistics would not correctly reflect potential changes during a transaction requiring an aggregation-based count approach.
So in version 2.x <code>MongoOperations.count()</code> would use the collection statistics if no transaction was in progress, and the aggregation variant if so.</p>
</div>
<div class="paragraph">
<p>As of Spring Data MongoDB 3.x any <code>count</code> operation uses regardless the existence of filter criteria the aggregation-based count approach via MongoDBs <code>countDocuments</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>MongoDBs native <code>countDocuments</code> method and the <code>$match</code> aggregation, do not support <code>$near</code> and <code>$nearSphere</code> but require <code>$geoWithin</code> along with <code>$center</code> or <code>$centerSphere</code> which does not support <code>$minDistance</code> (see <a href="https://jira.mongodb.org/browse/SERVER-37043" class="bare">https://jira.mongodb.org/browse/SERVER-37043</a>).</p>
</div>
<div class="paragraph">
<p>Therefore a given <code>Query</code> will be rewritten for <code>count</code> operations using <code>Reactive</code>-/<code>MongoTemplate</code> to bypass the issue like shown below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="javascript" class="language-javascript hljs">{ location : { $near : [-73.99171, 40.738868], $maxDistance : 1.1 } } <i class="conum" data-value="1"></i><b>(1)</b>
{ location : { $geoWithin : { $center: [ [-73.99171, 40.738868], 1.1] } } } <i class="conum" data-value="2"></i><b>(2)</b>

{ location : { $near : [-73.99171, 40.738868], $minDistance : 0.1, $maxDistance : 1.1 } } <i class="conum" data-value="3"></i><b>(3)</b>
{$and :[ { $nor :[ { location :{ $geoWithin :{ $center :[ [-73.99171, 40.738868 ], 0.01] } } } ]}, { location :{ $geoWithin :{ $center :[ [-73.99171, 40.738868 ], 1.1] } } } ] } <i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Count source query using <code>$near</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Rewritten query now using <code>$geoWithin</code> with <code>$center</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Count source query using <code>$near</code> with <code>$minDistance</code> and <code>$maxDistance</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Rewritten query now a combination of <code>$nor</code> <code>$geowithin</code> critierias to work around unsupported <code>$minDistance</code>.</td>
</tr>
</table>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="mongo.mapreduce"><a class="anchor" href="index.html#mongo.mapreduce"></a>11.9. Map-Reduce Operations</h3>
<div class="paragraph">
<p>You can query MongoDB by using Map-Reduce, which is useful for batch processing, for data aggregation, and for when the query language does not fulfill your needs.</p>
</div>
<div class="paragraph">
<p>Spring provides integration with MongoDB&#8217;s Map-Reduce by providing methods on <code>MongoOperations</code> to simplify the creation and running of Map-Reduce operations.It can convert the results of a Map-Reduce operation to a POJO and integrates with Spring&#8217;s <a href="https://docs.spring.io/spring/docs/5.3.1/spring-framework-reference/core.html#resources">Resource abstraction</a>.This lets you place your JavaScript files on the file system, classpath, HTTP server, or any other Spring Resource implementation and then reference the JavaScript resources through an easy URI style syntax&#8201;&#8212;&#8201;for example, <code>classpath:reduce.js;</code>.Externalizing JavaScript code in files is often preferable to embedding them as Java strings in your code.Note that you can still pass JavaScript code as Java strings if you prefer.</p>
</div>
<div class="sect3">
<h4 id="mongo.mapreduce.example"><a class="anchor" href="index.html#mongo.mapreduce.example"></a>11.9.1. Example Usage</h4>
<div class="paragraph">
<p>To understand how to perform Map-Reduce operations, we use an example from the book, <em>MongoDB - The Definitive Guide</em> <sup class="footnote">[<a id="_footnoteref_1" class="footnote" href="index.html#_footnotedef_1" title="View footnote.">1</a>]</sup>.In this example, we create three documents that have the values [a,b], [b,c], and [c,d], respectively.The values in each document are associated with the key, 'x', as the following example shows (assume these documents are in a collection named <code>jmr1</code>):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">{ "_id" : ObjectId("4e5ff893c0277826074ec533"), "x" : [ "a", "b" ] }
{ "_id" : ObjectId("4e5ff893c0277826074ec534"), "x" : [ "b", "c" ] }
{ "_id" : ObjectId("4e5ff893c0277826074ec535"), "x" : [ "c", "d" ] }</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following map function counts the occurrence of each letter in the array for each document:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">function () {
    for (var i = 0; i &lt; this.x.length; i++) {
        emit(this.x[i], 1);
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The follwing reduce function sums up the occurrence of each letter across all the documents:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">function (key, values) {
    var sum = 0;
    for (var i = 0; i &lt; values.length; i++)
        sum += values[i];
    return sum;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Running the preceding functions result in the following collection:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">{ "_id" : "a", "value" : 1 }
{ "_id" : "b", "value" : 2 }
{ "_id" : "c", "value" : 2 }
{ "_id" : "d", "value" : 1 }</code></pre>
</div>
</div>
<div class="paragraph">
<p>Assuming that the map and reduce functions are located in <code>map.js</code> and <code>reduce.js</code> and bundled in your jar so they are available on the classpath, you can run a Map-Reduce operation as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">MapReduceResults&lt;ValueObject&gt; results = mongoOperations.mapReduce("jmr1", "classpath:map.js", "classpath:reduce.js", ValueObject.class);
for (ValueObject valueObject : results) {
  System.out.println(valueObject);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The preceding exmaple produces the following output:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">ValueObject [id=a, value=1.0]
ValueObject [id=b, value=2.0]
ValueObject [id=c, value=2.0]
ValueObject [id=d, value=1.0]</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>MapReduceResults</code> class implements <code>Iterable</code> and provides access to the raw output and timing and count statistics.The following listing shows the <code>ValueObject</code> class:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">public class ValueObject {

  private String id;
  private float value;

  public String getId() {
    return id;
  }

  public float getValue() {
    return value;
  }

  public void setValue(float value) {
    this.value = value;
  }

  @Override
  public String toString() {
    return "ValueObject [id=" + id + ", value=" + value + "]";
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>By default, the output type of <code>INLINE</code> is used so that you need not specify an output collection.To specify additional Map-Reduce options, use an overloaded method that takes an additional <code>MapReduceOptions</code> argument.The class <code>MapReduceOptions</code> has a fluent API, so adding additional options can be done in a compact syntax.The following example sets the output collection to <code>jmr1_out</code> (note that setting only the output collection assumes a default output type of <code>REPLACE</code>):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">MapReduceResults&lt;ValueObject&gt; results = mongoOperations.mapReduce("jmr1", "classpath:map.js", "classpath:reduce.js",
                                                                     new MapReduceOptions().outputCollection("jmr1_out"), ValueObject.class);</code></pre>
</div>
</div>
<div class="paragraph">
<p>There is also a static import (<code>import static org.springframework.data.mongodb.core.mapreduce.MapReduceOptions.options;</code>) that can be used to make the syntax slightly more compact, as the following example shows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">MapReduceResults&lt;ValueObject&gt; results = mongoOperations.mapReduce("jmr1", "classpath:map.js", "classpath:reduce.js",
                                                                     options().outputCollection("jmr1_out"), ValueObject.class);</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also specify a query to reduce the set of data that is fed into the Map-Reduce operation.The following example removes the document that contains [a,b] from consideration for Map-Reduce operations:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">Query query = new Query(where("x").ne(new String[] { "a", "b" }));
MapReduceResults&lt;ValueObject&gt; results = mongoOperations.mapReduce(query, "jmr1", "classpath:map.js", "classpath:reduce.js",
                                                                     options().outputCollection("jmr1_out"), ValueObject.class);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that you can specify additional limit and sort values on the query, but you cannot skip values.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="mongo.server-side-scripts"><a class="anchor" href="index.html#mongo.server-side-scripts"></a>11.10. Script Operations</h3>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p><a href="https://docs.mongodb.com/master/release-notes/4.2-compatibility/">MongoDB 4.2</a> removed support for the <code>eval</code> command used
by <code>ScriptOperations</code>.<br>
There is no replacement for the removed functionality.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>MongoDB allows running JavaScript functions on the server by either directly sending the script or calling a stored one. <code>ScriptOperations</code> can be accessed through <code>MongoTemplate</code> and provides basic abstraction for <code>JavaScript</code> usage. The following example shows how to us the <code>ScriptOperations</code> class:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">ScriptOperations scriptOps = template.scriptOps();

ExecutableMongoScript echoScript = new ExecutableMongoScript("function(x) { return x; }");
scriptOps.execute(echoScript, "directly execute script");     <i class="conum" data-value="1"></i><b>(1)</b>

scriptOps.register(new NamedMongoScript("echo", echoScript)); <i class="conum" data-value="2"></i><b>(2)</b>
scriptOps.call("echo", "execute script via name");            <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Run the script directly without storing the function on server side.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Store the script using 'echo' as its name. The given name identifies the script and allows calling it later.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Run the script with name 'echo' using the provided parameters.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="mongo.group"><a class="anchor" href="index.html#mongo.group"></a>11.11. Group Operations</h3>
<div class="paragraph">
<p>As an alternative to using Map-Reduce to perform data aggregation, you can use the <a href="https://www.mongodb.org/display/DOCS/Aggregation#Aggregation-Group"><code>group</code> operation</a> which feels similar to using SQL&#8217;s group by query style, so it may feel more approachable vs. using Map-Reduce. Using the group operations does have some limitations, for example it is not supported in a shared environment and it returns the full result set in a single BSON object, so the result should be small, less than 10,000 keys.</p>
</div>
<div class="paragraph">
<p>Spring provides integration with MongoDB&#8217;s group operation by providing methods on MongoOperations to simplify the creation and running of group operations. It can convert the results of the group operation to a POJO and also integrates with Spring&#8217;s <a href="https://docs.spring.io/spring/docs/5.3.1/spring-framework-reference/core.html#resources">Resource abstraction</a> abstraction. This will let you place your JavaScript files on the file system, classpath, http server or any other Spring Resource implementation and then reference the JavaScript resources via an easy URI style syntax, e.g. 'classpath:reduce.js;. Externalizing JavaScript code in files if often preferable to embedding them as Java strings in your code. Note that you can still pass JavaScript code as Java strings if you prefer.</p>
</div>
<div class="sect3">
<h4 id="mongo.group.example"><a class="anchor" href="index.html#mongo.group.example"></a>11.11.1. Example Usage</h4>
<div class="paragraph">
<p>In order to understand how group operations work the following example is used, which is somewhat artificial. For a more realistic example consult the book 'MongoDB - The definitive guide'. A collection named <code>group_test_collection</code> created with the following rows.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">{ "_id" : ObjectId("4ec1d25d41421e2015da64f1"), "x" : 1 }
{ "_id" : ObjectId("4ec1d25d41421e2015da64f2"), "x" : 1 }
{ "_id" : ObjectId("4ec1d25d41421e2015da64f3"), "x" : 2 }
{ "_id" : ObjectId("4ec1d25d41421e2015da64f4"), "x" : 3 }
{ "_id" : ObjectId("4ec1d25d41421e2015da64f5"), "x" : 3 }
{ "_id" : ObjectId("4ec1d25d41421e2015da64f6"), "x" : 3 }</code></pre>
</div>
</div>
<div class="paragraph">
<p>We would like to group by the only field in each row, the <code>x</code> field and aggregate the number of times each specific value of <code>x</code> occurs. To do this we need to create an initial document that contains our count variable and also a reduce function which will increment it each time it is encountered. The Java code to run the group operation is shown below</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">GroupByResults&lt;XObject&gt; results = mongoTemplate.group("group_test_collection",
                                                      GroupBy.key("x").initialDocument("{ count: 0 }").reduceFunction("function(doc, prev) { prev.count += 1 }"),
                                                      XObject.class);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The first argument is the name of the collection to run the group operation over, the second is a fluent API that specifies properties of the group operation via a <code>GroupBy</code> class. In this example we are using just the <code>intialDocument</code> and <code>reduceFunction</code> methods. You can also specify a key-function, as well as a finalizer as part of the fluent API. If you have multiple keys to group by, you can pass in a comma separated list of keys.</p>
</div>
<div class="paragraph">
<p>The raw results of the group operation is a JSON document that looks like this</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">{
  "retval" : [ { "x" : 1.0 , "count" : 2.0} ,
               { "x" : 2.0 , "count" : 1.0} ,
               { "x" : 3.0 , "count" : 3.0} ] ,
  "count" : 6.0 ,
  "keys" : 3 ,
  "ok" : 1.0
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The document under the "retval" field is mapped onto the third argument in the group method, in this case XObject which is shown below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">public class XObject {

  private float x;

  private float count;


  public float getX() {
    return x;
  }

  public void setX(float x) {
    this.x = x;
  }

  public float getCount() {
    return count;
  }

  public void setCount(float count) {
    this.count = count;
  }

  @Override
  public String toString() {
    return "XObject [x=" + x + " count = " + count + "]";
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also obtain the raw result as a <code>Document</code> by calling the method <code>getRawResults</code> on the <code>GroupByResults</code> class.</p>
</div>
<div class="paragraph">
<p>There is an additional method overload of the group method on <code>MongoOperations</code> which lets you specify a <code>Criteria</code> object for selecting a subset of the rows. An example which uses a <code>Criteria</code> object, with some syntax sugar using static imports, as well as referencing a key-function and reduce function javascript files via a Spring Resource string is shown below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">import static org.springframework.data.mongodb.core.mapreduce.GroupBy.keyFunction;
import static org.springframework.data.mongodb.core.query.Criteria.where;

GroupByResults&lt;XObject&gt; results = mongoTemplate.group(where("x").gt(0),
                                        "group_test_collection",
                                        keyFunction("classpath:keyFunction.js").initialDocument("{ count: 0 }").reduceFunction("classpath:groupReduce.js"), XObject.class);</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="mongo.aggregation"><a class="anchor" href="index.html#mongo.aggregation"></a>11.12. Aggregation Framework Support</h3>
<div class="paragraph">
<p>Spring Data MongoDB provides support for the Aggregation Framework introduced to MongoDB in version 2.2.</p>
</div>
<div class="paragraph">
<p>For further information, see the full <a href="https://docs.mongodb.org/manual/aggregation/">reference documentation</a> of the aggregation framework and other data aggregation tools for MongoDB.</p>
</div>
<div class="sect3">
<h4 id="mongo.aggregation.basic-concepts"><a class="anchor" href="index.html#mongo.aggregation.basic-concepts"></a>11.12.1. Basic Concepts</h4>
<div class="paragraph">
<p>The Aggregation Framework support in Spring Data MongoDB is based on the following key abstractions: <code>Aggregation</code>, <code>AggregationOperation</code>, and <code>AggregationResults</code>.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>Aggregation</code></p>
<div class="paragraph">
<p>An <code>Aggregation</code> represents a MongoDB <code>aggregate</code> operation and holds the description of the aggregation pipeline instructions. Aggregations are created by invoking the appropriate <code>newAggregation(…)</code> static factory method of the <code>Aggregation</code> class, which takes a list of <code>AggregateOperation</code> and an optional input class.</p>
</div>
<div class="paragraph">
<p>The actual aggregate operation is run by the <code>aggregate</code> method of the <code>MongoTemplate</code>, which takes the desired output class as a parameter.</p>
</div>
</li>
<li>
<p><code>TypedAggregation</code></p>
<div class="paragraph">
<p>A <code>TypedAggregation</code>, just like an <code>Aggregation</code>, holds the instructions of the aggregation pipeline and a reference to the input type, that is used for mapping domain properties to actual document fields.</p>
</div>
<div class="paragraph">
<p>At runtime, field references get checked against the given input type, considering potential <code>@Field</code> annotations and raising errors when referencing nonexistent properties.</p>
</div>
</li>
<li>
<p><code>AggregationOperation</code></p>
<div class="paragraph">
<p>An <code>AggregationOperation</code> represents a MongoDB aggregation pipeline operation and describes the processing that should be performed in this aggregation step. Although you could manually create an <code>AggregationOperation</code>, we recommend using the static factory methods provided by the <code>Aggregate</code> class to construct an <code>AggregateOperation</code>.</p>
</div>
</li>
<li>
<p><code>AggregationResults</code></p>
<div class="paragraph">
<p><code>AggregationResults</code> is the container for the result of an aggregate operation. It provides access to the raw aggregation result, in the form of a <code>Document</code> to the mapped objects and other information about the aggregation.</p>
</div>
<div class="paragraph">
<p>The following listing shows the canonical example for using the Spring Data MongoDB support for the MongoDB Aggregation Framework:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">import static org.springframework.data.mongodb.core.aggregation.Aggregation.*;

Aggregation agg = newAggregation(
    pipelineOP1(),
    pipelineOP2(),
    pipelineOPn()
);

AggregationResults&lt;OutputType&gt; results = mongoTemplate.aggregate(agg, "INPUT_COLLECTION_NAME", OutputType.class);
List&lt;OutputType&gt; mappedResult = results.getMappedResults();</code></pre>
</div>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Note that, if you provide an input class as the first parameter to the <code>newAggregation</code> method, the <code>MongoTemplate</code> derives the name of the input collection from this class. Otherwise, if you do not not specify an input class, you must provide the name of the input collection explicitly. If both an input class and an input collection are provided, the latter takes precedence.</p>
</div>
</div>
<div class="sect3">
<h4 id="mongo.aggregation.supported-aggregation-operations"><a class="anchor" href="index.html#mongo.aggregation.supported-aggregation-operations"></a>11.12.2. Supported Aggregation Operations</h4>
<div class="paragraph">
<p>The MongoDB Aggregation Framework provides the following types of aggregation operations:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Pipeline Aggregation Operators</p>
</li>
<li>
<p>Group Aggregation Operators</p>
</li>
<li>
<p>Boolean Aggregation Operators</p>
</li>
<li>
<p>Comparison Aggregation Operators</p>
</li>
<li>
<p>Arithmetic Aggregation Operators</p>
</li>
<li>
<p>String Aggregation Operators</p>
</li>
<li>
<p>Date Aggregation Operators</p>
</li>
<li>
<p>Array Aggregation Operators</p>
</li>
<li>
<p>Conditional Aggregation Operators</p>
</li>
<li>
<p>Lookup Aggregation Operators</p>
</li>
<li>
<p>Convert Aggregation Operators</p>
</li>
<li>
<p>Object Aggregation Operators</p>
</li>
<li>
<p>Script Aggregation Operators</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>At the time of this writing, we provide support for the following Aggregation Operations in Spring Data MongoDB:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 13. Aggregation Operations currently supported by Spring Data MongoDB</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Pipeline Aggregation Operators</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>bucket</code>, <code>bucketAuto</code>, <code>count</code>, <code>facet</code>, <code>geoNear</code>, <code>graphLookup</code>, <code>group</code>, <code>limit</code>, <code>lookup</code>, <code>match</code>, <code>project</code>, <code>replaceRoot</code>, <code>skip</code>, <code>sort</code>, <code>unwind</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set Aggregation Operators</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>setEquals</code>, <code>setIntersection</code>, <code>setUnion</code>, <code>setDifference</code>, <code>setIsSubset</code>, <code>anyElementTrue</code>, <code>allElementsTrue</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Group Aggregation Operators</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>addToSet</code>, <code>first</code>, <code>last</code>, <code>max</code>, <code>min</code>, <code>avg</code>, <code>push</code>, <code>sum</code>, <code>(*count)</code>, <code>stdDevPop</code>, <code>stdDevSamp</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Arithmetic Aggregation Operators</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>abs</code>, <code>add</code> (*via <code>plus</code>), <code>ceil</code>, <code>divide</code>, <code>exp</code>, <code>floor</code>, <code>ln</code>, <code>log</code>, <code>log10</code>, <code>mod</code>, <code>multiply</code>, <code>pow</code>, <code>round</code>, <code>sqrt</code>, <code>subtract</code> (*via <code>minus</code>), <code>trunc</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">String Aggregation Operators</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>concat</code>, <code>substr</code>, <code>toLower</code>, <code>toUpper</code>, <code>stcasecmp</code>, <code>indexOfBytes</code>, <code>indexOfCP</code>, <code>split</code>, <code>strLenBytes</code>, <code>strLenCP</code>, <code>substrCP</code>, <code>trim</code>, <code>ltrim</code>, <code>rtim</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Comparison Aggregation Operators</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>eq</code> (*via: <code>is</code>), <code>gt</code>, <code>gte</code>, <code>lt</code>, <code>lte</code>, <code>ne</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Array Aggregation Operators</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>arrayElementAt</code>, <code>arrayToObject</code>, <code>concatArrays</code>, <code>filter</code>, <code>in</code>, <code>indexOfArray</code>, <code>isArray</code>, <code>range</code>, <code>reverseArray</code>, <code>reduce</code>, <code>size</code>, <code>slice</code>, <code>zip</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Literal Operators</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>literal</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Date Aggregation Operators</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>dayOfYear</code>, <code>dayOfMonth</code>, <code>dayOfWeek</code>, <code>year</code>, <code>month</code>, <code>week</code>, <code>hour</code>, <code>minute</code>, <code>second</code>, <code>millisecond</code>, <code>dateToString</code>, <code>dateFromString</code>, <code>dateFromParts</code>, <code>dateToParts</code>, <code>isoDayOfWeek</code>, <code>isoWeek</code>, <code>isoWeekYear</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Variable Operators</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>map</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Conditional Aggregation Operators</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>cond</code>, <code>ifNull</code>, <code>switch</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Type Aggregation Operators</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>type</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Convert Aggregation Operators</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>convert</code>, <code>toBool</code>, <code>toDate</code>, <code>toDecimal</code>, <code>toDouble</code>, <code>toInt</code>, <code>toLong</code>, <code>toObjectId</code>, <code>toString</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Object Aggregation Operators</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>objectToArray</code>, <code>mergeObjects</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Script Aggregation Operators</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>function</code>, <code>accumulator</code></p></td>
</tr>
</tbody>
</table>
<div class="ulist">
<ul>
<li>
<p>The operation is mapped or added by Spring Data MongoDB.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Note that the aggregation operations not listed here are currently not supported by Spring Data MongoDB. Comparison aggregation operators are expressed as <code>Criteria</code> expressions.</p>
</div>
</div>
<div class="sect3">
<h4 id="mongo.aggregation.projection"><a class="anchor" href="index.html#mongo.aggregation.projection"></a>11.12.3. Projection Expressions</h4>
<div class="paragraph">
<p>Projection expressions are used to define the fields that are the outcome of a particular aggregation step. Projection expressions can be defined through the <code>project</code> method of the <code>Aggregation</code> class, either by passing a list of <code>String</code> objects or an aggregation framework <code>Fields</code> object. The projection can be extended with additional fields through a fluent API by using the <code>and(String)</code> method and aliased by using the <code>as(String)</code> method.
Note that you can also define fields with aliases by using the <code>Fields.field</code> static factory method of the aggregation framework, which you can then use to construct a new <code>Fields</code> instance. References to projected fields in later aggregation stages are valid only for the field names of included fields or their aliases (including newly defined fields and their aliases). Fields not included in the projection cannot be referenced in later aggregation stages. The following listings show examples of projection expression:</p>
</div>
<div class="exampleblock">
<div class="title">Example 100. Projection expression examples</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">// generates {$project: {name: 1, netPrice: 1}}
project("name", "netPrice")

// generates {$project: {thing1: $thing2}}
project().and("thing1").as("thing2")

// generates {$project: {a: 1, b: 1, thing2: $thing1}}
project("a","b").and("thing1").as("thing2")</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 101. Multi-Stage Aggregation using Projection and Sorting</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">// generates {$project: {name: 1, netPrice: 1}}, {$sort: {name: 1}}
project("name", "netPrice"), sort(ASC, "name")

// generates {$project: {name: $firstname}}, {$sort: {name: 1}}
project().and("firstname").as("name"), sort(ASC, "name")

// does not work
project().and("firstname").as("name"), sort(ASC, "firstname")</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>More examples for project operations can be found in the <code>AggregationTests</code> class. Note that further details regarding the projection expressions can be found in the <a href="https://docs.mongodb.org/manual/reference/operator/aggregation/project/#pipe._S_project">corresponding section</a> of the MongoDB Aggregation Framework reference documentation.</p>
</div>
</div>
<div class="sect3">
<h4 id="mongo.aggregation.facet"><a class="anchor" href="index.html#mongo.aggregation.facet"></a>11.12.4. Faceted Classification</h4>
<div class="paragraph">
<p>As of Version 3.4, MongoDB supports faceted classification by using the Aggregation Framework. A faceted classification uses semantic categories (either general or subject-specific) that are combined to create the full classification entry. Documents flowing through the aggregation pipeline are classified into buckets. A multi-faceted classification enables various aggregations on the same set of input documents, without needing to retrieve the input documents multiple times.</p>
</div>
<div class="sect4">
<h5>Buckets</h5>
<div class="paragraph">
<p>Bucket operations categorize incoming documents into groups, called buckets, based on a specified expression and bucket boundaries. Bucket operations require a grouping field or a grouping expression. You can define them by using the <code>bucket()</code> and <code>bucketAuto()</code> methods of the <code>Aggregate</code> class. <code>BucketOperation</code> and <code>BucketAutoOperation</code> can expose accumulations based on aggregation expressions for input documents. You can extend the bucket operation with additional parameters through a fluent API by using the <code>with…()</code> methods and the <code>andOutput(String)</code> method. You can alias the operation by using the <code>as(String)</code> method. Each bucket is represented as a document in the output.</p>
</div>
<div class="paragraph">
<p><code>BucketOperation</code> takes a defined set of boundaries to group incoming documents into these categories. Boundaries are required to be sorted. The following listing shows some examples of bucket operations:</p>
</div>
<div class="exampleblock">
<div class="title">Example 102. Bucket operation examples</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">// generates {$bucket: {groupBy: $price, boundaries: [0, 100, 400]}}
bucket("price").withBoundaries(0, 100, 400);

// generates {$bucket: {groupBy: $price, default: "Other" boundaries: [0, 100]}}
bucket("price").withBoundaries(0, 100).withDefault("Other");

// generates {$bucket: {groupBy: $price, boundaries: [0, 100], output: { count: { $sum: 1}}}}
bucket("price").withBoundaries(0, 100).andOutputCount().as("count");

// generates {$bucket: {groupBy: $price, boundaries: [0, 100], 5, output: { titles: { $push: "$title"}}}
bucket("price").withBoundaries(0, 100).andOutput("title").push().as("titles");</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p><code>BucketAutoOperation</code> determines boundaries in an attempt to evenly distribute documents into a specified number of buckets. <code>BucketAutoOperation</code> optionally takes a granularity value that specifies the <a href="https://en.wikipedia.org/wiki/Preferred_number">preferred number</a> series to use to ensure that the calculated boundary edges end on preferred round numbers or on powers of 10. The following listing shows examples of bucket operations:</p>
</div>
<div class="exampleblock">
<div class="title">Example 103. Bucket operation examples</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">// generates {$bucketAuto: {groupBy: $price, buckets: 5}}
bucketAuto("price", 5)

// generates {$bucketAuto: {groupBy: $price, buckets: 5, granularity: "E24"}}
bucketAuto("price", 5).withGranularity(Granularities.E24).withDefault("Other");

// generates {$bucketAuto: {groupBy: $price, buckets: 5, output: { titles: { $push: "$title"}}}
bucketAuto("price", 5).andOutput("title").push().as("titles");</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>To create output fields in buckets, bucket operations can use <code>AggregationExpression</code> through <code>andOutput()</code> and <a href="index.html#mongo.aggregation.projection.expressions">SpEL expressions</a> through <code>andOutputExpression()</code>.</p>
</div>
<div class="paragraph">
<p>Note that further details regarding bucket expressions can be found in the <a href="https://docs.mongodb.org/manual/reference/operator/aggregation/bucket/"><code>$bucket</code> section</a> and
<a href="https://docs.mongodb.org/manual/reference/operator/aggregation/bucketAuto/"><code>$bucketAuto</code> section</a> of the MongoDB Aggregation Framework reference documentation.</p>
</div>
</div>
<div class="sect4">
<h5>Multi-faceted Aggregation</h5>
<div class="paragraph">
<p>Multiple aggregation pipelines can be used to create multi-faceted aggregations that characterize data across multiple dimensions (or facets) within a single aggregation stage. Multi-faceted aggregations provide multiple filters and categorizations to guide data browsing and analysis. A common implementation of faceting is how many online retailers provide ways to narrow down search results by applying filters on product price, manufacturer, size, and other factors.</p>
</div>
<div class="paragraph">
<p>You can define a <code>FacetOperation</code> by using the <code>facet()</code> method of the <code>Aggregation</code> class. You can customize it with multiple aggregation pipelines by using the <code>and()</code> method. Each sub-pipeline has its own field in the output document where its results are stored as an array of documents.</p>
</div>
<div class="paragraph">
<p>Sub-pipelines can project and filter input documents prior to grouping. Common use cases include extraction of date parts or calculations before categorization. The following listing shows facet operation examples:</p>
</div>
<div class="exampleblock">
<div class="title">Example 104. Facet operation examples</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">// generates {$facet: {categorizedByPrice: [ { $match: { price: {$exists : true}}}, { $bucketAuto: {groupBy: $price, buckets: 5}}]}}
facet(match(Criteria.where("price").exists(true)), bucketAuto("price", 5)).as("categorizedByPrice"))

// generates {$facet: {categorizedByCountry: [ { $match: { country: {$exists : true}}}, { $sortByCount: "$country"}]}}
facet(match(Criteria.where("country").exists(true)), sortByCount("country")).as("categorizedByCountry"))

// generates {$facet: {categorizedByYear: [
//     { $project: { title: 1, publicationYear: { $year: "publicationDate"}}},
//     { $bucketAuto: {groupBy: $price, buckets: 5, output: { titles: {$push:"$title"}}}
// ]}}
facet(project("title").and("publicationDate").extractYear().as("publicationYear"),
      bucketAuto("publicationYear", 5).andOutput("title").push().as("titles"))
  .as("categorizedByYear"))</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Note that further details regarding facet operation can be found in the <a href="https://docs.mongodb.org/manual/reference/operator/aggregation/facet/"><code>$facet</code> section</a> of the MongoDB Aggregation Framework reference documentation.</p>
</div>
</div>
<div class="sect4">
<h5 id="mongo.aggregation.sort-by-count"><a class="anchor" href="index.html#mongo.aggregation.sort-by-count"></a>Sort By Count</h5>
<div class="paragraph">
<p>Sort by count operations group incoming documents based on the value of a specified expression, compute the count of documents in each distinct group, and sort the results by count. It offers a handy shortcut to apply sorting when using <a href="index.html#mongo.aggregation.facet">Faceted Classification</a>. Sort by count operations require a grouping field or grouping expression. The following listing shows a sort by count example:</p>
</div>
<div class="exampleblock">
<div class="title">Example 105. Sort by count example</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">// generates { $sortByCount: "$country" }
sortByCount("country");</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>A sort by count operation is equivalent to the following BSON (Binary JSON):</p>
</div>
<div class="listingblock">
<div class="content">
<pre>{ $group: { _id: &lt;expression&gt;, count: { $sum: 1 } } },
{ $sort: { count: -1 } }</pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="mongo.aggregation.projection.expressions"><a class="anchor" href="index.html#mongo.aggregation.projection.expressions"></a>Spring Expression Support in Projection Expressions</h5>
<div class="paragraph">
<p>We support the use of SpEL expressions in projection expressions through the <code>andExpression</code> method of the <code>ProjectionOperation</code> and <code>BucketOperation</code> classes. This feature lets you define the desired expression as a SpEL expression. On running a query, the SpEL expression is translated into a corresponding MongoDB projection expression part. This arrangement makes it much easier to express complex calculations.</p>
</div>
<div class="sect5">
<h6>Complex Calculations with SpEL expressions</h6>
<div class="paragraph">
<p>Consider the following SpEL expression:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">1 + (q + 1) / (q - 1)</code></pre>
</div>
</div>
<div class="paragraph">
<p>The preceding expression is translated into the following projection expression part:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="javascript" class="language-javascript hljs">{ "$add" : [ 1, {
    "$divide" : [ {
        "$add":["$q", 1]}, {
        "$subtract":[ "$q", 1]}
    ]
}]}</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can see examples in more context in <a href="index.html#mongo.aggregation.examples.example5">Aggregation Framework Example 5</a> and <a href="index.html#mongo.aggregation.examples.example6">Aggregation Framework Example 6</a>. You can find more usage examples for supported SpEL expression constructs in <code>SpelExpressionTransformerUnitTests</code>. The following table shows the SpEL transformations supported by Spring Data MongoDB:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 14. Supported SpEL transformations</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">SpEL Expression</th>
<th class="tableblock halign-left valign-top">Mongo Expression Part</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">a == b</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">{ $eq : [$a, $b] }</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">a != b</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">{ $ne : [$a , $b] }</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">a &gt; b</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">{ $gt : [$a, $b] }</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">a &gt;= b</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">{ $gte : [$a, $b] }</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">a &lt; b</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">{ $lt : [$a, $b] }</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">a &#8656; b</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">{ $lte : [$a, $b] }</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">a + b</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">{ $add : [$a, $b] }</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">a - b</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">{ $subtract : [$a, $b] }</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">a * b</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">{ $multiply : [$a, $b] }</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">a / b</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">{ $divide : [$a, $b] }</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">a^b</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">{ $pow : [$a, $b] }</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">a % b</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">{ $mod : [$a, $b] }</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">a &amp;&amp; b</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">{ $and : [$a, $b] }</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">a || b</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">{ $or : [$a, $b] }</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">!a</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">{ $not : [$a] }</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>In addition to the transformations shown in the preceding table, you can use standard SpEL operations such as <code>new</code> to (for example) create arrays and reference expressions through their names (followed by the arguments to use in brackets). The following example shows how to create an array in this fashion:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">// { $setEquals : [$a, [5, 8, 13] ] }
.andExpression("setEquals(a, new int[]{5, 8, 13})");</code></pre>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="mongo.aggregation.examples"><a class="anchor" href="index.html#mongo.aggregation.examples"></a>Aggregation Framework Examples</h5>
<div class="paragraph">
<p>The examples in this section demonstrate the usage patterns for the MongoDB Aggregation Framework with Spring Data MongoDB.</p>
</div>
<div class="sect5">
<h6 id="mongo.aggregation.examples.example1"><a class="anchor" href="index.html#mongo.aggregation.examples.example1"></a>Aggregation Framework Example 1</h6>
<div class="paragraph">
<p>In this introductory example, we want to aggregate a list of tags to get the occurrence count of a particular tag from a MongoDB collection (called <code>tags</code>) sorted by the occurrence count in descending order. This example demonstrates the usage of grouping, sorting, projections (selection), and unwinding (result splitting).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">class TagCount {
 String tag;
 int n;
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">import static org.springframework.data.mongodb.core.aggregation.Aggregation.*;

Aggregation agg = newAggregation(
    project("tags"),
    unwind("tags"),
    group("tags").count().as("n"),
    project("n").and("tag").previousOperation(),
    sort(DESC, "n")
);

AggregationResults&lt;TagCount&gt; results = mongoTemplate.aggregate(agg, "tags", TagCount.class);
List&lt;TagCount&gt; tagCount = results.getMappedResults();</code></pre>
</div>
</div>
<div class="paragraph">
<p>The preceding listing uses the following algorithm:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Create a new aggregation by using the <code>newAggregation</code> static factory method, to which we pass a list of aggregation operations. These aggregate operations define the aggregation pipeline of our <code>Aggregation</code>.</p>
</li>
<li>
<p>Use the <code>project</code> operation to select the <code>tags</code> field (which is an array of strings) from the input collection.</p>
</li>
<li>
<p>Use the <code>unwind</code> operation to generate a new document for each tag within the <code>tags</code> array.</p>
</li>
<li>
<p>Use the <code>group</code> operation to define a group for each <code>tags</code> value for which we aggregate the occurrence count (by using the <code>count</code> aggregation operator and collecting the result in a new field called <code>n</code>).</p>
</li>
<li>
<p>Select the <code>n</code> field and create an alias for the ID field generated from the previous group operation (hence the call to <code>previousOperation()</code>) with a name of <code>tag</code>.</p>
</li>
<li>
<p>Use the <code>sort</code> operation to sort the resulting list of tags by their occurrence count in descending order.</p>
</li>
<li>
<p>Call the <code>aggregate</code> method on <code>MongoTemplate</code> to let MongoDB perform the actual aggregation operation, with the created <code>Aggregation</code> as an argument.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Note that the input collection is explicitly specified as the <code>tags</code> parameter to the <code>aggregate</code> Method. If the name of the input collection is not specified explicitly, it is derived from the input class passed as the first parameter to the <code>newAggreation</code> method.</p>
</div>
</div>
<div class="sect5">
<h6 id="mongo.aggregation.examples.example2"><a class="anchor" href="index.html#mongo.aggregation.examples.example2"></a>Aggregation Framework Example 2</h6>
<div class="paragraph">
<p>This example is based on the <a href="https://docs.mongodb.org/manual/tutorial/aggregation-examples/#largest-and-smallest-cities-by-state">Largest and Smallest Cities by State</a> example from the MongoDB Aggregation Framework documentation. We added additional sorting to produce stable results with different MongoDB versions. Here we want to return the smallest and largest cities by population for each state by using the aggregation framework. This example demonstrates grouping, sorting, and projections (selection).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">class ZipInfo {
   String id;
   String city;
   String state;
   @Field("pop") int population;
   @Field("loc") double[] location;
}

class City {
   String name;
   int population;
}

class ZipInfoStats {
   String id;
   String state;
   City biggestCity;
   City smallestCity;
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">import static org.springframework.data.mongodb.core.aggregation.Aggregation.*;

TypedAggregation&lt;ZipInfo&gt; aggregation = newAggregation(ZipInfo.class,
    group("state", "city")
       .sum("population").as("pop"),
    sort(ASC, "pop", "state", "city"),
    group("state")
       .last("city").as("biggestCity")
       .last("pop").as("biggestPop")
       .first("city").as("smallestCity")
       .first("pop").as("smallestPop"),
    project()
       .and("state").previousOperation()
       .and("biggestCity")
          .nested(bind("name", "biggestCity").and("population", "biggestPop"))
       .and("smallestCity")
          .nested(bind("name", "smallestCity").and("population", "smallestPop")),
    sort(ASC, "state")
);

AggregationResults&lt;ZipInfoStats&gt; result = mongoTemplate.aggregate(aggregation, ZipInfoStats.class);
ZipInfoStats firstZipInfoStats = result.getMappedResults().get(0);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that the <code>ZipInfo</code> class maps the structure of the given input-collection. The <code>ZipInfoStats</code> class defines the structure in the desired output format.</p>
</div>
<div class="paragraph">
<p>The preceding listings use the following algorithm:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Use the <code>group</code> operation to define a group from the input-collection. The grouping criteria is the combination of the <code>state</code> and <code>city</code> fields, which forms the ID structure of the group. We aggregate the value of the <code>population</code> property from the grouped elements by using the <code>sum</code> operator and save the result in the <code>pop</code> field.</p>
</li>
<li>
<p>Use the <code>sort</code> operation to sort the intermediate-result by the <code>pop</code>, <code>state</code> and <code>city</code> fields, in ascending order, such that the smallest city is at the top and the biggest city is at the bottom of the result. Note that the sorting on <code>state</code> and <code>city</code> is implicitly performed against the group ID fields (which Spring Data MongoDB handled).</p>
</li>
<li>
<p>Use a <code>group</code> operation again to group the intermediate result by <code>state</code>. Note that <code>state</code> again implicitly references a group ID field. We select the name and the population count of the biggest and smallest city with calls to the <code>last(…)</code> and <code>first(&#8230;&#8203;)</code> operators, respectively, in the <code>project</code> operation.</p>
</li>
<li>
<p>Select the <code>state</code> field from the previous <code>group</code> operation. Note that <code>state</code> again implicitly references a group ID field. Because we do not want an implicitly generated ID to appear, we exclude the ID from the previous operation by using <code>and(previousOperation()).exclude()</code>. Because we want to populate the nested <code>City</code> structures in our output class, we have to emit appropriate sub-documents by using the nested method.</p>
</li>
<li>
<p>Sort the resulting list of <code>StateStats</code> by their state name in ascending order in the <code>sort</code> operation.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Note that we derive the name of the input collection from the <code>ZipInfo</code> class passed as the first parameter to the <code>newAggregation</code> method.</p>
</div>
</div>
<div class="sect5">
<h6 id="mongo.aggregation.examples.example3"><a class="anchor" href="index.html#mongo.aggregation.examples.example3"></a>Aggregation Framework Example 3</h6>
<div class="paragraph">
<p>This example is based on the <a href="https://docs.mongodb.org/manual/tutorial/aggregation-examples/#states-with-populations-over-10-million">States with Populations Over 10 Million</a> example from the MongoDB Aggregation Framework documentation. We added additional sorting to produce stable results with different MongoDB versions. Here we want to return all states with a population greater than 10 million, using the aggregation framework. This example demonstrates grouping, sorting, and matching (filtering).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">class StateStats {
   @Id String id;
   String state;
   @Field("totalPop") int totalPopulation;
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">import static org.springframework.data.mongodb.core.aggregation.Aggregation.*;

TypedAggregation&lt;ZipInfo&gt; agg = newAggregation(ZipInfo.class,
    group("state").sum("population").as("totalPop"),
    sort(ASC, previousOperation(), "totalPop"),
    match(where("totalPop").gte(10 * 1000 * 1000))
);

AggregationResults&lt;StateStats&gt; result = mongoTemplate.aggregate(agg, StateStats.class);
List&lt;StateStats&gt; stateStatsList = result.getMappedResults();</code></pre>
</div>
</div>
<div class="paragraph">
<p>The preceding listings use the following algorithm:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Group the input collection by the <code>state</code> field and calculate the sum of the <code>population</code> field and store the result in the new field <code>"totalPop"</code>.</p>
</li>
<li>
<p>Sort the intermediate result by the id-reference of the previous group operation in addition to the <code>"totalPop"</code> field in ascending order.</p>
</li>
<li>
<p>Filter the intermediate result by using a <code>match</code> operation which accepts a <code>Criteria</code> query as an argument.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Note that we derive the name of the input collection from the <code>ZipInfo</code> class passed as first parameter to the <code>newAggregation</code> method.</p>
</div>
</div>
<div class="sect5">
<h6 id="mongo.aggregation.examples.example4"><a class="anchor" href="index.html#mongo.aggregation.examples.example4"></a>Aggregation Framework Example 4</h6>
<div class="paragraph">
<p>This example demonstrates the use of simple arithmetic operations in the projection operation.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">class Product {
    String id;
    String name;
    double netPrice;
    int spaceUnits;
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">import static org.springframework.data.mongodb.core.aggregation.Aggregation.*;

TypedAggregation&lt;Product&gt; agg = newAggregation(Product.class,
    project("name", "netPrice")
        .and("netPrice").plus(1).as("netPricePlus1")
        .and("netPrice").minus(1).as("netPriceMinus1")
        .and("netPrice").multiply(1.19).as("grossPrice")
        .and("netPrice").divide(2).as("netPriceDiv2")
        .and("spaceUnits").mod(2).as("spaceUnitsMod2")
);

AggregationResults&lt;Document&gt; result = mongoTemplate.aggregate(agg, Document.class);
List&lt;Document&gt; resultList = result.getMappedResults();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that we derive the name of the input collection from the <code>Product</code> class passed as first parameter to the <code>newAggregation</code> method.</p>
</div>
</div>
<div class="sect5">
<h6 id="mongo.aggregation.examples.example5"><a class="anchor" href="index.html#mongo.aggregation.examples.example5"></a>Aggregation Framework Example 5</h6>
<div class="paragraph">
<p>This example demonstrates the use of simple arithmetic operations derived from SpEL Expressions in the projection operation.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">class Product {
    String id;
    String name;
    double netPrice;
    int spaceUnits;
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">import static org.springframework.data.mongodb.core.aggregation.Aggregation.*;

TypedAggregation&lt;Product&gt; agg = newAggregation(Product.class,
    project("name", "netPrice")
        .andExpression("netPrice + 1").as("netPricePlus1")
        .andExpression("netPrice - 1").as("netPriceMinus1")
        .andExpression("netPrice / 2").as("netPriceDiv2")
        .andExpression("netPrice * 1.19").as("grossPrice")
        .andExpression("spaceUnits % 2").as("spaceUnitsMod2")
        .andExpression("(netPrice * 0.8  + 1.2) * 1.19").as("grossPriceIncludingDiscountAndCharge")

);

AggregationResults&lt;Document&gt; result = mongoTemplate.aggregate(agg, Document.class);
List&lt;Document&gt; resultList = result.getMappedResults();</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="mongo.aggregation.examples.example6"><a class="anchor" href="index.html#mongo.aggregation.examples.example6"></a>Aggregation Framework Example 6</h6>
<div class="paragraph">
<p>This example demonstrates the use of complex arithmetic operations derived from SpEL Expressions in the projection operation.</p>
</div>
<div class="paragraph">
<p>Note: The additional parameters passed to the <code>addExpression</code> method can be referenced with indexer expressions according to their position. In this example, we reference the first parameter of the parameters array with <code>[0]</code>. When the SpEL expression is transformed into a MongoDB aggregation framework expression, external parameter expressions are replaced with their respective values.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">class Product {
    String id;
    String name;
    double netPrice;
    int spaceUnits;
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">import static org.springframework.data.mongodb.core.aggregation.Aggregation.*;

double shippingCosts = 1.2;

TypedAggregation&lt;Product&gt; agg = newAggregation(Product.class,
    project("name", "netPrice")
        .andExpression("(netPrice * (1-discountRate)  + [0]) * (1+taxRate)", shippingCosts).as("salesPrice")
);

AggregationResults&lt;Document&gt; result = mongoTemplate.aggregate(agg, Document.class);
List&lt;Document&gt; resultList = result.getMappedResults();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that we can also refer to other fields of the document within the SpEL expression.</p>
</div>
</div>
<div class="sect5">
<h6 id="mongo.aggregation.examples.example7"><a class="anchor" href="index.html#mongo.aggregation.examples.example7"></a>Aggregation Framework Example 7</h6>
<div class="paragraph">
<p>This example uses conditional projection. It is derived from the <a href="https://docs.mongodb.com/manual/reference/operator/aggregation/cond/">$cond reference documentation</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">public class InventoryItem {

  @Id int id;
  String item;
  String description;
  int qty;
}

public class InventoryItemProjection {

  @Id int id;
  String item;
  String description;
  int qty;
  int discount
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">import static org.springframework.data.mongodb.core.aggregation.Aggregation.*;

TypedAggregation&lt;InventoryItem&gt; agg = newAggregation(InventoryItem.class,
  project("item").and("discount")
    .applyCondition(ConditionalOperator.newBuilder().when(Criteria.where("qty").gte(250))
      .then(30)
      .otherwise(20))
    .and(ifNull("description", "Unspecified")).as("description")
);

AggregationResults&lt;InventoryItemProjection&gt; result = mongoTemplate.aggregate(agg, "inventory", InventoryItemProjection.class);
List&lt;InventoryItemProjection&gt; stateStatsList = result.getMappedResults();</code></pre>
</div>
</div>
<div class="paragraph">
<p>This one-step aggregation uses a projection operation with the <code>inventory</code> collection. We project the <code>discount</code> field by using a conditional operation for all inventory items that have a <code>qty</code> greater than or equal to <code>250</code>. A second conditional projection is performed for the <code>description</code> field. We apply the <code>Unspecified</code> description to all items that either do not have a <code>description</code> field or items that have a <code>null</code> description.</p>
</div>
<div class="paragraph">
<p>As of MongoDB 3.6, it is possible to exclude fields from the projection by using a conditional expression.</p>
</div>
<div class="exampleblock">
<div class="title">Example 106. Conditional aggregation projection</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">TypedAggregation&lt;Book&gt; agg = Aggregation.newAggregation(Book.class,
  project("title")
    .and(ConditionalOperators.when(ComparisonOperators.valueOf("author.middle")     <i class="conum" data-value="1"></i><b>(1)</b>
        .equalToValue(""))                                                          <i class="conum" data-value="2"></i><b>(2)</b>
        .then("$$REMOVE")                                                           <i class="conum" data-value="3"></i><b>(3)</b>
        .otherwiseValueOf("author.middle")                                          <i class="conum" data-value="4"></i><b>(4)</b>
    )
	.as("author.middle"));</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>If the value of the field <code>author.middle</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>does not contain a value,</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>then use <a href="https://docs.mongodb.com/manual/reference/aggregation-variables/#variable.REMOVE"><code>$$REMOVE</code></a> to exclude the field.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Otherwise, add the field value of <code>author.middle</code>.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="mongo-template.index-and-collections"><a class="anchor" href="index.html#mongo-template.index-and-collections"></a>11.13. Index and Collection Management</h3>
<div class="paragraph">
<p><code>MongoTemplate</code> provides a few methods for managing indexes and collections. These methods are collected into a helper interface called <code>IndexOperations</code>. You can access these operations by calling the <code>indexOps</code> method and passing in either the collection name or the <code>java.lang.Class</code> of your entity (the collection name is derived from the <code>.class</code>, either by name or from annotation metadata).</p>
</div>
<div class="paragraph">
<p>The following listing shows the <code>IndexOperations</code> interface:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">public interface IndexOperations {

  void ensureIndex(IndexDefinition indexDefinition);

  void dropIndex(String name);

  void dropAllIndexes();

  void resetIndexCache();

  List&lt;IndexInfo&gt; getIndexInfo();
}</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="mongo-template.index-and-collections.index"><a class="anchor" href="index.html#mongo-template.index-and-collections.index"></a>11.13.1. Methods for Creating an Index</h4>
<div class="paragraph">
<p>You can create an index on a collection to improve query performance by using the MongoTemplate class, as the following example shows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">mongoTemplate.indexOps(Person.class).ensureIndex(new Index().on("name",Order.ASCENDING));</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>ensureIndex</code> makes sure that an index for the provided IndexDefinition exists for the collection.</p>
</div>
<div class="paragraph">
<p>You can create standard, geospatial, and text indexes by using the <code>IndexDefinition</code>, <code>GeoSpatialIndex</code> and <code>TextIndexDefinition</code> classes. For example, given the <code>Venue</code> class defined in a previous section, you could declare a geospatial query, as the following example shows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">mongoTemplate.indexOps(Venue.class).ensureIndex(new GeospatialIndex("location"));</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<code>Index</code> and <code>GeospatialIndex</code> support configuration of <a href="index.html#mongo.collation">collations</a>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="mongo-template.index-and-collections.access"><a class="anchor" href="index.html#mongo-template.index-and-collections.access"></a>11.13.2. Accessing Index Information</h4>
<div class="paragraph">
<p>The <code>IndexOperations</code> interface has the <code>getIndexInfo</code> method that returns a list of <code>IndexInfo</code> objects. This list contains all the indexes defined on the collection. The following example defines an index on the <code>Person</code> class that has an <code>age</code> property:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">template.indexOps(Person.class).ensureIndex(new Index().on("age", Order.DESCENDING).unique());

List&lt;IndexInfo&gt; indexInfoList = template.indexOps(Person.class).getIndexInfo();

// Contains
// [IndexInfo [fieldSpec={_id=ASCENDING}, name=_id_, unique=false, sparse=false],
//  IndexInfo [fieldSpec={age=DESCENDING}, name=age_-1, unique=true, sparse=false]]</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="mongo-template.index-and-collections.collection"><a class="anchor" href="index.html#mongo-template.index-and-collections.collection"></a>11.13.3. Methods for Working with a Collection</h4>
<div class="paragraph">
<p>The following example shows how to create a collection:</p>
</div>
<div class="exampleblock">
<div class="title">Example 107. Working with collections by using <code>MongoTemplate</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">MongoCollection&lt;Document&gt; collection = null;
if (!mongoTemplate.getCollectionNames().contains("MyNewCollection")) {
    collection = mongoTemplate.createCollection("MyNewCollection");
}

mongoTemplate.dropCollection("MyNewCollection");</code></pre>
</div>
</div>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>getCollectionNames</strong>: Returns a set of collection names.</p>
</li>
<li>
<p><strong>collectionExists</strong>: Checks to see if a collection with a given name exists.</p>
</li>
<li>
<p><strong>createCollection</strong>: Creates an uncapped collection.</p>
</li>
<li>
<p><strong>dropCollection</strong>: Drops the collection.</p>
</li>
<li>
<p><strong>getCollection</strong>: Gets a collection by name, creating it if it does not exist.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Collection creation allows customization with <code>CollectionOptions</code> and supports <a href="index.html#mongo.collation">collations</a>.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="mongo-template.commands"><a class="anchor" href="index.html#mongo-template.commands"></a>11.14. Running Commands</h3>
<div class="paragraph">
<p>You can get at the MongoDB driver&#8217;s <code>MongoDatabase.runCommand( )</code> method by using the <code>executeCommand(…)</code> methods on <code>MongoTemplate</code>. These methods also perform exception translation into Spring&#8217;s <code>DataAccessException</code> hierarchy.</p>
</div>
<div class="sect3">
<h4 id="mongo-template.commands.execution"><a class="anchor" href="index.html#mongo-template.commands.execution"></a>11.14.1. Methods for running commands</h4>
<div class="ulist">
<ul>
<li>
<p><code>Document</code> <strong>executeCommand</strong> <code>(Document command)</code>: Run a MongoDB command.</p>
</li>
<li>
<p><code>Document</code> <strong>executeCommand</strong> <code>(Document command, ReadPreference readPreference)</code>: Run a MongoDB command with the given nullable MongoDB <code>ReadPreference</code>.</p>
</li>
<li>
<p><code>Document</code> <strong>executeCommand</strong> <code>(String jsonCommand)</code>: Run a MongoDB command expressed as a JSON string.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="mongodb.mapping-usage.events"><a class="anchor" href="index.html#mongodb.mapping-usage.events"></a>11.15. Lifecycle Events</h3>
<div class="paragraph">
<p>The MongoDB mapping framework includes several <code>org.springframework.context.ApplicationEvent</code> events that your application can respond to by registering special beans in the <code>ApplicationContext</code>. Being based on Spring&#8217;s <code>ApplicationContext</code> event infrastructure enables other products, such as Spring Integration, to easily receive these events, as they are a well known eventing mechanism in Spring-based applications.</p>
</div>
<div class="paragraph">
<p>To intercept an object before it goes through the conversion process (which turns your domain object into a <code>org.bson.Document</code>), you can register a subclass of <code>AbstractMongoEventListener</code> that overrides the <code>onBeforeConvert</code> method. When the event is dispatched, your listener is called and passed the domain object before it goes into the converter. The following example shows how to do so:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">public class BeforeConvertListener extends AbstractMongoEventListener&lt;Person&gt; {
  @Override
  public void onBeforeConvert(BeforeConvertEvent&lt;Person&gt; event) {
    ... does some auditing manipulation, set timestamps, whatever ...
  }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>To intercept an object before it goes into the database, you can register a subclass of <code>org.springframework.data.mongodb.core.mapping.event.AbstractMongoEventListener</code> that overrides the <code>onBeforeSave</code> method. When the event is dispatched, your listener is called and passed the domain object and the converted <code>com.mongodb.Document</code>. The following example shows how to do so:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">public class BeforeSaveListener extends AbstractMongoEventListener&lt;Person&gt; {
  @Override
  public void onBeforeSave(BeforeSaveEvent&lt;Person&gt; event) {
    … change values, delete them, whatever …
  }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Declaring these beans in your Spring ApplicationContext causes them to be invoked whenever the event is dispatched.</p>
</div>
<div class="paragraph">
<p>The following callback methods are present in <code>AbstractMappingEventListener</code>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>onBeforeConvert</code>: Called in <code>MongoTemplate</code> <code>insert</code>, <code>insertList</code>, and <code>save</code> operations before the object is converted to a <code>Document</code> by a <code>MongoConverter</code>.</p>
</li>
<li>
<p><code>onBeforeSave</code>: Called in <code>MongoTemplate</code> <code>insert</code>, <code>insertList</code>, and <code>save</code> operations <strong>before</strong> inserting or saving the <code>Document</code> in the database.</p>
</li>
<li>
<p><code>onAfterSave</code>: Called in <code>MongoTemplate</code> <code>insert</code>, <code>insertList</code>, and <code>save</code> operations <strong>after</strong> inserting or saving the <code>Document</code> in the database.</p>
</li>
<li>
<p><code>onAfterLoad</code>: Called in <code>MongoTemplate</code> <code>find</code>, <code>findAndRemove</code>, <code>findOne</code>, and <code>getCollection</code> methods after the <code>Document</code> has been retrieved from the database.</p>
</li>
<li>
<p><code>onAfterConvert</code>: Called in <code>MongoTemplate</code> <code>find</code>, <code>findAndRemove</code>, <code>findOne</code>, and <code>getCollection</code> methods after the <code>Document</code> has been retrieved from the database was converted to a POJO.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Lifecycle events are only emitted for root level types. Complex types used as properties within a document root are not subject to event publication unless they are document references annotated with <code>@DBRef</code>.
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Lifecycle events depend on an <code>ApplicationEventMulticaster</code>, which in case of the <code>SimpleApplicationEventMulticaster</code> can be configured with a <code>TaskExecutor</code>, and therefore gives no guarantees when an Event is processed.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="entity-callbacks"><a class="anchor" href="index.html#entity-callbacks"></a>11.16. Entity Callbacks</h3>
<div class="paragraph">
<p>The Spring Data infrastructure provides hooks for modifying an entity before and after certain methods are invoked.
Those so called <code>EntityCallback</code> instances provide a convenient way to check and potentially modify an entity in a callback fashioned style.<br>
An <code>EntityCallback</code> looks pretty much like a specialized <code>ApplicationListener</code>.
Some Spring Data modules publish store specific events (such as <code>BeforeSaveEvent</code>) that allow modifying the given entity. In some cases, such as when working with immutable types, these events can cause trouble.
Also, event publishing relies on <code>ApplicationEventMulticaster</code>. If configuring that with an asynchronous <code>TaskExecutor</code> it can lead to unpredictable outcomes, as event processing can be forked onto a Thread.</p>
</div>
<div class="paragraph">
<p>Entity callbacks provide integration points with both synchronous and reactive APIs to guarantee in-order execution at well-defined checkpoints within the processing chain, returning a potentially modified entity or an reactive wrapper type.</p>
</div>
<div class="paragraph">
<p>Entity callbacks are typically separated by API type. This separation means that a synchronous API considers only synchronous entity callbacks and a reactive implementation considers only reactive entity callbacks.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The Entity Callback API has been introduced with Spring Data Commons 2.2. It is the recommended way of applying entity modifications.
Existing store specific <code>ApplicationEvents</code> are still published <strong>before</strong> the invoking potentially registered <code>EntityCallback</code> instances.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="entity-callbacks.implement"><a class="anchor" href="index.html#entity-callbacks.implement"></a>11.16.1. Implementing Entity Callbacks</h4>
<div class="paragraph">
<p>An <code>EntityCallback</code> is directly associated with its domain type through its generic type argument.
Each Spring Data module typically ships with a set of predefined <code>EntityCallback</code> interfaces covering the entity lifecycle.</p>
</div>
<div class="exampleblock">
<div class="title">Example 108. Anatomy of an <code>EntityCallback</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@FunctionalInterface
public interface BeforeSaveCallback&lt;T&gt; extends EntityCallback&lt;T&gt; {

	/**
	 * Entity callback method invoked before a domain object is saved.
	 * Can return either the same or a modified instance.
	 *
	 * @return the domain object to be persisted.
	 */
	T onBeforeSave(T entity &lt;2&gt;, String collection &lt;3&gt;); <i class="conum" data-value="1"></i><b>(1)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>BeforeSaveCallback</code> specific method to be called before an entity is saved. Returns a potentially modifed instance.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The entity right before persisting.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>A number of store specific arguments like the <em>collection</em> the entity is persisted to.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 109. Anatomy of a reactive <code>EntityCallback</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@FunctionalInterface
public interface ReactiveBeforeSaveCallback&lt;T&gt; extends EntityCallback&lt;T&gt; {

	/**
	 * Entity callback method invoked on subscription, before a domain object is saved.
	 * The returned Publisher can emit either the same or a modified instance.
	 *
	 * @return Publisher emitting the domain object to be persisted.
	 */
	Publisher&lt;T&gt; onBeforeSave(T entity &lt;2&gt;, String collection &lt;3&gt;); <i class="conum" data-value="1"></i><b>(1)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>BeforeSaveCallback</code> specific method to be called on subscription, before an entity is saved. Emits a potentially modifed instance.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The entity right before persisting.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>A number of store specific arguments like the <em>collection</em> the entity is persisted to.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Optional entity callback parameters are defined by the implementing Spring Data module and inferred from call site of <code>EntityCallback.callback()</code>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Implement the interface suiting your application needs like shown in the example below:</p>
</div>
<div class="exampleblock">
<div class="title">Example 110. Example <code>BeforeSaveCallback</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">class DefaultingEntityCallback implements BeforeSaveCallback&lt;Person&gt;, Ordered {      <i class="conum" data-value="2"></i><b>(2)</b>

	@Override
	public Object onBeforeSave(Person entity, String collection) {                   <i class="conum" data-value="1"></i><b>(1)</b>

		if(collection == "user") {
		    return // ...
		}

		return // ...
	}

	@Override
	public int getOrder() {
		return 100;                                                                  <i class="conum" data-value="2"></i><b>(2)</b>
	}
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Callback implementation according to your requirements.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Potentially order the entity callback if multiple ones for the same domain type exist. Ordering follows lowest precedence.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="entity-callbacks.register"><a class="anchor" href="index.html#entity-callbacks.register"></a>11.16.2. Registering Entity Callbacks</h4>
<div class="paragraph">
<p><code>EntityCallback</code> beans are picked up by the store specific implementations in case they are registered in the <code>ApplicationContext</code>.
Most template APIs already implement <code>ApplicationContextAware</code> and therefore have access to the <code>ApplicationContext</code></p>
</div>
<div class="paragraph">
<p>The following example explains a collection of valid entity callback registrations:</p>
</div>
<div class="exampleblock">
<div class="title">Example 111. Example <code>EntityCallback</code> Bean registration</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Order(1)                                                           <i class="conum" data-value="1"></i><b>(1)</b>
@Component
class First implements BeforeSaveCallback&lt;Person&gt; {

	@Override
	public Person onBeforeSave(Person person) {
		return // ...
	}
}

@Component
class DefaultingEntityCallback implements BeforeSaveCallback&lt;Person&gt;,
                                                           Ordered { <i class="conum" data-value="2"></i><b>(2)</b>

	@Override
	public Object onBeforeSave(Person entity, String collection) {
		// ...
	}

	@Override
	public int getOrder() {
		return 100;                                                  <i class="conum" data-value="2"></i><b>(2)</b>
	}
}

@Configuration
public class EntityCallbackConfiguration {

    @Bean
    BeforeSaveCallback&lt;Person&gt; unorderedLambdaReceiverCallback() {   <i class="conum" data-value="3"></i><b>(3)</b>
        return (BeforeSaveCallback&lt;Person&gt;) it -&gt; // ...
    }
}

@Component
class UserCallbacks implements BeforeConvertCallback&lt;User&gt;,
                                        BeforeSaveCallback&lt;User&gt; {   <i class="conum" data-value="4"></i><b>(4)</b>

	@Override
	public Person onBeforeConvert(User user) {
		return // ...
	}

	@Override
	public Person onBeforeSave(User user) {
		return // ...
	}
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>BeforeSaveCallback</code> receiving its order from the <code>@Order</code> annotation.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>BeforeSaveCallback</code> receiving its order via the <code>Ordered</code> interface implementation.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td><code>BeforeSaveCallback</code> using a lambda expression. Unordered by default and invoked last. Note that callbacks implemented by a lambda expression do not expose typing information hence invoking these with a non-assignable entity affects the callback throughput. Use a <code>class</code> or <code>enum</code> to enable type filtering for the callback bean.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Combine multiple entity callback interfaces in a single implementation class.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="mongo.entity-callbacks"><a class="anchor" href="index.html#mongo.entity-callbacks"></a>11.16.3. Store specific EntityCallbacks</h4>
<div class="paragraph">
<p>Spring Data MongoDB uses the <code>EntityCallback</code> API for its auditing support and reacts on the following callbacks.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 15. Supported Entity Callbacks</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Callback</th>
<th class="tableblock halign-left valign-top">Method</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Order</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Reactive/BeforeConvertCallback</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>onBeforeConvert(T entity, String collection)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Invoked before a domain object is converted to <code>org.bson.Document</code>.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Ordered.LOWEST_PRECEDENCE</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Reactive/AfterConvertCallback</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>onAfterConvert(T entity, org.bson.Document target, String collection)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Invoked after a domain object is loaded.<br>
Can modify the domain object after reading it from a <code>org.bson.Document</code>.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Ordered.LOWEST_PRECEDENCE</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Reactive/AuditingEntityCallback</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>onBeforeConvert(Object entity, String collection)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Marks an auditable entity <em>created</em> or <em>modified</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">100</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Reactive/BeforeSaveCallback</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>onBeforeSave(T entity, org.bson.Document target, String collection)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Invoked before a domain object is saved.<br>
Can modify the target, to be persisted, <code>Document</code> containing all mapped entity information.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Ordered.LOWEST_PRECEDENCE</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Reactive/AfterSaveCallback</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>onAfterSave(T entity, org.bson.Document target, String collection)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Invoked before a domain object is saved.<br>
Can modify the domain object, to be returned after save, <code>Document</code> containing all mapped entity information.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Ordered.LOWEST_PRECEDENCE</code></p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect2">
<h3 id="mongo.exception"><a class="anchor" href="index.html#mongo.exception"></a>11.17. Exception Translation</h3>
<div class="paragraph">
<p>The Spring framework provides exception translation for a wide variety of database and mapping technologies. This has traditionally been for JDBC and JPA. The Spring support for MongoDB extends this feature to the MongoDB Database by providing an implementation of the <code>org.springframework.dao.support.PersistenceExceptionTranslator</code> interface.</p>
</div>
<div class="paragraph">
<p>The motivation behind mapping to Spring&#8217;s <a href="https://docs.spring.io/spring/docs/5.3.1/spring-framework-reference/data-access.html#dao-exceptions">consistent data access exception hierarchy</a> is that you are then able to write portable and descriptive exception handling code without resorting to coding against MongoDB error codes. All of Spring&#8217;s data access exceptions are inherited from the root <code>DataAccessException</code> class so that you can be sure to catch all database related exception within a single try-catch block. Note that not all exceptions thrown by the MongoDB driver inherit from the <code>MongoException</code> class. The inner exception and message are preserved so that no information is lost.</p>
</div>
<div class="paragraph">
<p>Some of the mappings performed by the <code>MongoExceptionTranslator</code> are <code>com.mongodb.Network to DataAccessResourceFailureException</code> and <code>MongoException</code> error codes 1003, 12001, 12010, 12011, and 12012 to <code>InvalidDataAccessApiUsageException</code>. Look into the implementation for more details on the mapping.</p>
</div>
</div>
<div class="sect2">
<h3 id="mongo.executioncallback"><a class="anchor" href="index.html#mongo.executioncallback"></a>11.18. Execution Callbacks</h3>
<div class="paragraph">
<p>One common design feature of all Spring template classes is that all functionality is routed into one of the template&#8217;s <code>execute</code> callback methods. Doing so helps to ensure that exceptions and any resource management that may be required are performed consistently. While JDBC and JMS need this feature much more than MongoDB does, it still offers a single spot for exception translation and logging to occur. Consequently, using these <code>execute</code> callbacks is the preferred way to access the MongoDB driver&#8217;s <code>MongoDatabase</code> and <code>MongoCollection</code> objects to perform uncommon operations that were not exposed as methods on <code>MongoTemplate</code>.</p>
</div>
<div class="paragraph">
<p>The following list describes the <code>execute</code> callback methods.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>&lt;T&gt; T</code> <strong>execute</strong> <code>(Class&lt;?&gt; entityClass, CollectionCallback&lt;T&gt; action)</code>: Runs the given <code>CollectionCallback</code> for the entity collection of the specified class.</p>
</li>
<li>
<p><code>&lt;T&gt; T</code> <strong>execute</strong> <code>(String collectionName, CollectionCallback&lt;T&gt; action)</code>: Runs the given <code>CollectionCallback</code> on the collection of the given name.</p>
</li>
<li>
<p><code>&lt;T&gt; T</code> <strong>execute</strong> <code>(DbCallback&lt;T&gt; action)</code>: Runs a DbCallback, translating any exceptions as necessary. Spring Data MongoDB provides support for the Aggregation Framework introduced to MongoDB in version 2.2.</p>
</li>
<li>
<p><code>&lt;T&gt; T</code> <strong>execute</strong> <code>(String collectionName, DbCallback&lt;T&gt; action)</code>: Runs a <code>DbCallback</code> on the collection of the given name translating any exceptions as necessary.</p>
</li>
<li>
<p><code>&lt;T&gt; T</code> <strong>executeInSession</strong> <code>(DbCallback&lt;T&gt; action)</code>: Runs the given <code>DbCallback</code> within the same connection to the database so as to ensure consistency in a write-heavy environment where you may read the data that you wrote.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The following example uses the <code>CollectionCallback</code> to return information about an index:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">boolean hasIndex = template.execute("geolocation", new CollectionCallbackBoolean&gt;() {
  public Boolean doInCollection(Venue.class, DBCollection collection) throws MongoException, DataAccessException {
    List&lt;Document&gt; indexes = collection.getIndexInfo();
    for (Document document : indexes) {
      if ("location_2d".equals(document.get("name"))) {
        return true;
      }
    }
    return false;
  }
});</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="gridfs"><a class="anchor" href="index.html#gridfs"></a>11.19. GridFS Support</h3>
<div class="paragraph">
<p>MongoDB supports storing binary files inside its filesystem, GridFS. Spring Data MongoDB provides a <code>GridFsOperations</code> interface as well as the corresponding implementation, <code>GridFsTemplate</code>, to let you interact with the filesystem. You can set up a <code>GridFsTemplate</code> instance by handing it a <code>MongoDatabaseFactory</code> as well as a <code>MongoConverter</code>, as the following example shows:</p>
</div>
<div class="exampleblock">
<div class="title">Example 112. JavaConfig setup for a GridFsTemplate</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">class GridFsConfiguration extends AbstractMongoClientConfiguration {

  // … further configuration omitted

  @Bean
  public GridFsTemplate gridFsTemplate() {
    return new GridFsTemplate(mongoDbFactory(), mappingMongoConverter());
  }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The corresponding XML configuration follows:</p>
</div>
<div class="exampleblock">
<div class="title">Example 113. XML configuration for a GridFsTemplate</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;beans xmlns="http://www.springframework.org/schema/beans"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xmlns:mongo="http://www.springframework.org/schema/data/mongo"
  xsi:schemaLocation="http://www.springframework.org/schema/data/mongo
                      https://www.springframework.org/schema/data/mongo/spring-mongo.xsd
                      http://www.springframework.org/schema/beans
                      https://www.springframework.org/schema/beans/spring-beans.xsd"&gt;

  &lt;mongo:db-factory id="mongoDbFactory" dbname="database" /&gt;
  &lt;mongo:mapping-converter id="converter" /&gt;

  &lt;bean class="org.springframework.data.mongodb.gridfs.GridFsTemplate"&gt;
    &lt;constructor-arg ref="mongoDbFactory" /&gt;
    &lt;constructor-arg ref="converter" /&gt;
  &lt;/bean&gt;

&lt;/beans&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The template can now be injected and used to perform storage and retrieval operations, as the following example shows:</p>
</div>
<div class="exampleblock">
<div class="title">Example 114. Using GridFsTemplate to store files</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">class GridFsClient {

  @Autowired
  GridFsOperations operations;

  @Test
  public void storeFileToGridFs() {

    FileMetadata metadata = new FileMetadata();
    // populate metadata
    Resource file = … // lookup File or Resource

    operations.store(file.getInputStream(), "filename.txt", metadata);
  }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The <code>store(…)</code> operations take an <code>InputStream</code>, a filename, and (optionally) metadata information about the file to store. The metadata can be an arbitrary object, which will be marshaled by the <code>MongoConverter</code> configured with the <code>GridFsTemplate</code>. Alternatively, you can also provide a <code>Document</code>.</p>
</div>
<div class="paragraph">
<p>You can read files from the filesystem through either the <code>find(…)</code> or the <code>getResources(…)</code> methods. Let&#8217;s have a look at the <code>find(…)</code> methods first. You can either find a single file or multiple files that match a <code>Query</code>. You can use the <code>GridFsCriteria</code> helper class to define queries. It provides static factory methods to encapsulate default metadata fields (such as <code>whereFilename()</code> and <code>whereContentType()</code>) or a custom one through <code>whereMetaData()</code>. The following example shows how to use <code>GridFsTemplate</code> to query for files:</p>
</div>
<div class="exampleblock">
<div class="title">Example 115. Using GridFsTemplate to query for files</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">class GridFsClient {

  @Autowired
  GridFsOperations operations;

  @Test
  public void findFilesInGridFs() {
    GridFSFindIterable result = operations.find(query(whereFilename().is("filename.txt")))
  }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Currently, MongoDB does not support defining sort criteria when retrieving files from GridFS. For this reason, any sort criteria defined on the <code>Query</code> instance handed into the <code>find(…)</code> method are disregarded.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The other option to read files from the GridFs is to use the methods introduced by the <code>ResourcePatternResolver</code> interface. They allow handing an Ant path into the method and can thus retrieve files matching the given pattern. The following example shows how to use <code>GridFsTemplate</code> to read files:</p>
</div>
<div class="exampleblock">
<div class="title">Example 116. Using GridFsTemplate to read files</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">class GridFsClient {

  @Autowired
  GridFsOperations operations;

  @Test
  public void readFilesFromGridFs() {
    GridFsResources[] txtFiles = operations.getResources("*.txt");
  }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p><code>GridFsOperations</code> extends <code>ResourcePatternResolver</code> and lets the <code>GridFsTemplate</code> (for example) to be plugged into an <code>ApplicationContext</code> to read Spring Config files from MongoDB database.</p>
</div>
</div>
<div class="sect2">
<h3 id="tailable-cursors"><a class="anchor" href="index.html#tailable-cursors"></a>11.20. <a id="mongo.reactive.repositories.infinite-streams"></a> Infinite Streams with Tailable Cursors</h3>
<div class="paragraph">
<p>By default, MongoDB automatically closes a cursor when the client exhausts all results supplied by the cursor.
Closing a cursor on exhaustion turns a stream into a finite stream. For <a href="https://docs.mongodb.com/manual/core/capped-collections/">capped collections</a>,
you can use a <a href="https://docs.mongodb.com/manual/core/tailable-cursors/">Tailable Cursor</a> that remains open after the client
consumed all initially returned data.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Capped collections can be created with <code>MongoOperations.createCollection</code>. To do so, provide the required <code>CollectionOptions.empty().capped()&#8230;&#8203;</code>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Tailable cursors can be consumed with both, the imperative and the reactive MongoDB API. It is highly recommended to use the
reactive variant, as it is less resource-intensive. However, if you cannot use the reactive API, you can still use a messaging
concept that is already prevalent in the Spring ecosystem.</p>
</div>
<div class="sect3">
<h4 id="tailable-cursors.sync"><a class="anchor" href="index.html#tailable-cursors.sync"></a>11.20.1. Tailable Cursors with <code>MessageListener</code></h4>
<div class="paragraph">
<p>Listening to a capped collection using a Sync Driver creates a long running, blocking task that needs to be delegated to
a separate component. In this case, we need to first create a <code>MessageListenerContainer</code>, which will be the main entry point
for running the specific <code>SubscriptionRequest</code>. Spring Data MongoDB already ships with a default implementation that
operates on <code>MongoTemplate</code> and is capable of creating and running <code>Task</code> instances for a <code>TailableCursorRequest</code>.</p>
</div>
<div class="paragraph">
<p>The following example shows how to use tailable cursors with <code>MessageListener</code> instances:</p>
</div>
<div class="exampleblock">
<div class="title">Example 117. Tailable Cursors with <code>MessageListener</code> instances</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">MessageListenerContainer container = new DefaultMessageListenerContainer(template);
container.start();                                                                  <i class="conum" data-value="1"></i><b>(1)</b>

MessageListener&lt;Document, User&gt; listener = System.out::println;                     <i class="conum" data-value="2"></i><b>(2)</b>

TailableCursorRequest request = TailableCursorRequest.builder()
  .collection("orders")                                                             <i class="conum" data-value="3"></i><b>(3)</b>
  .filter(query(where("value").lt(100)))                                            <i class="conum" data-value="4"></i><b>(4)</b>
  .publishTo(listener)                                                              <i class="conum" data-value="5"></i><b>(5)</b>
  .build();

container.register(request, User.class);                                            <i class="conum" data-value="6"></i><b>(6)</b>

// ...

container.stop();                                                                   <i class="conum" data-value="7"></i><b>(7)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Starting the container intializes the resources and starts <code>Task</code> instances for already registered <code>SubscriptionRequest</code> instances. Requests added after startup are ran immediately.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Define the listener called when a <code>Message</code> is received. The <code>Message#getBody()</code> is converted to the requested domain type. Use <code>Document</code> to receive raw results without conversion.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Set the collection to listen to.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Provide an optional filter for documents to receive.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Set the message listener to publish incoming <code>Message</code>s to.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Register the request. The returned <code>Subscription</code> can be used to check the current <code>Task</code> state and cancel it to free resources.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Do not forget to stop the container once you are sure you no longer need it. Doing so stops all running <code>Task</code> instances within the container.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="tailable-cursors.reactive"><a class="anchor" href="index.html#tailable-cursors.reactive"></a>11.20.2. Reactive Tailable Cursors</h4>
<div class="paragraph">
<p>Using tailable cursors with a reactive data types allows construction of infinite streams. A tailable cursor remains open until it is closed externally. It emits data as new documents arrive in a capped collection.</p>
</div>
<div class="paragraph">
<p>Tailable cursors may become dead, or invalid, if either the query returns no match or the cursor returns the document at the &#8220;end&#8221; of the collection and the application then deletes that document. The following example shows how to create and use an infinite stream query:</p>
</div>
<div class="exampleblock">
<div class="title">Example 118. Infinite Stream queries with ReactiveMongoOperations</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">Flux&lt;Person&gt; stream = template.tail(query(where("name").is("Joe")), Person.class);

Disposable subscription = stream.doOnNext(person -&gt; System.out.println(person)).subscribe();

// …

// Later: Dispose the subscription to close the stream
subscription.dispose();</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Spring Data MongoDB Reactive repositories support infinite streams by annotating a query method with <code>@Tailable</code>. This works for methods that return <code>Flux</code> and other reactive types capable of emitting multiple elements, as the following example shows:</p>
</div>
<div class="exampleblock">
<div class="title">Example 119. Infinite Stream queries with ReactiveMongoRepository</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">public interface PersonRepository extends ReactiveMongoRepository&lt;Person, String&gt; {

  @Tailable
  Flux&lt;Person&gt; findByFirstname(String firstname);

}

Flux&lt;Person&gt; stream = repository.findByFirstname("Joe");

Disposable subscription = stream.doOnNext(System.out::println).subscribe();

// …

// Later: Dispose the subscription to close the stream
subscription.dispose();</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="change-streams"><a class="anchor" href="index.html#change-streams"></a>11.21. Change Streams</h3>
<div class="paragraph">
<p>As of MongoDB 3.6, <a href="https://docs.mongodb.com/manual/changeStreams/">Change Streams</a> let applications get notified about changes without having to tail the oplog.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Change Stream support is only possible for replica sets or for a sharded cluster.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Change Streams can be consumed with both, the imperative and the reactive MongoDB Java driver. It is highly recommended to use the reactive variant, as it is less resource-intensive. However, if you cannot use the reactive API, you can still obtain change events by using the messaging concept that is already prevalent in the Spring ecosystem.</p>
</div>
<div class="paragraph">
<p>It is possible to watch both on a collection as well as database level, whereas the database level variant publishes
changes from all collections within the database. When subscribing to a database change stream, make sure to use a
suitable type for the event type as conversion might not apply correctly across different entity types.
In doubt, use <code>Document</code>.</p>
</div>
<div class="sect3">
<h4>11.21.1. Change Streams with <code>MessageListener</code></h4>
<div class="paragraph">
<p>Listening to a <a href="https://docs.mongodb.com/manual/tutorial/change-streams-example/">Change Stream by using a Sync Driver</a> creates a long running, blocking task that needs to be delegated to a separate component.
In this case, we need to first create a <code>MessageListenerContainer</code>, which will be the main entry point for running the specific <code>SubscriptionRequest</code> tasks.
Spring Data MongoDB already ships with a default implementation that operates on <code>MongoTemplate</code> and is capable of creating and running <code>Task</code> instances for a <code>ChangeStreamRequest</code>.</p>
</div>
<div class="paragraph">
<p>The following example shows how to use Change Streams with <code>MessageListener</code> instances:</p>
</div>
<div class="exampleblock">
<div class="title">Example 120. Change Streams with <code>MessageListener</code> instances</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">MessageListenerContainer container = new DefaultMessageListenerContainer(template);
container.start();                                                                                        <i class="conum" data-value="1"></i><b>(1)</b>

MessageListener&lt;ChangeStreamDocument&lt;Document&gt;, User&gt; listener = System.out::println;                     <i class="conum" data-value="2"></i><b>(2)</b>
ChangeStreamRequestOptions options = new ChangeStreamRequestOptions("user", ChangeStreamOptions.empty()); <i class="conum" data-value="3"></i><b>(3)</b>

Subscription subscription = container.register(new ChangeStreamRequest&lt;&gt;(listener, options), User.class); <i class="conum" data-value="4"></i><b>(4)</b>

// ...

container.stop();                                                                                         <i class="conum" data-value="5"></i><b>(5)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Starting the container initializes the resources and starts <code>Task</code> instances for already registered <code>SubscriptionRequest</code> instances. Requests added after startup are ran immediately.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Define the listener called when a <code>Message</code> is received. The <code>Message#getBody()</code> is converted to the requested domain type. Use <code>Document</code> to receive raw results without conversion.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Set the collection to listen to and provide additional options through <code>ChangeStreamOptions</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Register the request. The returned <code>Subscription</code> can be used to check the current <code>Task</code> state and cancel it to free resources.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Do not forget to stop the container once you are sure you no longer need it. Doing so stops all running <code>Task</code> instances within the container.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Errors while processing are passed on to an <code>org.springframework.util.ErrorHandler</code>. If not stated otherwise a log appending <code>ErrorHandler</code> gets applied by default.<br>
Please use <code>register(request, body, errorHandler)</code> to provide additional functionality.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4>11.21.2. Reactive Change Streams</h4>
<div class="paragraph">
<p>Subscribing to Change Streams with the reactive API is a more natural approach to work with streams. Still, the essential building blocks, such as <code>ChangeStreamOptions</code>, remain the same. The following example shows how to use Change Streams emitting <code>ChangeStreamEvent</code>s:</p>
</div>
<div class="exampleblock">
<div class="title">Example 121. Change Streams emitting <code>ChangeStreamEvent</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">Flux&lt;ChangeStreamEvent&lt;User&gt;&gt; flux = reactiveTemplate.changeStream(User.class) <i class="conum" data-value="1"></i><b>(1)</b>
    .watchCollection("people")
    .filter(where("age").gte(38))                                              <i class="conum" data-value="2"></i><b>(2)</b>
    .listen();                                                                 <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The event target type the underlying document should be converted to. Leave this out to receive raw results without conversion.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Use an aggregation pipeline or just a query <code>Criteria</code> to filter events.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Obtain a <code>Flux</code> of change stream events. The <code>ChangeStreamEvent#getBody()</code> is converted to the requested domain type from (2).</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4>11.21.3. Resuming Change Streams</h4>
<div class="paragraph">
<p>Change Streams can be resumed and resume emitting events where you left. To resume the stream, you need to supply either a resume
token or the last known server time (in UTC). Use <code>ChangeStreamOptions</code> to set the value accordingly.</p>
</div>
<div class="paragraph">
<p>The following example shows how to set the resume offset using server time:</p>
</div>
<div class="exampleblock">
<div class="title">Example 122. Resume a Change Stream</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">Flux&lt;ChangeStreamEvent&lt;User&gt;&gt; resumed = template.changeStream(User.class)
    .watchCollection("people")
    .resumeAt(Instant.now().minusSeconds(1)) <i class="conum" data-value="1"></i><b>(1)</b>
    .listen();</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>You may obtain the server time of an <code>ChangeStreamEvent</code> through the <code>getTimestamp</code> method or use the <code>resumeToken</code>
exposed through <code>getResumeToken</code>.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
In some cases an <code>Instant</code> might not be a precise enough measure when resuming a Change Stream. Use a MongoDB native
<a href="https://docs.mongodb.com/manual/reference/bson-types/#timestamps">BsonTimestamp</a> for that purpose.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="mongo.sessions"><a class="anchor" href="index.html#mongo.sessions"></a>12. MongoDB Sessions</h2>
<div class="sectionbody">
<div class="paragraph">
<p>As of version 3.6, MongoDB supports the concept of sessions. The use of sessions enables MongoDB&#8217;s <a href="https://docs.mongodb.com/manual/core/read-isolation-consistency-recency/#causal-consistency">Causal Consistency</a> model, which guarantees running operations in an order that respects their causal relationships. Those are split into <code>ServerSession</code> instances and <code>ClientSession</code> instances. In this section, when we speak of a session, we refer to <code>ClientSession</code>.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Operations within a client session are not isolated from operations outside the session.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Both <code>MongoOperations</code> and <code>ReactiveMongoOperations</code> provide gateway methods for tying a <code>ClientSession</code> to the operations. <code>MongoCollection</code> and <code>MongoDatabase</code> use session proxy objects that implement MongoDB&#8217;s collection and database interfaces, so you need not add a session on each call. This means that a potential call to <code>MongoCollection#find()</code> is delegated to <code>MongoCollection#find(ClientSession)</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Methods such as <code>(Reactive)MongoOperations#getCollection</code> return native MongoDB Java Driver gateway objects (such as <code>MongoCollection</code>) that themselves offer dedicated methods for <code>ClientSession</code>. These methods are <strong>NOT</strong> session-proxied. You should provide the <code>ClientSession</code> where needed when interacting directly with a <code>MongoCollection</code> or <code>MongoDatabase</code> and not through one of the <code>#execute</code> callbacks on <code>MongoOperations</code>.
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="mongo.sessions.sync"><a class="anchor" href="index.html#mongo.sessions.sync"></a>12.1. Synchronous <code>ClientSession</code> support.</h3>
<div class="paragraph">
<p>The following example shows the usage of a session:</p>
</div>
<div class="exampleblock">
<div class="title">Example 123. <code>ClientSession</code> with <code>MongoOperations</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">ClientSessionOptions sessionOptions = ClientSessionOptions.builder()
    .causallyConsistent(true)
    .build();

ClientSession session = client.startSession(sessionOptions); <i class="conum" data-value="1"></i><b>(1)</b>

template.withSession(() -&gt; session)
    .execute(action -&gt; {

        Query query = query(where("name").is("Durzo Blint"));
        Person durzo = action.findOne(query, Person.class);  <i class="conum" data-value="2"></i><b>(2)</b>

        Person azoth = new Person("Kylar Stern");
        azoth.setMaster(durzo);

        action.insert(azoth);                                <i class="conum" data-value="3"></i><b>(3)</b>

        return azoth;
    });

session.close()                                              <i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Obtain a new session from the server.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Use <code>MongoOperation</code> methods as before. The <code>ClientSession</code> gets applied automatically.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Make sure to close the <code>ClientSession</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Close the session.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
When dealing with <code>DBRef</code> instances, especially lazily loaded ones, it is essential to <strong>not</strong> close the <code>ClientSession</code> before all data is loaded. Otherwise, lazy fetch fails.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="mongo.sessions.reactive"><a class="anchor" href="index.html#mongo.sessions.reactive"></a>12.2. Reactive <code>ClientSession</code> support</h3>
<div class="paragraph">
<p>The reactive counterpart uses the same building blocks as the imperative one, as the following example shows:</p>
</div>
<div class="exampleblock">
<div class="title">Example 124. ClientSession with <code>ReactiveMongoOperations</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">ClientSessionOptions sessionOptions = ClientSessionOptions.builder()
    .causallyConsistent(true)
    .build();

Publisher&lt;ClientSession&gt; session = client.startSession(sessionOptions); <i class="conum" data-value="1"></i><b>(1)</b>

template.withSession(session)
    .execute(action -&gt; {

        Query query = query(where("name").is("Durzo Blint"));
        return action.findOne(query, Person.class)
            .flatMap(durzo -&gt; {

                Person azoth = new Person("Kylar Stern");
                azoth.setMaster(durzo);

                return action.insert(azoth);                            <i class="conum" data-value="2"></i><b>(2)</b>
            });
    }, ClientSession::close)                                            <i class="conum" data-value="3"></i><b>(3)</b>
    .subscribe();                                                       <i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Obtain a <code>Publisher</code> for new session retrieval.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Use <code>ReactiveMongoOperation</code> methods as before. The <code>ClientSession</code> is obtained and applied automatically.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Make sure to close the <code>ClientSession</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Nothing happens until you subscribe. See <a href="https://projectreactor.io/docs/core/release/reference/#reactive.subscribe">the Project Reactor Reference Guide</a> for details.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>By using a <code>Publisher</code> that provides the actual session, you can defer session acquisition to the point of actual subscription.
Still, you need to close the session when done, so as to not pollute the server with stale sessions. Use the <code>doFinally</code> hook on <code>execute</code> to call <code>ClientSession#close()</code> when you no longer need the session.
If you prefer having more control over the session itself, you can obtain the <code>ClientSession</code> through the driver and provide it through a <code>Supplier</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Reactive use of <code>ClientSession</code> is limited to Template API usage. There&#8217;s currently no session integration with reactive repositories.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="mongo.transactions"><a class="anchor" href="index.html#mongo.transactions"></a>13. MongoDB Transactions</h2>
<div class="sectionbody">
<div class="paragraph">
<p>As of version 4, MongoDB supports <a href="https://www.mongodb.com/transactions">Transactions</a>. Transactions are built on top of <a href="index.html#mongo.sessions">Sessions</a> and, consequently, require an active <code>ClientSession</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Unless you specify a <code>MongoTransactionManager</code> within your application context, transaction support is <strong>DISABLED</strong>. You can use <code>setSessionSynchronization(ALWAYS)</code> to participate in ongoing non-native MongoDB transactions.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To get full programmatic control over transactions, you may want to use the session callback on <code>MongoOperations</code>.</p>
</div>
<div class="paragraph">
<p>The following example shows programmatic transaction control within a <code>SessionCallback</code>:</p>
</div>
<div class="exampleblock">
<div class="title">Example 125. Programmatic transactions</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">ClientSession session = client.startSession(options);                   <i class="conum" data-value="1"></i><b>(1)</b>

template.withSession(session)
    .execute(action -&gt; {

        session.startTransaction();                                     <i class="conum" data-value="2"></i><b>(2)</b>

        try {

            Step step = // ...;
            action.insert(step);

            process(step);

            action.update(Step.class).apply(Update.set("state", // ...

            session.commitTransaction();                                <i class="conum" data-value="3"></i><b>(3)</b>

        } catch (RuntimeException e) {
            session.abortTransaction();                                 <i class="conum" data-value="4"></i><b>(4)</b>
        }
    }, ClientSession::close)                                            <i class="conum" data-value="5"></i><b>(5)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Obtain a new <code>ClientSession</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Start the transaction.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>If everything works out as expected, commit the changes.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Something broke, so roll back everything.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Do not forget to close the session when done.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>The preceding example lets you have full control over transactional behavior while using the session scoped <code>MongoOperations</code> instance within the callback to ensure the session is passed on to every server call.
To avoid some of the overhead that comes with this approach, you can use a <code>TransactionTemplate</code> to take away some of the noise of manual transaction flow.</p>
</div>
<div class="sect2">
<h3 id="mongo.transactions.transaction-template"><a class="anchor" href="index.html#mongo.transactions.transaction-template"></a>13.1. Transactions with <code>TransactionTemplate</code></h3>
<div class="paragraph">
<p>Spring Data MongoDB transactions support a <code>TransactionTemplate</code>. The following example shows how to create and use a <code>TransactionTemplate</code>:</p>
</div>
<div class="exampleblock">
<div class="title">Example 126. Transactions with <code>TransactionTemplate</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">template.setSessionSynchronization(ALWAYS);                                     <i class="conum" data-value="1"></i><b>(1)</b>

// ...

TransactionTemplate txTemplate = new TransactionTemplate(anyTxManager);         <i class="conum" data-value="2"></i><b>(2)</b>

txTemplate.execute(new TransactionCallbackWithoutResult() {

    @Override
    protected void doInTransactionWithoutResult(TransactionStatus status) {     <i class="conum" data-value="3"></i><b>(3)</b>

        Step step = // ...;
        template.insert(step);

        process(step);

        template.update(Step.class).apply(Update.set("state", // ...
    };
});</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Enable transaction synchronization during Template API configuration.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Create the <code>TransactionTemplate</code> using the provided <code>PlatformTransactionManager</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Within the callback the <code>ClientSession</code> and transaction are already registered.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
Changing state of <code>MongoTemplate</code> during runtime (as you might think would be possible in item 1 of the preceding listing) can cause threading and visibility issues.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="mongo.transactions.tx-manager"><a class="anchor" href="index.html#mongo.transactions.tx-manager"></a>13.2. Transactions with <code>MongoTransactionManager</code></h3>
<div class="paragraph">
<p><code>MongoTransactionManager</code> is the gateway to the well known Spring transaction support. It lets applications use <a href="https://docs.spring.io/spring/docs/5.3.1/spring-framework-reference/html/transaction.html">the managed transaction features of Spring</a>.
The <code>MongoTransactionManager</code> binds a <code>ClientSession</code> to the thread. <code>MongoTemplate</code> detects the session and operates on these resources which are associated with the transaction accordingly. <code>MongoTemplate</code> can also participate in other, ongoing transactions. The following example shows how to create and use transactions with a <code>MongoTransactionManager</code>:</p>
</div>
<div class="exampleblock">
<div class="title">Example 127. Transactions with <code>MongoTransactionManager</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Configuration
static class Config extends AbstractMongoClientConfiguration {

    @Bean
    MongoTransactionManager transactionManager(MongoDatabaseFactory dbFactory) {  <i class="conum" data-value="1"></i><b>(1)</b>
        return new MongoTransactionManager(dbFactory);
    }

    // ...
}

@Component
public class StateService {

    @Transactional
    void someBusinessFunction(Step step) {                                        <i class="conum" data-value="2"></i><b>(2)</b>

        template.insert(step);

        process(step);

        template.update(Step.class).apply(Update.set("state", // ...
    };
});</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Register <code>MongoTransactionManager</code> in the application context.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Mark methods as transactional.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<code>@Transactional(readOnly = true)</code> advises <code>MongoTransactionManager</code> to also start a transaction that adds the
<code>ClientSession</code> to outgoing requests.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="mongo.transactions.reactive"><a class="anchor" href="index.html#mongo.transactions.reactive"></a>13.3. Reactive Transactions</h3>
<div class="paragraph">
<p>Same as with the reactive <code>ClientSession</code> support, the <code>ReactiveMongoTemplate</code> offers dedicated methods for operating
within a transaction without having to worry about the committing or stopping actions depending on the operations outcome.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Unless you specify a <code>ReactiveMongoTransactionManager</code> within your application context, transaction support is <strong>DISABLED</strong>. You can use <code>setSessionSynchronization(ALWAYS)</code> to participate in ongoing non-native MongoDB transactions.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Using the plain MongoDB reactive driver API a <code>delete</code> within a transactional flow may look like this.</p>
</div>
<div class="exampleblock">
<div class="title">Example 128. Native driver support</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">Mono&lt;DeleteResult&gt; result = Mono
    .from(client.startSession())                                                             <i class="conum" data-value="1"></i><b>(1)</b>

    .flatMap(session -&gt; {
        session.startTransaction();                                                          <i class="conum" data-value="2"></i><b>(2)</b>

        return Mono.from(collection.deleteMany(session, ...))                                <i class="conum" data-value="3"></i><b>(3)</b>

            .onErrorResume(e -&gt; Mono.from(session.abortTransaction()).then(Mono.error(e)))   <i class="conum" data-value="4"></i><b>(4)</b>

            .flatMap(val -&gt; Mono.from(session.commitTransaction()).then(Mono.just(val)))     <i class="conum" data-value="5"></i><b>(5)</b>

            .doFinally(signal -&gt; session.close());                                           <i class="conum" data-value="6"></i><b>(6)</b>
      });</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>First we obviously need to initiate the session.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Once we have the <code>ClientSession</code> at hand, start the transaction.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Operate within the transaction by passing on the <code>ClientSession</code> to the operation.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>If the operations completes exceptionally, we need to stop the transaction and preserve the error.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Or of course, commit the changes in case of success. Still preserving the operations result.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Lastly, we need to make sure to close the session.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>The culprit of the above operation is in keeping the main flows <code>DeleteResult</code> instead of the transaction outcome
published via either <code>commitTransaction()</code> or <code>abortTransaction()</code>, which leads to a rather complicated setup.</p>
</div>
</div>
<div class="sect2">
<h3 id="mongo.transactions.reactive-operator"><a class="anchor" href="index.html#mongo.transactions.reactive-operator"></a>13.4. Transactions with <code>TransactionalOperator</code></h3>
<div class="paragraph">
<p>Spring Data MongoDB transactions support a <code>TransactionalOperator</code>. The following example shows how to create and use a <code>TransactionalOperator</code>:</p>
</div>
<div class="exampleblock">
<div class="title">Example 129. Transactions with <code>TransactionalOperator</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">template.setSessionSynchronization(ALWAYS);                                          <i class="conum" data-value="1"></i><b>(1)</b>

// ...

TransactionalOperator rxtx = TransactionalOperator.create(anyTxManager,
                                   new DefaultTransactionDefinition());              <i class="conum" data-value="2"></i><b>(2)</b>


Step step = // ...;
template.insert(step);

Mono&lt;Void&gt; process(step)
    .then(template.update(Step.class).apply(Update.set("state", …))
    .as(rxtx::transactional)                                                         <i class="conum" data-value="3"></i><b>(3)</b>
    .then();</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Enable transaction synchronization for Transactional participation.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Create the <code>TransactionalOperator</code> using the provided <code>ReactiveTransactionManager</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td><code>TransactionalOperator.transactional(…)</code> provides transaction management for all upstream operations.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="mongo.transactions.reactive-tx-manager"><a class="anchor" href="index.html#mongo.transactions.reactive-tx-manager"></a>13.5. Transactions with <code>ReactiveMongoTransactionManager</code></h3>
<div class="paragraph">
<p><code>ReactiveMongoTransactionManager</code> is the gateway to the well known Spring transaction support.
It allows applications to leverage <a href="https://docs.spring.io/spring/docs/5.3.1/spring-framework-reference/html/transaction.html">the managed transaction features of Spring</a>.
The <code>ReactiveMongoTransactionManager</code> binds a <code>ClientSession</code> to the subscriber <code>Context</code>.
<code>ReactiveMongoTemplate</code> detects the session and operates on these resources which are associated with the transaction accordingly.
<code>ReactiveMongoTemplate</code> can also participate in other, ongoing transactions.
The following example shows how to create and use transactions with a <code>ReactiveMongoTransactionManager</code>:</p>
</div>
<div class="exampleblock">
<div class="title">Example 130. Transactions with <code>ReactiveMongoTransactionManager</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Configuration
static class Config extends AbstractMongoClientConfiguration {

    @Bean
    ReactiveMongoTransactionManager transactionManager(ReactiveDatabaseFactory factory) {  <i class="conum" data-value="1"></i><b>(1)</b>
        return new ReactiveMongoTransactionManager(factory);
    }

    // ...
}

@Service
public class StateService {

    @Transactional
    Mono&lt;UpdateResult&gt; someBusinessFunction(Step step) {                                  <i class="conum" data-value="2"></i><b>(2)</b>

        return template.insert(step)
            .then(process(step))
            .then(template.update(Step.class).apply(Update.set("state", …));
    };
});</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Register <code>ReactiveMongoTransactionManager</code> in the application context.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Mark methods as transactional.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<code>@Transactional(readOnly = true)</code> advises <code>ReactiveMongoTransactionManager</code> to also start a transaction that adds the <code>ClientSession</code> to outgoing requests.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="mongo.transactions.behavior"><a class="anchor" href="index.html#mongo.transactions.behavior"></a>13.6. Special behavior inside transactions</h3>
<div class="paragraph">
<p>Inside transactions, MongoDB server has a slightly different behavior.</p>
</div>
<div class="paragraph">
<p><strong>Connection Settings</strong></p>
</div>
<div class="paragraph">
<p>The MongoDB drivers offer a dedicated replica set name configuration option turing the driver into auto detection
mode. This option helps identifying the primary replica set nodes and command routing during a transaction.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Make sure to add <code>replicaSet</code> to the MongoDB URI. Please refer to <a href="https://docs.mongodb.com/manual/reference/connection-string/#connections-connection-options">connection string options</a> for further details.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><strong>Collection Operations</strong></p>
</div>
<div class="paragraph">
<p>MongoDB does <strong>not</strong> support collection operations, such as collection creation, within a transaction. This also
affects the on the fly collection creation that happens on first usage. Therefore make sure to have all required
structures in place.</p>
</div>
<div class="paragraph">
<p><strong>Transient Errors</strong></p>
</div>
<div class="paragraph">
<p>MongoDB can add special labels to errors raised during transactional operations. Those may indicate transient failures
that might vanish by merely retrying the operation.
We highly recommend <a href="https://github.com/spring-projects/spring-retry">Spring Retry</a> for those purposes. Nevertheless
one may override <code>MongoTransactionManager#doCommit(MongoTransactionObject)</code> to implement a <a href="https://docs.mongodb.com/manual/core/transactions/#retry-commit-operation">Retry Commit Operation</a>
behavior as outlined in the MongoDB reference manual.</p>
</div>
<div class="paragraph">
<p><strong>Count</strong></p>
</div>
<div class="paragraph">
<p>MongoDB <code>count</code> operates upon collection statistics which may not reflect the actual situation within a transaction.
The server responds with <em>error 50851</em> when issuing a <code>count</code> command inside of a multi-document transaction.
Once <code>MongoTemplate</code> detects an active transaction, all exposed <code>count()</code> methods are converted and delegated to the
aggregation framework using <code>$match</code> and <code>$count</code> operators, preserving <code>Query</code> settings, such as <code>collation</code>.</p>
</div>
<div class="paragraph">
<p>Restrictions apply when using geo commands inside of the aggregation count helper. The following operators cannot be used and must be replaced with a different operator:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>$where</code> &#8594; <code>$expr</code></p>
</li>
<li>
<p><code>$near</code> &#8594; <code>$geoWithin</code> with <code>$center</code></p>
</li>
<li>
<p><code>$nearSphere</code> &#8594; <code>$geoWithin</code> with <code>$centerSphere</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Queries using <code>Criteria.near(…)</code> and <code>Criteria.nearSphere(…)</code> must be rewritten to <code>Criteria.within(…)</code> respective <code>Criteria.withinSphere(…)</code>. Same applies for the <code>near</code> query keyword in repository query methods that must be changed to <code>within</code>. See also MongoDB JIRA ticket <a href="https://jira.mongodb.org/browse/DRIVERS-518">DRIVERS-518</a> for further reference.</p>
</div>
<div class="paragraph">
<p>The following snippet shows <code>count</code> usage inside the session-bound closure:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="javascript" class="language-javascript hljs">session.startTransaction();

template.withSession(session)
    .execute(action -&gt; {
        action.count(query(where("state").is("active")), Step.class)
        ...</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The snippet above materializes in the following command:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="javascript" class="language-javascript hljs">db.collection.aggregate(
   [
      { $match: { state: "active" } },
      { $count: "totalEntityCount" }
   ]
)</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>instead of:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="javascript" class="language-javascript hljs">db.collection.find( { state: "active" } ).count()</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="mongo.reactive"><a class="anchor" href="index.html#mongo.reactive"></a>14. Reactive MongoDB support</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The reactive MongoDB support contains the following basic set of features:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Spring configuration support that uses Java-based <code>@Configuration</code> classes, a <code>MongoClient</code> instance, and replica sets.</p>
</li>
<li>
<p><code>ReactiveMongoTemplate</code>, which is a helper class that increases productivity by using <code>MongoOperations</code> in a reactive manner. It includes integrated object mapping between <code>Document</code> instances and POJOs.</p>
</li>
<li>
<p>Exception translation into Spring&#8217;s portable Data Access Exception hierarchy.</p>
</li>
<li>
<p>Feature-rich Object Mapping integrated with Spring&#8217;s <code>ConversionService</code>.</p>
</li>
<li>
<p>Annotation-based mapping metadata that is extensible to support other metadata formats.</p>
</li>
<li>
<p>Persistence and mapping lifecycle events.</p>
</li>
<li>
<p>Java based <code>Query</code>, <code>Criteria</code>, and <code>Update</code> DSLs.</p>
</li>
<li>
<p>Automatic implementation of reactive repository interfaces including support for custom query methods.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For most tasks, you should use <code>ReactiveMongoTemplate</code> or the repository support, both of which use the rich mapping functionality. <code>ReactiveMongoTemplate</code> is the place to look for accessing functionality such as incrementing counters or ad-hoc CRUD operations. <code>ReactiveMongoTemplate</code> also provides callback methods so that you can use the low-level API artifacts (such as <code>MongoDatabase</code>) to communicate directly with MongoDB. The goal with naming conventions on various API artifacts is to copy those in the base MongoDB Java driver so that you can map your existing knowledge onto the Spring APIs.</p>
</div>
<div class="sect2">
<h3 id="mongodb-reactive-getting-started"><a class="anchor" href="index.html#mongodb-reactive-getting-started"></a>14.1. Getting Started</h3>
<div class="paragraph">
<p>Spring MongoDB support requires MongoDB 2.6 or higher and Java SE 8 or higher.</p>
</div>
<div class="paragraph">
<p>First, you need to set up a running MongoDB server. Refer to the <a href="https://docs.mongodb.org/manual/core/introduction/">MongoDB Quick Start guide</a> for an explanation on how to startup a MongoDB instance. Once installed, starting MongoDB is typically a matter of running the following command: <code>${MONGO_HOME}/bin/mongod</code></p>
</div>
<div class="paragraph">
<p>To create a Spring project in STS, go to File &#8594; New &#8594; Spring Template Project &#8594; Simple Spring Utility Project and press Yes when prompted. Then enter a project and a package name, such as org.spring.mongodb.example.</p>
</div>
<div class="paragraph">
<p>Then add the following to the pom.xml dependencies section.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;dependencies&gt;

  &lt;!-- other dependency elements omitted --&gt;

  &lt;dependency&gt;
    &lt;groupId&gt;org.springframework.data&lt;/groupId&gt;
    &lt;artifactId&gt;spring-data-mongodb&lt;/artifactId&gt;
    &lt;version&gt;3.1.1&lt;/version&gt;
  &lt;/dependency&gt;

  &lt;dependency&gt;
    &lt;groupId&gt;org.mongodb&lt;/groupId&gt;
    &lt;artifactId&gt;mongodb-driver-reactivestreams&lt;/artifactId&gt;
    &lt;version&gt;4.1.1&lt;/version&gt;
  &lt;/dependency&gt;

  &lt;dependency&gt;
    &lt;groupId&gt;io.projectreactor&lt;/groupId&gt;
    &lt;artifactId&gt;reactor-core&lt;/artifactId&gt;
    &lt;version&gt;2020.0.1&lt;/version&gt;
  &lt;/dependency&gt;

&lt;/dependencies&gt;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
MongoDB uses two different drivers for blocking and reactive (non-blocking) data access. While blocking operations are provided by default, you can opt-in for reactive usage.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To get started with a working example, create a simple <code>Person</code> class to persist, as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Document
public class Person {

  private String id;
  private String name;
  private int age;

  public Person(String name, int age) {
    this.name = name;
    this.age = age;
  }

  public String getId() {
    return id;
  }
  public String getName() {
    return name;
  }
  public int getAge() {
    return age;
  }

  @Override
  public String toString() {
    return "Person [id=" + id + ", name=" + name + ", age=" + age + "]";
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then create an application to run, as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">public class ReactiveMongoApp {

  private static final Logger log = LoggerFactory.getLogger(ReactiveMongoApp.class);

  public static void main(String[] args) throws Exception {

    CountDownLatch latch = new CountDownLatch(1);

    ReactiveMongoTemplate mongoOps = new ReactiveMongoTemplate(MongoClients.create(), "database");

    mongoOps.insert(new Person("Joe", 34))
          .flatMap(p -&gt; mongoOps.findOne(new Query(where("name").is("Joe")), Person.class))
          .doOnNext(person -&gt; log.info(person.toString()))
          .flatMap(person -&gt; mongoOps.dropCollection("person"))
          .doOnComplete(latch::countDown)
          .subscribe();

    latch.await();
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Running the preceding class produces the following output:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">2016-09-20 14:56:57,373 DEBUG .index.MongoPersistentEntityIndexCreator: 124 - Analyzing class class example.ReactiveMongoApp$Person for index information.
2016-09-20 14:56:57,452 DEBUG .data.mongodb.core.ReactiveMongoTemplate: 975 - Inserting Document containing fields: [_class, name, age] in collection: person
2016-09-20 14:56:57,541 DEBUG .data.mongodb.core.ReactiveMongoTemplate:1503 - findOne using query: { "name" : "Joe"} fields: null for class: class example.ReactiveMongoApp$Person in collection: person
2016-09-20 14:56:57,545 DEBUG .data.mongodb.core.ReactiveMongoTemplate:1979 - findOne using query: { "name" : "Joe"} in db.collection: database.person
2016-09-20 14:56:57,567  INFO                 example.ReactiveMongoApp:  43 - Person [id=57e1321977ac501c68d73104, name=Joe, age=34]
2016-09-20 14:56:57,573 DEBUG .data.mongodb.core.ReactiveMongoTemplate: 528 - Dropped collection [person]</code></pre>
</div>
</div>
<div class="paragraph">
<p>Even in this simple example, there are a few things to take notice of:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>You can instantiate the central helper class of Spring Mongo (<a href="index.html#mongo.reactive.template"><code>ReactiveMongoTemplate</code></a>) by using the standard <code>com.mongodb.reactivestreams.client.MongoClient</code> object and the name of the database to use.</p>
</li>
<li>
<p>The mapper works against standard POJO objects without the need for any additional metadata (though you can optionally provide that information. See <a href="index.html#mapping-chapter">here</a>.).</p>
</li>
<li>
<p>Conventions are used for handling the ID field, converting it to be an <code>ObjectId</code> when stored in the database.</p>
</li>
<li>
<p>Mapping conventions can use field access. Notice that the <code>Person</code> class has only getters.</p>
</li>
<li>
<p>If the constructor argument names match the field names of the stored document, they are used to instantiate the object</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>There is a <a href="https://github.com/spring-projects/spring-data-examples">GitHub repository with several examples</a> that you can download and play around with to get a feel for how the library works.</p>
</div>
</div>
<div class="sect2">
<h3 id="mongo.reactive.driver"><a class="anchor" href="index.html#mongo.reactive.driver"></a>14.2. Connecting to MongoDB with Spring and the Reactive Streams Driver</h3>
<div class="paragraph">
<p>One of the first tasks when using MongoDB and Spring is to create a <code>com.mongodb.reactivestreams.client.MongoClient</code> object by using the IoC container.</p>
</div>
<div class="sect3">
<h4 id="mongo.reactive.mongo-java-config"><a class="anchor" href="index.html#mongo.reactive.mongo-java-config"></a>14.2.1. Registering a MongoClient Instance Using Java-based Metadata</h4>
<div class="paragraph">
<p>The following example shows how to use Java-based bean metadata to register an instance of a <code>com.mongodb.reactivestreams.client.MongoClient</code>:</p>
</div>
<div class="exampleblock">
<div class="title">Example 131. Registering a <code>com.mongodb.reactivestreams.client.MongoClient</code> object using Java based bean metadata</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Configuration
public class AppConfig {

  /*
   * Use the Reactive Streams Mongo Client API to create a com.mongodb.reactivestreams.client.MongoClient instance.
   */
   public @Bean MongoClient reactiveMongoClient()  {
       return MongoClients.create("mongodb://localhost");
   }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>This approach lets you use the standard <code>com.mongodb.reactivestreams.client.MongoClient</code> API (which you may already know).</p>
</div>
<div class="paragraph">
<p>An alternative is to register an instance of <code>com.mongodb.reactivestreams.client.MongoClient</code> instance with the container by using Spring&#8217;s <code>ReactiveMongoClientFactoryBean</code>. As compared to instantiating a <code>com.mongodb.reactivestreams.client.MongoClient</code> instance directly, the <code>FactoryBean</code> approach has the added advantage of also providing the container with an <code>ExceptionTranslator</code> implementation that translates MongoDB exceptions to exceptions in Spring&#8217;s portable <code>DataAccessException</code> hierarchy for data access classes annotated with the <code>@Repository</code> annotation. This hierarchy and use of <code>@Repository</code> is described in <a href="https://docs.spring.io/spring/docs/5.3.1/spring-framework-reference/data-access.html">Spring&#8217;s DAO support features</a>.</p>
</div>
<div class="paragraph">
<p>The following example shows Java-based bean metadata that supports exception translation on <code>@Repository</code> annotated classes:</p>
</div>
<div class="exampleblock">
<div class="title">Example 132. Registering a <code>com.mongodb.reactivestreams.client.MongoClient</code> object using Spring&#8217;s MongoClientFactoryBean and enabling Spring&#8217;s exception translation support</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Configuration
public class AppConfig {

    /*
     * Factory bean that creates the com.mongodb.reactivestreams.client.MongoClient instance
     */
     public @Bean ReactiveMongoClientFactoryBean mongoClient() {

          ReactiveMongoClientFactoryBean clientFactory = new ReactiveMongoClientFactoryBean();
          clientFactory.setHost("localhost");

          return clientFactory;
     }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>To access the <code>com.mongodb.reactivestreams.client.MongoClient</code> object created by the <code>ReactiveMongoClientFactoryBean</code> in other <code>@Configuration</code> or your own classes, get the <code>MongoClient</code> from the context.</p>
</div>
</div>
<div class="sect3">
<h4 id="mongo.reactive.mongo-db-factory"><a class="anchor" href="index.html#mongo.reactive.mongo-db-factory"></a>14.2.2. The ReactiveMongoDatabaseFactory Interface</h4>
<div class="paragraph">
<p>While <code>com.mongodb.reactivestreams.client.MongoClient</code> is the entry point to the reactive MongoDB driver API, connecting to a specific MongoDB database instance requires additional information, such as the database name. With that information, you can obtain a <code>com.mongodb.reactivestreams.client.MongoDatabase</code> object and access all the functionality of a specific MongoDB database instance. Spring provides the <code>org.springframework.data.mongodb.core.ReactiveMongoDatabaseFactory</code> interface to bootstrap connectivity to the database. The following listing shows the <code>ReactiveMongoDatabaseFactory</code> interface:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">public interface ReactiveMongoDatabaseFactory {

  /**
   * Creates a default {@link MongoDatabase} instance.
   *
   * @return
   * @throws DataAccessException
   */
  MongoDatabase getMongoDatabase() throws DataAccessException;

  /**
   * Creates a {@link MongoDatabase} instance to access the database with the given name.
   *
   * @param dbName must not be {@literal null} or empty.
   * @return
   * @throws DataAccessException
   */
  MongoDatabase getMongoDatabase(String dbName) throws DataAccessException;

  /**
   * Exposes a shared {@link MongoExceptionTranslator}.
   *
   * @return will never be {@literal null}.
   */
  PersistenceExceptionTranslator getExceptionTranslator();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>org.springframework.data.mongodb.core.SimpleReactiveMongoDatabaseFactory</code> class implements the <code>ReactiveMongoDatabaseFactory</code> interface and is created with a standard <code>com.mongodb.reactivestreams.client.MongoClient</code> instance and the database name.</p>
</div>
<div class="paragraph">
<p>Instead of using the IoC container to create an instance of <code>ReactiveMongoTemplate</code>, you can use them in standard Java code, as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">public class MongoApp {

  private static final Log log = LogFactory.getLog(MongoApp.class);

  public static void main(String[] args) throws Exception {

    ReactiveMongoOperations mongoOps = new ReactiveMongoOperations(new SimpleReactiveMongoDatabaseFactory(MongoClient.create(), "database"));

    mongoOps.insert(new Person("Joe", 34))
        .flatMap(p -&gt; mongoOps.findOne(new Query(where("name").is("Joe")), Person.class))
        .doOnNext(person -&gt; log.info(person.toString()))
        .flatMap(person -&gt; mongoOps.dropCollection("person"))
        .subscribe();
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The use of <code>SimpleReactiveMongoDatabaseFactory</code> is the only difference between the listing shown in the <a href="index.html#mongodb-reactive-getting-started">getting started section</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="mongo.reactive.mongo-db-factory-java"><a class="anchor" href="index.html#mongo.reactive.mongo-db-factory-java"></a>14.2.3. Registering a ReactiveMongoDatabaseFactory Instance by Using Java-based Metadata</h4>
<div class="paragraph">
<p>To register a <code>ReactiveMongoDatabaseFactory</code> instance with the container, you can write code much like what was highlighted in the previous code listing, as the following example shows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Configuration
public class MongoConfiguration {

  public @Bean ReactiveMongoDatabaseFactory reactiveMongoDatabaseFactory() {
    return new SimpleReactiveMongoDatabaseFactory(MongoClients.create(), "database");
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>To define the username and password, create a MongoDB connection string and pass it into the factory method, as the next listing shows. The following listing also shows how to use <code>ReactiveMongoDatabaseFactory</code> to register an instance of <code>ReactiveMongoTemplate</code> with the container:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Configuration
public class MongoConfiguration {

  public @Bean ReactiveMongoDatabaseFactory reactiveMongoDatabaseFactory() {
    return new SimpleReactiveMongoDatabaseFactory(MongoClients.create("mongodb://joe:<a href="../../../../../../cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="b0c3d5d3c2d5c4f0dcdfd3d1dcd8dfc3c4">[email&#160;protected]</a>"), "database");
  }

  public @Bean ReactiveMongoTemplate reactiveMongoTemplate() {
    return new ReactiveMongoTemplate(reactiveMongoDatabaseFactory());
  }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="mongo.reactive.template"><a class="anchor" href="index.html#mongo.reactive.template"></a>14.3. Introduction to <code>ReactiveMongoTemplate</code></h3>
<div class="paragraph">
<p>The <code>ReactiveMongoTemplate</code> class, located in the <code>org.springframework.data.mongodb</code> package, is the central class of the Spring&#8217;s Reactive MongoDB support and provides a rich feature set to interact with the database. The template offers convenience operations to create, update, delete, and query for MongoDB documents and provides a mapping between your domain objects and MongoDB documents.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Once configured, <code>ReactiveMongoTemplate</code> is thread-safe and can be reused across multiple instances.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The mapping between MongoDB documents and domain classes is done by delegating to an implementation of the <code>MongoConverter</code> interface. Spring provides a default implementation with <code>MongoMappingConverter</code>, but you can also write your own converter. See the <a href="index.html#mongo.custom-converters">section on <code>MongoConverter</code> instances</a> for more detailed information.</p>
</div>
<div class="paragraph">
<p>The <code>ReactiveMongoTemplate</code> class implements the <code>ReactiveMongoOperations</code> interface. As much as possible, the methods on <code>ReactiveMongoOperations</code> mirror methods available on the MongoDB driver <code>Collection</code> object, to make the API familiar to existing MongoDB developers who are used to the driver API. For example, you can find methods such as <code>find</code>, <code>findAndModify</code>, <code>findOne</code>, <code>insert</code>, <code>remove</code>, <code>save</code>, <code>update</code>, and <code>updateMulti</code>. The design goal is to make it as easy as possible to transition between the use of the base MongoDB driver and <code>ReactiveMongoOperations</code>. A major difference between the two APIs is that <code>ReactiveMongoOperations</code> can be passed domain objects instead of <code>Document</code>, and there are fluent APIs for <code>Query</code>, <code>Criteria</code>, and <code>Update</code> operations instead of populating a <code>Document</code> to specify the parameters for those operations.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The preferred way to reference the operations on <code>ReactiveMongoTemplate</code> instance is through its <code>ReactiveMongoOperations</code> interface.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The default converter implementation used by <code>ReactiveMongoTemplate</code> is <code>MappingMongoConverter</code>. While the <code>MappingMongoConverter</code> can use additional metadata to specify the mapping of objects to documents, it can also convert objects that contain no additional metadata by using some conventions for the mapping of IDs and collection names. These conventions as well as the use of mapping annotations are explained in the <a href="index.html#mapping-chapter">Mapping chapter</a>.</p>
</div>
<div class="paragraph">
<p>Another central feature of <code>ReactiveMongoTemplate</code> is exception translation of exceptions thrown in the MongoDB Java driver into Spring&#8217;s portable Data Access Exception hierarchy. See the section on <a href="index.html#mongo.exception">exception translation</a> for more information.</p>
</div>
<div class="paragraph">
<p>There are many convenience methods on <code>ReactiveMongoTemplate</code> to help you easily perform common tasks. However, if you need to access the MongoDB driver API directly to access functionality not explicitly exposed by the MongoTemplate, you can use one of several <code>execute</code> callback methods to access underlying driver APIs. The <code>execute</code> callbacks give you a reference to either a <code>com.mongodb.reactivestreams.client.MongoCollection</code> or a <code>com.mongodb.reactivestreams.client.MongoDatabase</code> object. See <a href="index.html#mongo.reactive.executioncallback">Execution Callbacks</a> for more information.</p>
</div>
<div class="sect3">
<h4 id="mongo.reactive.template.instantiating"><a class="anchor" href="index.html#mongo.reactive.template.instantiating"></a>14.3.1. Instantiating ReactiveMongoTemplate</h4>
<div class="paragraph">
<p>You can use Java to create and register an instance of <code>ReactiveMongoTemplate</code>, as follows:</p>
</div>
<div class="exampleblock">
<div class="title">Example 133. Registering a <code>com.mongodb.reactivestreams.client.MongoClient</code> object and enabling Spring&#8217;s exception translation support</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Configuration
public class AppConfig {

  public @Bean MongoClient reactiveMongoClient() {
      return MongoClients.create("mongodb://localhost");
  }

  public @Bean ReactiveMongoTemplate reactiveMongoTemplate() {
      return new ReactiveMongoTemplate(reactiveMongoClient(), "mydatabase");
  }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>There are several overloaded constructors of <code>ReactiveMongoTemplate</code>, including:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>ReactiveMongoTemplate(MongoClient mongo, String databaseName)</code>: Takes the <code>com.mongodb.reactivestreams.client.MongoClient</code> object and the default database name to operate against.</p>
</li>
<li>
<p><code>ReactiveMongoTemplate(ReactiveMongoDatabaseFactory mongoDatabaseFactory)</code>: Takes a <code>ReactiveMongoDatabaseFactory</code> object that encapsulated the <code>com.mongodb.reactivestreams.client.MongoClient</code> object and database name.</p>
</li>
<li>
<p><code>ReactiveMongoTemplate(ReactiveMongoDatabaseFactory mongoDatabaseFactory, MongoConverter mongoConverter)</code>: Adds a <code>MongoConverter</code> to use for mapping.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>When creating a <code>ReactiveMongoTemplate</code>, you might also want to set the following properties:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>WriteResultCheckingPolicy</code></p>
</li>
<li>
<p><code>WriteConcern</code></p>
</li>
<li>
<p><code>ReadPreference</code></p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The preferred way to reference the operations on <code>ReactiveMongoTemplate</code> instance is through its <code>ReactiveMongoOperations</code> interface.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="mongo.reactive.template.writeresultchecking"><a class="anchor" href="index.html#mongo.reactive.template.writeresultchecking"></a>14.3.2. <code>WriteResultChecking</code> Policy</h4>
<div class="paragraph">
<p>When in development, it is handy to either log or throw an <code>Exception</code> if the <code>com.mongodb.WriteResult</code> returned from any MongoDB operation contains an error. It is quite common to forget to do this during development and then end up with an application that looks like it runs successfully when, in fact, the database was not modified according to your expectations. Set the <code>MongoTemplate</code> <code>WriteResultChecking</code> property to an enum with the following values, <code>LOG</code>, <code>EXCEPTION</code>, or <code>NONE</code> to either log the error, throw and exception or do nothing. The default is to use a <code>WriteResultChecking</code> value of <code>NONE</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="mongo.reactive.template.writeconcern"><a class="anchor" href="index.html#mongo.reactive.template.writeconcern"></a>14.3.3. <code>WriteConcern</code></h4>
<div class="paragraph">
<p>If it has not yet been specified through the driver at a higher level (such as <code>MongoDatabase</code>), you can set the <code>com.mongodb.WriteConcern</code> property that the <code>ReactiveMongoTemplate</code> uses for write operations. If ReactiveMongoTemplate&#8217;s <code>WriteConcern</code> property is not set, it defaults to the one set in the MongoDB driver&#8217;s <code>MongoDatabase</code> or <code>MongoCollection</code> setting.</p>
</div>
</div>
<div class="sect3">
<h4 id="mongo.reactive.template.writeconcernresolver"><a class="anchor" href="index.html#mongo.reactive.template.writeconcernresolver"></a>14.3.4. <code>WriteConcernResolver</code></h4>
<div class="paragraph">
<p>For more advanced cases where you want to set different <code>WriteConcern</code> values on a per-operation basis (for remove, update, insert, and save operations), a strategy interface called <code>WriteConcernResolver</code> can be configured on <code>ReactiveMongoTemplate</code>. Since <code>ReactiveMongoTemplate</code> is used to persist POJOs, the <code>WriteConcernResolver</code> lets you create a policy that can map a specific POJO class to a <code>WriteConcern</code> value. The following listing shows the <code>WriteConcernResolver</code> interface:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">public interface WriteConcernResolver {
  WriteConcern resolve(MongoAction action);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The argument, <code>MongoAction</code>, determines the <code>WriteConcern</code> value to be used and whether to use the value of the template itself as a default. <code>MongoAction</code> contains the collection name being written to, the <code>java.lang.Class</code> of the POJO, the converted <code>DBObject</code>, the operation as a value from the <code>MongoActionOperation</code> enumeration (one of <code>REMOVE</code>, <code>UPDATE</code>, <code>INSERT</code>, <code>INSERT_LIST</code>, and <code>SAVE</code>), and a few other pieces of contextual information. The following example shows how to create a <code>WriteConcernResolver</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">private class MyAppWriteConcernResolver implements WriteConcernResolver {

  public WriteConcern resolve(MongoAction action) {
    if (action.getEntityClass().getSimpleName().contains("Audit")) {
      return WriteConcern.NONE;
    } else if (action.getEntityClass().getSimpleName().contains("Metadata")) {
      return WriteConcern.JOURNAL_SAFE;
    }
    return action.getDefaultWriteConcern();
  }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="mongo.reactive.template.save-update-remove"><a class="anchor" href="index.html#mongo.reactive.template.save-update-remove"></a>14.4. Saving, Updating, and Removing Documents</h3>
<div class="paragraph">
<p><code>ReactiveMongoTemplate</code> lets you save, update, and delete your domain objects and map those objects to documents stored in MongoDB.</p>
</div>
<div class="paragraph">
<p>Consider the following <code>Person</code> class:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">public class Person {

  private String id;
  private String name;
  private int age;

  public Person(String name, int age) {
    this.name = name;
    this.age = age;
  }

  public String getId() {
    return id;
  }
  public String getName() {
    return name;
  }
  public int getAge() {
    return age;
  }

  @Override
  public String toString() {
    return "Person [id=" + id + ", name=" + name + ", age=" + age + "]";
  }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following listing shows how you can save, update, and delete the <code>Person</code> object:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">public class ReactiveMongoApp {

  private static final Logger log = LoggerFactory.getLogger(ReactiveMongoApp.class);

  public static void main(String[] args) throws Exception {

    CountDownLatch latch = new CountDownLatch(1);

    ReactiveMongoTemplate mongoOps = new ReactiveMongoTemplate(MongoClients.create(), "database");

    mongoOps.insert(new Person("Joe", 34)).doOnNext(person -&gt; log.info("Insert: " + person))
      .flatMap(person -&gt; mongoOps.findById(person.getId(), Person.class))
      .doOnNext(person -&gt; log.info("Found: " + person))
      .zipWith(person -&gt; mongoOps.updateFirst(query(where("name").is("Joe")), update("age", 35), Person.class))
      .flatMap(tuple -&gt; mongoOps.remove(tuple.getT1())).flatMap(deleteResult -&gt; mongoOps.findAll(Person.class))
      .count().doOnSuccess(count -&gt; {
        log.info("Number of people: " + count);
        latch.countDown();
      })

      .subscribe();

    latch.await();
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The preceding example includes implicit conversion between a <code>String</code> and <code>ObjectId</code> (by using the <code>MongoConverter</code>) as stored in the database and recognizing a convention of the property <code>Id</code> name.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The preceding example is meant to show the use of save, update, and remove operations on <code>ReactiveMongoTemplate</code> and not to show complex mapping or chaining functionality.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>&#8220;<a href="index.html#mongo.query">Querying Documents</a>&#8221; explains the query syntax used in the preceding example in more detail. Additional documentation can be found in <a href="index.html#mongo-template">the blocking <code>MongoTemplate</code></a> section.</p>
</div>
</div>
<div class="sect2">
<h3 id="mongo.reactive.executioncallback"><a class="anchor" href="index.html#mongo.reactive.executioncallback"></a>14.5. Execution Callbacks</h3>
<div class="paragraph">
<p>One common design feature of all Spring template classes is that all functionality is routed into one of the templates that run callback methods. This helps ensure that exceptions and any resource management that maybe required are performed consistency. While this was of much greater need in the case of JDBC and JMS than with MongoDB, it still offers a single spot for exception translation and logging to occur. As such, using the <code>execute</code> callback is the preferred way to access the MongoDB driver&#8217;s <code>MongoDatabase</code> and <code>MongoCollection</code> objects to perform uncommon operations that were not exposed as methods on <code>ReactiveMongoTemplate</code>.</p>
</div>
<div class="paragraph">
<p>Here is a list of <code>execute</code> callback methods.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>&lt;T&gt; Flux&lt;T&gt;</code> <strong>execute</strong> <code>(Class&lt;?&gt; entityClass, ReactiveCollectionCallback&lt;T&gt; action)</code>: Runs the given <code>ReactiveCollectionCallback</code> for the entity collection of the specified class.</p>
</li>
<li>
<p><code>&lt;T&gt; Flux&lt;T&gt;</code> <strong>execute</strong> <code>(String collectionName, ReactiveCollectionCallback&lt;T&gt; action)</code>: Runs the given <code>ReactiveCollectionCallback</code> on the collection of the given name.</p>
</li>
<li>
<p><code>&lt;T&gt; Flux&lt;T&gt;</code> <strong>execute</strong> <code>(ReactiveDatabaseCallback&lt;T&gt; action)</code>: Runs a <code>ReactiveDatabaseCallback</code> translating any exceptions as necessary.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The following example uses the <code>ReactiveCollectionCallback</code> to return information about an index:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">Flux&lt;Boolean&gt; hasIndex = operations.execute("geolocation",
    collection -&gt; Flux.from(collection.listIndexes(Document.class))
      .filter(document -&gt; document.get("name").equals("fancy-index-name"))
      .flatMap(document -&gt; Mono.just(true))
      .defaultIfEmpty(false));</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="reactive.gridfs"><a class="anchor" href="index.html#reactive.gridfs"></a>14.6. GridFS Support</h3>
<div class="paragraph">
<p>MongoDB supports storing binary files inside its filesystem, GridFS.
Spring Data MongoDB provides a <code>ReactiveGridFsOperations</code> interface as well as the corresponding implementation, <code>ReactiveGridFsTemplate</code>, to let you interact with the filesystem.
You can set up a <code>ReactiveGridFsTemplate</code> instance by handing it a <code>ReactiveMongoDatabaseFactory</code> as well as a <code>MongoConverter</code>, as the following example shows:</p>
</div>
<div class="exampleblock">
<div class="title">Example 134. JavaConfig setup for a ReactiveGridFsTemplate</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">class GridFsConfiguration extends AbstractReactiveMongoConfiguration {

  // … further configuration omitted

  @Bean
  public ReactiveGridFsTemplate reactiveGridFsTemplate() {
    return new ReactiveGridFsTemplate(reactiveMongoDbFactory(), mappingMongoConverter());
  }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The template can now be injected and used to perform storage and retrieval operations, as the following example shows:</p>
</div>
<div class="exampleblock">
<div class="title">Example 135. Using ReactiveGridFsTemplate to store files</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">class ReactiveGridFsClient {

  @Autowired
  ReactiveGridFsTemplate operations;

  @Test
  public Mono&lt;ObjectId&gt; storeFileToGridFs() {

    FileMetadata metadata = new FileMetadata();
    // populate metadata
    Publisher&lt;DataBuffer&gt; file = … // lookup File or Resource

    return operations.store(file, "filename.txt", metadata);
  }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The <code>store(…)</code> operations take an <code>Publisher&lt;DataBuffer&gt;</code>, a filename, and (optionally) metadata information about the file to store. The metadata can be an arbitrary object, which will be marshaled by the <code>MongoConverter</code> configured with the <code>ReactiveGridFsTemplate</code>. Alternatively, you can also provide a <code>Document</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
MongoDB&#8217;s driver uses <code>AsyncInputStream</code> and <code>AsyncOutputStream</code> interfaces to exchange binary streams. Spring Data MongoDB adapts these interfaces to <code>Publisher&lt;DataBuffer&gt;</code>. Read more about <code>DataBuffer</code> in <a href="https://docs.spring.io/spring/docs/5.3.1/spring-framework-reference/core.html#databuffers">Spring&#8217;s reference documentation</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You can read files from the filesystem through either the <code>find(…)</code> or the <code>getResources(…)</code> methods. Let&#8217;s have a look at the <code>find(…)</code> methods first. You can either find a single file or multiple files that match a <code>Query</code>. You can use the <code>GridFsCriteria</code> helper class to define queries. It provides static factory methods to encapsulate default metadata fields (such as <code>whereFilename()</code> and <code>whereContentType()</code>) or a custom one through <code>whereMetaData()</code>. The following example shows how to use <code>ReactiveGridFsTemplate</code> to query for files:</p>
</div>
<div class="exampleblock">
<div class="title">Example 136. Using ReactiveGridFsTemplate to query for files</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">class ReactiveGridFsClient {

  @Autowired
  ReactiveGridFsTemplate operations;

  @Test
  public Flux&lt;GridFSFile&gt; findFilesInGridFs() {
    return operations.find(query(whereFilename().is("filename.txt")))
  }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Currently, MongoDB does not support defining sort criteria when retrieving files from GridFS. For this reason, any sort criteria defined on the <code>Query</code> instance handed into the <code>find(…)</code> method are disregarded.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The other option to read files from the GridFs is to use the methods modeled along the lines of <code>ResourcePatternResolver</code>.
<code>ReactiveGridFsOperations</code> uses reactive types to defer running while <code>ResourcePatternResolver</code> uses a synchronous interface.
These methods allow handing an Ant path into the method and can thus retrieve files matching the given pattern. The following example shows how to use <code>ReactiveGridFsTemplate</code> to read files:</p>
</div>
<div class="exampleblock">
<div class="title">Example 137. Using ReactiveGridFsTemplate to read files</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">class ReactiveGridFsClient {

  @Autowired
  ReactiveGridFsOperations operations;

  @Test
  public void readFilesFromGridFs() {
     Flux&lt;ReactiveGridFsResource&gt; txtFiles = operations.getResources("*.txt");
  }
}</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="mongo.repositories"><a class="anchor" href="index.html#mongo.repositories"></a>15. MongoDB Repositories</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="mongo-repo-intro"><a class="anchor" href="index.html#mongo-repo-intro"></a>15.1. Introduction</h3>
<div class="paragraph">
<p>This chapter points out the specialties for repository support for MongoDB. This chapter builds on the core repository support explained in <a href="index.html#repositories">Working with Spring Data Repositories</a>. You should have a sound understanding of the basic concepts explained there.</p>
</div>
</div>
<div class="sect2">
<h3 id="mongo-repo-usage"><a class="anchor" href="index.html#mongo-repo-usage"></a>15.2. Usage</h3>
<div class="paragraph">
<p>To access domain entities stored in a MongoDB, you can use our sophisticated repository support that eases implementation quite significantly.To do so, create an interface for your repository, as the following example shows:</p>
</div>
<div class="exampleblock">
<div class="title">Example 138. Sample Person entity</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">public class Person {

  @Id
  private String id;
  private String firstname;
  private String lastname;
  private Address address;

  // … getters and setters omitted
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Note that the domain type shown in the preceding example has a property named <code>id</code> of type <code>String</code>.The default serialization mechanism used in <code>MongoTemplate</code> (which backs the repository support) regards properties named <code>id</code> as the document ID. Currently, we support <code>String</code>, <code>ObjectId</code>, and <code>BigInteger</code> as ID types.
Please see <a href="index.html#mongo-template.id-handling">ID mapping</a> for more information about on how the <code>id</code> field is handled in the mapping layer.</p>
</div>
<div class="paragraph">
<p>Now that we have a domain object, we can define an interface that uses it, as follows:</p>
</div>
<div class="exampleblock">
<div class="title">Example 139. Basic repository interface to persist Person entities</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">public interface PersonRepository extends PagingAndSortingRepository&lt;Person, String&gt; {

  // additional custom query methods go here
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Right now this interface serves only to provide type information, but we can add additional methods to it later.</p>
</div>
<div class="paragraph">
<p>To start using the repository, use the <code>@EnableMongoRepositories</code> annotation.
That annotation carries the same attributes as the namespace element.If no base package is configured, the infrastructure scans the package of the annotated configuration class.The following example shows how to use Java configuration for a repository:</p>
</div>
<div class="exampleblock">
<div class="title">Example 140. Java configuration for repositories</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Configuration
@EnableMongoRepositories
class ApplicationConfig extends AbstractMongoClientConfiguration {

  @Override
  protected String getDatabaseName() {
    return "e-store";
  }

  @Override
  protected String getMappingBasePackage() {
    return "com.oreilly.springdata.mongodb";
  }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>If you would rather go with XML based configuration add the following content:</p>
</div>
<div class="exampleblock">
<div class="title">Example 141. General MongoDB repository Spring XML configuration</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;beans xmlns="http://www.springframework.org/schema/beans"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xmlns:mongo="http://www.springframework.org/schema/data/mongo"
  xsi:schemaLocation="http://www.springframework.org/schema/beans
    https://www.springframework.org/schema/beans/spring-beans-3.0.xsd
    http://www.springframework.org/schema/data/mongo
    https://www.springframework.org/schema/data/mongo/spring-mongo-1.0.xsd"&gt;

  &lt;mongo:mongo-client id="mongoClient" /&gt;

  &lt;bean id="mongoTemplate" class="org.springframework.data.mongodb.core.MongoTemplate"&gt;
    &lt;constructor-arg ref="mongoClient" /&gt;
    &lt;constructor-arg value="databaseName" /&gt;
  &lt;/bean&gt;

  &lt;mongo:repositories base-package="com.acme.*.repositories" /&gt;

&lt;/beans&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>This namespace element causes the base packages to be scanned for interfaces that extend <code>MongoRepository</code> and create Spring beans for each one found.By default, the repositories get a <code>MongoTemplate</code> Spring bean wired that is called <code>mongoTemplate</code>, so you only need to configure <code>mongo-template-ref</code> explicitly if you deviate from this convention.</p>
</div>
<div class="paragraph">
<p>Because our domain repository extends <code>PagingAndSortingRepository</code>, it provides you with CRUD operations as well as methods for paginated and sorted access to the entities.Working with the repository instance is just a matter of dependency injecting it into a client.Consequently, accessing the second page of <code>Person</code> objects at a page size of 10 would resemble the following code:</p>
</div>
<div class="exampleblock">
<div class="title">Example 142. Paging access to Person entities</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@RunWith(SpringRunner.class)
@ContextConfiguration
public class PersonRepositoryTests {

    @Autowired PersonRepository repository;

    @Test
    public void readsFirstPageCorrectly() {

      Page&lt;Person&gt; persons = repository.findAll(PageRequest.of(0, 10));
      assertThat(persons.isFirstPage()).isTrue();
    }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The preceding example creates an application context with Spring&#8217;s unit test support, which performs annotation-based dependency injection into test cases.Inside the test method, we use the repository to query the datastore.We hand the repository a <code>PageRequest</code> instance that requests the first page of <code>Person</code> objects at a page size of 10.</p>
</div>
</div>
<div class="sect2">
<h3 id="mongodb.repositories.queries"><a class="anchor" href="index.html#mongodb.repositories.queries"></a>15.3. Query Methods</h3>
<div class="paragraph">
<p>Most of the data access operations you usually trigger on a repository result in a query being executed against the MongoDB databases.Defining such a query is a matter of declaring a method on the repository interface, as the following example shows:</p>
</div>
<div class="exampleblock">
<div class="title">Example 143. PersonRepository with query methods</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">public interface PersonRepository extends PagingAndSortingRepository&lt;Person, String&gt; {

    List&lt;Person&gt; findByLastname(String lastname);                      <i class="conum" data-value="1"></i><b>(1)</b>

    Page&lt;Person&gt; findByFirstname(String firstname, Pageable pageable); <i class="conum" data-value="2"></i><b>(2)</b>

    Person findByShippingAddresses(Address address);                   <i class="conum" data-value="3"></i><b>(3)</b>

    Person findFirstByLastname(String lastname)                        <i class="conum" data-value="4"></i><b>(4)</b>

    Stream&lt;Person&gt; findAllBy();                                        <i class="conum" data-value="5"></i><b>(5)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <code>findByLastname</code> method shows a query for all people with the given last name. The query is derived by parsing the method name for constraints that can be concatenated with <code>And</code> and <code>Or</code>. Thus, the method name results in a query expression of <code>{"lastname" : lastname}</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Applies pagination to a query. You can equip your method signature with a <code>Pageable</code> parameter and let the method return a <code>Page</code> instance and Spring Data automatically pages the query accordingly.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Shows that you can query based on properties that are not primitive types. Throws <code>IncorrectResultSizeDataAccessException</code> if more than one match is found.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Uses the <code>First</code> keyword to restrict the query to only the first result. Unlike &lt;3&gt;, this method does not throw an exception if more than one match is found.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Uses a Java 8 <code>Stream</code> that reads and converts individual elements while iterating the stream.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
We do not support referring to parameters that are mapped as <code>DBRef</code> in the domain class.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The following table shows the keywords that are supported for query methods:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 16. Supported keywords for query methods</caption>
<colgroup>
<col style="width: 16.6666%;">
<col style="width: 33.3333%;">
<col style="width: 50.0001%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Keyword</th>
<th class="tableblock halign-left valign-top">Sample</th>
<th class="tableblock halign-left valign-top">Logical result</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>After</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>findByBirthdateAfter(Date date)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"birthdate" : {"$gt" : date}}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>GreaterThan</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>findByAgeGreaterThan(int age)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"age" : {"$gt" : age}}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>GreaterThanEqual</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>findByAgeGreaterThanEqual(int age)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"age" : {"$gte" : age}}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Before</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>findByBirthdateBefore(Date date)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"birthdate" : {"$lt" : date}}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>LessThan</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>findByAgeLessThan(int age)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"age" : {"$lt" : age}}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>LessThanEqual</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>findByAgeLessThanEqual(int age)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"age" : {"$lte" : age}}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Between</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>findByAgeBetween(int from, int to)</code><br>
<code>findByAgeBetween(Range&lt;Integer&gt; range)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"age" : {"$gt" : from, "$lt" : to}}</code><br>
lower / upper bounds (<code>$gt</code> / <code>$gte</code> &amp; <code>$lt</code> / <code>$lte</code>) according to <code>Range</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>In</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>findByAgeIn(Collection ages)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"age" : {"$in" : [ages&#8230;&#8203;]}}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>NotIn</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>findByAgeNotIn(Collection ages)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"age" : {"$nin" : [ages&#8230;&#8203;]}}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>IsNotNull</code>, <code>NotNull</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>findByFirstnameNotNull()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"firstname" : {"$ne" : null}}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>IsNull</code>, <code>Null</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>findByFirstnameNull()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"firstname" : null}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Like</code>, <code>StartingWith</code>, <code>EndingWith</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>findByFirstnameLike(String name)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"firstname" : name} (name as regex)</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>NotLike</code>, <code>IsNotLike</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>findByFirstnameNotLike(String name)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"firstname" : { "$not" : name }} (name as regex)</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Containing</code> on String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>findByFirstnameContaining(String name)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"firstname" : name} (name as regex)</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>NotContaining</code> on String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>findByFirstnameNotContaining(String name)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"firstname" : { "$not" : name}} (name as regex)</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Containing</code> on Collection</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>findByAddressesContaining(Address address)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"addresses" : { "$in" : address}}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>NotContaining</code> on Collection</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>findByAddressesNotContaining(Address address)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"addresses" : { "$not" : { "$in" : address}}}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Regex</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>findByFirstnameRegex(String firstname)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"firstname" : {"$regex" : firstname }}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>(No keyword)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>findByFirstname(String name)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"firstname" : name}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Not</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>findByFirstnameNot(String name)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"firstname" : {"$ne" : name}}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Near</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>findByLocationNear(Point point)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"location" : {"$near" : [x,y]}}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Near</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>findByLocationNear(Point point, Distance max)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"location" : {"$near" : [x,y], "$maxDistance" : max}}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Near</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>findByLocationNear(Point point, Distance min, Distance max)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"location" : {"$near" : [x,y], "$minDistance" : min, "$maxDistance" : max}}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Within</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>findByLocationWithin(Circle circle)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"location" : {"$geoWithin" : {"$center" : [ [x, y], distance]}}}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Within</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>findByLocationWithin(Box box)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"location" : {"$geoWithin" : {"$box" : [ [x1, y1], x2, y2]}}}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>IsTrue</code>, <code>True</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>findByActiveIsTrue()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"active" : true}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>IsFalse</code>, <code>False</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>findByActiveIsFalse()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"active" : false}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Exists</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>findByLocationExists(boolean exists)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"location" : {"$exists" : exists }}</code></p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If the property criterion compares a document, the order of the fields and exact equality in the document matters.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="mongodb.repositories.queries.delete"><a class="anchor" href="index.html#mongodb.repositories.queries.delete"></a>15.3.1. Repository Delete Queries</h4>
<div class="paragraph">
<p>The keywords in the preceding table can be used in conjunction with <code>delete…By</code> or <code>remove…By</code> to create queries that delete matching documents.</p>
</div>
<div class="exampleblock">
<div class="title">Example 144. <code>Delete…By</code> Query</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">public interface PersonRepository extends MongoRepository&lt;Person, String&gt; {

  List &lt;Person&gt; deleteByLastname(String lastname);      <i class="conum" data-value="1"></i><b>(1)</b>

  Long deletePersonByLastname(String lastname);         <i class="conum" data-value="2"></i><b>(2)</b>

  @Nullable
  Person deleteSingleByLastname(String lastname);       <i class="conum" data-value="3"></i><b>(3)</b>

  Optional&lt;Person&gt; deleteByBirthdate(Date birthdate);   <i class="conum" data-value="4"></i><b>(4)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Using a return type of <code>List</code> retrieves and returns all matching documents before actually deleting them.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>A numeric return type directly removes the matching documents, returning the total number of documents removed.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>A single domain type result retrieves and removes the first matching document.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Same as in 3 but wrapped in an <code>Optional</code> type.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="mongodb.repositories.queries.geo-spatial"><a class="anchor" href="index.html#mongodb.repositories.queries.geo-spatial"></a>15.3.2. Geo-spatial Repository Queries</h4>
<div class="paragraph">
<p>As you saw in the preceding table of keywords, a few keywords trigger geo-spatial operations within a MongoDB query. The <code>Near</code> keyword allows some further modification, as the next few examples show.</p>
</div>
<div class="paragraph">
<p>The following example shows how to define a <code>near</code> query that finds all persons with a given distance of a given point:</p>
</div>
<div class="exampleblock">
<div class="title">Example 145. Advanced <code>Near</code> queries</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">public interface PersonRepository extends MongoRepository&lt;Person, String&gt; {

  // { 'location' : { '$near' : [point.x, point.y], '$maxDistance' : distance}}
  List&lt;Person&gt; findByLocationNear(Point location, Distance distance);
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Adding a <code>Distance</code> parameter to the query method allows restricting results to those within the given distance. If the <code>Distance</code> was set up containing a <code>Metric</code>, we transparently use <code>$nearSphere</code> instead of <code>$code</code>, as the following example shows:</p>
</div>
<div class="exampleblock">
<div class="title">Example 146. Using <code>Distance</code> with <code>Metrics</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">Point point = new Point(43.7, 48.8);
Distance distance = new Distance(200, Metrics.KILOMETERS);
… = repository.findByLocationNear(point, distance);
// {'location' : {'$nearSphere' : [43.7, 48.8], '$maxDistance' : 0.03135711885774796}}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Using a <code>Distance</code> with a <code>Metric</code> causes a <code>$nearSphere</code> (instead of a plain <code>$near</code>) clause to be added. Beyond that, the actual distance gets calculated according to the <code>Metrics</code> used.</p>
</div>
<div class="paragraph">
<p>(Note that <code>Metric</code> does not refer to metric units of measure. It could be miles rather than kilometers. Rather, <code>metric</code> refers to the concept of a system of measurement, regardless of which system you use.)</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Using <code>@GeoSpatialIndexed(type = GeoSpatialIndexType.GEO_2DSPHERE)</code> on the target property forces usage of the <code>$nearSphere</code> operator.
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5>Geo-near Queries</h5>
<div class="paragraph">
<p>Spring Data MongoDb supports geo-near queries, as the following example shows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">public interface PersonRepository extends MongoRepository&lt;Person, String&gt; {

  // {'geoNear' : 'location', 'near' : [x, y] }
  GeoResults&lt;Person&gt; findByLocationNear(Point location);

  // No metric: {'geoNear' : 'person', 'near' : [x, y], maxDistance : distance }
  // Metric: {'geoNear' : 'person', 'near' : [x, y], 'maxDistance' : distance,
  //          'distanceMultiplier' : metric.multiplier, 'spherical' : true }
  GeoResults&lt;Person&gt; findByLocationNear(Point location, Distance distance);

  // Metric: {'geoNear' : 'person', 'near' : [x, y], 'minDistance' : min,
  //          'maxDistance' : max, 'distanceMultiplier' : metric.multiplier,
  //          'spherical' : true }
  GeoResults&lt;Person&gt; findByLocationNear(Point location, Distance min, Distance max);

  // {'geoNear' : 'location', 'near' : [x, y] }
  GeoResults&lt;Person&gt; findByLocationNear(Point location);
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="mongodb.repositories.queries.json-based"><a class="anchor" href="index.html#mongodb.repositories.queries.json-based"></a>15.3.3. MongoDB JSON-based Query Methods and Field Restriction</h4>
<div class="paragraph">
<p>By adding the <code>org.springframework.data.mongodb.repository.Query</code> annotation to your repository query methods, you can specify a MongoDB JSON query string to use instead of having the query be derived from the method name, as the following example shows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">public interface PersonRepository extends MongoRepository&lt;Person, String&gt; {

  @Query("{ 'firstname' : ?0 }")
  List&lt;Person&gt; findByThePersonsFirstname(String firstname);

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>?0</code> placeholder lets you substitute the value from the method arguments into the JSON query string.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<code>String</code> parameter values are escaped during the binding process, which means that it is not possible to add MongoDB specific operators through the argument.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You can also use the filter property to restrict the set of properties that is mapped into the Java object, as the following example shows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">public interface PersonRepository extends MongoRepository&lt;Person, String&gt; {

  @Query(value="{ 'firstname' : ?0 }", fields="{ 'firstname' : 1, 'lastname' : 1}")
  List&lt;Person&gt; findByThePersonsFirstname(String firstname);

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The query in the preceding example returns only the <code>firstname</code>, <code>lastname</code> and <code>Id</code> properties of the <code>Person</code> objects. The <code>age</code> property, a <code>java.lang.Integer</code>, is not set and its value is therefore null.</p>
</div>
</div>
<div class="sect3">
<h4 id="mongodb.repositories.queries.sort"><a class="anchor" href="index.html#mongodb.repositories.queries.sort"></a>15.3.4. Sorting Query Method results</h4>
<div class="paragraph">
<p>MongoDB repositories allow various approaches to define sorting order. Let&#8217;s take a look at the following example:</p>
</div>
<div class="exampleblock">
<div class="title">Example 147. Sorting Query Results</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">public interface PersonRepository extends MongoRepository&lt;Person, String&gt; {

  List&lt;Person&gt; findByFirstnameSortByAgeDesc(String firstname); <i class="conum" data-value="1"></i><b>(1)</b>

  List&lt;Person&gt; findByFirstname(String firstname, Sort sort);   <i class="conum" data-value="2"></i><b>(2)</b>

  @Query(sort = "{ age : -1 }")
  List&lt;Person&gt; findByFirstname(String firstname);              <i class="conum" data-value="3"></i><b>(3)</b>

  @Query(sort = "{ age : -1 }")
  List&lt;Person&gt; findByLastname(String lastname, Sort sort);     <i class="conum" data-value="4"></i><b>(4)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Static sorting derived from method name. <code>SortByAgeDesc</code> results in <code>{ age : -1 }</code> for the sort parameter.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Dynamic sorting using a method argument. <code>Sort.by(DESC, "age")</code> creates <code>{ age : -1 }</code> for the sort parameter.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Static sorting via <code>Query</code> annotation. Sort parameter applied as stated in the <code>sort</code> attribute.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Default sorting via <code>Query</code> annotation combined with dynamic one via a method argument. <code>Sort.unsorted()</code>
results in <code>{ age : -1 }</code>. Using <code>Sort.by(ASC, "age")</code> overrides the defaults and creates <code>{ age : 1 }</code>. <code>Sort.by
(ASC, "firstname")</code> alters the default and results in <code>{ age : -1, firstname : 1 }</code>.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="mongodb.repositories.queries.json-spel"><a class="anchor" href="index.html#mongodb.repositories.queries.json-spel"></a>15.3.5. JSON-based Queries with SpEL Expressions</h4>
<div class="paragraph">
<p>Query strings and field definitions can be used together with SpEL expressions to create dynamic queries at runtime.
SpEL expressions can provide predicate values and can be used to extend predicates with subdocuments.</p>
</div>
<div class="paragraph">
<p>Expressions expose method arguments through an array that contains all the arguments.The following query uses <code>[0]</code>
to declare the predicate value for <code>lastname</code> (which is equivalent to the <code>?0</code> parameter binding):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">public interface PersonRepository extends MongoRepository&lt;Person, String&gt; {

  @Query("{'lastname': ?#{[0]} }")
  List&lt;Person&gt; findByQueryWithExpression(String param0);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Expressions can be used to invoke functions, evaluate conditionals, and construct values.SpEL expressions
used in conjunction with JSON reveal a side-effect, because Map-like declarations inside of SpEL read like JSON, as the following example shows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">public interface PersonRepository extends MongoRepository&lt;Person, String&gt; {

  @Query("{'id': ?#{ [0] ? {$exists :true} : [1] }}")
  List&lt;Person&gt; findByQueryWithExpressionAndNestedObject(boolean param0, String param1);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>SpEL in query strings can be a powerful way to enhance queries.However, they can also accept a broad range of unwanted arguments.
You should make sure to sanitize strings before passing them to the query to avoid unwanted changes to your query.</p>
</div>
<div class="paragraph">
<p>Expression support is extensible through the Query SPI: <code>org.springframework.data.repository.query.spi.EvaluationContextExtension</code>.
The Query SPI can contribute properties and functions and can customize the root object.Extensions are retrieved from the application context
at the time of SpEL evaluation when the query is built.The following example shows how to use <code>EvaluationContextExtension</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">public class SampleEvaluationContextExtension extends EvaluationContextExtensionSupport {

  @Override
  public String getExtensionId() {
    return "security";
  }

  @Override
  public Map&lt;String, Object&gt; getProperties() {
    return Collections.singletonMap("principal", SecurityContextHolder.getCurrent().getPrincipal());
  }
}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Bootstrapping <code>MongoRepositoryFactory</code> yourself is not application context-aware and requires further configuration to pick up Query SPI extensions.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Reactive query methods can make use of <code>org.springframework.data.spel.spi.ReactiveEvaluationContextExtension</code>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="mongodb.repositories.queries.type-safe"><a class="anchor" href="index.html#mongodb.repositories.queries.type-safe"></a>15.3.6. Type-safe Query Methods</h4>
<div class="paragraph">
<p>MongoDB repository support integrates with the <a href="http://www.querydsl.com/">Querydsl</a> project, which provides a way to perform type-safe queries.
To quote from the project description, "Instead of writing queries as inline strings or externalizing them into XML files they are constructed via a fluent API." It provides the following features:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Code completion in the IDE (all properties, methods, and operations can be expanded in your favorite Java IDE).</p>
</li>
<li>
<p>Almost no syntactically invalid queries allowed (type-safe on all levels).</p>
</li>
<li>
<p>Domain types and properties can be referenced safely&#8201;&#8212;&#8201;no strings involved!</p>
</li>
<li>
<p>Adapts better to refactoring changes in domain types.</p>
</li>
<li>
<p>Incremental query definition is easier.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>See the <a href="http://www.querydsl.com/static/querydsl/latest/reference/html/">QueryDSL documentation</a> for how to bootstrap your environment for APT-based code generation using Maven or Ant.</p>
</div>
<div class="paragraph">
<p>QueryDSL lets you write queries such as the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">QPerson person = new QPerson("person");
List&lt;Person&gt; result = repository.findAll(person.address.zipCode.eq("C0123"));

Page&lt;Person&gt; page = repository.findAll(person.lastname.contains("a"),
                                       PageRequest.of(0, 2, Direction.ASC, "lastname"));</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>QPerson</code> is a class that is generated by the Java annotation post-processing tool.It is a <code>Predicate</code> that lets you write type-safe queries.Notice that there are no strings in the query other than the <code>C0123</code> value.</p>
</div>
<div class="paragraph">
<p>You can use the generated <code>Predicate</code> class by using the <code>QuerydslPredicateExecutor</code> interface, which the following listing shows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">public interface QuerydslPredicateExecutor&lt;T&gt; {

  T findOne(Predicate predicate);

  List&lt;T&gt; findAll(Predicate predicate);

  List&lt;T&gt; findAll(Predicate predicate, OrderSpecifier&lt;?&gt;... orders);

  Page&lt;T&gt; findAll(Predicate predicate, Pageable pageable);

  Long count(Predicate predicate);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>To use this in your repository implementation, add it to the list of repository interfaces from which your interface inherits, as the following example shows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">public interface PersonRepository extends MongoRepository&lt;Person, String&gt;, QuerydslPredicateExecutor&lt;Person&gt; {

   // additional query methods go here
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="mongodb.repositories.queries.full-text"><a class="anchor" href="index.html#mongodb.repositories.queries.full-text"></a>15.3.7. Full-text Search Queries</h4>
<div class="paragraph">
<p>MongoDB&#8217;s full-text search feature is store-specific and, therefore, can be found on <code>MongoRepository</code> rather than on the more general <code>CrudRepository</code>. We need a document with a full-text index (see &#8220;<a href="index.html#mapping-usage-indexes.text-index">Text Indexes</a>&#8221; to learn how to create a full-text index).</p>
</div>
<div class="paragraph">
<p>Additional methods on <code>MongoRepository</code> take <code>TextCriteria</code> as an input parameter. In addition to those explicit methods, it is also possible to add a <code>TextCriteria</code>-derived repository method. The criteria are added as an additional <code>AND</code> criteria. Once the entity contains a <code>@TextScore</code>-annotated property, the document&#8217;s full-text score can be retrieved. Furthermore, the <code>@TextScore</code> annotated also makes it possible to sort by the document&#8217;s score, as the following example shows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Document
class FullTextDocument {

  @Id String id;
  @TextIndexed String title;
  @TextIndexed String content;
  @TextScore Float score;
}

interface FullTextRepository extends Repository&lt;FullTextDocument, String&gt; {

  // Execute a full-text search and define sorting dynamically
  List&lt;FullTextDocument&gt; findAllBy(TextCriteria criteria, Sort sort);

  // Paginate over a full-text search result
  Page&lt;FullTextDocument&gt; findAllBy(TextCriteria criteria, Pageable pageable);

  // Combine a derived query with a full-text search
  List&lt;FullTextDocument&gt; findByTitleOrderByScoreDesc(String title, TextCriteria criteria);
}


Sort sort = Sort.by("score");
TextCriteria criteria = TextCriteria.forDefaultLanguage().matchingAny("spring", "data");
List&lt;FullTextDocument&gt; result = repository.findAllBy(criteria, sort);

criteria = TextCriteria.forDefaultLanguage().matching("film");
Page&lt;FullTextDocument&gt; page = repository.findAllBy(criteria, PageRequest.of(1, 1, sort));
List&lt;FullTextDocument&gt; result = repository.findByTitleOrderByScoreDesc("mongodb", criteria);</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="projections"><a class="anchor" href="index.html#projections"></a>15.3.8. Projections</h4>
<div class="paragraph">
<p>Spring Data query methods usually return one or multiple instances of the aggregate root managed by the repository.
However, it might sometimes be desirable to create projections based on certain attributes of those types.
Spring Data allows modeling dedicated return types, to more selectively retrieve partial views of the managed aggregates.</p>
</div>
<div class="paragraph">
<p>Imagine a repository and aggregate root type such as the following example:</p>
</div>
<div class="exampleblock">
<div class="title">Example 148. A sample aggregate and repository</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">class Person {

  @Id UUID id;
  String firstname, lastname;
  Address address;

  static class Address {
    String zipCode, city, street;
  }
}

interface PersonRepository extends Repository&lt;Person, UUID&gt; {

  Collection&lt;Person&gt; findByLastname(String lastname);
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Now imagine that we want to retrieve the person&#8217;s name attributes only.
What means does Spring Data offer to achieve this? The rest of this chapter answers that question.</p>
</div>
<div class="sect4">
<h5 id="projections.interfaces"><a class="anchor" href="index.html#projections.interfaces"></a>Interface-based Projections</h5>
<div class="paragraph">
<p>The easiest way to limit the result of the queries to only the name attributes is by declaring an interface that exposes accessor methods for the properties to be read, as shown in the following example:</p>
</div>
<div class="exampleblock">
<div class="title">Example 149. A projection interface to retrieve a subset of attributes</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">interface NamesOnly {

  String getFirstname();
  String getLastname();
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The important bit here is that the properties defined here exactly match properties in the aggregate root.
Doing so lets a query method be added as follows:</p>
</div>
<div class="exampleblock">
<div class="title">Example 150. A repository using an interface based projection with a query method</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">interface PersonRepository extends Repository&lt;Person, UUID&gt; {

  Collection&lt;NamesOnly&gt; findByLastname(String lastname);
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The query execution engine creates proxy instances of that interface at runtime for each element returned and forwards calls to the exposed methods to the target object.</p>
</div>
<div id="projections.interfaces.nested" class="paragraph">
<p>Projections can be used recursively. If you want to include some of the <code>Address</code> information as well, create a projection interface for that and return that interface from the declaration of <code>getAddress()</code>, as shown in the following example:</p>
</div>
<div class="exampleblock">
<div class="title">Example 151. A projection interface to retrieve a subset of attributes</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">interface PersonSummary {

  String getFirstname();
  String getLastname();
  AddressSummary getAddress();

  interface AddressSummary {
    String getCity();
  }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>On method invocation, the <code>address</code> property of the target instance is obtained and wrapped into a projecting proxy in turn.</p>
</div>
<div class="sect5">
<h6 id="projections.interfaces.closed"><a class="anchor" href="index.html#projections.interfaces.closed"></a>Closed Projections</h6>
<div class="paragraph">
<p>A projection interface whose accessor methods all match properties of the target aggregate is considered to be a closed projection. The following example (which we used earlier in this chapter, too) is a closed projection:</p>
</div>
<div class="exampleblock">
<div class="title">Example 152. A closed projection</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">interface NamesOnly {

  String getFirstname();
  String getLastname();
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>If you use a closed projection, Spring Data can optimize the query execution, because we know about all the attributes that are needed to back the projection proxy.
For more details on that, see the module-specific part of the reference documentation.</p>
</div>
</div>
<div class="sect5">
<h6 id="projections.interfaces.open"><a class="anchor" href="index.html#projections.interfaces.open"></a>Open Projections</h6>
<div class="paragraph">
<p>Accessor methods in projection interfaces can also be used to compute new values by using the <code>@Value</code> annotation, as shown in the following example:</p>
</div>
<div id="projections.interfaces.open.simple" class="exampleblock">
<div class="title">Example 153. An Open Projection</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">interface NamesOnly {

  @Value("#{target.firstname + ' ' + target.lastname}")
  String getFullName();
  …
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The aggregate root backing the projection is available in the <code>target</code> variable.
A projection interface using <code>@Value</code> is an open projection.
Spring Data cannot apply query execution optimizations in this case, because the SpEL expression could use any attribute of the aggregate root.</p>
</div>
<div class="paragraph">
<p>The expressions used in <code>@Value</code> should not be too complex&#8201;&#8212;&#8201;you want to avoid programming in <code>String</code> variables.
For very simple expressions, one option might be to resort to default methods (introduced in Java 8), as shown in the following example:</p>
</div>
<div id="projections.interfaces.open.default" class="exampleblock">
<div class="title">Example 154. A projection interface using a default method for custom logic</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">interface NamesOnly {

  String getFirstname();
  String getLastname();

  default String getFullName() {
    return getFirstname().concat(" ").concat(getLastname());
  }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>This approach requires you to be able to implement logic purely based on the other accessor methods exposed on the projection interface.
A second, more flexible, option is to implement the custom logic in a Spring bean and then invoke that from the SpEL expression, as shown in the following example:</p>
</div>
<div id="projections.interfaces.open.bean-reference" class="exampleblock">
<div class="title">Example 155. Sample Person object</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Component
class MyBean {

  String getFullName(Person person) {
    …
  }
}

interface NamesOnly {

  @Value("#{@myBean.getFullName(target)}")
  String getFullName();
  …
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Notice how the SpEL expression refers to <code>myBean</code> and invokes the <code>getFullName(…)</code> method and forwards the projection target as a method parameter.
Methods backed by SpEL expression evaluation can also use method parameters, which can then be referred to from the expression.
The method parameters are available through an <code>Object</code> array named <code>args</code>. The following example shows how to get a method parameter from the <code>args</code> array:</p>
</div>
<div class="exampleblock">
<div class="title">Example 156. Sample Person object</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">interface NamesOnly {

  @Value("#{args[0] + ' ' + target.firstname + '!'}")
  String getSalutation(String prefix);
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Again, for more complex expressions, you should use a Spring bean and let the expression invoke a method, as described <a href="index.html#projections.interfaces.open.bean-reference">earlier</a>.</p>
</div>
</div>
<div class="sect5">
<h6 id="projections.interfaces.nullable-wrappers"><a class="anchor" href="index.html#projections.interfaces.nullable-wrappers"></a>Nullable Wrappers</h6>
<div class="paragraph">
<p>Getters in projection interfaces can make use of nullable wrappers for improved null-safety. Currently supported wrapper types are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>java.util.Optional</code></p>
</li>
<li>
<p><code>com.google.common.base.Optional</code></p>
</li>
<li>
<p><code>scala.Option</code></p>
</li>
<li>
<p><code>io.vavr.control.Option</code></p>
</li>
</ul>
</div>
<div class="exampleblock">
<div class="title">Example 157. A projection interface using nullable wrappers</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">interface NamesOnly {

  Optional&lt;String&gt; getFirstname();
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>If the underlying projection value is not <code>null</code>, then values are returned using the present-representation of the wrapper type.
In case the backing value is <code>null</code>, then the getter method returns the empty representation of the used wrapper type.</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="projections.dtos"><a class="anchor" href="index.html#projections.dtos"></a>Class-based Projections (DTOs)</h5>
<div class="paragraph">
<p>Another way of defining projections is by using value type DTOs (Data Transfer Objects) that hold properties for the fields that are supposed to be retrieved.
These DTO types can be used in exactly the same way projection interfaces are used, except that no proxying happens and no nested projections can be applied.</p>
</div>
<div class="paragraph">
<p>If the store optimizes the query execution by limiting the fields to be loaded, the fields to be loaded are determined from the parameter names of the constructor that is exposed.</p>
</div>
<div class="paragraph">
<p>The following example shows a projecting DTO:</p>
</div>
<div class="exampleblock">
<div class="title">Example 158. A projecting DTO</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">class NamesOnly {

  private final String firstname, lastname;

  NamesOnly(String firstname, String lastname) {

    this.firstname = firstname;
    this.lastname = lastname;
  }

  String getFirstname() {
    return this.firstname;
  }

  String getLastname() {
    return this.lastname;
  }

  // equals(…) and hashCode() implementations
}</code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">Avoid boilerplate code for projection DTOs</div>
<div class="paragraph">
<p>You can dramatically simplify the code for a DTO by using <a href="https://projectlombok.org">Project Lombok</a>, which provides an <code>@Value</code> annotation (not to be confused with Spring&#8217;s <code>@Value</code> annotation shown in the earlier interface examples).
If you use Project Lombok&#8217;s <code>@Value</code> annotation, the sample DTO shown earlier would become the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Value
class NamesOnly {
	String firstname, lastname;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Fields are <code>private final</code> by default, and the class exposes a constructor that takes all fields and automatically gets <code>equals(…)</code> and <code>hashCode()</code> methods implemented.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="projection.dynamic"><a class="anchor" href="index.html#projection.dynamic"></a>Dynamic Projections</h5>
<div class="paragraph">
<p>So far, we have used the projection type as the return type or element type of a collection.
However, you might want to select the type to be used at invocation time (which makes it dynamic).
To apply dynamic projections, use a query method such as the one shown in the following example:</p>
</div>
<div class="exampleblock">
<div class="title">Example 159. A repository using a dynamic projection parameter</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">interface PersonRepository extends Repository&lt;Person, UUID&gt; {

  &lt;T&gt; Collection&lt;T&gt; findByLastname(String lastname, Class&lt;T&gt; type);
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>This way, the method can be used to obtain the aggregates as is or with a projection applied, as shown in the following example:</p>
</div>
<div class="exampleblock">
<div class="title">Example 160. Using a repository with dynamic projections</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">void someMethod(PersonRepository people) {

  Collection&lt;Person&gt; aggregates =
    people.findByLastname("Matthews", Person.class);

  Collection&lt;NamesOnly&gt; aggregates =
    people.findByLastname("Matthews", NamesOnly.class);
}</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="mongodb.repositories.queries.aggregation"><a class="anchor" href="index.html#mongodb.repositories.queries.aggregation"></a>15.3.9. Aggregation Repository Methods</h4>
<div class="paragraph">
<p>The repository layer offers means to interact with <a href="index.html#mongo.aggregation">the aggregation framework</a> via annotated repository query methods.
Similar to the <a href="index.html#mongodb.repositories.queries.json-based">JSON based queries</a>, you can define a pipeline using the <code>org.springframework.data.mongodb.repository.Aggregation</code> annotation.
The definition may contain simple placeholders like <code>?0</code> as well as <a href="https://docs.spring.io/spring/docs/5.3.1/spring-framework-reference/core.html#expressions">SpEL expressions</a> <code>?#{ … }</code>.</p>
</div>
<div class="exampleblock">
<div class="title">Example 161. Aggregating Repository Method</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">public interface PersonRepository extends CrudReppsitory&lt;Person, String&gt; {

  @Aggregation("{ $group: { _id : $lastname, names : { $addToSet : $firstname } } }")
  List&lt;PersonAggregate&gt; groupByLastnameAndFirstnames();                            <i class="conum" data-value="1"></i><b>(1)</b>

  @Aggregation("{ $group: { _id : $lastname, names : { $addToSet : $firstname } } }")
  List&lt;PersonAggregate&gt; groupByLastnameAndFirstnames(Sort sort);                   <i class="conum" data-value="2"></i><b>(2)</b>

  @Aggregation("{ $group: { _id : $lastname, names : { $addToSet : ?0 } } }")
  List&lt;PersonAggregate&gt; groupByLastnameAnd(String property);                       <i class="conum" data-value="3"></i><b>(3)</b>

  @Aggregation("{ $group: { _id : $lastname, names : { $addToSet : ?0 } } }")
  List&lt;PersonAggregate&gt; groupByLastnameAnd(String property, Pageable page);        <i class="conum" data-value="4"></i><b>(4)</b>

  @Aggregation("{ $group : { _id : null, total : { $sum : $age } } }")
  SumValue sumAgeUsingValueWrapper();                                              <i class="conum" data-value="5"></i><b>(5)</b>

  @Aggregation("{ $group : { _id : null, total : { $sum : $age } } }")
  Long sumAge();                                                                   <i class="conum" data-value="6"></i><b>(6)</b>

  @Aggregation("{ $group : { _id : null, total : { $sum : $age } } }")
  AggregationResults&lt;SumValue&gt; sumAgeRaw();                                        <i class="conum" data-value="7"></i><b>(7)</b>

  @Aggregation("{ '$project': { '_id' : '$lastname' } }")
  List&lt;String&gt; findAllLastnames();                                                 <i class="conum" data-value="8"></i><b>(8)</b>
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">public class PersonAggregate {

  private @Id String lastname;                                                     <i class="conum" data-value="2"></i><b>(2)</b>
  private List&lt;String&gt; names;

  public PersonAggregate(String lastname, List&lt;String&gt; names) {
     // ...
  }

  // Getter / Setter omitted
}

public class SumValue {

  private final Long total;                                                        <i class="conum" data-value="5"></i><b>(5)</b> <i class="conum" data-value="7"></i><b>(7)</b>

  public SumValue(Long total) {
    // ...
  }

  // Getter omitted
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Aggregation pipeline to group first names by <code>lastname</code> in the <code>Person</code> collection returning these as <code>PersonAggregate</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>If <code>Sort</code> argument is present, <code>$sort</code> is appended after the declared pipeline stages so that it only affects the order of the final results after having passed all other aggregation stages.
Therefore, the <code>Sort</code> properties are mapped against the methods return type <code>PersonAggregate</code> which turns <code>Sort.by("lastname")</code> into <code>{ $sort : { '_id', 1 } }</code> because <code>PersonAggregate.lastname</code> is annotated with <code>@Id</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Replaces <code>?0</code> with the given value for <code>property</code> for a dynamic aggregation pipeline.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td><code>$skip</code>, <code>$limit</code> and <code>$sort</code> can be passed on via a <code>Pageable</code> argument. Same as in &lt;2&gt;, the operators are appended to the pipeline definition.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Map the result of an aggregation returning a single <code>Document</code> to an instance of a desired <code>SumValue</code> target type.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Aggregations resulting in single document holding just an accumulation result like eg. <code>$sum</code> can be extracted directly from the result <code>Document</code>.
To gain more control, you might consider <code>AggregationResult</code> as method return type as shown in &lt;7&gt;.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Obtain the raw <code>AggregationResults</code> mapped to the generic target wrapper type <code>SumValue</code> or <code>org.bson.Document</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>Like in &lt;6&gt;, a single value can be directly obtained from multiple result <code>Document</code>s.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>In some scenarios, aggregations might require additional options, such as a maximum run time, additional log comments, or the permission to temporarily write data to disk.
Use the <code>@Meta</code> annotation to set those options via <code>maxExecutionTimeMs</code>, <code>comment</code> or <code>allowDiskUse</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">public interface PersonRepository extends CrudReppsitory&lt;Person, String&gt; {

  @Meta(allowDiskUse = true)
  @Aggregation("{ $group: { _id : $lastname, names : { $addToSet : $firstname } } }")
  List&lt;PersonAggregate&gt; groupByLastnameAndFirstnames();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Or use <code>@Meta</code> to create your own annotation as shown in the sample below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Retention(RetentionPolicy.RUNTIME)
@Target({ ElementType.METHOD })
@Meta(allowDiskUse = true)
@interface AllowDiskUse { }

public interface PersonRepository extends CrudReppsitory&lt;Person, String&gt; {

  @AllowDiskUse
  @Aggregation("{ $group: { _id : $lastname, names : { $addToSet : $firstname } } }")
  List&lt;PersonAggregate&gt; groupByLastnameAndFirstnames();
}</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
You can use <code>@Aggregation</code> also with <a href="index.html#mongo.reactive.repositories">Reactive Repositories</a>.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Simple-type single-result inspects the returned <code>Document</code> and checks for the following:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Only one entry in the document, return it.</p>
</li>
<li>
<p>Two entries, one is the <code>_id</code> value. Return the other.</p>
</li>
<li>
<p>Return for the first value assignable to the return type.</p>
</li>
<li>
<p>Throw an exception if none of the above is applicable.</p>
</li>
</ol>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
The <code>Page</code> return type is not supported for repository methods using <code>@Aggregation</code>. However you can use a
<code>Pageable</code> argument to add <code>$skip</code>, <code>$limit</code> and <code>$sort</code> to the pipeline.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="mongodb.repositories.misc.cdi-integration"><a class="anchor" href="index.html#mongodb.repositories.misc.cdi-integration"></a>15.4. CDI Integration</h3>
<div class="paragraph">
<p>Instances of the repository interfaces are usually created by a container, and Spring is the most natural choice when working with Spring Data. As of version 1.3.0, Spring Data MongoDB ships with a custom CDI extension that lets you use the repository abstraction in CDI environments. The extension is part of the JAR. To activate it, drop the Spring Data MongoDB JAR into your classpath. You can now set up the infrastructure by implementing a CDI Producer for the <code>MongoTemplate</code>, as the following example shows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">class MongoTemplateProducer {

    @Produces
    @ApplicationScoped
    public MongoOperations createMongoTemplate() {

        MongoDatabaseFactory factory = new SimpleMongoClientDatabaseFactory(MongoClients.create(), "database");
        return new MongoTemplate(factory);
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The Spring Data MongoDB CDI extension picks up the <code>MongoTemplate</code> available as a CDI bean and creates a proxy for a Spring Data repository whenever a bean of a repository type is requested by the container. Thus, obtaining an instance of a Spring Data repository is a matter of declaring an <code>@Inject</code>-ed property, as the following example shows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">class RepositoryClient {

  @Inject
  PersonRepository repository;

  public void businessMethod() {
    List&lt;Person&gt; people = repository.findAll();
  }
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="mongo.reactive.repositories"><a class="anchor" href="index.html#mongo.reactive.repositories"></a>16. Reactive MongoDB repositories</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This chapter describes the specialties for reactive repository support for MongoDB. This chapter builds on the core repository support explained in <a href="index.html#repositories">Working with Spring Data Repositories</a>. You should have a sound understanding of the basic concepts explained there.</p>
</div>
<div class="sect2">
<h3 id="mongo.reactive.repositories.libraries"><a class="anchor" href="index.html#mongo.reactive.repositories.libraries"></a>16.1. Reactive Composition Libraries</h3>
<div class="paragraph">
<p>The reactive space offers various reactive composition libraries. The most common libraries are <a href="https://github.com/ReactiveX/RxJava">RxJava</a> and <a href="https://projectreactor.io/">Project Reactor</a>.</p>
</div>
<div class="paragraph">
<p>Spring Data MongoDB is built on top of the <a href="https://mongodb.github.io/mongo-java-driver-reactivestreams/">MongoDB Reactive Streams</a> driver, to provide maximal interoperability by relying on the <a href="https://www.reactive-streams.org/">Reactive Streams</a> initiative. Static APIs, such as <code>ReactiveMongoOperations</code>, are provided by using Project Reactor&#8217;s <code>Flux</code> and <code>Mono</code> types. Project Reactor offers various adapters to convert reactive wrapper types (<code>Flux</code> to <code>Observable</code> and vice versa), but conversion can easily clutter your code.</p>
</div>
<div class="paragraph">
<p>Spring Data&#8217;s Repository abstraction is a dynamic API, mostly defined by you and your requirements as you declare query methods. Reactive MongoDB repositories can be implemented by using either RxJava or Project Reactor wrapper types by extending from one of the following library-specific repository interfaces:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>ReactiveCrudRepository</code></p>
</li>
<li>
<p><code>ReactiveSortingRepository</code></p>
</li>
<li>
<p><code>RxJava2CrudRepository</code></p>
</li>
<li>
<p><code>RxJava2SortingRepository</code></p>
</li>
<li>
<p><code>RxJava3CrudRepository</code></p>
</li>
<li>
<p><code>RxJava3SortingRepository</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Spring Data converts reactive wrapper types behind the scenes so that you can stick to your favorite composition library.</p>
</div>
</div>
<div class="sect2">
<h3 id="mongo.reactive.repositories.usage"><a class="anchor" href="index.html#mongo.reactive.repositories.usage"></a>16.2. Usage</h3>
<div class="paragraph">
<p>To access domain entities stored in a MongoDB database, you can use our sophisticated repository support that eases implementing those quite significantly. To do so, create an interface similar for your repository. Before you can do that, though, you need an entity, such as the entity defined in the following example:</p>
</div>
<div class="exampleblock">
<div class="title">Example 162. Sample <code>Person</code> entity</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">public class Person {

  @Id
  private String id;
  private String firstname;
  private String lastname;
  private Address address;

  // … getters and setters omitted
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Note that the entity defined in the preceding example has a property named <code>id</code> of type <code>String</code>. The default serialization mechanism used in <code>MongoTemplate</code> (which backs the repository support) regards properties named <code>id</code> as the document ID. Currently, we support <code>String</code>, <code>ObjectId</code>, and <code>BigInteger</code> as id-types.
Please see <a href="index.html#mongo-template.id-handling">ID mapping</a> for more information about on how the <code>id</code> field is handled in the mapping layer.</p>
</div>
<div class="paragraph">
<p>The following example shows how to create an interface that defines queries against the <code>Person</code> object from the preceding example:</p>
</div>
<div class="exampleblock">
<div class="title">Example 163. Basic repository interface to persist Person entities</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">public interface ReactivePersonRepository extends ReactiveSortingRepository&lt;Person, String&gt; {

  Flux&lt;Person&gt; findByFirstname(String firstname);                                   <i class="conum" data-value="1"></i><b>(1)</b>

  Flux&lt;Person&gt; findByFirstname(Publisher&lt;String&gt; firstname);                        <i class="conum" data-value="2"></i><b>(2)</b>

  Flux&lt;Person&gt; findByFirstnameOrderByLastname(String firstname, Pageable pageable); <i class="conum" data-value="3"></i><b>(3)</b>

  Mono&lt;Person&gt; findByFirstnameAndLastname(String firstname, String lastname);       <i class="conum" data-value="4"></i><b>(4)</b>

  Mono&lt;Person&gt; findFirstByLastname(String lastname);                                <i class="conum" data-value="5"></i><b>(5)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The method shows a query for all people with the given <code>lastname</code>. The query is derived by parsing the method name for constraints that can be concatenated with <code>And</code> and <code>Or</code>. Thus, the method name results in a query expression of <code>{"lastname" : lastname}</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The method shows a query for all people with the given <code>firstname</code> once the <code>firstname</code> is emitted by the given <code>Publisher</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Use <code>Pageable</code> to pass offset and sorting parameters to the database.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Find a single entity for the given criteria. It completes with <code>IncorrectResultSizeDataAccessException</code> on non-unique results.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Unless &lt;4&gt;, the first entity is always emitted even if the query yields more result documents.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>For Java configuration, use the <code>@EnableReactiveMongoRepositories</code> annotation. The annotation carries the same attributes as the namespace element. If no base package is configured, the infrastructure scans the package of the annotated configuration class.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
MongoDB uses two different drivers for imperative (synchronous/blocking) and reactive (non-blocking) data access. You must create a connection by using the Reactive Streams driver to provide the required infrastructure for Spring Data&#8217;s Reactive MongoDB support. Consequently, you must provide a separate configuration for MongoDB&#8217;s Reactive Streams driver. Note that your application operates on two different connections if you use reactive and blocking Spring Data MongoDB templates and repositories.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The following listing shows how to use Java configuration for a repository:</p>
</div>
<div class="exampleblock">
<div class="title">Example 164. Java configuration for repositories</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Configuration
@EnableReactiveMongoRepositories
class ApplicationConfig extends AbstractReactiveMongoConfiguration {

  @Override
  protected String getDatabaseName() {
    return "e-store";
  }

  @Override
  public MongoClient reactiveMongoClient() {
    return MongoClients.create();
  }

  @Override
  protected String getMappingBasePackage() {
    return "com.oreilly.springdata.mongodb";
  }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Because our domain repository extends <code>ReactiveSortingRepository</code>, it provides you with CRUD operations as well as methods for sorted access to the entities. Working with the repository instance is a matter of dependency injecting it into a client, as the following example shows:</p>
</div>
<div class="exampleblock">
<div class="title">Example 165. Sorted access to Person entities</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">public class PersonRepositoryTests {

    @Autowired ReactivePersonRepository repository;

    @Test
    public void sortsElementsCorrectly() {
      Flux&lt;Person&gt; persons = repository.findAll(Sort.by(new Order(ASC, "lastname")));
    }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
The <code>Page</code> return type (as in <code>Mono&lt;Page&gt;</code>) is not supported by reactive repositories.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>It is possible to use <code>Pageable</code> in derived finder methods, to pass on <code>sort</code>, <code>limit</code> and <code>offset</code> parameters to the query to reduce load and network traffic.
The returned <code>Flux</code> will only emit data within the declared range.</p>
</div>
<div class="exampleblock">
<div class="title">Example 166. Limit and Offset with reactive repositories</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">Pageable page = PageRequest.of(1, 10, Sort.by("lastname"));
Flux&lt;Person&gt; persons = repository.findByFirstnameOrderByLastname("luke", page);</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="mongo.reactive.repositories.features"><a class="anchor" href="index.html#mongo.reactive.repositories.features"></a>16.3. Features</h3>
<div class="paragraph">
<p>Spring Data&#8217;s Reactive MongoDB support comes with a reduced feature set compared to the blocking <a href="index.html#mongo.repositories">MongoDB Repositories</a>.</p>
</div>
<div class="paragraph">
<p>It supports the following features:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Query Methods using <a href="index.html#mongodb.repositories.queries">String queries and Query Derivation</a></p>
</li>
<li>
<p><a href="index.html#mongodb.reactive.repositories.queries.geo-spatial">Geo-spatial Repository Queries</a></p>
</li>
<li>
<p><a href="index.html#mongodb.repositories.queries.delete">Repository Delete Queries</a></p>
</li>
<li>
<p><a href="index.html#mongodb.repositories.queries.json-based">MongoDB JSON-based Query Methods and Field Restriction</a></p>
</li>
<li>
<p><a href="index.html#mongodb.repositories.queries.full-text">Full-text Search Queries</a></p>
</li>
<li>
<p><a href="index.html#mongodb.reactive.repositories.queries.type-safe">Type-safe Query Methods</a></p>
</li>
<li>
<p><a href="index.html#projections">Projections</a></p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="mongodb.reactive.repositories.queries.geo-spatial"><a class="anchor" href="index.html#mongodb.reactive.repositories.queries.geo-spatial"></a>16.3.1. Geo-spatial Repository Queries</h4>
<div class="paragraph">
<p>As you saw earlier in &#8220;<a href="index.html#mongodb.reactive.repositories.queries.geo-spatial">Geo-spatial Repository Queries</a>&#8221;, a few keywords trigger geo-spatial operations within a MongoDB query. The <code>Near</code> keyword allows some further modification, as the next few examples show.</p>
</div>
<div class="paragraph">
<p>The following example shows how to define a <code>near</code> query that finds all persons with a given distance of a given point:</p>
</div>
<div class="exampleblock">
<div class="title">Example 167. Advanced <code>Near</code> queries</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">public interface PersonRepository extends ReactiveMongoRepository&lt;Person, String&gt; {

  // { 'location' : { '$near' : [point.x, point.y], '$maxDistance' : distance}}
  Flux&lt;Person&gt; findByLocationNear(Point location, Distance distance);
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Adding a <code>Distance</code> parameter to the query method allows restricting results to those within the given distance. If the <code>Distance</code> was set up containing a <code>Metric</code>, we transparently use <code>$nearSphere</code> instead of <code>$code</code>, as the following example shows:</p>
</div>
<div class="exampleblock">
<div class="title">Example 168. Using <code>Distance</code> with <code>Metrics</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">Point point = new Point(43.7, 48.8);
Distance distance = new Distance(200, Metrics.KILOMETERS);
… = repository.findByLocationNear(point, distance);
// {'location' : {'$nearSphere' : [43.7, 48.8], '$maxDistance' : 0.03135711885774796}}</code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Reactive Geo-spatial repository queries support the domain type and <code>GeoResult&lt;T&gt;</code> results within a reactive wrapper type. <code>GeoPage</code> and <code>GeoResults</code> are not supported as they contradict the deferred result approach with pre-calculating the average distance. Howevery, you can still pass in a <code>Pageable</code> argument to page results yourself.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Using a <code>Distance</code> with a <code>Metric</code> causes a <code>$nearSphere</code> (instead of a plain <code>$near</code>) clause to be added. Beyond that, the actual distance gets calculated according to the <code>Metrics</code> used.</p>
</div>
<div class="paragraph">
<p>(Note that <code>Metric</code> does not refer to metric units of measure. It could be miles rather than kilometers. Rather, <code>metric</code> refers to the concept of a system of measurement, regardless of which system you use.)</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Using <code>@GeoSpatialIndexed(type = GeoSpatialIndexType.GEO_2DSPHERE)</code> on the target property forces usage of <code>$nearSphere</code> operator.
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5>Geo-near Queries</h5>
<div class="paragraph">
<p>Spring Data MongoDB supports geo-near queries, as the following example shows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">public interface PersonRepository extends ReactiveMongoRepository&lt;Person, String&gt;  {

  // {'geoNear' : 'location', 'near' : [x, y] }
  Flux&lt;GeoResult&lt;Person&gt;&gt; findByLocationNear(Point location);

  // No metric: {'geoNear' : 'person', 'near' : [x, y], maxDistance : distance }
  // Metric: {'geoNear' : 'person', 'near' : [x, y], 'maxDistance' : distance,
  //          'distanceMultiplier' : metric.multiplier, 'spherical' : true }
  Flux&lt;GeoResult&lt;Person&gt;&gt; findByLocationNear(Point location, Distance distance);

  // Metric: {'geoNear' : 'person', 'near' : [x, y], 'minDistance' : min,
  //          'maxDistance' : max, 'distanceMultiplier' : metric.multiplier,
  //          'spherical' : true }
  Flux&lt;GeoResult&lt;Person&gt;&gt; findByLocationNear(Point location, Distance min, Distance max);

  // {'geoNear' : 'location', 'near' : [x, y] }
  Flux&lt;GeoResult&lt;Person&gt;&gt; findByLocationNear(Point location);
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="mongodb.reactive.repositories.queries.type-safe"><a class="anchor" href="index.html#mongodb.reactive.repositories.queries.type-safe"></a>16.3.2. Type-safe Query Methods</h4>
<div class="paragraph">
<p>Reactive MongoDB repository support integrates with the <a href="http://www.querydsl.com/">Querydsl</a> project, which provides a way to perform type-safe queries.</p>
</div>
<div class="quoteblock">
<blockquote>
Instead of writing queries as inline strings or externalizing them into XML files they are constructed via a fluent API.
</blockquote>
<div class="attribution">
&#8212; Querydsl Team
</div>
</div>
<div class="paragraph">
<p>It provides the following features:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Code completion in the IDE (all properties, methods, and operations can be expanded in your favorite Java IDE).</p>
</li>
<li>
<p>Almost no syntactically invalid queries allowed (type-safe on all levels).</p>
</li>
<li>
<p>Domain types and properties can be referenced safely&#8201;&#8212;&#8201;no strings involved!</p>
</li>
<li>
<p>Adapts better to refactoring changes in domain types.</p>
</li>
<li>
<p>Incremental query definition is easier.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>See the <a href="http://www.querydsl.com/static/querydsl/latest/reference/html/">Querydsl documentation</a> for how to bootstrap your environment for APT-based code generation using Maven or Ant.</p>
</div>
<div class="paragraph">
<p>The Querydsl repository support lets you write and run queries, such as the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">QPerson person = QPerson.person;

Flux&lt;Person&gt; result = repository.findAll(person.address.zipCode.eq("C0123"));</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>QPerson</code> is a class that is generated by the Java annotation post-processing tool. It is a <code>Predicate</code> that lets you write type-safe queries.
Note that there are no strings in the query other than the <code>C0123</code> value.</p>
</div>
<div class="paragraph">
<p>You can use the generated <code>Predicate</code> class by using the <code>ReactiveQuerydslPredicateExecutor</code> interface, which the following listing shows:</p>
</div>
<div class="exampleblock">
<div class="title">Example 169. The Gateway to Reactive Querydsl - The ReactiveQuerydslPredicateExecutor</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">public interface ReactiveQuerydslPredicateExecutor&lt;T&gt; {

	Mono&lt;T&gt; findOne(Predicate predicate);

	Flux&lt;T&gt; findAll(Predicate predicate);

	Flux&lt;T&gt; findAll(Predicate predicate, Sort sort);

	Flux&lt;T&gt; findAll(Predicate predicate, OrderSpecifier&lt;?&gt;... orders);

	Flux&lt;T&gt; findAll(OrderSpecifier&lt;?&gt;... orders);

	Mono&lt;Long&gt; count(Predicate predicate);

	Mono&lt;Boolean&gt; exists(Predicate predicate);
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>To use this in your repository implementation, add it to the list of repository interfaces from which your interface inherits, as the following example shows:</p>
</div>
<div class="exampleblock">
<div class="title">Example 170. Reactive Querydsl Respository Declaration</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">public interface PersonRepository extends ReactiveMongoRepository&lt;Person, String&gt;, ReactiveQuerydslPredicateExecutor&lt;Person&gt; {

   // additional query methods go here
}</code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Please note that joins (DBRef&#8217;s) are not supported with Reactive MongoDB support.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="auditing"><a class="anchor" href="index.html#auditing"></a>17. Auditing</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="auditing.basics"><a class="anchor" href="index.html#auditing.basics"></a>17.1. Basics</h3>
<div class="paragraph">
<p>Spring Data provides sophisticated support to transparently keep track of who created or changed an entity and when the change happened. To benefit from that functionality, you have to equip your entity classes with auditing metadata that can be defined either using annotations or by implementing an interface.</p>
</div>
<div class="sect3">
<h4 id="auditing.annotations"><a class="anchor" href="index.html#auditing.annotations"></a>17.1.1. Annotation-based Auditing Metadata</h4>
<div class="paragraph">
<p>We provide <code>@CreatedBy</code> and <code>@LastModifiedBy</code> to capture the user who created or modified the entity as well as <code>@CreatedDate</code> and <code>@LastModifiedDate</code> to capture when the change happened.</p>
</div>
<div class="exampleblock">
<div class="title">Example 171. An audited entity</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">class Customer {

  @CreatedBy
  private User user;

  @CreatedDate
  private DateTime createdDate;

  // … further properties omitted
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>As you can see, the annotations can be applied selectively, depending on which information you want to capture. The annotations capturing when changes were made can be used on properties of type Joda-Time, <code>DateTime</code>, legacy Java <code>Date</code> and <code>Calendar</code>, JDK8 date and time types, and <code>long</code> or <code>Long</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="auditing.interfaces"><a class="anchor" href="index.html#auditing.interfaces"></a>17.1.2. Interface-based Auditing Metadata</h4>
<div class="paragraph">
<p>In case you do not want to use annotations to define auditing metadata, you can let your domain class implement the <code>Auditable</code> interface. It exposes setter methods for all of the auditing properties.</p>
</div>
<div class="paragraph">
<p>There is also a convenience base class, <code>AbstractAuditable</code>, which you can extend to avoid the need to manually implement the interface methods. Doing so increases the coupling of your domain classes to Spring Data, which might be something you want to avoid. Usually, the annotation-based way of defining auditing metadata is preferred as it is less invasive and more flexible.</p>
</div>
</div>
<div class="sect3">
<h4 id="auditing.auditor-aware"><a class="anchor" href="index.html#auditing.auditor-aware"></a>17.1.3. <code>AuditorAware</code></h4>
<div class="paragraph">
<p>In case you use either <code>@CreatedBy</code> or <code>@LastModifiedBy</code>, the auditing infrastructure somehow needs to become aware of the current principal. To do so, we provide an <code>AuditorAware&lt;T&gt;</code> SPI interface that you have to implement to tell the infrastructure who the current user or system interacting with the application is. The generic type <code>T</code> defines what type the properties annotated with <code>@CreatedBy</code> or <code>@LastModifiedBy</code> have to be.</p>
</div>
<div class="paragraph">
<p>The following example shows an implementation of the interface that uses Spring Security&#8217;s <code>Authentication</code> object:</p>
</div>
<div class="exampleblock">
<div class="title">Example 172. Implementation of <code>AuditorAware</code> based on Spring Security</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">class SpringSecurityAuditorAware implements AuditorAware&lt;User&gt; {

  @Override
  public Optional&lt;User&gt; getCurrentAuditor() {

    return Optional.ofNullable(SecurityContextHolder.getContext())
            .map(SecurityContext::getAuthentication)
            .filter(Authentication::isAuthenticated)
            .map(Authentication::getPrincipal)
            .map(User.class::cast);
  }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The implementation accesses the <code>Authentication</code> object provided by Spring Security and looks up the custom <code>UserDetails</code> instance that you have created in your <code>UserDetailsService</code> implementation. We assume here that you are exposing the domain user through the <code>UserDetails</code> implementation but that, based on the <code>Authentication</code> found, you could also look it up from anywhere.</p>
</div>
</div>
<div class="sect3">
<h4 id="auditing.reactive-auditor-aware"><a class="anchor" href="index.html#auditing.reactive-auditor-aware"></a>17.1.4. <code>ReactiveAuditorAware</code></h4>
<div class="paragraph">
<p>When using reactive infrastructure you might want to make use of contextual information to provide <code>@CreatedBy</code> or <code>@LastModifiedBy</code> information.
We provide an <code>ReactiveAuditorAware&lt;T&gt;</code> SPI interface that you have to implement to tell the infrastructure who the current user or system interacting with the application is. The generic type <code>T</code> defines what type the properties annotated with <code>@CreatedBy</code> or <code>@LastModifiedBy</code> have to be.</p>
</div>
<div class="paragraph">
<p>The following example shows an implementation of the interface that uses reactive Spring Security&#8217;s <code>Authentication</code> object:</p>
</div>
<div class="exampleblock">
<div class="title">Example 173. Implementation of <code>ReactiveAuditorAware</code> based on Spring Security</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">class SpringSecurityAuditorAware implements ReactiveAuditorAware&lt;User&gt; {

  @Override
  public Mono&lt;User&gt; getCurrentAuditor() {

    return ReactiveSecurityContextHolder.getContext()
                .map(SecurityContext::getAuthentication)
                .filter(Authentication::isAuthenticated)
                .map(Authentication::getPrincipal)
                .map(User.class::cast);
  }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The implementation accesses the <code>Authentication</code> object provided by Spring Security and looks up the custom <code>UserDetails</code> instance that you have created in your <code>UserDetailsService</code> implementation. We assume here that you are exposing the domain user through the <code>UserDetails</code> implementation but that, based on the <code>Authentication</code> found, you could also look it up from anywhere.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="mongo.auditing"><a class="anchor" href="index.html#mongo.auditing"></a>17.2. General Auditing Configuration for MongoDB</h3>
<div class="paragraph">
<p>Since Spring Data MongoDB 1.4, auditing can be enabled by annotating a configuration class with the <code>@EnableMongoAuditing</code> annotation, as the followign example shows:</p>
</div>
<div class="exampleblock">
<div class="title">Example 174. Activating auditing using JavaConfig</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Configuration
@EnableMongoAuditing
class Config {

  @Bean
  public AuditorAware&lt;AuditableUser&gt; myAuditorProvider() {
      return new AuditorAwareImpl();
  }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>If you expose a bean of type <code>AuditorAware</code> to the <code>ApplicationContext</code>, the auditing infrastructure picks it up automatically and uses it to determine the current user to be set on domain types. If you have multiple implementations registered in the <code>ApplicationContext</code>, you can select the one to be used by explicitly setting the <code>auditorAwareRef</code> attribute of <code>@EnableMongoAuditing</code>.</p>
</div>
<div class="paragraph">
<p>To activate auditing functionality via XML, add the Spring Data Mongo <code>auditing</code> namespace element to your configuration, as the following example shows:</p>
</div>
<div class="exampleblock">
<div class="title">Example 175. Activating auditing by using XML configuration</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;mongo:auditing mapping-context-ref="customMappingContext" auditor-aware-ref="yourAuditorAwareImpl"/&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>To enable auditing, leveraging a reactive programming model, use the <code>@EnableReactiveMongoAuditing</code> annotation.<br>
If you expose a bean of type <code>ReactiveAuditorAware</code> to the <code>ApplicationContext</code>, the auditing infrastructure picks it up automatically and uses it to determine the current user to be set on domain types. If you have multiple implementations registered in the <code>ApplicationContext</code>, you can select the one to be used by explicitly setting the <code>auditorAwareRef</code> attribute of <code>@EnableReactiveMongoAuditing</code>.</p>
</div>
<div class="exampleblock">
<div class="title">Example 176. Activating reactive auditing using JavaConfig</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Configuration
@EnableReactiveMongoAuditing
class Config {

  @Bean
  public ReactiveAuditorAware&lt;AuditableUser&gt; myAuditorProvider() {
      return new AuditorAwareImpl();
  }
}</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="mapping-chapter"><a class="anchor" href="index.html#mapping-chapter"></a>18. Mapping</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Rich mapping support is provided by the <code>MappingMongoConverter</code>. <code>MappingMongoConverter</code> has a rich metadata model that provides a full feature set to map domain objects to MongoDB documents. The mapping metadata model is populated by using annotations on your domain objects. However, the infrastructure is not limited to using annotations as the only source of metadata information. The <code>MappingMongoConverter</code> also lets you map objects to documents without providing any additional metadata, by following a set of conventions.</p>
</div>
<div class="paragraph">
<p>This section describes the features of the <code>MappingMongoConverter</code>, including fundamentals, how to use conventions for mapping objects to documents and how to override those conventions with annotation-based mapping metadata.</p>
</div>
<div class="sect2">
<h3 id="mapping.fundamentals"><a class="anchor" href="index.html#mapping.fundamentals"></a>18.1. Object Mapping Fundamentals</h3>
<div class="paragraph">
<p>This section covers the fundamentals of Spring Data object mapping, object creation, field and property access, mutability and immutability.
Note, that this section only applies to Spring Data modules that do not use the object mapping of the underlying data store (like JPA).
Also be sure to consult the store-specific sections for store-specific object mapping, like indexes, customizing column or field names or the like.</p>
</div>
<div class="paragraph">
<p>Core responsibility of the Spring Data object mapping is to create instances of domain objects and map the store-native data structures onto those.
This means we need two fundamental steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Instance creation by using one of the constructors exposed.</p>
</li>
<li>
<p>Instance population to materialize all exposed properties.</p>
</li>
</ol>
</div>
<div class="sect3">
<h4 id="mapping.object-creation"><a class="anchor" href="index.html#mapping.object-creation"></a>18.1.1. Object creation</h4>
<div class="paragraph">
<p>Spring Data automatically tries to detect a persistent entity&#8217;s constructor to be used to materialize objects of that type.
The resolution algorithm works as follows:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>If there&#8217;s a no-argument constructor, it will be used.
Other constructors will be ignored.</p>
</li>
<li>
<p>If there&#8217;s a single constructor taking arguments, it will be used.</p>
</li>
<li>
<p>If there are multiple constructors taking arguments, the one to be used by Spring Data will have to be annotated with <code>@PersistenceConstructor</code>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The value resolution assumes constructor argument names to match the property names of the entity, i.e. the resolution will be performed as if the property was to be populated, including all customizations in mapping (different datastore column or field name etc.).
This also requires either parameter names information available in the class file or an <code>@ConstructorProperties</code> annotation being present on the constructor.</p>
</div>
<div class="paragraph">
<p>The value resolution can be customized by using Spring Framework&#8217;s <code>@Value</code> value annotation using a store-specific SpEL expression.
Please consult the section on store specific mappings for further details.</p>
</div>
<div id="mapping.object-creation.details" class="sidebarblock">
<div class="content">
<div class="title">Object creation internals</div>
<div class="paragraph">
<p>To avoid the overhead of reflection, Spring Data object creation uses a factory class generated at runtime by default, which will call the domain classes constructor directly.
I.e. for this example type:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">class Person {
  Person(String firstname, String lastname) { … }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>we will create a factory class semantically equivalent to this one at runtime:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">class PersonObjectInstantiator implements ObjectInstantiator {

  Object newInstance(Object... args) {
    return new Person((String) args[0], (String) args[1]);
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This gives us a roundabout 10% performance boost over reflection.
For the domain class to be eligible for such optimization, it needs to adhere to a set of constraints:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>it must not be a private class</p>
</li>
<li>
<p>it must not be a non-static inner class</p>
</li>
<li>
<p>it must not be a CGLib proxy class</p>
</li>
<li>
<p>the constructor to be used by Spring Data must not be private</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If any of these criteria match, Spring Data will fall back to entity instantiation via reflection.</p>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="mapping.property-population"><a class="anchor" href="index.html#mapping.property-population"></a>18.1.2. Property population</h4>
<div class="paragraph">
<p>Once an instance of the entity has been created, Spring Data populates all remaining persistent properties of that class.
Unless already populated by the entity&#8217;s constructor (i.e. consumed through its constructor argument list), the identifier property will be populated first to allow the resolution of cyclic object references.
After that, all non-transient properties that have not already been populated by the constructor are set on the entity instance.
For that we use the following algorithm:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>If the property is immutable but exposes a <code>with…</code> method (see below), we use the <code>with…</code> method to create a new entity instance with the new property value.</p>
</li>
<li>
<p>If property access (i.e. access through getters and setters) is defined, we&#8217;re invoking the setter method.</p>
</li>
<li>
<p>If the property is mutable we set the field directly.</p>
</li>
<li>
<p>If the property is immutable we&#8217;re using the constructor to be used by persistence operations (see <a href="index.html#mapping.object-creation">Object creation</a>) to create a copy of the instance.</p>
</li>
<li>
<p>By default, we set the field value directly.</p>
</li>
</ol>
</div>
<div id="mapping.property-population.details" class="sidebarblock">
<div class="content">
<div class="title">Property population internals</div>
<div class="paragraph">
<p>Similarly to our <a href="index.html#mapping.object-creation.details">optimizations in object construction</a> we also use Spring Data runtime generated accessor classes to interact with the entity instance.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">class Person {

  private final Long id;
  private String firstname;
  private @AccessType(Type.PROPERTY) String lastname;

  Person() {
    this.id = null;
  }

  Person(Long id, String firstname, String lastname) {
    // Field assignments
  }

  Person withId(Long id) {
    return new Person(id, this.firstname, this.lastame);
  }

  void setLastname(String lastname) {
    this.lastname = lastname;
  }
}</code></pre>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 177. A generated Property Accessor</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">class PersonPropertyAccessor implements PersistentPropertyAccessor {

  private static final MethodHandle firstname;              <i class="conum" data-value="2"></i><b>(2)</b>

  private Person person;                                    <i class="conum" data-value="1"></i><b>(1)</b>

  public void setProperty(PersistentProperty property, Object value) {

    String name = property.getName();

    if ("firstname".equals(name)) {
      firstname.invoke(person, (String) value);             <i class="conum" data-value="2"></i><b>(2)</b>
    } else if ("id".equals(name)) {
      this.person = person.withId((Long) value);            <i class="conum" data-value="3"></i><b>(3)</b>
    } else if ("lastname".equals(name)) {
      this.person.setLastname((String) value);              <i class="conum" data-value="4"></i><b>(4)</b>
    }
  }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>PropertyAccessor&#8217;s hold a mutable instance of the underlying object. This is, to enable mutations of otherwise immutable properties.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>By default, Spring Data uses field-access to read and write property values. As per visibility rules of <code>private</code> fields, <code>MethodHandles</code> are used to interact with fields.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The class exposes a <code>withId(…)</code> method that&#8217;s used to set the identifier, e.g. when an instance is inserted into the datastore and an identifier has been generated. Calling <code>withId(…)</code> creates a new <code>Person</code> object. All subsequent mutations will take place in the new instance leaving the previous untouched.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Using property-access allows direct method invocations without using <code>MethodHandles</code>.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>This gives us a roundabout 25% performance boost over reflection.
For the domain class to be eligible for such optimization, it needs to adhere to a set of constraints:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Types must not reside in the default or under the <code>java</code> package.</p>
</li>
<li>
<p>Types and their constructors must be <code>public</code></p>
</li>
<li>
<p>Types that are inner classes must be <code>static</code>.</p>
</li>
<li>
<p>The used Java Runtime must allow for declaring classes in the originating <code>ClassLoader</code>. Java 9 and newer impose certain limitations.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>By default, Spring Data attempts to use generated property accessors and falls back to reflection-based ones if a limitation is detected.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s have a look at the following entity:</p>
</div>
<div class="exampleblock">
<div class="title">Example 178. A sample entity</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">class Person {

  private final @Id Long id;                                                <i class="conum" data-value="1"></i><b>(1)</b>
  private final String firstname, lastname;                                 <i class="conum" data-value="2"></i><b>(2)</b>
  private final LocalDate birthday;
  private final int age;                                                    <i class="conum" data-value="3"></i><b>(3)</b>

  private String comment;                                                   <i class="conum" data-value="4"></i><b>(4)</b>
  private @AccessType(Type.PROPERTY) String remarks;                        <i class="conum" data-value="5"></i><b>(5)</b>

  static Person of(String firstname, String lastname, LocalDate birthday) { <i class="conum" data-value="6"></i><b>(6)</b>

    return new Person(null, firstname, lastname, birthday,
      Period.between(birthday, LocalDate.now()).getYears());
  }

  Person(Long id, String firstname, String lastname, LocalDate birthday, int age) { <i class="conum" data-value="6"></i><b>(6)</b>

    this.id = id;
    this.firstname = firstname;
    this.lastname = lastname;
    this.birthday = birthday;
    this.age = age;
  }

  Person withId(Long id) {                                                  <i class="conum" data-value="1"></i><b>(1)</b>
    return new Person(id, this.firstname, this.lastname, this.birthday, this.age);
  }

  void setRemarks(String remarks) {                                         <i class="conum" data-value="5"></i><b>(5)</b>
    this.remarks = remarks;
  }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The identifier property is final but set to <code>null</code> in the constructor.
The class exposes a <code>withId(…)</code> method that&#8217;s used to set the identifier, e.g. when an instance is inserted into the datastore and an identifier has been generated.
The original <code>Person</code> instance stays unchanged as a new one is created.
The same pattern is usually applied for other properties that are store managed but might have to be changed for persistence operations.
The wither method is optional as the persistence constructor (see 6) is effectively a copy constructor and setting the property will be translated into creating a fresh instance with the new identifier value applied.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The <code>firstname</code> and <code>lastname</code> properties are ordinary immutable properties potentially exposed through getters.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The <code>age</code> property is an immutable but derived one from the <code>birthday</code> property.
With the design shown, the database value will trump the defaulting as Spring Data uses the only declared constructor.
Even if the intent is that the calculation should be preferred, it&#8217;s important that this constructor also takes <code>age</code> as parameter (to potentially ignore it) as otherwise the property population step will attempt to set the age field and fail due to it being immutable and no <code>with…</code> method being present.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The <code>comment</code> property is mutable is populated by setting its field directly.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>The <code>remarks</code> properties are mutable and populated by setting the <code>comment</code> field directly or by invoking the setter method for</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>The class exposes a factory method and a constructor for object creation.
The core idea here is to use factory methods instead of additional constructors to avoid the need for constructor disambiguation through <code>@PersistenceConstructor</code>.
Instead, defaulting of properties is handled within the factory method.</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="mapping.general-recommendations"><a class="anchor" href="index.html#mapping.general-recommendations"></a>18.1.3. General recommendations</h4>
<div class="ulist">
<ul>
<li>
<p><em>Try to stick to immutable objects</em>&#8201;&#8212;&#8201;Immutable objects are straightforward to create as materializing an object is then a matter of calling its constructor only.
Also, this avoids your domain objects to be littered with setter methods that allow client code to manipulate the objects state.
If you need those, prefer to make them package protected so that they can only be invoked by a limited amount of co-located types.
Constructor-only materialization is up to 30% faster than properties population.</p>
</li>
<li>
<p><em>Provide an all-args constructor</em>&#8201;&#8212;&#8201;Even if you cannot or don&#8217;t want to model your entities as immutable values, there&#8217;s still value in providing a constructor that takes all properties of the entity as arguments, including the mutable ones, as this allows the object mapping to skip the property population for optimal performance.</p>
</li>
<li>
<p><em>Use factory methods instead of overloaded constructors to avoid <code>@PersistenceConstructor</code></em>&#8201;&#8212;&#8201;With an all-argument constructor needed for optimal performance, we usually want to expose more application use case specific constructors that omit things like auto-generated identifiers etc.
It&#8217;s an established pattern to rather use static factory methods to expose these variants of the all-args constructor.</p>
</li>
<li>
<p><em>Make sure you adhere to the constraints that allow the generated instantiator and property accessor classes to be used</em>&#8201;&#8212;&#8201;</p>
</li>
<li>
<p><em>For identifiers to be generated, still use a final field in combination with an all-arguments persistence constructor (preferred) or a <code>with…</code> method</em>&#8201;&#8212;&#8201;</p>
</li>
<li>
<p><em>Use Lombok to avoid boilerplate code</em>&#8201;&#8212;&#8201;As persistence operations usually require a constructor taking all arguments, their declaration becomes a tedious repetition of boilerplate parameter to field assignments that can best be avoided by using Lombok&#8217;s <code>@AllArgsConstructor</code>.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="mapping.kotlin"><a class="anchor" href="index.html#mapping.kotlin"></a>18.1.4. Kotlin support</h4>
<div class="paragraph">
<p>Spring Data adapts specifics of Kotlin to allow object creation and mutation.</p>
</div>
<div class="sect4">
<h5>Kotlin object creation</h5>
<div class="paragraph">
<p>Kotlin classes are supported to be instantiated , all classes are immutable by default and require explicit property declarations to define mutable properties.
Consider the following <code>data</code> class <code>Person</code>:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="kotlin" class="language-kotlin hljs">data class Person(val id: String, val name: String)</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The class above compiles to a typical class with an explicit constructor.We can customize this class by adding another constructor and annotate it with <code>@PersistenceConstructor</code> to indicate a constructor preference:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="kotlin" class="language-kotlin hljs">data class Person(var id: String, val name: String) {

    @PersistenceConstructor
    constructor(id: String) : this(id, "unknown")
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Kotlin supports parameter optionality by allowing default values to be used if a parameter is not provided.
When Spring Data detects a constructor with parameter defaulting, then it leaves these parameters absent if the data store does not provide a value (or simply returns <code>null</code>) so Kotlin can apply parameter defaulting.Consider the following class that applies parameter defaulting for <code>name</code></p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="kotlin" class="language-kotlin hljs">data class Person(var id: String, val name: String = "unknown")</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Every time the <code>name</code> parameter is either not part of the result or its value is <code>null</code>, then the <code>name</code> defaults to <code>unknown</code>.</p>
</div>
</div>
<div class="sect4">
<h5>Property population of Kotlin data classes</h5>
<div class="paragraph">
<p>In Kotlin, all classes are immutable by default and require explicit property declarations to define mutable properties.
Consider the following <code>data</code> class <code>Person</code>:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="kotlin" class="language-kotlin hljs">data class Person(val id: String, val name: String)</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>This class is effectively immutable.
It allows creating new instances as Kotlin generates a <code>copy(…)</code> method that creates new object instances copying all property values from the existing object and applying property values provided as arguments to the method.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="mapping-conventions"><a class="anchor" href="index.html#mapping-conventions"></a>18.2. Convention-based Mapping</h3>
<div class="paragraph">
<p><code>MappingMongoConverter</code> has a few conventions for mapping objects to documents when no additional mapping metadata is provided. The conventions are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The short Java class name is mapped to the collection name in the following manner. The class <code>com.bigbank.SavingsAccount</code> maps to the <code>savingsAccount</code> collection name.</p>
</li>
<li>
<p>All nested objects are stored as nested objects in the document and <strong>not</strong> as DBRefs.</p>
</li>
<li>
<p>The converter uses any Spring Converters registered with it to override the default mapping of object properties to document fields and values.</p>
</li>
<li>
<p>The fields of an object are used to convert to and from fields in the document. Public <code>JavaBean</code> properties are not used.</p>
</li>
<li>
<p>If you have a single non-zero-argument constructor whose constructor argument names match top-level field names of document, that constructor is used. Otherwise, the zero-argument constructor is used. If there is more than one non-zero-argument constructor, an exception will be thrown.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="mapping.conventions.id-field"><a class="anchor" href="index.html#mapping.conventions.id-field"></a>18.2.1. How the <code>_id</code> field is handled in the mapping layer.</h4>
<div class="paragraph">
<p>MongoDB requires that you have an <code>_id</code> field for all documents. If you don&#8217;t provide one the driver will assign a ObjectId with a generated value. The "_id" field can be of any type the, other than arrays, so long as it is unique. The driver naturally supports all primitive types and Dates. When using the <code>MappingMongoConverter</code> there are certain rules that govern how properties from the Java class is mapped to this <code>_id</code> field.</p>
</div>
<div class="paragraph">
<p>The following outlines what field will be mapped to the <code>_id</code> document field:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A field annotated with <code>@Id</code> (<code>org.springframework.data.annotation.Id</code>) will be mapped to the <code>_id</code> field.</p>
</li>
<li>
<p>A field without an annotation but named <code>id</code> will be mapped to the <code>_id</code> field.</p>
</li>
<li>
<p>The default field name for identifiers is <code>_id</code> and can be customized via the <code>@Field</code> annotation.</p>
</li>
</ul>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 17. Examples for the translation of <code>_id</code> field definitions</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field definition</th>
<th class="tableblock halign-left valign-top">Resulting Id-Fieldname in MongoDB</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>String</code> id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>_id</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@Field</code> <code>String</code> id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>_id</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@Field("x")</code> <code>String</code> id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>x</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@Id</code> <code>String</code> x</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>_id</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@Field("x")</code> <code>@Id</code> <code>String</code> x</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>_id</code></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The following outlines what type conversion, if any, will be done on the property mapped to the _id document field.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If a field named <code>id</code> is declared as a String or BigInteger in the Java class it will be converted to and stored as an ObjectId if possible. ObjectId as a field type is also valid. If you specify a value for <code>id</code> in your application, the conversion to an ObjectId is detected to the MongoDB driver. If the specified <code>id</code> value cannot be converted to an ObjectId, then the value will be stored as is in the document&#8217;s _id field. This also applies if the field is annotated with <code>@Id</code>.</p>
</li>
<li>
<p>If a field is annotated with <code>@MongoId</code> in the Java class it will be converted to and stored as using its actual type. No further conversion happens unless <code>@MongoId</code> declares a desired field type.</p>
</li>
<li>
<p>If a field is annotated with <code>@MongoId(FieldType.…)</code> in the Java class it will be attempted to convert the value to the declared <code>FieldType.</code></p>
</li>
<li>
<p>If a field named <code>id</code> id field is not declared as a String, BigInteger, or ObjectID in the Java class then you should assign it a value in your application so it can be stored 'as-is' in the document&#8217;s _id field.</p>
</li>
<li>
<p>If no field named <code>id</code> is present in the Java class then an implicit <code>_id</code> file will be generated by the driver but not mapped to a property or field of the Java class.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>When querying and updating <code>MongoTemplate</code> will use the converter to handle conversions of the <code>Query</code> and <code>Update</code> objects that correspond to the above rules for saving documents so field names and types used in your queries will be able to match what is in your domain classes.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="mapping-conversion"><a class="anchor" href="index.html#mapping-conversion"></a>18.3. Data Mapping and Type Conversion</h3>
<div class="paragraph">
<p>This section explains how types are mapped to and from a MongoDB representation. Spring Data MongoDB supports all types that can be represented as BSON, MongoDB&#8217;s internal document format.
In addition to these types, Spring Data MongoDB provides a set of built-in converters to map additional types. You can provide your own converters to adjust type conversion. See <a href="index.html#mapping-explicit-converters">[mapping-explicit-converters]</a> for further details.</p>
</div>
<div class="paragraph">
<p>The following provides samples of each available type conversion:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 18. Type</caption>
<colgroup>
<col style="width: 30%;">
<col style="width: 10%;">
<col style="width: 60%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Type conversion</th>
<th class="tableblock halign-left valign-top">Sample</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>String</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">native</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"firstname" : "Dave"}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>double</code>, <code>Double</code>, <code>float</code>, <code>Float</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">native</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"weight" : 42.5}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>int</code>, <code>Integer</code>, <code>short</code>, <code>Short</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">native<br>
32-bit integer</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"height" : 42}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>long</code>, <code>Long</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">native<br>
64-bit integer</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"height" : 42}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Date</code>, <code>Timestamp</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">native</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"date" : ISODate("2019-11-12T23:00:00.809Z")}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>byte[]</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">native</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"bin" : { "$binary" : "AQIDBA==", "$type" : "00" }}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.util.UUID</code> (Legacy UUID)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">native</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"uuid" : { "$binary" : "MEaf1CFQ6lSphaa3b9AtlA==", "$type" : "03" }}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Date</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">native</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"date" : ISODate("2019-11-12T23:00:00.809Z")}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ObjectId</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">native</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"_id" : ObjectId("5707a2690364aba3136ab870")}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Array, <code>List</code>, <code>BasicDBList</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">native</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"cookies" : [ … ]}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>boolean</code>, <code>Boolean</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">native</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"active" : true}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>null</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">native</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"value" : null}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Document</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">native</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"value" : { … }}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Decimal128</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">native</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"value" : NumberDecimal(…)}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>AtomicInteger</code><br>
calling <code>get()</code> before the actual conversion</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">converter<br>
32-bit integer</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"value" : "741" }</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>AtomicLong</code><br>
calling <code>get()</code> before the actual conversion</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">converter<br>
64-bit integer</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"value" : "741" }</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>BigInteger</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">converter<br>
<code>String</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"value" : "741" }</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>BigDecimal</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">converter<br>
<code>String</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"value" : "741.99" }</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>URL</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">converter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"website" : "https://projects.spring.io/spring-data-mongodb/" }</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Locale</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">converter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"locale : "en_US" }</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>char</code>, <code>Character</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">converter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"char" : "a" }</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>NamedMongoScript</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">converter<br>
<code>Code</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"_id" : "script name", value: (some javascript code)</code>}</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.util.Currency</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">converter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"currencyCode" : "EUR"}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Instant</code><br>
(Java 8)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">native</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"date" : ISODate("2019-11-12T23:00:00.809Z")}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Instant</code><br>
(Joda, JSR310-BackPort)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">converter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"date" : ISODate("2019-11-12T23:00:00.809Z")}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>LocalDate</code><br>
(Joda, Java 8, JSR310-BackPort)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">converter / native (Java8)<sup class="footnote">[<a id="_footnoteref_2" class="footnote" href="index.html#_footnotedef_2" title="View footnote.">2</a>]</sup></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"date" : ISODate("2019-11-12T00:00:00.000Z")}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>LocalDateTime</code>, <code>LocalTime</code><br>
(Joda, Java 8, JSR310-BackPort)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">converter / native (Java8)<sup class="footnote">[<a id="_footnoteref_3" class="footnote" href="index.html#_footnotedef_3" title="View footnote.">3</a>]</sup></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"date" : ISODate("2019-11-12T23:00:00.809Z")}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>DateTime</code> (Joda)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">converter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"date" : ISODate("2019-11-12T23:00:00.809Z")}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ZoneId</code> (Java 8, JSR310-BackPort)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">converter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"zoneId" : "ECT - Europe/Paris"}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Box</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">converter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"box" : { "first" : { "x" : 1.0 , "y" : 2.0} , "second" : { "x" : 3.0 , "y" : 4.0}}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Polygon</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">converter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"polygon" : { "points" : [ { "x" : 1.0 , "y" : 2.0} , { "x" : 3.0 , "y" : 4.0} , { "x" : 4.0 , "y" : 5.0}]}}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Circle</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">converter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"circle" : { "center" : { "x" : 1.0 , "y" : 2.0} , "radius" : 3.0 , "metric" : "NEUTRAL"}}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Point</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">converter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"point" : { "x" : 1.0 , "y" : 2.0}}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>GeoJsonPoint</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">converter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"point" : { "type" : "Point" , "coordinates" : [3.0 , 4.0] }}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>GeoJsonMultiPoint</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">converter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"geoJsonLineString" : {"type":"MultiPoint", "coordinates": [ [ 0 , 0 ], [ 0 , 1 ], [ 1 , 1 ] ] }}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Sphere</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">converter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"sphere" : { "center" : { "x" : 1.0 , "y" : 2.0} , "radius" : 3.0 , "metric" : "NEUTRAL"}}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>GeoJsonPolygon</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">converter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"polygon" : { "type" : "Polygon", "coordinates" : [[ [ 0 , 0 ], [ 3 , 6 ], [ 6 , 1 ], [ 0 , 0 ] ]] }}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>GeoJsonMultiPolygon</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">converter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"geoJsonMultiPolygon" : { "type" : "MultiPolygon", "coordinates" : [
[ [ [ -73.958 , 40.8003 ] , [ -73.9498 , 40.7968 ] ] ],
[ [ [ -73.973 , 40.7648 ] , [ -73.9588 , 40.8003 ] ] ]
] }}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>GeoJsonLineString</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">converter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{ "geoJsonLineString" : { "type" : "LineString", "coordinates" : [ [ 40 , 5 ], [ 41 , 6 ] ] }}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>GeoJsonMultiLineString</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">converter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{"geoJsonLineString" : { "type" : "MultiLineString", coordinates: [
[ [ -73.97162 , 40.78205 ], [ -73.96374 , 40.77715 ] ],
[ [ -73.97880 , 40.77247 ], [ -73.97036 , 40.76811 ] ]
] }}</code></p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="mapping-configuration"><a class="anchor" href="index.html#mapping-configuration"></a>18.4. Mapping Configuration</h3>
<div class="paragraph">
<p>Unless explicitly configured, an instance of <code>MappingMongoConverter</code> is created by default when you create a <code>MongoTemplate</code>. You can create your own instance of the <code>MappingMongoConverter</code>. Doing so lets you dictate where in the classpath your domain classes can be found, so that Spring Data MongoDB can extract metadata and construct indexes. Also, by creating your own instance, you can register Spring converters to map specific classes to and from the database.</p>
</div>
<div class="paragraph">
<p>You can configure the <code>MappingMongoConverter</code> as well as <code>com.mongodb.client.MongoClient</code> and MongoTemplate by using either Java-based or XML-based metadata. The following example uses Spring&#8217;s Java-based configuration:</p>
</div>
<div class="exampleblock">
<div class="title">Example 179. @Configuration class to configure MongoDB mapping support</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Configuration
public class MongoConfig extends AbstractMongoClientConfiguration {

  @Override
  public String getDatabaseName() {
    return "database";
  }

  // the following are optional

  @Override
  public String getMappingBasePackage() { <i class="conum" data-value="1"></i><b>(1)</b>
    return "com.bigbank.domain";
  }

  @Override
  void configureConverters(MongoConverterConfigurationAdapter adapter) { <i class="conum" data-value="2"></i><b>(2)</b>

  	adapter.registerConverter(new org.springframework.data.mongodb.test.PersonReadConverter());
  	adapter.registerConverter(new org.springframework.data.mongodb.test.PersonWriteConverter());
  }

  @Bean
  public LoggingEventListener&lt;MongoMappingEvent&gt; mappingEventsListener() {
    return new LoggingEventListener&lt;MongoMappingEvent&gt;();
  }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The mapping base package defines the root path used to scan for entities used to pre initialize the <code>MappingContext</code>. By default the configuration classes package is used.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Configure additional custom converters for specific domain types that replace the default mapping procedure for those types with your custom implementation.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p><code>AbstractMongoClientConfiguration</code> requires you to implement methods that define a <code>com.mongodb.client.MongoClient</code> as well as provide a database name. <code>AbstractMongoClientConfiguration</code> also has a method named <code>getMappingBasePackage(…)</code> that you can override to tell the converter where to scan for classes annotated with the <code>@Document</code> annotation.</p>
</div>
<div class="paragraph">
<p>You can add additional converters to the converter by overriding the <code>customConversionsConfiguration</code> method.
MongoDB&#8217;s native JSR-310 support can be enabled through <code>MongoConverterConfigurationAdapter.useNativeDriverJavaTimeCodecs()</code>.
Also shown in the preceding example is a <code>LoggingEventListener</code>, which logs <code>MongoMappingEvent</code> instances that are posted onto Spring&#8217;s <code>ApplicationContextEvent</code> infrastructure.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<code>AbstractMongoClientConfiguration</code> creates a <code>MongoTemplate</code> instance and registers it with the container under the name <code>mongoTemplate</code>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Spring&#8217;s MongoDB namespace lets you enable mapping functionality in XML, as the following example shows:</p>
</div>
<div class="exampleblock">
<div class="title">Example 180. XML schema to configure MongoDB mapping support</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;beans xmlns="http://www.springframework.org/schema/beans"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xmlns:mongo="http://www.springframework.org/schema/data/mongo"
  xsi:schemaLocation="
    http://www.springframework.org/schema/data/mongo https://www.springframework.org/schema/data/mongo/spring-mongo.xsd
    http://www.springframework.org/schema/beans https://www.springframework.org/schema/beans/spring-beans-3.0.xsd"&gt;

  &lt;!-- Default bean name is 'mongo' --&gt;
  &lt;mongo:mongo-client host="localhost" port="27017"/&gt;

  &lt;mongo:db-factory dbname="database" mongo-ref="mongoClient"/&gt;

  &lt;!-- by default look for a Mongo object named 'mongo' - default name used for the converter is 'mappingConverter' --&gt;
  &lt;mongo:mapping-converter base-package="com.bigbank.domain"&gt;
    &lt;mongo:custom-converters&gt;
      &lt;mongo:converter ref="readConverter"/&gt;
      &lt;mongo:converter&gt;
        &lt;bean class="org.springframework.data.mongodb.test.PersonWriteConverter"/&gt;
      &lt;/mongo:converter&gt;
    &lt;/mongo:custom-converters&gt;
  &lt;/mongo:mapping-converter&gt;

  &lt;bean id="readConverter" class="org.springframework.data.mongodb.test.PersonReadConverter"/&gt;

  &lt;!-- set the mapping converter to be used by the MongoTemplate --&gt;
  &lt;bean id="mongoTemplate" class="org.springframework.data.mongodb.core.MongoTemplate"&gt;
    &lt;constructor-arg name="mongoDbFactory" ref="mongoDbFactory"/&gt;
    &lt;constructor-arg name="mongoConverter" ref="mappingConverter"/&gt;
  &lt;/bean&gt;

  &lt;bean class="org.springframework.data.mongodb.core.mapping.event.LoggingEventListener"/&gt;

&lt;/beans&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The <code>base-package</code> property tells it where to scan for classes annotated with the <code>@org.springframework.data.mongodb.core.mapping.Document</code> annotation.</p>
</div>
</div>
<div class="sect2">
<h3 id="mapping-usage"><a class="anchor" href="index.html#mapping-usage"></a>18.5. Metadata-based Mapping</h3>
<div class="paragraph">
<p>To take full advantage of the object mapping functionality inside the Spring Data MongoDB support, you should annotate your mapped objects with the <code>@Document</code> annotation. Although it is not necessary for the mapping framework to have this annotation (your POJOs are mapped correctly, even without any annotations), it lets the classpath scanner find and pre-process your domain objects to extract the necessary metadata. If you do not use this annotation, your application takes a slight performance hit the first time you store a domain object, because the mapping framework needs to build up its internal metadata model so that it knows about the properties of your domain object and how to persist them. The following example shows a domain object:</p>
</div>
<div class="exampleblock">
<div class="title">Example 181. Example domain object</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">package com.mycompany.domain;

@Document
public class Person {

  @Id
  private ObjectId id;

  @Indexed
  private Integer ssn;

  private String firstName;

  @Indexed
  private String lastName;
}</code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
The <code>@Id</code> annotation tells the mapper which property you want to use for the MongoDB <code>_id</code> property, and the <code>@Indexed</code> annotation tells the mapping framework to call <code>createIndex(…)</code> on that property of your document, making searches faster.
Automatic index creation is only done for types annotated with <code>@Document</code>.
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Auto index creation is <strong>disabled</strong> by default and needs to be enabled through the configuration (see <a href="index.html#mapping.index-creation">Index Creation</a>).
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="mapping.index-creation"><a class="anchor" href="index.html#mapping.index-creation"></a>18.5.1. Index Creation</h4>
<div class="paragraph">
<p>Spring Data MongoDB can automatically create indexes for entity types annotated with <code>@Document</code>.
Index creation must be explicitly enabled since version 3.0 to prevent undesired effects with collection lifecyle and performance impact.
Indexes are automatically created for the initial entity set on application startup and when accessing an entity type for the first time while the application runs.</p>
</div>
<div class="paragraph">
<p>We generally recommend explicit index creation for application-based control of indexes as Spring Data cannot automatically create indexes for collections that were recreated while the application was running.</p>
</div>
<div class="paragraph">
<p><code>IndexResolver</code> provides an abstraction for programmatic index definition creation if you want to make use of <code>@Indexed</code> annotations such as <code>@GeoSpatialIndexed</code>, <code>@TextIndexed</code>, <code>@CompoundIndex</code>.
You can use index definitions with <code>IndexOperations</code> to create indexes.
A good point in time for index creation is on application startup, specifically after the application context was refreshed, triggered by observing <code>ContextRefreshedEvent</code>.
This event guarantees that the context is fully initialized.
Note that at this time other components, especially bean factories might have access to the MongoDB database.</p>
</div>
<div class="exampleblock">
<div class="title">Example 182. Programmatic Index Creation for a single Domain Type</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">class MyListener {

  @EventListener(ContextRefreshedEvent.class)
  public void initIndicesAfterStartup() {

    MappingContext&lt;? extends MongoPersistentEntity&lt;?&gt;, MongoPersistentProperty&gt; mappingContext = mongoTemplate
                .getConverter().getMappingContext();

    IndexResolver resolver = new MongoPersistentEntityIndexResolver(mappingContext);

    IndexOperations indexOps = mongoTemplate.indexOps(DomainType.class);
    resolver.resolveIndexFor(DomainType.class).forEach(indexOps::ensureIndex);
  }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 183. Programmatic Index Creation for all Initial Entities</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">class MyListener{

  @EventListener(ContextRefreshedEvent.class)
  public void initIndicesAfterStartup() {

    MappingContext&lt;? extends MongoPersistentEntity&lt;?&gt;, MongoPersistentProperty&gt; mappingContext = mongoTemplate
        .getConverter().getMappingContext();

    // consider only entities that are annotated with @Document
    mappingContext.getPersistentEntities()
                            .stream()
                            .filter(it -&gt; it.isAnnotationPresent(Document.class))
                            .forEach(it -&gt; {

    IndexOperations indexOps = mongoTemplate.indexOps(it.getType());
    resolver.resolveIndexFor(it.getType()).forEach(indexOps::ensureIndex);
    });
  }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Alternatively, if you want to ensure index and collection presence before any component is able to access your database from your application, declare a <code>@Bean</code> method for <code>MongoTemplate</code> and include the code from above before returning the <code>MongoTemplate</code> object.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>To turn automatic index creation <em>ON</em> please override <code>autoIndexCreation()</code> in your configuration.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Configuration
public class Config extends AbstractMongoClientConfiguration {

  @Override
  public boolean autoIndexCreation() {
    return true;
  }

// ...
}</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Automatic index creation is turned <em>OFF</em> by default as of version 3.0.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="mapping-usage-annotations"><a class="anchor" href="index.html#mapping-usage-annotations"></a>18.5.2. Mapping Annotation Overview</h4>
<div class="paragraph">
<p>The MappingMongoConverter can use metadata to drive the mapping of objects to documents. The following annotations are available:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>@Id</code>: Applied at the field level to mark the field used for identity purpose.</p>
</li>
<li>
<p><code>@MongoId</code>: Applied at the field level to mark the field used for identity purpose. Accepts an optional <code>FieldType</code> to customize id conversion.</p>
</li>
<li>
<p><code>@Document</code>: Applied at the class level to indicate this class is a candidate for mapping to the database. You can specify the name of the collection where the data will be stored.</p>
</li>
<li>
<p><code>@DBRef</code>: Applied at the field to indicate it is to be stored using a com.mongodb.DBRef.</p>
</li>
<li>
<p><code>@Indexed</code>: Applied at the field level to describe how to index the field.</p>
</li>
<li>
<p><code>@CompoundIndex</code> (repeatable): Applied at the type level to declare Compound Indexes.</p>
</li>
<li>
<p><code>@GeoSpatialIndexed</code>: Applied at the field level to describe how to geoindex the field.</p>
</li>
<li>
<p><code>@TextIndexed</code>: Applied at the field level to mark the field to be included in the text index.</p>
</li>
<li>
<p><code>@HashIndexed</code>: Applied at the field level for usage within a hashed index to partition data across a sharded cluster.</p>
</li>
<li>
<p><code>@Language</code>: Applied at the field level to set the language override property for text index.</p>
</li>
<li>
<p><code>@Transient</code>: By default, all fields are mapped to the document. This annotation excludes the field where it is applied from being stored in the database. Transient properties cannot be used within a persistence constructor as the converter cannot materialize a value for the constructor argument.</p>
</li>
<li>
<p><code>@PersistenceConstructor</code>: Marks a given constructor - even a package protected one - to use when instantiating the object from the database. Constructor arguments are mapped by name to the key values in the retrieved Document.</p>
</li>
<li>
<p><code>@Value</code>: This annotation is part of the Spring Framework . Within the mapping framework it can be applied to constructor arguments. This lets you use a Spring Expression Language statement to transform a key&#8217;s value retrieved in the database before it is used to construct a domain object. In order to reference a property of a given document one has to use expressions like: <code>@Value("#root.myProperty")</code> where <code>root</code> refers to the root of the given document.</p>
</li>
<li>
<p><code>@Field</code>: Applied at the field level it allows to describe the name and type of the field as it will be represented in the MongoDB BSON document thus allowing the name and type to be different than the fieldname of the class as well as the property type.</p>
</li>
<li>
<p><code>@Version</code>: Applied at field level is used for optimistic locking and checked for modification on save operations. The initial value is <code>zero</code> (<code>one</code> for primitive types) which is bumped automatically on every update.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The mapping metadata infrastructure is defined in a separate spring-data-commons project that is technology agnostic. Specific subclasses are using in the MongoDB support to support annotation based metadata. Other strategies are also possible to put in place if there is demand.</p>
</div>
<div class="paragraph">
<p>Here is an example of a more complex mapping.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Document
@CompoundIndex(name = "age_idx", def = "{'lastName': 1, 'age': -1}")
public class Person&lt;T extends Address&gt; {

  @Id
  private String id;

  @Indexed(unique = true)
  private Integer ssn;

  @Field("fName")
  private String firstName;

  @Indexed
  private String lastName;

  private Integer age;

  @Transient
  private Integer accountTotal;

  @DBRef
  private List&lt;Account&gt; accounts;

  private T address;

  public Person(Integer ssn) {
    this.ssn = ssn;
  }

  @PersistenceConstructor
  public Person(Integer ssn, String firstName, String lastName, Integer age, T address) {
    this.ssn = ssn;
    this.firstName = firstName;
    this.lastName = lastName;
    this.age = age;
    this.address = address;
  }

  public String getId() {
    return id;
  }

  // no setter for Id.  (getter is only exposed for some unit testing)

  public Integer getSsn() {
    return ssn;
  }

// other getters/setters omitted
}</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p><code>@Field(targetType=&#8230;&#8203;)</code> can come in handy when the native MongoDB type inferred by the mapping infrastructure does not
match the expected one. Like for <code>BigDecimal</code>, which is represented as <code>String</code> instead of <code>Decimal128</code>, just because earlier
versions of MongoDB Server did not have support for it.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">public class Balance {

  @Field(targetType = DECIMAL128)
  private BigDecimal value;

  // ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>You may even consider your own, custom annotation.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Target(ElementType.FIELD)
@Retention(RetentionPolicy.RUNTIME)
@Field(targetType = FieldType.DECIMAL128)
public @interface Decimal128 { }

// ...

public class Balance {

  @Decimal128
  private BigDecimal value;

  // ...
}</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="mapping-custom-object-construction"><a class="anchor" href="index.html#mapping-custom-object-construction"></a>18.5.3. Customized Object Construction</h4>
<div class="paragraph">
<p>The mapping subsystem allows the customization of the object construction by annotating a constructor with the <code>@PersistenceConstructor</code> annotation. The values to be used for the constructor parameters are resolved in the following way:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If a parameter is annotated with the <code>@Value</code> annotation, the given expression is evaluated and the result is used as the parameter value.</p>
</li>
<li>
<p>If the Java type has a property whose name matches the given field of the input document, then it&#8217;s property information is used to select the appropriate constructor parameter to pass the input field value to. This works only if the parameter name information is present in the java <code>.class</code> files which can be achieved by compiling the source with debug information or using the new <code>-parameters</code> command-line switch for javac in Java 8.</p>
</li>
<li>
<p>Otherwise a <code>MappingException</code> will be thrown indicating that the given constructor parameter could not be bound.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">class OrderItem {

  private @Id String id;
  private int quantity;
  private double unitPrice;

  OrderItem(String id, @Value("#root.qty ?: 0") int quantity, double unitPrice) {
    this.id = id;
    this.quantity = quantity;
    this.unitPrice = unitPrice;
  }

  // getters/setters ommitted
}

Document input = new Document("id", "4711");
input.put("unitPrice", 2.5);
input.put("qty",5);
OrderItem item = converter.read(OrderItem.class, input);</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The SpEL expression in the <code>@Value</code> annotation of the <code>quantity</code> parameter falls back to the value <code>0</code> if the given property path cannot be resolved.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Additional examples for using the <code>@PersistenceConstructor</code> annotation can be found in the <a href="https://github.com/spring-projects/spring-data-mongodb/blob/master/spring-data-mongodb/src/test/java/org/springframework/data/mongodb/core/convert/MappingMongoConverterUnitTests.java">MappingMongoConverterUnitTests</a> test suite.</p>
</div>
</div>
<div class="sect3">
<h4 id="mapping-usage-indexes.compound-index"><a class="anchor" href="index.html#mapping-usage-indexes.compound-index"></a>18.5.4. Compound Indexes</h4>
<div class="paragraph">
<p>Compound indexes are also supported. They are defined at the class level, rather than on individual properties.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Compound indexes are very important to improve the performance of queries that involve criteria on multiple fields
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Here&#8217;s an example that creates a compound index of <code>lastName</code> in ascending order and <code>age</code> in descending order:</p>
</div>
<div class="exampleblock">
<div class="title">Example 184. Example Compound Index Usage</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">package com.mycompany.domain;

@Document
@CompoundIndex(name = "age_idx", def = "{'lastName': 1, 'age': -1}")
public class Person {

  @Id
  private ObjectId id;
  private Integer age;
  private String firstName;
  private String lastName;

}</code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p><code>@CompoundIndex</code> is repeatable using <code>@CompoundIndexes</code> as its container.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Document
@CompoundIndex(name = "cmp-idx-one", def = "{'firstname': 1, 'lastname': -1}")
@CompoundIndex(name = "cmp-idx-two", def = "{'address.city': -1, 'address.street': 1}")
public class Person {

  String firstname;
  String lastname;

  Address address;

  // ...
}</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="mapping-usage-indexes.hashed-index"><a class="anchor" href="index.html#mapping-usage-indexes.hashed-index"></a>18.5.5. Hashed Indexes</h4>
<div class="paragraph">
<p>Hashed indexes allow hash based sharding within a sharded cluster.
Using hashed field values to shard collections results in a more random distribution.
For details, refer to the <a href="https://docs.mongodb.com/manual/core/index-hashed/">MongoDB Documentation</a>.</p>
</div>
<div class="paragraph">
<p>Here&#8217;s an example that creates a hashed index for <code>_id</code>:</p>
</div>
<div class="exampleblock">
<div class="title">Example 185. Example Hashed Index Usage</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Document
public class DomainType {

  @HashIndexed @Id String id;

  // ...
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Hashed indexes can be created next to other index definitions like shown below, in that case both indices are created:</p>
</div>
<div class="exampleblock">
<div class="title">Example 186. Example Hashed Index Usage togehter with simple index</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Document
public class DomainType {

  @Indexed
  @HashIndexed
  String value;

  // ...
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>In case the example above is too verbose, a compound annotation allows to reduce the number of annotations that need to be declared on a property:</p>
</div>
<div class="exampleblock">
<div class="title">Example 187. Example Composed Hashed Index Usage</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Document
public class DomainType {

  @IndexAndHash(name = "idx...")                            <i class="conum" data-value="1"></i><b>(1)</b>
  String value;

  // ...
}

@Indexed
@HashIndexed
@Retention(RetentionPolicy.RUNTIME)
public @interface IndexAndHash {

  @AliasFor(annotation = Indexed.class, attribute = "name") <i class="conum" data-value="1"></i><b>(1)</b>
  String name() default "";
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Potentially register an alias for certain attributes of the meta annotation.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Although index creation via annotations comes in handy for many scenarios cosider taking over more control by setting up indices manually via <code>IndexOperations</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">mongoOperations.indexOpsFor(Jedi.class)
  .ensureIndex(HashedIndex.hashed("useTheForce"));</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="mapping-usage-indexes.text-index"><a class="anchor" href="index.html#mapping-usage-indexes.text-index"></a>18.5.6. Text Indexes</h4>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The text index feature is disabled by default for MongoDB v.2.4.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Creating a text index allows accumulating several fields into a searchable full-text index. It is only possible to have one text index per collection, so all fields marked with <code>@TextIndexed</code> are combined into this index. Properties can be weighted to influence the document score for ranking results. The default language for the text index is English. To change the default language, set the <code>language</code> attribute to whichever language you want (for example,<code>@Document(language="spanish")</code>). Using a property called <code>language</code> or <code>@Language</code> lets you define a language override on a per document base. The following example shows how to created a text index and set the language to Spanish:</p>
</div>
<div class="exampleblock">
<div class="title">Example 188. Example Text Index Usage</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Document(language = "spanish")
class SomeEntity {

    @TextIndexed String foo;

    @Language String lang;

    Nested nested;
}

class Nested {

    @TextIndexed(weight=5) String bar;
    String roo;
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="mapping-usage-references"><a class="anchor" href="index.html#mapping-usage-references"></a>18.5.7. Using DBRefs</h4>
<div class="paragraph">
<p>The mapping framework does not have to store child objects embedded within the document.
You can also store them separately and use a DBRef to refer to that document.
When the object is loaded from MongoDB, those references are eagerly resolved so that you get back a mapped object that looks the same as if it had been stored embedded within your top-level document.</p>
</div>
<div class="paragraph">
<p>The following example uses a DBRef to refer to a specific document that exists independently of the object in which it is referenced (both classes are shown in-line for brevity&#8217;s sake):</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Document
public class Account {

  @Id
  private ObjectId id;
  private Float total;
}

@Document
public class Person {

  @Id
  private ObjectId id;
  @Indexed
  private Integer ssn;
  @DBRef
  private List&lt;Account&gt; accounts;
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>You need not use <code>@OneToMany</code> or similar mechanisms because the List of objects tells the mapping framework that you want a one-to-many relationship. When the object is stored in MongoDB, there is a list of DBRefs rather than the <code>Account</code> objects themselves.
When it comes to loading collections of <code>DBRef</code>s it is advisable to restrict references held in collection types to a specific MongoDB collection. This allows bulk loading of all references, whereas references pointing to different MongoDB collections need to be resolved one by one.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
The mapping framework does not handle cascading saves. If you change an <code>Account</code> object that is referenced by a <code>Person</code> object, you must save the <code>Account</code> object separately. Calling <code>save</code> on the <code>Person</code> object does not automatically save the <code>Account</code> objects in the <code>accounts</code> property.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><code>DBRef</code>s can also be resolved lazily. In this case the actual <code>Object</code> or <code>Collection</code> of references is resolved on first access of the property. Use the <code>lazy</code> attribute of <code>@DBRef</code> to specify this.
Required properties that are also defined as lazy loading <code>DBRef</code> and used as constructor arguments are also decorated with the lazy loading proxy making sure to put as little pressure on the database and network as possible.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Lazily loaded <code>DBRef</code>s can be hard to debug. Make sure tooling does not accidentally trigger proxy resolution by eg. calling <code>toString()</code> or some inline debug rendering invoking property getters.
Please consider to enable <em>trace</em> logging for <code>org.springframework.data.mongodb.core.convert.DefaultDbRefResolver</code> to gain insight on <code>DBRef</code> resolution.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="mapping-usage-events"><a class="anchor" href="index.html#mapping-usage-events"></a>18.5.8. Mapping Framework Events</h4>
<div class="paragraph">
<p>Events are fired throughout the lifecycle of the mapping process. This is described in the <a href="index.html#mongodb.mapping-usage.events">Lifecycle Events</a> section.</p>
</div>
<div class="paragraph">
<p>Declaring these beans in your Spring ApplicationContext causes them to be invoked whenever the event is dispatched.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="mongo.custom-converters"><a class="anchor" href="index.html#mongo.custom-converters"></a>18.6. Custom Conversions - Overriding Default Mapping</h3>
<div class="paragraph">
<p>The most trivial way of influencing the mapping result is by specifying the desired native MongoDB target type via the
<code>@Field</code> annotation. This allows to work with non MongoDB types like <code>BigDecimal</code> in the domain model while persisting
values in native <code>org.bson.types.Decimal128</code> format.</p>
</div>
<div class="exampleblock">
<div class="title">Example 189. Explicit target type mapping</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">public class Payment {

  @Id String id; <i class="conum" data-value="1"></i><b>(1)</b>

  @Field(targetType = FieldType.DECIMAL128) <i class="conum" data-value="2"></i><b>(2)</b>
  BigDecimal value;

  Date date; <i class="conum" data-value="3"></i><b>(3)</b>

}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">{
  "_id"   : ObjectId("5ca4a34fa264a01503b36af8"), <i class="conum" data-value="1"></i><b>(1)</b>
  "value" : NumberDecimal(2.099), <i class="conum" data-value="2"></i><b>(2)</b>
  "date"   : ISODate("2019-04-03T12:11:01.870Z") <i class="conum" data-value="3"></i><b>(3)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>String <em>id</em> values that represent a valid <code>ObjectId</code> are converted automatically. See <a href="index.html#mongo-template.id-handling">How the <code>_id</code> Field is Handled in the Mapping Layer</a>
for details.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The desired target type is explicitly defined as <code>Decimal128</code> which translates to <code>NumberDecimal</code>. Otherwise the
<code>BigDecimal</code> value would have been truned into a <code>String</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td><code>Date</code> values are handled by the MongoDB driver itself an are stored as <code>ISODate</code>.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>The snippet above is handy for providing simple type hints. To gain more fine-grained control over the mapping process,
you can register Spring converters with the <code>MongoConverter</code> implementations, such as the <code>MappingMongoConverter</code>.</p>
</div>
<div class="paragraph">
<p>The <code>MappingMongoConverter</code> checks to see if any Spring converters can handle a specific class before attempting to map the object itself. To 'hijack' the normal mapping strategies of the <code>MappingMongoConverter</code>, perhaps for increased performance or other custom mapping needs, you first need to create an implementation of the Spring <code>Converter</code> interface and then register it with the <code>MappingConverter</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
For more information on the Spring type conversion service, see the reference docs <a href="https://docs.spring.io/spring/docs/5.3.1/spring-framework-reference/core.html#validation">here</a>.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="mongo.custom-converters.writer"><a class="anchor" href="index.html#mongo.custom-converters.writer"></a>18.6.1. Saving by Using a Registered Spring Converter</h4>
<div class="paragraph">
<p>The following example shows an implementation of the <code>Converter</code> that converts from a <code>Person</code> object to a <code>org.bson.Document</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">import org.springframework.core.convert.converter.Converter;

import org.bson.Document;

public class PersonWriteConverter implements Converter&lt;Person, Document&gt; {

  public Document convert(Person source) {
    Document document = new Document();
    document.put("_id", source.getId());
    document.put("name", source.getFirstName());
    document.put("age", source.getAge());
    return document;
  }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="mongo.custom-converters.reader"><a class="anchor" href="index.html#mongo.custom-converters.reader"></a>18.6.2. Reading by Using a Spring Converter</h4>
<div class="paragraph">
<p>The following example shows an implementation of a <code>Converter</code> that converts from a <code>Document</code> to a <code>Person</code> object:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">public class PersonReadConverter implements Converter&lt;Document, Person&gt; {

  public Person convert(Document source) {
    Person p = new Person((ObjectId) source.get("_id"), (String) source.get("name"));
    p.setAge((Integer) source.get("age"));
    return p;
  }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="mongo.custom-converters.xml"><a class="anchor" href="index.html#mongo.custom-converters.xml"></a>18.6.3. Registering Spring Converters with the <code>MongoConverter</code></h4>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">class MyMongoConfiguration extends AbstractMongoClientConfiguration {

	@Override
	public String getDatabaseName() {
		return "database";
	}

	@Override
	protected void configureConverters(MongoConverterConfigurationAdapter adapter) {
		adapter.registerConverter(new com.example.PersonReadConverter());
		adapter.registerConverter(new com.example.PersonWriteConverter());
	}
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following example of a Spring <code>Converter</code> implementation converts from a <code>String</code> to a custom <code>Email</code> value object:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@ReadingConverter
public class EmailReadConverter implements Converter&lt;String, Email&gt; {

  public Email convert(String source) {
    return Email.valueOf(source);
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you write a <code>Converter</code> whose source and target type are native types, we cannot determine whether we should consider it as a reading or a writing converter.
Registering the converter instance as both might lead to unwanted results.
For example, a <code>Converter&lt;String, Long&gt;</code> is ambiguous, although it probably does not make sense to try to convert all <code>String</code> instances into <code>Long</code> instances when writing.
To let you force the infrastructure to register a converter for only one way, we provide <code>@ReadingConverter</code> and <code>@WritingConverter</code> annotations to be used in the converter implementation.</p>
</div>
<div class="paragraph">
<p>Converters are subject to explicit registration as instances are not picked up from a classpath or container scan to avoid unwanted registration with a conversion service and the side effects resulting from such a registration. Converters are registered with <code>CustomConversions</code> as the central facility that allows registration and querying for registered converters based on source- and target type.</p>
</div>
<div class="paragraph">
<p><code>CustomConversions</code> ships with a pre-defined set of converter registrations:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>JSR-310 Converters for conversion between <code>java.time</code>, <code>java.util.Date</code> and <code>String</code> types.</p>
</li>
<li>
<p>Deprecated: Joda Time Converters for conversion between <code>org.joda.time</code>, JSR-310, and <code>java.util.Date</code>.</p>
</li>
<li>
<p>Deprecated: ThreeTenBackport Converters for conversion between <code>org.joda.time</code>, JSR-310, and <code>java.util.Date</code>.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Default converters for local temporal types (e.g. <code>LocalDateTime</code> to <code>java.util.Date</code>) rely on system-default timezone settings to convert between those types. You can override the default converter, by registering your own converter.
</td>
</tr>
</table>
</div>
<div class="sect5">
<h6 id="customconversions.converter-disambiguation"><a class="anchor" href="index.html#customconversions.converter-disambiguation"></a>Converter Disambiguation</h6>
<div class="paragraph">
<p>Generally, we inspect the <code>Converter</code> implementations for the source and target types they convert from and to.
Depending on whether one of those is a type the underlying data access API can handle natively, we register the converter instance as a reading or a writing converter.
The following examples show a writing- and a read converter (note the difference is in the order of the qualifiers on <code>Converter</code>):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">// Write converter as only the target type is one that can be handled natively
class MyConverter implements Converter&lt;Person, String&gt; { … }

// Read converter as only the source type is one that can be handled natively
class MyConverter implements Converter&lt;String, Person&gt; { … }</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sharding"><a class="anchor" href="index.html#sharding"></a>19. Sharding</h2>
<div class="sectionbody">
<div class="paragraph">
<p>MongoDB supports large data sets via sharding, a method for distributing data across multiple database servers.
Please refer to the <a href="https://docs.mongodb.com/manual/sharding/">MongoDB Documentation</a> to learn how to set up a sharded cluster, its requirements and limitations.</p>
</div>
<div class="paragraph">
<p>Spring Data MongoDB uses the <code>@Sharded</code> annotation to identify entities stored in sharded collections as shown below.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">@Document("users")
@Sharded(shardKey = { "country", "userId" }) <i class="conum" data-value="1"></i><b>(1)</b>
public class User {

	@Id
	Long id;

	@Field("userid")
	String userId;

	String country;
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The properties of the shard key get mapped to the actual field names.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="sharding.sharded-collections"><a class="anchor" href="index.html#sharding.sharded-collections"></a>19.1. Sharded Collections</h3>
<div class="paragraph">
<p>Spring Data MongoDB does not auto set up sharding for collections nor indexes required for it.
The snippet below shows how to do so using the MongoDB client API.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">MongoDatabase adminDB = template.getMongoDbFactory()
    .getMongoDatabase("admin");                                     <i class="conum" data-value="1"></i><b>(1)</b>

adminDB.runCommand(new Document("enableSharding", "db"));           <i class="conum" data-value="2"></i><b>(2)</b>

Document shardCmd = new Document("shardCollection", "db.users")     <i class="conum" data-value="3"></i><b>(3)</b>
	.append("key", new Document("country", 1).append("userid", 1)); <i class="conum" data-value="4"></i><b>(4)</b>

adminDB.runCommand(shardCmd);</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Sharding commands need to be run against the <em>admin</em> database.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Enable sharding for a specific database if necessary.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Shard a collection within the database having sharding enabled.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Specify the shard key.
This example uses range based sharding.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="sharding.shard-key"><a class="anchor" href="index.html#sharding.shard-key"></a>19.2. Shard Key Handling</h3>
<div class="paragraph">
<p>The shard key consists of a single or multiple properties that must exist in every document in the target collection.
It is used to distribute documents across shards.</p>
</div>
<div class="paragraph">
<p>Adding the <code>@Sharded</code> annotation to an entity enables Spring Data MongoDB to apply best effort optimisations required for sharded scenarios.
This means essentially adding required shard key information, if not already present, to <code>replaceOne</code> filter queries when upserting entities.
This may require an additional server round trip to determine the actual value of the current shard key.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
By setting <code>@Sharded(immutableKey = true)</code> Spring Data does not attempt to check if an entity shard key was changed.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Please see the <a href="https://docs.mongodb.com/manual/reference/method/db.collection.replaceOne/#upsert">MongoDB Documentation</a> for further details.
The following list contains which operations are eligible for shard key auto-inclusion:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>(Reactive)CrudRepository.save(…)</code></p>
</li>
<li>
<p><code>(Reactive)CrudRepository.saveAll(…)</code></p>
</li>
<li>
<p><code>(Reactive)MongoTemplate.save(…)</code></p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="kotlin"><a class="anchor" href="index.html#kotlin"></a>20. Kotlin Support</h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="https://kotlinlang.org">Kotlin</a> is a statically typed language that targets the JVM (and other platforms) which allows writing concise and elegant code while providing excellent <a href="https://kotlinlang.org/docs/reference/java-interop.html">interoperability</a> with existing libraries written in Java.</p>
</div>
<div class="paragraph">
<p>Spring Data provides first-class support for Kotlin and lets developers write Kotlin applications almost as if Spring Data was a Kotlin native framework.</p>
</div>
<div class="paragraph">
<p>The easiest way to build a Spring application with Kotlin is to leverage Spring Boot and its <a href="../../../../../../spring-boot/docs/current/reference/html/boot-features-kotlin.html">dedicated Kotlin support</a>.
This comprehensive <a href="https://spring.io/guides/tutorials/spring-boot-kotlin/">tutorial</a> will teach you how to build Spring Boot applications with Kotlin using <a href="https://start.spring.io/#!language=kotlin&amp;type=gradle-project">start.spring.io</a>.</p>
</div>
<div class="sect2">
<h3 id="kotlin.requirements"><a class="anchor" href="index.html#kotlin.requirements"></a>20.1. Requirements</h3>
<div class="paragraph">
<p>Spring Data supports Kotlin 1.3 and requires <a href="https://bintray.com/bintray/jcenter/org.jetbrains.kotlin%3Akotlin-stdlib"><code>kotlin-stdlib</code></a> (or one of its variants, such as <a href="https://bintray.com/bintray/jcenter/org.jetbrains.kotlin%3Akotlin-stdlib-jdk8"><code>kotlin-stdlib-jdk8</code></a>) and <a href="https://bintray.com/bintray/jcenter/org.jetbrains.kotlin%3Akotlin-reflect"><code>kotlin-reflect</code></a> to be present on the classpath.
Those are provided by default if you bootstrap a Kotlin project via <a href="https://start.spring.io/#!language=kotlin&amp;type=gradle-project">start.spring.io</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="kotlin.null-safety"><a class="anchor" href="index.html#kotlin.null-safety"></a>20.2. Null Safety</h3>
<div class="paragraph">
<p>One of Kotlin&#8217;s key features is <a href="https://kotlinlang.org/docs/reference/null-safety.html">null safety</a>, which cleanly deals with <code>null</code> values at compile time.
This makes applications safer through nullability declarations and the expression of &#8220;value or no value&#8221; semantics without paying the cost of wrappers, such as <code>Optional</code>.
(Kotlin allows using functional constructs with nullable values. See this <a href="https://www.baeldung.com/kotlin-null-safety">comprehensive guide to Kotlin null safety</a>.)</p>
</div>
<div class="paragraph">
<p>Although Java does not let you express null safety in its type system, Spring Data API is annotated with <a href="https://jcp.org/en/jsr/detail?id=305">JSR-305</a> tooling friendly annotations declared in the <code>org.springframework.lang</code> package.
By default, types from Java APIs used in Kotlin are recognized as <a href="https://kotlinlang.org/docs/reference/java-interop.html#null-safety-and-platform-types">platform types</a>, for which null checks are relaxed.
<a href="https://kotlinlang.org/docs/reference/java-interop.html#jsr-305-support">Kotlin support for JSR-305 annotations</a> and Spring nullability annotations provide null safety for the whole Spring Data API to Kotlin developers, with the advantage of dealing with <code>null</code> related issues at compile time.</p>
</div>
<div class="paragraph">
<p>See <a href="index.html#repositories.nullability">Null Handling of Repository Methods</a> how null safety applies to Spring Data Repositories.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>You can configure JSR-305 checks by adding the <code>-Xjsr305</code> compiler flag with the following options: <code>-Xjsr305={strict|warn|ignore}</code>.</p>
</div>
<div class="paragraph">
<p>For Kotlin versions 1.1+, the default behavior is the same as <code>-Xjsr305=warn</code>.
The <code>strict</code> value is required take Spring Data API null-safety into account. Kotlin types inferred from Spring API but should be used with the knowledge that Spring API nullability declaration could evolve, even between minor releases and that more checks may be added in the future.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Generic type arguments, varargs, and array elements nullability are not supported yet, but should be in an upcoming release.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="kotlin.mapping"><a class="anchor" href="index.html#kotlin.mapping"></a>20.3. Object Mapping</h3>
<div class="paragraph">
<p>See <a href="index.html#mapping.kotlin">Kotlin support</a> for details on how Kotlin objects are materialized.</p>
</div>
</div>
<div class="sect2">
<h3 id="kotlin.extensions"><a class="anchor" href="index.html#kotlin.extensions"></a>20.4. Extensions</h3>
<div class="paragraph">
<p>Kotlin <a href="https://kotlinlang.org/docs/reference/extensions.html">extensions</a> provide the ability to extend existing classes with additional functionality. Spring Data Kotlin APIs use these extensions to add new Kotlin-specific conveniences to existing Spring APIs.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Keep in mind that Kotlin extensions need to be imported to be used.
Similar to static imports, an IDE should automatically suggest the import in most cases.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For example, <a href="https://kotlinlang.org/docs/reference/inline-functions.html#reified-type-parameters">Kotlin reified type parameters</a> provide a workaround for JVM <a href="https://docs.oracle.com/javase/tutorial/java/generics/erasure.html">generics type erasure</a>, and Spring Data provides some extensions to take advantage of this feature.
This allows for a better Kotlin API.</p>
</div>
<div class="paragraph">
<p>To retrieve a list of <code>SWCharacter</code> objects in Java, you would normally write the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">Flux&lt;SWCharacter&gt; characters  = template.find(SWCharacter.class).inCollection("star-wars").all()</code></pre>
</div>
</div>
<div class="paragraph">
<p>With Kotlin and the Spring Data extensions, you can instead write the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="kotlin" class="language-kotlin hljs">val characters = template.find&lt;SWCharacter&gt;().inCollection("star-wars").all()
// or (both are equivalent)
val characters : Flux&lt;SWCharacter&gt; = template.find().inCollection("star-wars").all()</code></pre>
</div>
</div>
<div class="paragraph">
<p>As in Java, <code>characters</code> in Kotlin is strongly typed, but Kotlin&#8217;s clever type inference allows for shorter syntax.</p>
</div>
<div class="paragraph">
<p>Spring Data MongoDB provides the following extensions:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Reified generics support for <code>MongoOperations</code>, <code>ReactiveMongoOperations</code>, <code>FluentMongoOperations</code>, <code>ReactiveFluentMongoOperations</code>, and <code>Criteria</code>.</p>
</li>
<li>
<p><a href="index.html#mongo.query.kotlin-support">Type-safe Queries for Kotlin</a></p>
</li>
<li>
<p><a href="index.html#kotlin.coroutines">Coroutines</a> extensions for <code>ReactiveFluentMongoOperations</code>.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="kotlin.coroutines"><a class="anchor" href="index.html#kotlin.coroutines"></a>20.5. Coroutines</h3>
<div class="paragraph">
<p>Kotlin <a href="https://kotlinlang.org/docs/reference/coroutines-overview.html">Coroutines</a> are lightweight threads allowing to write non-blocking code imperatively.
On language side, <code>suspend</code> functions provides an abstraction for asynchronous operations while on library side <a href="https://github.com/Kotlin/kotlinx.coroutines">kotlinx.coroutines</a> provides functions like <a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/async.html"><code>async { }</code></a> and types like <a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines.flow/-flow/index.html"><code>Flow</code></a>.</p>
</div>
<div class="paragraph">
<p>Spring Data modules provide support for Coroutines on the following scope:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/-deferred/index.html">Deferred</a> and <a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines.flow/-flow/index.html">Flow</a> return values support in Kotlin extensions</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="kotlin.coroutines.dependencies"><a class="anchor" href="index.html#kotlin.coroutines.dependencies"></a>20.5.1. Dependencies</h4>
<div class="paragraph">
<p>Coroutines support is enabled when <code>kotlinx-coroutines-core</code>, <code>kotlinx-coroutines-reactive</code> and <code>kotlinx-coroutines-reactor</code> dependencies are in the classpath:</p>
</div>
<div class="exampleblock">
<div class="title">Example 190. Dependencies to add in Maven pom.xml</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;dependency&gt;
	&lt;groupId&gt;org.jetbrains.kotlinx&lt;/groupId&gt;
	&lt;artifactId&gt;kotlinx-coroutines-core&lt;/artifactId&gt;
&lt;/dependency&gt;

&lt;dependency&gt;
	&lt;groupId&gt;org.jetbrains.kotlinx&lt;/groupId&gt;
	&lt;artifactId&gt;kotlinx-coroutines-reactive&lt;/artifactId&gt;
&lt;/dependency&gt;

&lt;dependency&gt;
	&lt;groupId&gt;org.jetbrains.kotlinx&lt;/groupId&gt;
	&lt;artifactId&gt;kotlinx-coroutines-reactor&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Supported versions <code>1.3.0</code> and above.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="kotlin.coroutines.reactive"><a class="anchor" href="index.html#kotlin.coroutines.reactive"></a>20.5.2. How Reactive translates to Coroutines?</h4>
<div class="paragraph">
<p>For return values, the translation from Reactive to Coroutines APIs is the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>fun handler(): Mono&lt;Void&gt;</code> becomes <code>suspend fun handler()</code></p>
</li>
<li>
<p><code>fun handler(): Mono&lt;T&gt;</code> becomes <code>suspend fun handler(): T</code> or <code>suspend fun handler(): T?</code> depending on if the <code>Mono</code> can be empty or not (with the advantage of being more statically typed)</p>
</li>
<li>
<p><code>fun handler(): Flux&lt;T&gt;</code> becomes <code>fun handler(): Flow&lt;T&gt;</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p><a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines.flow/-flow/index.html"><code>Flow</code></a> is <code>Flux</code> equivalent in Coroutines world, suitable for hot or cold stream, finite or infinite streams, with the following main differences:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>Flow</code> is push-based while <code>Flux</code> is push-pull hybrid</p>
</li>
<li>
<p>Backpressure is implemented via suspending functions</p>
</li>
<li>
<p><code>Flow</code> has only a <a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines.flow/-flow/collect.html">single suspending <code>collect</code> method</a> and operators are implemented as <a href="https://kotlinlang.org/docs/reference/extensions.html">extensions</a></p>
</li>
<li>
<p><a href="https://github.com/Kotlin/kotlinx.coroutines/tree/master/kotlinx-coroutines-core/common/src/flow/operators">Operators are easy to implement</a> thanks to Coroutines</p>
</li>
<li>
<p>Extensions allow adding custom operators to <code>Flow</code></p>
</li>
<li>
<p>Collect operations are suspending functions</p>
</li>
<li>
<p><a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines.flow/map.html"><code>map</code> operator</a> supports asynchronous operation (no need for <code>flatMap</code>) since it takes a suspending function parameter</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Read this blog post about <a href="https://spring.io/blog/2019/04/12/going-reactive-with-spring-coroutines-and-kotlin-flow">Going Reactive with Spring, Coroutines and Kotlin Flow</a> for more details, including how to run code concurrently with Coroutines.</p>
</div>
</div>
<div class="sect3">
<h4 id="kotlin.coroutines.repositories"><a class="anchor" href="index.html#kotlin.coroutines.repositories"></a>20.5.3. Repositories</h4>
<div class="paragraph">
<p>Here is an example of a Coroutines repository:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="kotlin" class="language-kotlin hljs">interface CoroutineRepository : CoroutineCrudRepository&lt;User, String&gt; {

    suspend fun findOne(id: String): User

    fun findByFirstname(firstname: String): Flow&lt;User&gt;

    suspend fun findAllByFirstname(id: String): List&lt;User&gt;
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Coroutines repositories are built on reactive repositories to expose the non-blocking nature of data access through Kotlin&#8217;s Coroutines.
Methods on a Coroutines repository can be backed either by a query method or a custom implementation.
Invoking a custom implementation method propagates the Coroutines invocation to the actual implementation method if the custom method is <code>suspend</code>-able without requiring the implementation method to return a reactive type such as <code>Mono</code> or <code>Flux</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Coroutines repositories are only discovered when the repository extends the <code>CoroutineCrudRepository</code> interface.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="mongo.jmx"><a class="anchor" href="index.html#mongo.jmx"></a>21. JMX support</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The JMX support for MongoDB exposes the results of running the 'serverStatus' command on the admin database for a single MongoDB server instance. It also exposes an administrative MBean, <code>MongoAdmin</code>, that lets you perform administrative operations, such as dropping or creating a database. The JMX features build upon the JMX feature set available in the Spring Framework. See <a href="https://docs.spring.io/spring/docs/5.3.1/spring-framework-reference/integration.html#jmx">here</a> for more details.</p>
</div>
<div class="sect2">
<h3 id="mongodb:jmx-configuration"><a class="anchor" href="index.html#mongodb:jmx-configuration"></a>21.1. MongoDB JMX Configuration</h3>
<div class="paragraph">
<p>Spring&#8217;s Mongo namespace lets you enable JMX functionality, as the following example shows:</p>
</div>
<div class="exampleblock">
<div class="title">Example 191. XML schema to configure MongoDB</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xml" class="language-xml hljs">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;beans xmlns="http://www.springframework.org/schema/beans"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xmlns:context="http://www.springframework.org/schema/context"
  xmlns:mongo="http://www.springframework.org/schema/data/mongo"
  xsi:schemaLocation="
    http://www.springframework.org/schema/context
    https://www.springframework.org/schema/context/spring-context-3.0.xsd
    http://www.springframework.org/schema/data/mongo
    https://www.springframework.org/schema/data/mongo/spring-mongo-1.0.xsd
    http://www.springframework.org/schema/beans https://www.springframework.org/schema/beans/spring-beans-3.0.xsd"&gt;

    &lt;!-- Default bean name is 'mongo' --&gt;
    &lt;mongo:mongo-client host="localhost" port="27017"/&gt;

    &lt;!-- by default look for a Mongo object named 'mongo' --&gt;
    &lt;mongo:jmx/&gt;

    &lt;context:mbean-export/&gt;

    &lt;!-- To translate any MongoExceptions thrown in @Repository annotated classes --&gt;
    &lt;context:annotation-config/&gt;

    &lt;bean id="registry" class="org.springframework.remoting.rmi.RmiRegistryFactoryBean" p:port="1099" /&gt;

    &lt;!-- Expose JMX over RMI --&gt;
    &lt;bean id="serverConnector" class="org.springframework.jmx.support.ConnectorServerFactoryBean"
        depends-on="registry"
        p:objectName="connector:name=rmi"
        p:serviceUrl="service:jmx:rmi://localhost/jndi/rmi://localhost:1099/myconnector" /&gt;

&lt;/beans&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The preceding code exposes several MBeans:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>AssertMetrics</code></p>
</li>
<li>
<p><code>BackgroundFlushingMetrics</code></p>
</li>
<li>
<p><code>BtreeIndexCounters</code></p>
</li>
<li>
<p><code>ConnectionMetrics</code></p>
</li>
<li>
<p><code>GlobalLockMetrics</code></p>
</li>
<li>
<p><code>MemoryMetrics</code></p>
</li>
<li>
<p><code>OperationCounters</code></p>
</li>
<li>
<p><code>ServerInfo</code></p>
</li>
<li>
<p><code>MongoAdmin</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The following screenshot from JConsole shows the resulting configuration:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/jconsole.png" alt="jconsole">
</div>
</div>
</div>
</div>
</div>
<h1 id="appendix" class="sect0"><a class="anchor" href="index.html#appendix"></a>Appendix</h1>
<div class="sect1">
<h2 id="repositories.namespace-reference"><a class="anchor" href="index.html#repositories.namespace-reference"></a>Appendix A: Namespace reference</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="populator.namespace-dao-config"><a class="anchor" href="index.html#populator.namespace-dao-config"></a>The <code>&lt;repositories /&gt;</code> Element</h3>
<div class="paragraph">
<p>The <code>&lt;repositories /&gt;</code> element triggers the setup of the Spring Data repository infrastructure. The most important attribute is <code>base-package</code>, which defines the package to scan for Spring Data repository interfaces. See &#8220;<a href="index.html#repositories.create-instances.spring">XML Configuration</a>&#8221;. The following table describes the attributes of the <code>&lt;repositories /&gt;</code> element:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 19. Attributes</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 75%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Name</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>base-package</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Defines the package to be scanned for repository interfaces that extend <code>*Repository</code> (the actual interface is determined by the specific Spring Data module) in auto-detection mode. All packages below the configured package are scanned, too. Wildcards are allowed.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>repository-impl-postfix</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Defines the postfix to autodetect custom repository implementations. Classes whose names end with the configured postfix are considered as candidates. Defaults to <code>Impl</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>query-lookup-strategy</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Determines the strategy to be used to create finder queries. See &#8220;<a href="index.html#repositories.query-methods.query-lookup-strategies">Query Lookup Strategies</a>&#8221; for details. Defaults to <code>create-if-not-found</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>named-queries-location</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Defines the location to search for a Properties file containing externally defined queries.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>consider-nested-repositories</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether nested repository interface definitions should be considered. Defaults to <code>false</code>.</p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="populator.namespace-reference"><a class="anchor" href="index.html#populator.namespace-reference"></a>Appendix B: Populators namespace reference</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="namespace-dao-config"><a class="anchor" href="index.html#namespace-dao-config"></a>The &lt;populator /&gt; element</h3>
<div class="paragraph">
<p>The <code>&lt;populator /&gt;</code> element allows to populate the a data store via the Spring Data repository infrastructure.<sup class="footnote">[<a id="_footnoteref_4" class="footnote" href="index.html#_footnotedef_4" title="View footnote.">4</a>]</sup></p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 20. Attributes</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 75%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Name</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>locations</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Where to find the files to read the objects from the repository shall be populated with.</p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="repository-query-keywords"><a class="anchor" href="index.html#repository-query-keywords"></a>Appendix C: Repository query keywords</h2>
<div class="sectionbody">
<div class="sect2">
<h3>Supported query keywords</h3>
<div class="paragraph">
<p>The following table lists the keywords generally supported by the Spring Data repository query derivation mechanism. However, consult the store-specific documentation for the exact list of supported keywords, because some keywords listed here might not be supported in a particular store.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 21. Query keywords</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 75%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Logical keyword</th>
<th class="tableblock halign-left valign-top">Keyword expressions</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>AND</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>And</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>OR</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Or</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>AFTER</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>After</code>, <code>IsAfter</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>BEFORE</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Before</code>, <code>IsBefore</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>CONTAINING</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Containing</code>, <code>IsContaining</code>, <code>Contains</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>BETWEEN</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Between</code>, <code>IsBetween</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ENDING_WITH</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>EndingWith</code>, <code>IsEndingWith</code>, <code>EndsWith</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>EXISTS</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Exists</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>FALSE</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>False</code>, <code>IsFalse</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>GREATER_THAN</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>GreaterThan</code>, <code>IsGreaterThan</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>GREATER_THAN_EQUALS</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>GreaterThanEqual</code>, <code>IsGreaterThanEqual</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>IN</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>In</code>, <code>IsIn</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>IS</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Is</code>, <code>Equals</code>, (or no keyword)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>IS_EMPTY</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>IsEmpty</code>, <code>Empty</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>IS_NOT_EMPTY</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>IsNotEmpty</code>, <code>NotEmpty</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>IS_NOT_NULL</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>NotNull</code>, <code>IsNotNull</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>IS_NULL</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Null</code>, <code>IsNull</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>LESS_THAN</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>LessThan</code>, <code>IsLessThan</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>LESS_THAN_EQUAL</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>LessThanEqual</code>, <code>IsLessThanEqual</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>LIKE</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Like</code>, <code>IsLike</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>NEAR</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Near</code>, <code>IsNear</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>NOT</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Not</code>, <code>IsNot</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>NOT_IN</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>NotIn</code>, <code>IsNotIn</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>NOT_LIKE</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>NotLike</code>, <code>IsNotLike</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>REGEX</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Regex</code>, <code>MatchesRegex</code>, <code>Matches</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>STARTING_WITH</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>StartingWith</code>, <code>IsStartingWith</code>, <code>StartsWith</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>TRUE</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>True</code>, <code>IsTrue</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>WITHIN</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Within</code>, <code>IsWithin</code></p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="repository-query-return-types"><a class="anchor" href="index.html#repository-query-return-types"></a>Appendix D: Repository query return types</h2>
<div class="sectionbody">
<div class="sect2">
<h3>Supported Query Return Types</h3>
<div class="paragraph">
<p>The following table lists the return types generally supported by Spring Data repositories. However, consult the store-specific documentation for the exact list of supported return types, because some types listed here might not be supported in a particular store.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Geospatial types (such as <code>GeoResult</code>, <code>GeoResults</code>, and <code>GeoPage</code>) are available only for data stores that support geospatial queries.
</td>
</tr>
</table>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 22. Query return types</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 75%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Return type</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>void</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Denotes no return value.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Primitives</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Java primitives.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Wrapper types</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Java wrapper types.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>T</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A unique entity. Expects the query method to return one result at most. If no result is found, <code>null</code> is returned. More than one result triggers an <code>IncorrectResultSizeDataAccessException</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Iterator&lt;T&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">An <code>Iterator</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Collection&lt;T&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A <code>Collection</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>List&lt;T&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A <code>List</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Optional&lt;T&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A Java 8 or Guava <code>Optional</code>. Expects the query method to return one result at most. If no result is found, <code>Optional.empty()</code> or <code>Optional.absent()</code> is returned. More than one result triggers an <code>IncorrectResultSizeDataAccessException</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Option&lt;T&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Either a Scala or Vavr <code>Option</code> type. Semantically the same behavior as Java 8&#8217;s <code>Optional</code>, described earlier.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Stream&lt;T&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A Java 8 <code>Stream</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Streamable&lt;T&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A convenience extension of <code>Iterable</code> that directy exposes methods to stream, map and filter results, concatenate them etc.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Types that implement <code>Streamable</code> and take a <code>Streamable</code> constructor or factory method argument</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Types that expose a constructor or <code>….of(…)</code>/<code>….valueOf(…)</code> factory method taking a <code>Streamable</code> as argument. See <a href="index.html#repositories.collections-and-iterables.streamable-wrapper">Returning Custom Streamable Wrapper Types</a> for details.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Vavr <code>Seq</code>, <code>List</code>, <code>Map</code>, <code>Set</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Vavr collection types. See <a href="index.html#repositories.collections-and-iterables.vavr">Support for Vavr Collections</a> for details.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Future&lt;T&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A <code>Future</code>. Expects a method to be annotated with <code>@Async</code> and requires Spring&#8217;s asynchronous method execution capability to be enabled.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>CompletableFuture&lt;T&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A Java 8 <code>CompletableFuture</code>. Expects a method to be annotated with <code>@Async</code> and requires Spring&#8217;s asynchronous method execution capability to be enabled.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ListenableFuture</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A <code>org.springframework.util.concurrent.ListenableFuture</code>. Expects a method to be annotated with <code>@Async</code> and requires Spring&#8217;s asynchronous method execution capability to be enabled.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Slice</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A sized chunk of data with an indication of whether there is more data available. Requires a <code>Pageable</code> method parameter.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Page&lt;T&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A <code>Slice</code> with additional information, such as the total number of results. Requires a <code>Pageable</code> method parameter.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>GeoResult&lt;T&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A result entry with additional information, such as the distance to a reference location.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>GeoResults&lt;T&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A list of <code>GeoResult&lt;T&gt;</code> with additional information, such as the average distance to a reference location.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>GeoPage&lt;T&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A <code>Page</code> with <code>GeoResult&lt;T&gt;</code>, such as the average distance to a reference location.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Mono&lt;T&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A Project Reactor <code>Mono</code> emitting zero or one element using reactive repositories. Expects the query method to return one result at most. If no result is found, <code>Mono.empty()</code> is returned. More than one result triggers an <code>IncorrectResultSizeDataAccessException</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Flux&lt;T&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A Project Reactor <code>Flux</code> emitting zero, one, or many elements using reactive repositories. Queries returning <code>Flux</code> can emit also an infinite number of elements.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Single&lt;T&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A RxJava <code>Single</code> emitting a single element using reactive repositories. Expects the query method to return one result at most. If no result is found, <code>Mono.empty()</code> is returned. More than one result triggers an <code>IncorrectResultSizeDataAccessException</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Maybe&lt;T&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A RxJava <code>Maybe</code> emitting zero or one element using reactive repositories. Expects the query method to return one result at most. If no result is found, <code>Mono.empty()</code> is returned. More than one result triggers an <code>IncorrectResultSizeDataAccessException</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Flowable&lt;T&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A RxJava <code>Flowable</code> emitting zero, one, or many elements using reactive repositories. Queries returning <code>Flowable</code> can emit also an infinite number of elements.</p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
<div id="footnotes">
<hr>
<div class="footnote" id="_footnotedef_1">
<a href="index.html#_footnoteref_1">1</a>. Kristina Chodorow. <em>MongoDB - The Definitive Guide</em>. O&#8217;Reilly Media, 2013
</div>
<div class="footnote" id="_footnotedef_2">
<a href="index.html#_footnoteref_2">2</a>. Uses UTC zone offset. Configure via <a href="index.html#mapping-configuration">MongoConverterConfigurationAdapter</a>
</div>
<div class="footnote" id="_footnotedef_3">
<a href="index.html#_footnoteref_3">3</a>. Uses UTC zone offset. Configure via <a href="index.html#mapping-configuration">MongoConverterConfigurationAdapter</a>
</div>
<div class="footnote" id="_footnotedef_4">
<a href="index.html#_footnoteref_4">4</a>. see <a href="index.html#repositories.create-instances.spring">XML Configuration</a>
</div>
</div>
<div id="footer">
<div id="footer-text">
Version 3.1.1<br>
Last updated 2020-11-11 12:32:12 +0100
</div>
</div>
<link rel="stylesheet" href="js/highlight/styles/github.min.css">
<script data-cfasync="false" src="../../../../../../cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script src="js/highlight/highlight.min.js"></script>
<script>hljs.initHighlighting()</script>
<script type="text/javascript" src="js/tocbot/tocbot.min.js"></script>
<script type="text/javascript" src="js/toc.js"></script>
<script>if(window.parent==window){(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-2728886-23','auto',{'siteSpeedSampleRate':100});ga('send','pageview');}</script></body>
</html>